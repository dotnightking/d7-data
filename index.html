<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TX Engine">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>TX Scratch-Off Engine v7.5</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ°</text></svg>">
<style>
:root{--bg:#0d1118;--card:#151d28;--border:#1e2d3d;--text:#d0dae6;--dim:#8899aa;--grn:#2ecc71;--red:#e74c3c;--blu:#3498db;--amb:#f39c12;--pur:#9b59b6;--wht:#ecf0f1;--gld:#d4a017;--grn1:#2ecc7118;--red1:#e74c3c18;--blu1:#3498db18;--pur1:#9b59b618}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;font-size:13px;line-height:1.5;min-height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}input[type=number]{-moz-appearance:textfield}
.W{max-width:960px;margin:0 auto;padding:0 14px 100px}
.H{padding:14px 0;border-bottom:1px solid var(--border);margin-bottom:16px;position:sticky;top:0;background:var(--bg);z-index:99}
h1{font-size:20px;font-weight:800;color:var(--grn);letter-spacing:-.02em}
.sub{font-size:11px;color:var(--gld);margin-top:2px}
.tabs{display:flex;gap:5px;margin-top:10px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none}.tabs::-webkit-scrollbar{display:none}
.T{padding:8px 16px;border-radius:8px;border:1px solid var(--border);color:var(--dim);cursor:pointer;font:600 11px/1 'Segoe UI',sans-serif;white-space:nowrap;background:0 0;transition:.15s}
.T:hover{border-color:var(--dim);color:var(--text)}.T.on{border-color:var(--grn);background:var(--grn1);color:var(--grn)}
.C{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px;position:relative}
.L{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.06em;font-weight:600;margin-bottom:4px}
.V{font-size:24px;font-weight:800;line-height:1}
.g{color:var(--grn)}.r{color:var(--red)}.b{color:var(--blu)}.a{color:var(--amb)}.p{color:var(--pur)}.w{color:var(--wht)}.d{color:var(--dim)}
.G{display:grid;gap:10px}.GA{grid-template-columns:repeat(auto-fit,minmax(130px,1fr))}
.G2{grid-template-columns:1fr 1fr}.G3{grid-template-columns:1fr 1fr 1fr}
.cl{background:var(--bg);border-radius:8px;padding:10px}
.B{padding:8px 16px;border-radius:8px;border:1px solid var(--border);color:var(--dim);cursor:pointer;font:600 11px 'Segoe UI',sans-serif;background:0 0;display:inline-block;transition:.15s}
.B:hover{border-color:var(--dim);color:var(--text)}.B.on{border-color:var(--grn);background:var(--grn1);color:var(--grn)}
.B.bn{border-color:var(--blu);background:var(--blu1);color:var(--blu)}
.B.pn{border-color:var(--pur);background:var(--pur1);color:var(--pur)}
.B.rn{border-color:var(--red);background:var(--red1);color:var(--red)}
.I{background:#0a0e14;border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font:13px 'Segoe UI',sans-serif;outline:0;width:100%}
.I:focus{border-color:var(--blu)}select.I{cursor:pointer;-webkit-appearance:none}
.FR{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
.sig.buy{background:var(--grn1);color:var(--grn);border:1px solid #2ecc7130}
.sig.avoid{background:var(--red1);color:var(--red);border:1px solid #e74c3c30}
.badge{font-size:9px;font-weight:700;padding:3px 10px;border-radius:0 0 6px 6px;position:absolute;top:-1px;letter-spacing:.04em}
table{width:100%;border-collapse:collapse}
th{text-align:right;padding:6px 8px;font-size:10px;color:var(--dim);border-bottom:1px solid var(--border);font-weight:600}
td{padding:6px 8px;text-align:right;font-size:11px;border-bottom:1px solid #1e2d3d20}
.ck{cursor:pointer;transition:.15s}.ck:hover{background:#ffffff08;border-color:#ffffff18}
.bar-track{flex:1;height:22px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative;display:flex}
.spark{display:inline-flex;align-items:end;gap:1px;height:20px;vertical-align:middle}
.spark-bar{width:3px;border-radius:1px;min-height:2px}
.why-tag{font-size:10px;padding:3px 8px;border-radius:5px;font-weight:700;display:inline-block;margin:2px 2px}
@media(max-width:640px){.G3{grid-template-columns:1fr 1fr}.GA{grid-template-columns:repeat(auto-fit,minmax(110px,1fr))}h1{font-size:17px}
  .C{padding:12px;margin-bottom:10px}
  .sold-bar .V{font-size:18px!important}
}
</style>
</head>
<body>
<div class="W" id="app"></div>
<script>
var GD=[];var DD="";

// === UTILITIES ===
function fmt(n){if(n>=1e6)return"$"+(n/1e6).toFixed(1)+"M";if(n>=1e3)return"$"+(n/1e3).toFixed(1)+"K";return"$"+Math.round(n)}
function pct(n){return n>0&&n<0.001?"1:"+fN(Math.round(1/n)):(n*100).toFixed(1)+"%"}
function fmtO(n){if(n===Infinity||n>1e9)return"-";if(n>=1e6)return"1:"+Math.round(n/1e6)+"M";if(n>=1e3)return"1:"+Math.round(n/1e3)+"K";return"1:"+Math.round(n)}
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function fN(n){return Number(n).toLocaleString()}

// === LOG COMBINATION ===
function prClr(pr){var m={1:"#c39bd3",2:"#bb8fce",3:"#af7ac5",5:"#a569bd",10:"#9b59b6",20:"#884ea0",30:"#7d3c98",50:"#6c3483",100:"#5b2c6f"};return m[pr]||"#9b59b6"}

// === GLOBAL logC (used everywhere, defined ONCE) ===
function logC(n,k){
  if(k>n||k<0)return-Infinity;if(k===0||k===n)return 0;if(k>n-k)k=n-k;
  var s=0;for(var i=1;i<=k;i++)s+=Math.log(n-i+1)-Math.log(i);return s;
}

// === ODDS VALIDATION ===
function validateOdds(g){
  if(!g.odds||g.odds<=0||!g.tot||g.tot<=0)return{valid:false};
  var tw=0;for(var i=0;i<g.pz.length;i++)tw+=g.pz[i].p;
  var co=g.tot/tw,diff=Math.abs(co-g.odds)/g.odds;
  return{valid:diff<0.05,computedOdds:co,diff:diff,totalWinners:tw};
}

// === FACT-BASED BTP DETECTION ===
function detectBTP(g){
  var i,pc=g.tot>0&&g.pk>0?Math.round(g.tot/g.pk):0;
  if(pc<=0)return{valid:false,reason:"Missing total/pack size"};
  var packPrice=g.pk*g.pr,tiers=[];
  for(i=0;i<g.pz.length;i++){var p=g.pz[i];tiers.push({a:p.a,printed:p.p,claimed:p.c,rem:p.p-p.c,ratio:p.p/pc,idx:i});}
  var floorZone=[],aboveFloor=[];
  for(i=0;i<tiers.length;i++){(tiers[i].ratio>=0.3?floorZone:aboveFloor).push(tiers[i]);}
  var btp=null;
  for(i=0;i<floorZone.length;i++)if(floorZone[i].ratio>=0.5&&(!btp||floorZone[i].a>btp.a))btp=floorZone[i];
  if(!btp&&floorZone.length>0)btp=floorZone.reduce(function(a,b){return a.a>b.a?a:b});
  var floorValid=false,computedFloor=0;
  if(g.guar>0&&floorZone.length>0){
    var fzs=floorZone.slice().sort(function(a,b){return b.a-a.a}),target=g.guar,comp=0;
    for(i=0;i<fzs.length;i++){var cnt=Math.min(Math.max(1,Math.floor(fzs[i].ratio)),Math.max(1,Math.floor(target/fzs[i].a)));if(cnt>0&&target>=fzs[i].a){comp+=fzs[i].a*cnt;target-=fzs[i].a*cnt;}}
    computedFloor=comp;floorValid=Math.abs(g.guar-comp)<=Math.max(g.pr,g.guar*0.08);
  }
  var aboveSorted=aboveFloor.slice().sort(function(a,b){return b.a-a.a}),jackpotTiers=[];
  if(aboveSorted.length>=1){jackpotTiers.push(aboveSorted[0]);
    if(aboveSorted.length>=2&&aboveSorted[1].ratio<0.1){jackpotTiers.push(aboveSorted[1]);
      if(aboveSorted.length>=3&&aboveSorted[2].ratio<0.05)jackpotTiers.push(aboveSorted[2]);}}
  var jkMap={};for(i=0;i<jackpotTiers.length;i++)jkMap[jackpotTiers[i].a]=1;
  var midTiers=aboveFloor.filter(function(t){return!jkMap[t.a]}).sort(function(a,b){return b.a-a.a});
  return{valid:true,pc:pc,packPrice:packPrice,floorZone:floorZone,floorValid:floorValid,computedFloor:computedFloor,btp:btp,hasJackpot:jackpotTiers.length>0,jackpotTiers:jackpotTiers,midTiers:midTiers};
}

// === CORE ANALYSIS ===
function analyze(g){
  var i,p,R=function(p){return p.p-p.c};
  var totalTickets=g.tot,totWinP=0,tpvp=0;
  for(i=0;i<g.pz.length;i++){totWinP+=g.pz[i].p;tpvp+=g.pz[i].a*g.pz[i].p;}
  if(totalTickets<=0&&g.odds>0)totalTickets=Math.round(totWinP*g.odds);
  var complete=totalTickets>0&&g.pk>0&&g.guar>0&&g.odds>0;
  var pc=totalTickets>0&&g.pk>0?Math.round(totalTickets/g.pk):0;
  var packPrice=g.pk*g.pr,designedReturn=totalTickets>0&&g.pr>0?tpvp/(totalTickets*g.pr):0;
  var gd={tot:totalTickets,pk:g.pk,pr:g.pr,guar:g.guar,odds:g.odds,pz:g.pz};
  var btpInfo=detectBTP(gd),oddsCheck=validateOdds(gd);
  var aa=btpInfo.valid&&btpInfo.btp?btpInfo.btp.a:0;
  var ai=g.pz.findIndex(function(p){return p.a===aa});
  var at=ai>=0?g.pz[ai]:null,acr=at&&at.p>0?at.c/at.p:0;
  var btpValid=btpInfo.valid&&btpInfo.floorValid;
  var eps=pc>0?Math.round(pc*acr):0,epr=Math.max(1,pc-eps);
  var ets=eps*g.pk,etr=Math.max(0,totalTickets-ets);
  var tpvc=0;for(i=0;i<g.pz.length;i++)tpvc+=g.pz[i].a*g.pz[i].c;
  var tpvr=tpvp-tpvc,pkc=packPrice;
  var soldReturn=ets>0?tpvc/ets:0,remainReturn=etr>0?tpvr/etr:0;
  var mat=totalTickets>0?ets/totalTickets:0;
  var returnGap=soldReturn>0&&mat>0.10?(remainReturn-soldReturn)/soldReturn:0;
  var remainReturnPct=etr>0&&g.pr>0?tpvr/(etr*g.pr):0;
  var ot=ai>=0?g.pz.slice(0,ai):[],olr=0,oot=0;
  for(i=0;i<ot.length;i++){olr+=R(ot[i]);oot+=ot[i].p;}
  var orpC=epr>0?olr/epr:0,orpO=pc>0?oot/pc:0;
  var orpS=orpO>0?((orpC-orpO)/orpO)*100:0;
  var abvC=0,abvP=0,blwC=0,blwP=0;
  for(i=0;i<ot.length;i++){abvC+=ot[i].c;abvP+=ot[i].p;}
  for(i=ai+1;i<g.pz.length;i++){blwC+=g.pz[i].c;blwP+=g.pz[i].p;}
  var abvPct=abvP>0?abvC/abvP:0,blwPct=blwP>0?blwC/blwP:0;
  var tp=g.pz[0],tpr=R(tp),tpo=etr>0&&tpr>0?etr/tpr:Infinity;
  var tpPack=epr>0&&tpr>0?tpr/epr:0;
  var jackpotTiers=btpInfo.valid?btpInfo.jackpotTiers:[];
  var tierWeights=[1.0,0.5,0],jackpotShifts=[];
  for(i=0;i<jackpotTiers.length;i++){
    var jt=jackpotTiers[i];
    var lD=pc>0?jt.printed/pc:0,cD=epr>0?jt.rem/epr:0,sh=lD>0?cD/lD:0;
    var lO=pc>0&&jt.printed>0?Math.round(pc/jt.printed):Infinity;
    var cO=epr>0&&jt.rem>0?Math.round(epr/jt.rem):Infinity;
    var role=i===0?"TOP":i===1?"TOP-1":"TOP-2";
    var wt=i<tierWeights.length?tierWeights[i]:0;
    var claimLag=acr>0?(acr-(jt.printed>0?jt.claimed/jt.printed:0))/acr:0;
    jackpotShifts.push({a:jt.a,printed:jt.printed,remaining:jt.rem,claimed:jt.claimed,
      launchOdds:lO,currentOdds:cO,shift:sh,role:role,weight:wt,claimLag:claimLag,claimDelayTier:jt.a>599,
      signal:jt.rem<=0?"GONE":sh>=1.5?"STRONG":sh>=1.2?"GOOD":sh>=0.9?"NEUTRAL":sh>=0.7?"WEAK":"DEPLETED"});
  }
  var jackpotRem=0,jackpotPrinted=0,jackpotRemW=0,jackpotPrintedW=0;
  for(i=0;i<jackpotTiers.length;i++){
    jackpotRem+=jackpotTiers[i].rem;jackpotPrinted+=jackpotTiers[i].printed;
    var w2=i<tierWeights.length?tierWeights[i]:0;
    jackpotRemW+=jackpotTiers[i].rem*w2;jackpotPrintedW+=jackpotTiers[i].printed*w2;
  }
  var jackpotDensityNow=epr>0?jackpotRemW/epr:0;
  var jackpotDensityLaunch=pc>0?jackpotPrintedW/pc:0;
  var jackpotDensityShift=jackpotDensityLaunch>0?jackpotDensityNow/jackpotDensityLaunch:0;
  var topDensityShift=jackpotShifts.length>0?jackpotShifts[0].shift:0;
  var topClaimLag=jackpotShifts.length>0?jackpotShifts[0].claimLag:0;
  var jackpotEV=0,jackpotEVLaunch=0,jackpotEVRaw=0,jackpotEVLaunchRaw=0;
  for(i=0;i<jackpotTiers.length;i++){
    var evW=i<tierWeights.length?tierWeights[i]:0;
    var tierEV=jackpotTiers[i].rem>0&&epr>0?jackpotTiers[i].a*(jackpotTiers[i].rem/epr):0;
    var tierEVL=jackpotTiers[i].printed>0&&pc>0?jackpotTiers[i].a*(jackpotTiers[i].printed/pc):0;
    jackpotEV+=tierEV*evW;jackpotEVLaunch+=tierEVL*evW;jackpotEVRaw+=tierEV;jackpotEVLaunchRaw+=tierEVL;
  }
  var jackpotEVShift=jackpotEVLaunch>0?jackpotEV/jackpotEVLaunch:0;
  var hyperNow=0,hyperLaunch=0,hyperTopNow=0,hyperTopLaunch=0;
  if(etr>0&&g.pk>0&&jackpotRem>0)hyperNow=1-Math.exp(logC(etr-jackpotRem,g.pk)-logC(etr,g.pk));
  if(totalTickets>0&&g.pk>0&&jackpotPrinted>0)hyperLaunch=1-Math.exp(logC(totalTickets-jackpotPrinted,g.pk)-logC(totalTickets,g.pk));
  if(jackpotTiers.length>0){
    var tpRem2=jackpotTiers[0].rem,tpPri=jackpotTiers[0].printed;
    if(etr>0&&g.pk>0&&tpRem2>0)hyperTopNow=1-Math.exp(logC(etr-tpRem2,g.pk)-logC(etr,g.pk));
    if(totalTickets>0&&g.pk>0&&tpPri>0)hyperTopLaunch=1-Math.exp(logC(totalTickets-tpPri,g.pk)-logC(totalTickets,g.pk));
  }
  var hyperRatio=hyperLaunch>0?hyperNow/hyperLaunch:0;
  var hyperTopRatio=hyperTopLaunch>0?hyperTopNow/hyperTopLaunch:0;
  var hollowedOut=false;
  if(jackpotTiers.length>=2&&jackpotTiers[0].rem>0){
    var midGone=true;for(i=1;i<jackpotTiers.length;i++)if(jackpotTiers[i].rem>0)midGone=false;
    if(midGone)hollowedOut=true;
  }
  var totRem=0;for(i=0;i<g.pz.length;i++)totRem+=R(g.pz[i]);
  var winOdds=etr>0&&totRem>0?etr/totRem:Infinity;
  var ts=[],gSig="NEUTRAL",gRsn="Claims tracking normally.";
  for(i=0;i<ot.length;i++){
    p=ot[i];var ar=p.p>0?p.c/p.p:0,dev=acr>0?(ar-acr)/acr:0;
    var minSample=Math.max(5,p.p*0.05);
    var isJackpot=false;
    if(btpInfo.valid)for(var jj=0;jj<btpInfo.jackpotTiers.length;jj++)if(btpInfo.jackpotTiers[jj].a===p.a){isJackpot=true;break;}
    ts.push({a:p.a,ar:ar,er:acr,dev:dev,sig:p.c>=minSample&&dev<-0.05?"HOT":p.c>=minSample&&dev>0.05?"COLD":"NORMAL",rem:R(p),cat:isJackpot?"JACKPOT":"MID",isJackpot:isJackpot});
  }
  var jkH=0,jkC=0,jkN=0,allJkG=true;
  for(i=0;i<ts.length;i++){if(!ts[i].isJackpot)continue;jkN++;if(ts[i].rem>0)allJkG=false;if(ts[i].sig==="HOT")jkH++;if(ts[i].sig==="COLD")jkC++;}
  if(!btpInfo.hasJackpot){gSig="NO_JACKPOT";gRsn="No rare prize tiers above floor.";}
  else if(allJkG&&jkN>0){gSig="DEAD";gRsn="All jackpot prizes claimed.";}
  else if(jkC>0&&jkH===0){gSig="AVOID";gRsn="Jackpot prizes depleting faster than tickets selling.";}
  else if(jkH>0&&jkC===0){gSig="BUY";gRsn="Jackpot prizes underclaimed.";if(ts.filter(function(t){return!t.isJackpot&&t.sig==="HOT"}).length>0){gSig="STRONG_BUY";gRsn="Jackpot AND mid prizes underclaimed.";}}
  else if(jkH>0&&jkC>0){gSig="MIXED";gRsn="Some jackpot tiers under, others overclaimed.";}
  else{var mH=ts.filter(function(t){return!t.isJackpot&&t.sig==="HOT"}).length,mC=ts.filter(function(t){return!t.isJackpot&&t.sig==="COLD"}).length;
    if(mH>0&&mC===0){gSig="BUY";gRsn="Jackpot neutral but mid prizes underclaimed.";}
    else if(mC>0&&mH===0){gSig="CAUTION";gRsn="Jackpot neutral but mid prizes depleting.";}}
  if(returnGap<-0.03&&(gSig==="STRONG_BUY"||gSig==="BUY")){gSig="NEUTRAL";gRsn="Counts lag but dollars claimed disproportionately.";}
  if(returnGap>0.03&&gSig==="AVOID"){gSig="NEUTRAL";gRsn="Some tiers depleted but dollar value favors remaining.";}
  var floorEV=g.guar>0?g.guar:0,midRangeEV=0;
  if(btpInfo.valid)for(i=0;i<btpInfo.midTiers.length;i++){var mt=btpInfo.midTiers[i];if(mt.rem>0&&epr>0)midRangeEV+=mt.a*(mt.rem/epr);}
  var totalEV=floorEV+midRangeEV+jackpotEVRaw;
  var edge=packPrice>0?(totalEV/packPrice)-1:0;
  var midEVL=0;
  if(btpInfo.valid)for(i=0;i<btpInfo.midTiers.length;i++){var mt2=btpInfo.midTiers[i];if(mt2.printed>0&&pc>0)midEVL+=mt2.a*(mt2.printed/pc);}
  var totalEVLaunch=floorEV+midEVL+jackpotEVLaunchRaw;
  var edgeLaunch=packPrice>0?(totalEVLaunch/packPrice)-1:0;
  var impliedYield=eps>0&&packPrice>0?tpvc/(eps*packPrice):0;
  var yieldValid=g.guar>0&&packPrice>0?(impliedYield>=(g.guar/packPrice)*0.9&&impliedYield<=0.85):false;
  var totalClaimed=0;for(i=0;i<g.pz.length;i++)totalClaimed+=g.pz[i].c;
  var methodA=eps,methodB=g.odds>0&&g.pk>0?Math.round(totalClaimed/(g.pk/g.odds)):0;
  var yieldRate=designedReturn>0?designedReturn:0.70;
  var methodC=packPrice>0&&yieldRate>0?Math.round(tpvc/(packPrice*yieldRate)):0;
  var methods=[methodA,methodB,methodC].filter(function(m){return m>0}),confidence="LOW";
  if(methods.length>=2){
    var pairs=[];
    if(methodA>0&&methodB>0)pairs.push(Math.abs(methodA-methodB)/Math.max(methodA,methodB));
    if(methodA>0&&methodC>0)pairs.push(Math.abs(methodA-methodC)/Math.max(methodA,methodC));
    if(methodB>0&&methodC>0)pairs.push(Math.abs(methodB-methodC)/Math.max(methodB,methodC));
    var bestPair=Math.min.apply(null,pairs);
    if(bestPair<=0.05)confidence="HIGH";else if(bestPair<=0.10)confidence="MEDIUM";
  }
  var sc=50,scoreBreakdown=[];
  function addPts(pts,label){var rp=Math.round(pts);if(rp===0)return;sc+=rp;scoreBreakdown.push({f:label,p:rp});}
  if(jackpotDensityShift>0)addPts(Math.max(-20,Math.min(20,(jackpotDensityShift-1)*25)),"Top density "+jackpotDensityShift.toFixed(2)+"x");
  if(tpr===0){addPts(-15,"Top prize GONE");}
  else if(tp.p>0){var matScale=mat<0.2?0.3:mat<0.5?0.6:mat<0.7?0.8:1.0;addPts(Math.round(Math.min(15,((tpr/tp.p)*15)*matScale)),"Top "+tpr+"/"+tp.p+" @ "+pct(mat)+" sold");}
  if(topClaimLag!==0&&jackpotShifts.length>0&&mat>0.1){var lagDampen=jackpotShifts[0].a>599?0.85:1.0;addPts(Math.max(-8,Math.min(8,Math.round(topClaimLag*10*lagDampen))),"Top prize lag "+(topClaimLag>0?"+":"")+pct(topClaimLag));}
  if(hyperRatio>0)addPts(Math.max(-10,Math.min(10,Math.round((hyperRatio-1)*20))),"P(top in pack) "+hyperRatio.toFixed(2)+"x");
  if(jackpotEVShift>0)addPts(Math.max(-10,Math.min(10,Math.round((jackpotEVShift-1)*15))),"Top EV "+jackpotEVShift.toFixed(2)+"x");
  var mkMap={"STRONG_BUY":8,"BUY":5,"NEUTRAL":0,"NO_JACKPOT":0,"MIXED":0,"CAUTION":-3,"AVOID":-8,"DEAD":-15};
  addPts(mkMap[gSig]||0,"Markov "+gSig.replace(/_/g," "));
  if(returnGap!==0)addPts(Math.max(-5,Math.min(5,Math.round(returnGap*50))),"Return gap "+(returnGap>0?"+":"")+pct(returnGap));
  if(g.odds>0&&winOdds<Infinity)addPts(Math.max(-3,Math.min(3,Math.round(((g.odds-winOdds)/g.odds)*15))),"Win odds shift");
  var trend=getTrend((g.id||String(g.gn)));
  if(trend.length>=3){var recent=trend.slice(-3),firstJd=recent[0].jd,lastJd=recent[recent.length-1].jd;if(firstJd>0){var trendDir=(lastJd-firstJd)/firstJd;addPts(Math.max(-5,Math.min(5,Math.round(trendDir*30))),"Trend "+(trendDir>0?"â–²":"â–¼")+" "+pct(Math.abs(trendDir)));}}
  if(g.cs&&tpr>0)addPts(8,"CLOSING + top left");else if(g.cs&&tpr===0)addPts(-10,"CLOSING + gone");
  if(hollowedOut)addPts(-10,"HOLLOWED");
  if(!btpInfo.hasJackpot){sc=Math.min(sc,30);}
  if(mat<0.15&&mat>0){var pre=sc;sc=Math.round(50+(sc-50)*0.6);scoreBreakdown.push({f:"Early dampen",p:sc-pre});}
  if(!complete)addPts(-5,"Incomplete");
  if(confidence==="LOW"&&complete){var pre2=sc;sc=Math.round(50+(sc-50)*0.7);scoreBreakdown.push({f:"LOW conf dampen",p:sc-pre2});}
  var rawSc=sc;sc=Math.round(Math.min(100,Math.max(0,sc)));
  var whyScore=scoreBreakdown.slice().sort(function(a,b){return Math.abs(b.p)-Math.abs(a.p)}).filter(function(s){return s.p!==0}).slice(0,2);
  var tierCats={};
  if(btpInfo.valid){
    for(i=0;i<btpInfo.floorZone.length;i++)tierCats[btpInfo.floorZone[i].a]=btpInfo.floorZone[i].a===aa?"BTP":"FLOOR";
    for(i=0;i<btpInfo.midTiers.length;i++)tierCats[btpInfo.midTiers[i].a]="MID";
    for(i=0;i<btpInfo.jackpotTiers.length;i++){var role2=i===0?"TOP":i===1?"TOP-1":"TOP-2";tierCats[btpInfo.jackpotTiers[i].a]=role2;}
  }else{if(ai>=0)tierCats[g.pz[ai].a]="BTP";for(i=0;i<ai;i++)tierCats[g.pz[i].a]=i===0?"TOP":i===1?"TOP-1":"MID";for(i=ai+1;i<g.pz.length;i++)tierCats[g.pz[i].a]="FLOOR";}
  var tierAdv=[];
  for(i=0;i<ot.length;i++){p=ot[i];var trm=R(p);if(trm<=0)continue;
    var oO=totalTickets>0&&p.p>0?totalTickets/p.p:Infinity,cO2=etr>0&&trm>0?etr/trm:Infinity;
    tierAdv.push({a:p.a,origO:oO,currO:cO2,pctB:oO>0&&oO<Infinity?((oO-cO2)/oO)*100:0,rem:trm,cat:tierCats[p.a]||"?"});}
  var prizes=[];
  for(i=0;i<g.pz.length;i++){p=g.pz[i];var rm=R(p);
    prizes.push({a:p.a,p:p.p,c:p.c,rem:rm,pctC:p.p>0?(p.c/p.p*100):0,
      origO:totalTickets>0?totalTickets/p.p:Infinity,currO:etr>0&&rm>0?etr/rm:Infinity,
      isA:p.a===aa,isO:ai>=0&&i<ai,cat:tierCats[p.a]||"?",
      isJackpot:tierCats[p.a]==="JACKPOT",highSens:p.p<=10});}
  var flags=[];
  if(tpr===0)flags.push({t:"DANGER",m:"All "+fmt(tp.a)+" claimed",c:"r"});
  if(g.cs&&tpr>0)flags.push({t:"CLOSING",m:tpr+" top prizes left",c:"a"});
  if(gSig==="STRONG_BUY")flags.push({t:"HOT",m:gRsn,c:"g"});
  if(gSig==="BUY")flags.push({t:"BUY",m:gRsn,c:"g"});
  if(gSig==="DEAD")flags.push({t:"DEAD",m:gRsn,c:"r"});
  if(gSig==="AVOID")flags.push({t:"AVOID",m:gRsn,c:"r"});
  if(gSig==="CAUTION")flags.push({t:"CAUTION",m:gRsn,c:"a"});
  if(gSig==="NO_JACKPOT")flags.push({t:"NO JACKPOT",m:"No rare tiers",c:"d"});
  if(hollowedOut)flags.push({t:"HOLLOWED",m:"Top exists but mid gone",c:"a"});
  if(returnGap>0.02)flags.push({t:"RICH",m:"Remaining "+(returnGap*100).toFixed(1)+"% richer",c:"g"});
  if(returnGap<-0.02)flags.push({t:"THIN",m:"Remaining thinner",c:"r"});
  if(hyperRatio>1.2)flags.push({t:"JACKPOT+",m:"Odds "+hyperRatio.toFixed(1)+"x vs launch",c:"g"});
  if(mat<0.08)flags.push({t:"FRESH",m:"Only "+pct(mat)+" sold",c:"b"});
  if(!complete)flags.push({t:"INCOMPLETE",m:"Missing detail data",c:"a"});
  for(i=0;i<jackpotShifts.length;i++){if(jackpotShifts[i].printed<=10)flags.push({t:"âš¡$"+fN(jackpotShifts[i].a),m:"â‰¤10 printed",c:"a"});}
  for(i=0;i<ts.length;i++){if(ts[i].isJackpot&&ts[i].sig==="HOT"&&ts[i].dev<-0.15)flags.push({t:"$"+fN(ts[i].a)+" HOT",m:"Underclaimed",c:"p"});}
  if(!yieldValid&&complete)flags.push({t:"YIELDâš ",m:"Implied yield out of range",c:"a"});
  if(oddsCheck.valid===false&&g.odds>0)flags.push({t:"ODDSâš ",m:"Prize counts vs odds mismatch",c:"a"});
  return{g:g,pc:pc,aa:aa,ai:ai,acr:acr,eps:eps,epr:epr,ets:ets,etr:etr,
    tpvp:tpvp,tpvc:tpvc,tpvr:tpvr,pkc:pkc,complete:complete,
    totalTickets:totalTickets,packPrice:packPrice,totEstimated:totalTickets!==g.tot,
    designedReturn:designedReturn,soldReturn:soldReturn,remainReturn:remainReturn,
    returnGap:returnGap,remainReturnPct:remainReturnPct,
    btpInfo:btpInfo,btpValid:btpValid,oddsCheck:oddsCheck,
    orpC:orpC,orpO:orpO,orpS:orpS,abvPct:abvPct,blwPct:blwPct,
    tp:tp,tpr:tpr,tpo:tpo,mat:mat,sc:sc,rawSc:rawSc,tpPack:tpPack,
    winOdds:winOdds,totRem:totRem,
    jackpotTiers:jackpotTiers,jackpotShifts:jackpotShifts,
    jackpotDensityNow:jackpotDensityNow,jackpotDensityLaunch:jackpotDensityLaunch,
    jackpotDensityShift:jackpotDensityShift,
    topDensityShift:topDensityShift,topClaimLag:topClaimLag,
    jackpotEV:jackpotEV,jackpotEVLaunch:jackpotEVLaunch,jackpotEVShift:jackpotEVShift,
    jackpotEVRaw:jackpotEVRaw,jackpotEVLaunchRaw:jackpotEVLaunchRaw,
    hyperNow:hyperNow,hyperLaunch:hyperLaunch,hyperRatio:hyperRatio,
    hyperTopNow:hyperTopNow,hyperTopLaunch:hyperTopLaunch,hyperTopRatio:hyperTopRatio,
    hollowedOut:hollowedOut,
    floorEV:floorEV,midRangeEV:midRangeEV,totalEV:totalEV,edge:edge,
    totalEVLaunch:totalEVLaunch,edgeLaunch:edgeLaunch,
    methodA:methodA,methodB:methodB,methodC:methodC,dataConfidence:confidence,
    impliedYield:impliedYield,yieldValid:yieldValid,
    scoreBreakdown:scoreBreakdown,whyScore:whyScore,
    tierAdv:tierAdv,tierCats:tierCats,prizes:prizes,
    gm:{ts:ts,sig:gSig,rsn:gRsn},flags:flags,prizeClass:tp.a>1000?'high':'low'};
}

// === MONTE CARLO ===
function simulatePacks(a,N){
  if(!a.complete||a.epr<=0||a.etr<=0)return{valid:false};
  N=N||10000;
  var g=a.g,pk=g.pk,cost=a.packPrice,eW=g.odds>0?pk/g.odds:0;
  var topAmt=a.jackpotShifts.length>0?a.jackpotShifts[0].a:Infinity;
  var top1Amt=a.jackpotShifts.length>1?a.jackpotShifts[1].a:Infinity;
  var pool=[],totP=0;
  for(var i=0;i<g.pz.length;i++){var rm=g.pz[i].p-g.pz[i].c;if(rm>0){pool.push({a:g.pz[i].a,w:rm});totP+=rm;}}
  if(totP<=0)return{valid:false};
  var cum=[];var c=0;for(i=0;i<pool.length;i++){c+=pool[i].w;cum.push(c);}
  var results=[],pFl=0,pPr=0,pTop=0,pTop1=0,tRet=0;
  var buckets=[{l:"Below Floor",n:0},{l:"At Floor",n:0},{l:"Floor+",n:0},{l:"Break Even",n:0},{l:"2x-5x",n:0},{l:"5x+",n:0}];
  for(var s=0;s<N;s++){
    var tot=0,hitTop=false,hitTop1=false;
    var nW=Math.floor(eW)+(Math.random()<(eW%1)?1:0);
    if(Math.random()<0.1)nW+=Math.random()<0.5?1:-1;nW=Math.max(1,nW);
    for(var w=0;w<nW;w++){
      var r=Math.random()*totP,lo=0,hi=cum.length-1,drawn=pool[0].a;
      while(lo<=hi){var mid2=(lo+hi)>>1;if(cum[mid2]<r)lo=mid2+1;else{drawn=pool[mid2].a;hi=mid2-1;}}
      tot+=drawn;if(drawn>=topAmt)hitTop=true;if(drawn>=top1Amt)hitTop1=true;
    }
    if(a.floorEV>0&&tot<a.floorEV)tot=a.floorEV;
    results.push(tot);tRet+=tot;
    if(tot<=a.floorEV+1)pFl++;if(tot>=cost)pPr++;if(hitTop1)pTop1++;if(hitTop)pTop++;
    var bv=tot;var bi=bv<=a.floorEV+1?0:bv<cost*0.5?1:bv<cost?2:bv<cost*2?3:bv<cost*5?4:5;
    buckets[bi].n++;
  }
  results.sort(function(a,b){return a-b});
  return{valid:true,N:N,mean:tRet/N,median:results[N>>1],p5:results[Math.floor(N*0.05)],p95:results[Math.floor(N*0.95)],
    pFloor:pFl/N,pProfit:pPr/N,pTop1:pTop1/N,pTop:pTop/N,
    topAmt:topAmt,top1Amt:top1Amt,worst:results[0],best:results[N-1],cost:cost,floor:a.floorEV,
    buckets:buckets,expPL:(tRet/N)-cost};
}

// === REMAINING POOL FORECAST ===
function remainingPoolForecast(a){
  if(!a.complete||a.epr<=0||a.etr<=0||!a.btpInfo.valid)return{valid:false};
  var g=a.g,epr=a.epr,tiers=[];
  for(var i=0;i<g.pz.length;i++){var p=g.pz[i],rem=p.p-p.c;if(rem<=0)continue;
    var cat=a.tierCats[p.a]||"?";
    tiers.push({a:p.a,rem:rem,ratio:epr>0?rem/epr:0,cat:cat,isJackpot:cat==="TOP"||cat==="TOP-1"||cat==="TOP-2",isMid:cat==="MID"});}
  var jackpotPacks=0,jackpotTierDetails=[];
  for(i=0;i<tiers.length;i++){if(!tiers[i].isJackpot)continue;var t=tiers[i];
    jackpotTierDetails.push({a:t.a,rem:t.rem,cat:t.cat,packsWith:t.rem,pctOfRemaining:epr>0?t.rem/epr:0});jackpotPacks+=t.rem;}
  if(jackpotPacks>epr)jackpotPacks=epr;
  var midPrizes=0;for(i=0;i<tiers.length;i++)if(tiers[i].isMid)midPrizes+=tiers[i].rem;
  var midLambda=epr>0?midPrizes/epr:0,pMidPack=midLambda>0?1-Math.exp(-midLambda):0;
  var midPacks=Math.round(epr*pMidPack),pNoMid=Math.exp(-midLambda);
  var floorOnlyPacks=Math.round(epr*pNoMid*(1-jackpotPacks/epr));
  var floorMidPacks=Math.max(0,epr-floorOnlyPacks-jackpotPacks);
  var totalRemValue=0;for(i=0;i<tiers.length;i++)totalRemValue+=tiers[i].a*tiers[i].rem;
  var packCats=[];
  for(i=0;i<jackpotTierDetails.length;i++){var jd=jackpotTierDetails[i];
    packCats.push({label:"Contains $"+fN(jd.a)+" ("+jd.cat+")",count:jd.rem,pct:jd.pctOfRemaining,color:jd.cat==="TOP"?"#d4a017":jd.cat==="TOP-1"?"#af7ac5":"#5a6a7a",isJackpot:true});}
  packCats.push({label:"Mid-tier prize (no jackpot)",count:Math.max(0,floorMidPacks),pct:epr>0?Math.max(0,floorMidPacks)/epr:0,color:"#3498db",isJackpot:false});
  packCats.push({label:"Floor only ($"+fN(a.floorEV)+")",count:Math.max(0,floorOnlyPacks),pct:epr>0?Math.max(0,floorOnlyPacks)/epr:0,color:"#5a6a7a",isJackpot:false});
  return{valid:true,epr:epr,cost:a.packPrice,floor:a.floorEV,totalRemValue:totalRemValue,
    jackpotPacks:jackpotPacks,jackpotPct:epr>0?jackpotPacks/epr:0,
    midPacks:midPacks,floorOnlyPacks:floorOnlyPacks,
    jackpotTierDetails:jackpotTierDetails,packCats:packCats,tiers:tiers};
}

// === TREND ===
function saveTrend(){
  if(!S.data.length)return;
  var d=new Date().toISOString().slice(0,10);
  var t=JSON.parse(localStorage.getItem("txt7")||"{}");
  S.data.forEach(function(a){
    if(!a.complete)return;var k=(a.g.id||String(a.g.gn));if(!t[k])t[k]=[];
    if(t[k].length>0&&t[k][t[k].length-1].d===d)return;
    t[k].push({d:d,sc:a.sc,jd:a.jackpotDensityShift,jr:a.jackpotTiers.reduce(function(s,x){return s+x.rem},0),mat:a.mat,tpr:a.tpr});
    if(t[k].length>60)t[k]=t[k].slice(-60);
  });
  localStorage.setItem("txt7",JSON.stringify(t));
}
function getTrend(id){return(JSON.parse(localStorage.getItem("txt7")||"{}"))[id]||[];}

// ============================================================
// v7.1 NEW: BURN RATE + SELF-LEARNING PACK GUIDANCE
// ============================================================

// BURN RATE â€” daily pack consumption from trend snapshots
function computeBurnRate(id,a){
  var trend=getTrend(id);
  if(!trend||trend.length<2||!a.pc||a.pc<=0)return null;
  var pairs=[];
  for(var i=trend.length-1;i>=1;i--){
    var cur=trend[i],prev=trend[i-1];
    if(!cur.mat||!prev.mat||cur.mat===prev.mat)continue;
    if(!cur.d||!prev.d||cur.d===prev.d)continue;
    var days=Math.max(1,Math.round((new Date(cur.d)-new Date(prev.d))/86400000));
    var deltaMat=cur.mat-prev.mat;if(deltaMat<=0)continue;
    var ppd=Math.round((deltaMat*a.pc)/days);
    pairs.push({packsPerDay:ppd,days:days});if(pairs.length>=3)break;
  }
  if(!pairs.length)return null;
  var avgPpd=Math.round(pairs.reduce(function(s,p){return s+p.packsPerDay;},0)/pairs.length);
  if(avgPpd<=0)return null;
  var daysLeft=a.epr>0?Math.round(a.epr/avgPpd):null;
  var milestones=[],currentMat=a.mat||0;
  [0.15,0.20,0.30,0.50,0.75,1.0].forEach(function(tgt){
    if(tgt<=currentMat)return;
    var daysToTgt=Math.round(((tgt-currentMat)*a.pc)/avgPpd);
    var etaDate=new Date();etaDate.setDate(etaDate.getDate()+daysToTgt);
    milestones.push({pct:tgt,days:daysToTgt,label:etaDate.toLocaleString('default',{month:'short'})+' '+etaDate.getDate()});
  });
  return{packsPerDay:avgPpd,dollarsPerDay:avgPpd*(a.packPrice||0),
    daysLeft:daysLeft,milestones:milestones,snapshots:pairs.length,reliable:pairs.length>=2};
}

// WINNER MODEL â€” clusters games by prize structure fingerprint
// Key insight: gap between prize tiers reveals distribution behavior
//   tight gap (Casino Millions: top/top-1 < 1.5x) â†’ uniform distribution
//   wide gap (standard game: top/top-1 > 4x) â†’ top prize concentrated late
function buildWinnerModel(winData,gameData){
  if(!winData||!gameData||!gameData.length)return{valid:false};
  var groups={};
  gameData.forEach(function(g){
    var gn=String(g.gn),recs=winData[gn];
    if(!recs||!recs.length||!g.tot||!g.pk||!g.pr)return;
    var totalPacks=Math.round(g.tot/g.pk);if(totalPacks<=0)return;
    var pz=g.pz?g.pz.slice().sort(function(a,b){return b.a-a.a}):[];if(!pz.length)return;
    var topAmt=pz[0].a;if(topAmt<=1000)return;// skip low-value jackpots â€” different distribution
    var top1Amt=pz.length>1?pz[1].a:0,top2Amt=pz.length>2?pz[2].a:0;
    // Detect BTP threshold
    var btpAmt=0;
    for(var i=pz.length-1;i>=0;i--){if(pz[i].p/totalPacks>=0.3&&pz[i].a>btpAmt)btpAmt=pz[i].a;}
    var jkCount=0;for(var j=0;j<pz.length;j++){if(pz[j].a>btpAmt)jkCount++;}
    // Prize gap ratios â€” THE key signal for distribution behavior
    var jkGapRatio=top1Amt>0?topAmt/top1Amt:99;
    var jk1to2Ratio=top2Amt>0?top1Amt/top2Amt:99;
    var priceTier=g.pr<=5?'low':g.pr<=20?'mid':g.pr<=50?'high':'premium';
    var jkBucket=jkCount<=1?'single':jkCount<=3?'few':jkCount<=8?'multi':'mega';
    // tight=uniform distribution, moderate=mid concentrated, wide=very late concentrated
    var gapBucket=jkGapRatio<1.5?'tight':jkGapRatio<4?'moderate':'wide';
    var key=priceTier+'_'+jkBucket+'_'+gapBucket;
    if(!groups[key])groups[key]={key:key,priceTier:priceTier,jkBucket:jkBucket,gapBucket:gapBucket,
      games:[],positions:[],gapRatios:[],gapCVs:[],jkGapRatios:[],topAmts:[],jkCounts:[],jk1to2Ratios:[]};
    var grp=groups[key];
    grp.games.push(gn);grp.jkGapRatios.push(jkGapRatio);
    grp.topAmts.push(topAmt);grp.jkCounts.push(jkCount);grp.jk1to2Ratios.push(jk1to2Ratio);
    recs.forEach(function(r){
      if(!r.pn||r.pn<=0)return;
      var pos=(r.pn/totalPacks)*100;if(pos<0||pos>110)return;
      grp.positions.push({pos:Math.min(pos,100),pn:r.pn,gn:gn,totalPacks:totalPacks});
    });
    // Compute gaps for this game (normalized as fraction of total packs)
    var sortedPn=recs.map(function(r){return r.pn}).filter(function(p){return p>0}).sort(function(a,b){return a-b});
    if(sortedPn.length>=2){
      for(var gi=0;gi<sortedPn.length-1;gi++){
        grp.gapRatios.push((sortedPn[gi+1]-sortedPn[gi])/totalPacks);
      }
      grp.gapCVs.push({gn:gn,gaps:sortedPn.length-1,firstPn:sortedPn[0],lastPn:sortedPn[sortedPn.length-1],totalPacks:totalPacks});
    }
  });
  Object.keys(groups).forEach(function(key){
    var grp=groups[key];
    if(grp.positions.length<3){grp.valid=false;return;}grp.valid=true;
    var pos=grp.positions.map(function(p){return p.pos;}).sort(function(a,b){return a-b;});
    var n=pos.length;
    grp.deciles=[];
    for(var d=0;d<10;d++){var lo=d*10,hi=(d+1)*10,cnt=pos.filter(function(p){return p>=lo&&p<hi;}).length;
      grp.deciles.push({lo:lo,hi:hi,cnt:cnt,density:n>0?cnt/n:0});}
    grp.p10=pos[Math.floor(n*0.10)]||0;grp.p25=pos[Math.floor(n*0.25)]||0;
    grp.p50=pos[Math.floor(n*0.50)]||0;grp.p75=pos[Math.floor(n*0.75)]||0;grp.p90=pos[Math.floor(n*0.90)]||0;
    grp.mean=pos.reduce(function(s,v){return s+v;},0)/n;
    var maxDensity=Math.max.apply(null,grp.deciles.map(function(d){return d.density;}));
    grp.hotDeciles=grp.deciles.filter(function(d){return d.density>=maxDensity*0.7;});
    // Recommended start: tight=avoid early (uniform but needs volume), wide=later skewed
    grp.recommendedMinPct=grp.gapBucket==='tight'?Math.max(grp.p25,15):
                          grp.gapBucket==='moderate'?Math.max(grp.p10,12):Math.max(grp.p10,8);
    grp.recommendedMaxPct=Math.min(grp.p75,85);
    grp.sampleSize=n;grp.gameCount=grp.games.length;
    // Gap statistics from real winner data
    if(grp.gapRatios.length>=2){
      var gr=grp.gapRatios.slice().sort(function(a,b){return a-b;}),gn2=gr.length;
      grp.gapMean=gr.reduce(function(s,v){return s+v;},0)/gn2;
      var gVar=gr.reduce(function(s,v){return s+Math.pow(v-grp.gapMean,2);},0)/gn2;
      grp.gapStd=Math.sqrt(gVar);grp.gapCV=grp.gapMean>0?grp.gapStd/grp.gapMean:0;
      grp.gapP25=gr[Math.floor(gn2*0.25)];grp.gapP50=gr[Math.floor(gn2*0.50)];
      grp.gapP75=gr[Math.floor(gn2*0.75)];grp.gapP90=gr[Math.floor(gn2*0.90)];
      grp.gapCount=gn2;
    }
  });
  return{valid:true,groups:groups};
}

// PACK GUIDANCE â€” concrete recommendation for a specific game
function getPackGuidance(g,a,model){
  if(!model||!model.valid||!a.pc||a.pc<=0)return{valid:false,reason:'No winner model â€” fetch winners first'};
  var pz=g.pz?g.pz.slice().sort(function(ax,b){return b.a-ax.a;}):[];
  if(!pz.length)return{valid:false,reason:'No prize data'};
  var totalPacks=a.pc,topAmt=pz[0].a,top1Amt=pz.length>1?pz[1].a:0,top2Amt=pz.length>2?pz[2].a:0;
  var jkGapRatio=top1Amt>0?topAmt/top1Amt:99,jk1to2Ratio=top2Amt>0?top1Amt/top2Amt:99;
  var btpAmt=0;
  for(var i=pz.length-1;i>=0;i--){if(pz[i].p/totalPacks>=0.3&&pz[i].a>btpAmt)btpAmt=pz[i].a;}
  var jkCount=0;for(var j=0;j<pz.length;j++){if(pz[j].a>btpAmt)jkCount++;}
  var priceTier=g.pr<=5?'low':g.pr<=20?'mid':g.pr<=50?'high':'premium';
  var jkBucket=jkCount<=1?'single':jkCount<=3?'few':jkCount<=8?'multi':'mega';
  var gapBucket=jkGapRatio<1.5?'tight':jkGapRatio<4?'moderate':'wide';
  var key=priceTier+'_'+jkBucket+'_'+gapBucket;
  var grp=model.groups[key],usedFallback=false,fallbackReason='';
  if(!grp||!grp.valid){
    var f1=Object.keys(model.groups).filter(function(k){return k.indexOf(priceTier+'_'+jkBucket)===0&&model.groups[k].valid;}).sort(function(a2,b){return model.groups[b].sampleSize-model.groups[a2].sampleSize;});
    if(f1.length){grp=model.groups[f1[0]];usedFallback=true;fallbackReason='Gap bucket relaxed';}
  }
  if(!grp||!grp.valid){
    var f2=Object.keys(model.groups).filter(function(k){return k.indexOf(priceTier)===0&&model.groups[k].valid;}).sort(function(a2,b){return model.groups[b].sampleSize-model.groups[a2].sampleSize;});
    if(f2.length){grp=model.groups[f2[0]];usedFallback=true;fallbackReason='Price tier only â€” limited data';}
  }
  if(!grp||!grp.valid)return{valid:false,reason:'No matching cluster â€” need more winner data for this game type'};
  var currentSoldPct=(a.mat||0)*100;
  var minPct=Math.max(currentSoldPct,grp.recommendedMinPct),maxPct=Math.max(grp.recommendedMaxPct,minPct+5);
  if(maxPct>95)maxPct=95;
  var minPackNum=Math.round((minPct/100)*totalPacks),maxPackNum=Math.round((maxPct/100)*totalPacks);
  var lastWinnerPack=0;
  if(S.winData){var wd=S.winData[String(g.gn)];if(wd&&wd.length)lastWinnerPack=Math.max.apply(null,wd.map(function(r){return r.pn||0;}));}
  if(lastWinnerPack>minPackNum)minPackNum=lastWinnerPack+1;
  var remainingJkPrizes=a.jackpotTiers?a.jackpotTiers.reduce(function(s,t){return s+t.rem;},0):0;
  var zones=[];
  if(remainingJkPrizes>0&&a.epr>0){
    var startPack=Math.max(Math.round(a.mat*totalPacks),lastWinnerPack),zoneSize=Math.round((totalPacks-startPack)/Math.max(1,remainingJkPrizes));
    for(var z=0;z<Math.min(remainingJkPrizes,12);z++){
      var zStart=startPack+z*zoneSize,zEnd=zStart+zoneSize-1;
      zones.push({zone:z+1,start:zStart,end:zEnd,mid:Math.round((zStart+zEnd)/2),
        isRecommended:zStart>=minPackNum&&zStart<=maxPackNum});}
  }
  // Gap narrative â€” the core insight
  var gapNarrative='';
  if(gapBucket==='tight'){
    gapNarrative='Flat prize structure: top/top-1 gap only '+jkGapRatio.toFixed(2)+'x ('+fmt(topAmt)+' vs '+fmt(top1Amt)+'). This is the Casino Millions pattern â€” prizes distribute uniformly across the entire print run. No single "jackpot zone." Avoid very early packs; mid-to-late is reliable.';
    if(top2Amt>0)gapNarrative+=' Secondary gap: '+jk1to2Ratio.toFixed(2)+'x ('+fmt(top1Amt)+' vs '+fmt(top2Amt)+').';
  }else if(gapBucket==='moderate'){
    gapNarrative='Moderate prize step: '+jkGapRatio.toFixed(1)+'x gap ('+fmt(topAmt)+' vs '+fmt(top1Amt)+'). Top prize somewhat concentrated in mid-to-late packs per historical data.';
    if(top2Amt>0)gapNarrative+=' Top-1/top-2: '+jk1to2Ratio.toFixed(2)+'x.';
  }else{
    gapNarrative='Wide prize pyramid: '+jkGapRatio.toFixed(0)+'x gap ('+fmt(topAmt)+' vs '+fmt(top1Amt)+'). Top prize is a rare unicorn â€” later packs historically stronger for concentration.';
  }
  var specificAdvice='Ask for pack #'+fN(minPackNum)+' or higher';
  if(maxPackNum<totalPacks*0.95)specificAdvice+=' (sweet spot up to #'+fN(maxPackNum)+')';
  if(lastWinnerPack>0)specificAdvice+='. Last claim: pack #'+fN(lastWinnerPack);
  return{valid:true,clusterKey:grp.key,clusterSize:grp.sampleSize,clusterGames:grp.gameCount,
    priceTier:priceTier,jkBucket:jkBucket,gapBucket:gapBucket,gapRatio:jkGapRatio,jk1to2Ratio:jk1to2Ratio,
    recommendedMinPct:minPct,recommendedMaxPct:maxPct,minPackNum:minPackNum,maxPackNum:maxPackNum,
    gapNarrative:gapNarrative,specificAdvice:specificAdvice,
    zones:zones,remainingJkPrizes:remainingJkPrizes,lastWinnerPack:lastWinnerPack,
    p25:grp.p25,p50:grp.p50,p75:grp.p75,p90:grp.p90,deciles:grp.deciles,
    usedFallback:usedFallback,fallbackReason:fallbackReason};
}

// ============================================================
// END v7.1 NEW FUNCTIONS
// ============================================================


// ============================================================
// v7.2: JACKPOT PACK PREDICTION
// Predicts the exact pack number and prize amount for each
// remaining jackpot, using:
//   - Winner position model cluster (p25/p50/p75/deciles)
//   - Gap ratio (tight=uniform, wide=late-skewed)
//   - Last known winner pack as floor
//   - Current sold position as starting constraint
//   - Prize tier ordering (highest prize => rarest zone)
// ============================================================
function predictJackpotPacks(g,a,model){
  if(!a.pc||a.pc<=0)return{valid:false,reason:'No pack count'};
  var totalPacks=a.pc,soldPacks=Math.round((a.mat||0)*totalPacks),epr=a.epr||0;
  if(!a.jackpotTiers||!a.jackpotTiers.length)return{valid:false,reason:'No jackpot tiers'};
  var minJackpot=Math.max(g.pr*10,500);
  var predTiers=a.jackpotTiers.filter(function(t){return t.a>=minJackpot&&t.rem>0;});
  if(!predTiers.length)return{valid:false,reason:'No remaining jackpot prizes'};
  predTiers.sort(function(x,y){return y.a-x.a});
  if(predTiers.length>3)predTiers=predTiers.slice(0,3);
  var roles=["TOP","TOP-1","TOP-2"];
  // Build shift lookup from jackpotShifts (which has actual density data)
  var shiftMap={};
  if(a.jackpotShifts)a.jackpotShifts.forEach(function(js){shiftMap[js.a]=js;});
  var lastWinnerPack=0;
  if(S.winData){var wd=S.winData[String(g.gn)];if(wd&&wd.length)lastWinnerPack=Math.max.apply(null,wd.map(function(r){return r.pn||0;}));}
  var startPack=Math.max(soldPacks,lastWinnerPack);
  // Winner model lookup â€” same grouping logic as getPackGuidance
  var winGrp=null,winBasis='';
  if(S.winModel&&S.winModel.valid){
    var pz2=g.pz?g.pz.slice().sort(function(ax,b){return b.a-ax.a;}):[];
    var topAmt2=pz2.length?pz2[0].a:0,top1Amt2=pz2.length>1?pz2[1].a:0;
    var btpAmt2=0;for(var bi=pz2.length-1;bi>=0;bi--){if(pz2[bi].p/totalPacks>=0.3&&pz2[bi].a>btpAmt2)btpAmt2=pz2[bi].a;}
    var jkCount2=0;for(var bj=0;bj<pz2.length;bj++){if(pz2[bj].a>btpAmt2)jkCount2++;}
    var jkGapRatio2=top1Amt2>0?topAmt2/top1Amt2:99;
    var pt2=g.pr<=5?'low':g.pr<=20?'mid':g.pr<=50?'high':'premium';
    var jb2=jkCount2<=1?'single':jkCount2<=3?'few':jkCount2<=8?'multi':'mega';
    var gb2=jkGapRatio2<1.5?'tight':jkGapRatio2<4?'moderate':'wide';
    var wkey=pt2+'_'+jb2+'_'+gb2;
    winGrp=S.winModel.groups[wkey];
    if(!winGrp||!winGrp.valid||!winGrp.gapCount){
      var f1=Object.keys(S.winModel.groups).filter(function(k){return k.indexOf(pt2+'_'+jb2)===0&&S.winModel.groups[k].valid&&S.winModel.groups[k].gapCount>0;});
      if(f1.length)winGrp=S.winModel.groups[f1[0]];
    }
    if(winGrp&&winGrp.gapCount>0)winBasis='Empirical gaps ('+winGrp.gapCount+' from '+winGrp.gameCount+' games, CV='+winGrp.gapCV.toFixed(2)+')';
    else winGrp=null;
  }
  // Per-tier analysis
  var predictions=[];
  for(var ti=0;ti<predTiers.length;ti++){
    var t=predTiers[ti],role=roles[ti]||"TOP-"+ti;
    var K=t.rem,N=epr>0?epr:1;
    var pPerPack=N>0?1-Math.exp(logC(N-K,1)-logC(N,1)):0;
    // Hypergeometric: packs needed for 25/50/75% probability
    var p25=N,p50=N,p75=N;
    var step=Math.max(1,Math.floor(N/5000));// skip for large N
    for(var x=step;x<=N;x+=step){
      var pHit=1-Math.exp(logC(N-K,Math.min(x,N))-logC(N,Math.min(x,N)));
      if(pHit>=0.25&&p25===N)p25=x;
      if(pHit>=0.50&&p50===N)p50=x;
      if(pHit>=0.75&&p75===N){p75=x;break;}
    }
    // Get shift from jackpotShifts
    var jsData=shiftMap[t.a];
    var densityShift=jsData?jsData.shift:1;
    var signal=jsData?jsData.signal:(densityShift>=1.3?'STRONG':densityShift>=1.0?'GOOD':densityShift>=0.7?'WEAK':'DEPLETED');
    var claimLag=jsData?jsData.claimLag:0;
    var launchOdds=jsData?jsData.launchOdds:0;
    var currentOdds=jsData?jsData.currentOdds:0;
    var signalClr=signal==='STRONG'||signal==='GOOD'?'var(--grn)':signal==='NEUTRAL'?'var(--dim)':'var(--red)';
    // Expected gap & best pack
    var expectedGap=K>0?Math.round(N/K):N;
    var adjGap=densityShift>0.01?Math.round(expectedGap/densityShift):expectedGap;
    var bestPack=startPack+adjGap;
    var rangeLow=Math.min(startPack+p25,totalPacks),rangeHigh=Math.min(startPack+p75,totalPacks);
    var basis='Hypergeometric + density';
    // Override with empirical gap data if winner model has data (TOP tier only)
    if(winGrp&&role==='TOP'){
      var empGapPacks50=Math.round(winGrp.gapP50*totalPacks);
      var empGapPacks25=Math.round(winGrp.gapP25*totalPacks);
      var empGapPacks75=Math.round(winGrp.gapP75*totalPacks);
      bestPack=startPack+empGapPacks50;
      rangeLow=startPack+empGapPacks25;
      rangeHigh=startPack+empGapPacks75;
      basis=winBasis;
    }
    bestPack=Math.min(bestPack,totalPacks);bestPack=Math.max(bestPack,startPack+1);
    rangeLow=Math.max(rangeLow,startPack+1);rangeLow=Math.min(rangeLow,totalPacks);
    rangeHigh=Math.max(rangeHigh,rangeLow);rangeHigh=Math.min(rangeHigh,totalPacks);
    predictions.push({
      prizeAmt:t.a,role:role,rem:K,printed:t.printed||K,
      bestPack:bestPack,
      rangeLow:rangeLow,
      rangeHigh:rangeHigh,
      p25:p25,p50:p50,p75:p75,
      expectedGap:expectedGap,
      densityShift:densityShift,signal:signal,signalClr:signalClr,
      claimLag:claimLag,launchOdds:launchOdds,currentOdds:currentOdds,
      pPerPack:pPerPack,packsFor50:p50,
      claimDelay:estimateClaimDelay(t.a),
      pctOfRun:totalPacks>0?((bestPack/totalPacks)*100).toFixed(1):'0',
      confidence:winGrp&&role==='TOP'?(winGrp.gapCount>=10?'HIGH':'MEDIUM'):(K>=5?'HIGH':K>=2?'MEDIUM':'LOW'),
      basis:basis
    });
  }
  // Mid-tier density: any prize >=2x ticket but not in predTiers
  var midHits=0,midTotal=0;
  if(a.g.pz)a.g.pz.forEach(function(tr){
    if(tr.a>=g.pr*2&&tr.a<minJackpot){midHits+=tr.p-tr.c;midTotal+=tr.p;}
  });
  var midDensityNow=epr>0?midHits/epr:0;
  var midDensityLaunch=totalPacks>0?midTotal/totalPacks:0;
  var midShift=midDensityLaunch>0?midDensityNow/midDensityLaunch:1;
  // Overall EV per remaining pack (all tiers)
  var totalRemValue=0;
  if(a.g.pz)a.g.pz.forEach(function(tr){totalRemValue+=(tr.p-tr.c)*tr.a;});
  var evPerPack=epr>0?totalRemValue/epr:0;
  return{valid:true,predictions:predictions,lastWinnerPack:lastWinnerPack,
    startPack:startPack,totalPacks:totalPacks,soldPacks:soldPacks,epr:epr,
    evPerPack:evPerPack,midShift:midShift,midHits:midHits,
    prizeClass:a.prizeClass||'unknown',
    jackpotDensityShift:a.jackpotDensityShift||0,
    note:winGrp?winBasis:'Hypergeometric model with density adjustment.',
    winnerModel:!!winGrp,winnerGames:winGrp?winGrp.gameCount:0,winnerGaps:winGrp?winGrp.gapCount:0};
}



function sparkline(data,field,h){
  if(!data||data.length<2)return"";h=h||20;
  var v=data.map(function(d){return d[field]||0}),mn=Math.min.apply(null,v),mx=Math.max.apply(null,v),rng=mx-mn||1;
  var o='<span class="spark">';
  for(var i=0;i<v.length;i++){var bh=Math.max(2,Math.round(((v[i]-mn)/rng)*h));
    o+='<span class="spark-bar" style="height:'+bh+'px;background:'+(i===v.length-1?"var(--grn)":"var(--dim)")+'"></span>';}
  return o+'</span>';
}

// === STATE ===
// ============================================================
// v7.3: CLAIM DELAY + ARCHETYPE + TIMELINE
// ============================================================
function estimateClaimDelay(prizeAmt){
  if(prizeAmt<=599)return{minDays:0,maxDays:1,avgDays:0.3,method:'Retail (instant)',mobileImpact:false};
  if(prizeAmt<=2499)return{minDays:1,maxDays:5,avgDays:2,method:'App/Office',mobileImpact:true,mobileAvg:1.2};
  if(prizeAmt<=9999)return{minDays:2,maxDays:10,avgDays:5,method:'Regional office',mobileImpact:true,mobileAvg:3};
  return{minDays:3,maxDays:21,avgDays:10,method:'Austin HQ',mobileImpact:true,mobileAvg:6};
}
function adjustedClaimLag(rawLag,prizeAmt,burnRate){
  var delay=estimateClaimDelay(prizeAmt);
  if(!delay.mobileImpact||!burnRate||!burnRate.packsPerDay)return rawLag;
  return rawLag*(prizeAmt<=599?1.0:prizeAmt<=2499?0.85:prizeAmt<=9999?0.70:0.55);
}
function computeJackpotTimeline(a,burn){
  if(!a.complete||!a.epr||a.epr<=0)return{valid:false};
  var jkTiers=a.jackpotShifts||[];if(!jkTiers.length)return{valid:false};
  var ppd=burn?burn.packsPerDay:0;var timeline=[];
  jkTiers.forEach(function(jt){
    if(jt.remaining<=0){timeline.push({a:jt.a,role:jt.role,remaining:0,gone:true});return;}
    var N=a.epr,K=jt.remaining;
    var targets=[{pct:0.25,label:'25%'},{pct:0.50,label:'50%'},{pct:0.75,label:'75%'},{pct:0.90,label:'90%'}];
    var packsFor=[];
    targets.forEach(function(tgt){
      var lo2=1,hi2=N,best=N;
      while(lo2<=hi2){var mid3=(lo2+hi2)>>1;var ph=1-Math.exp(logC(N-K,mid3)-logC(N,mid3));if(ph>=tgt.pct){best=mid3;hi2=mid3-1;}else lo2=mid3+1;}
      var dn=ppd>0?Math.round(best/ppd):null,eta=null;
      if(dn!==null){eta=new Date();eta.setDate(eta.getDate()+dn);}
      packsFor.push({conf:tgt.pct,confLabel:tgt.label,packs:best,days:dn,eta:eta?eta.toLocaleString('default',{month:'short'})+' '+eta.getDate():null});
    });
    var cd=estimateClaimDelay(jt.a);
    var pPack=N>0&&K>0?1-Math.exp(logC(N-K,1)-logC(N,1)):0;
    timeline.push({a:jt.a,role:jt.role,remaining:jt.remaining,printed:jt.printed,pPerPack:pPack,packsFor:packsFor,claimDelay:cd,densityShift:jt.shift,signal:jt.signal,gone:false});
  });
  return{valid:true,timeline:timeline,hasBurn:ppd>0,ppd:ppd};
}
function claimVelocity(id,a){
  if(!a.jackpotTiers||!a.jackpotTiers.length)return null;
  var trend=getTrend(id);if(!trend||trend.length<2)return null;
  var pairs=[];
  for(var i=trend.length-1;i>=1;i--){var cur=trend[i],prev=trend[i-1];if(!cur.d||!prev.d||cur.d===prev.d)continue;if(cur.jr===undefined||prev.jr===undefined)continue;var days=Math.max(1,Math.round((new Date(cur.d)-new Date(prev.d))/86400000));var deltaJk=prev.jr-cur.jr;if(deltaJk<0)deltaJk=0;pairs.push({claimsPerDay:deltaJk/days,days:days});if(pairs.length>=5)break;}
  if(!pairs.length)return null;
  var avgCpd=pairs.reduce(function(s,p){return s+p.claimsPerDay;},0)/pairs.length;
  var totalJkRem=a.jackpotTiers.reduce(function(s,t){return s+t.rem;},0);
  return{claimsPerDay:avgCpd,daysToDepletion:avgCpd>0?Math.round(totalJkRem/avgCpd):null,totalRemaining:totalJkRem,snapshots:pairs.length,reliable:pairs.length>=2};
}
function burnRateProjection(id,a){
  var burn=computeBurnRate(id,a);if(!burn||!burn.packsPerDay)return null;
  var cv=claimVelocity(id,a);
  var totalJkRem=a.jackpotTiers?a.jackpotTiers.reduce(function(s,t){return s+t.rem;},0):0;
  var result={packsPerDay:burn.packsPerDay,dollarsPerDay:burn.dollarsPerDay,daysLeft:burn.daysLeft,milestones:burn.milestones,reliable:burn.reliable,snapshots:burn.snapshots};
  if(totalJkRem>0&&a.epr>0){var density=totalJkRem/a.epr;var packsPerJk=density>0?Math.round(1/density):Infinity;var daysPerJk=burn.packsPerDay>0?Math.round(packsPerJk/burn.packsPerDay):null;
    result.jackpotETA={packsPerJackpot:packsPerJk,daysPerJackpot:daysPerJk,density:density,totalRemaining:totalJkRem};
    if(cv&&cv.claimsPerDay>0){result.jackpotETA.fromClaimVelocity={claimsPerDay:cv.claimsPerDay,daysToNext:Math.round(1/cv.claimsPerDay),daysToDepletion:cv.daysToDepletion};}
    result.jackpotETA.tiers=[];
    if(a.jackpotShifts){a.jackpotShifts.forEach(function(j){if(j.remaining<=0)return;var tierDensity=a.epr>0?j.remaining/a.epr:0;var tierPacksPer=tierDensity>0?Math.round(1/tierDensity):Infinity;var tierDaysPer=burn.packsPerDay>0?Math.round(tierPacksPer/burn.packsPerDay):null;var delay=estimateClaimDelay(j.a);var N=a.epr,K=j.remaining;var lo2=1,hi2=N,p50packs=N;while(lo2<=hi2){var mid3=(lo2+hi2)>>1;var ph=1-Math.exp(logC(N-K,mid3)-logC(N,mid3));if(ph>=0.5){p50packs=mid3;hi2=mid3-1;}else lo2=mid3+1;}var lo3=1,hi3=N,p25packs=N;while(lo3<=hi3){var mid4=(lo3+hi3)>>1;var ph2=1-Math.exp(logC(N-K,mid4)-logC(N,mid4));if(ph2>=0.25){p25packs=mid4;hi3=mid4-1;}else lo3=mid4+1;}result.jackpotETA.tiers.push({amount:j.a,role:j.role,remaining:j.remaining,packsPerHit:tierPacksPer,daysPerHit:tierDaysPer,claimDelay:delay,p50packs:p50packs,p25packs:p25packs,p50days:burn.packsPerDay>0?Math.round(p50packs/burn.packsPerDay):null});});}}
  return result;
}

// ============================================================
// v7.5: ELLIOTT WAVE BURN RATE + PROJECTION ENGINE
// ============================================================

// Elliott Wave â€” identifies impulse/corrective waves in burn rate trend
// Uses daily mat% changes to detect 5-wave impulse + 3-wave corrective patterns
function elliottWaveBurnRate(id,a){
  var trend=getTrend(id);
  if(!trend||trend.length<5||!a.pc||a.pc<=0)return{valid:false,reason:'Need 5+ snapshots'};
  // Build daily burn rate series
  var series=[];
  for(var i=1;i<trend.length;i++){
    var cur=trend[i],prev=trend[i-1];
    if(!cur.mat||!prev.mat||!cur.d||!prev.d)continue;
    var days=Math.max(1,Math.round((new Date(cur.d)-new Date(prev.d))/86400000));
    var ppd=Math.round(((cur.mat-prev.mat)*a.pc)/days);
    if(ppd<0)ppd=0;
    series.push({d:cur.d,ppd:ppd,mat:cur.mat,jr:cur.jr!==undefined?cur.jr:null,sc:cur.sc});
  }
  if(series.length<4)return{valid:false,reason:'Insufficient rate data'};
  // Detect waves: rising=impulse, falling=corrective
  var waves=[],dir=0,waveStart=0;
  for(i=1;i<series.length;i++){
    var change=series[i].ppd-series[i-1].ppd;
    var newDir=change>0?1:change<0?-1:dir;
    if(newDir!==dir&&dir!==0){
      waves.push({start:waveStart,end:i-1,dir:dir,
        startPpd:series[waveStart].ppd,endPpd:series[i-1].ppd,
        len:i-1-waveStart,label:dir>0?'IMPULSE':'CORRECTIVE'});
      waveStart=i-1;
    }
    dir=newDir;
  }
  waves.push({start:waveStart,end:series.length-1,dir:dir,
    startPpd:series[waveStart].ppd,endPpd:series[series.length-1].ppd,
    len:series.length-1-waveStart,label:dir>0?'IMPULSE':'CORRECTIVE'});
  // Current phase
  var lastWave=waves[waves.length-1];
  var impulseCount=waves.filter(function(w){return w.dir>0}).length;
  var correctiveCount=waves.filter(function(w){return w.dir<0}).length;
  // EW pattern: classic is 5 impulse, 3 corrective in cycle
  var ewPhase='UNKNOWN',ewProjection=0,ewConf='LOW';
  var currentPpd=series[series.length-1].ppd;
  var avgPpd=Math.round(series.reduce(function(s,v){return s+v.ppd},0)/series.length);
  // Momentum: recent 3 vs older
  var recentAvg=0,olderAvg=0,rc=0,oc=0;
  for(i=Math.max(0,series.length-3);i<series.length;i++){recentAvg+=series[i].ppd;rc++;}
  for(i=0;i<Math.min(3,series.length-3);i++){olderAvg+=series[i].ppd;oc++;}
  recentAvg=rc>0?recentAvg/rc:avgPpd;
  olderAvg=oc>0?olderAvg/oc:avgPpd;
  var momentum=olderAvg>0?(recentAvg-olderAvg)/olderAvg:0;
  if(lastWave.dir>0&&impulseCount>=correctiveCount){
    ewPhase='IMPULSE_UP';// sales accelerating
    ewProjection=Math.round(currentPpd*(1+momentum*0.5));// project momentum continues at half strength
    ewConf=waves.length>=4?'MEDIUM':'LOW';
  }else if(lastWave.dir<0){
    ewPhase='CORRECTIVE_DOWN';// sales decelerating
    ewProjection=Math.round(currentPpd*(1+momentum*0.3));// expect correction to slow
    ewConf=waves.length>=3?'MEDIUM':'LOW';
  }else{
    ewPhase='SIDEWAYS';
    ewProjection=avgPpd;
    ewConf=series.length>=6?'MEDIUM':'LOW';
  }
  if(series.length>=8)ewConf='HIGH';
  ewProjection=Math.max(1,ewProjection);
  // Project future with EW-adjusted rate
  var projectedDaysLeft=a.epr>0?Math.round(a.epr/ewProjection):null;
  return{valid:true,series:series,waves:waves,
    currentPpd:currentPpd,avgPpd:avgPpd,ewProjection:ewProjection,
    momentum:momentum,phase:ewPhase,confidence:ewConf,
    impulseCount:impulseCount,correctiveCount:correctiveCount,
    projectedDaysLeft:projectedDaysLeft,
    recentAvg:Math.round(recentAvg),olderAvg:Math.round(olderAvg)};
}

// Comprehensive projection â€” replaces Monte Carlo with deterministic model
// Combines: hypergeometric odds, burn rate, EW projection, winner gaps, similar games, claim lag
function comprehensiveProjection(sel,burn,ew){
  if(!sel.complete||sel.epr<=0)return{valid:false};
  var g=sel.g,epr=sel.epr,pc=sel.pc;
  var ppd=ew&&ew.valid?ew.ewProjection:burn?burn.packsPerDay:0;
  // Per-tier jackpot analysis
  var tiers=[];
  var jkShifts=sel.jackpotShifts||[];
  for(var i=0;i<jkShifts.length;i++){
    var j=jkShifts[i];if(j.remaining<=0)continue;
    var N=epr,K=j.remaining;
    // Hypergeometric: packs for 25/50/75/90% probability
    var probs=[],targets=[0.25,0.50,0.75,0.90];
    var step=Math.max(1,Math.floor(N/3000));
    var curP=0;
    for(var x=step;x<=N&&curP<targets.length;x+=step){
      var ph=1-Math.exp(logC(N-K,Math.min(x,N))-logC(N,Math.min(x,N)));
      while(curP<targets.length&&ph>=targets[curP]){probs.push({conf:targets[curP],packs:x});curP++;}
    }
    while(probs.length<4)probs.push({conf:targets[probs.length],packs:N});
    var pPerPack=N>0&&K>0?1-Math.exp(logC(N-K,1)-logC(N,1)):0;
    // Winner gap data for this game
    var winGaps=null,avgGapDays=null,lastClaimDate=null;
    var wd=S.winData?S.winData[String(g.gn)]:null;
    if(wd&&wd.length>1){
      var sorted=wd.slice().sort(function(a,b){return new Date(a.date)-new Date(b.date)});
      var gaps=[];
      for(var gi=1;gi<sorted.length;gi++){
        var d1=new Date(sorted[gi-1].date),d2=new Date(sorted[gi].date);
        var dayGap=Math.round((d2-d1)/86400000);
        var packGap=Math.abs((sorted[gi].pn||0)-(sorted[gi-1].pn||0));
        if(dayGap>0)gaps.push({days:dayGap,packs:packGap});
      }
      if(gaps.length){
        avgGapDays=Math.round(gaps.reduce(function(s,g2){return s+g2.days},0)/gaps.length);
        winGaps={gaps:gaps,avgDays:avgGapDays,avgPacks:Math.round(gaps.reduce(function(s,g2){return s+g2.packs},0)/gaps.length),count:gaps.length};
      }
      lastClaimDate=sorted[sorted.length-1].date;
    }
    var daysSinceLast=lastClaimDate?Math.round((new Date()-new Date(lastClaimDate))/86400000):null;
    // Combine: hypergeometric + burn rate + winner gaps
    var p50packs=probs.length>=2?probs[1].packs:N;
    var p50days=ppd>0?Math.round(p50packs/ppd):null;
    // If we have winner gap data, blend with hypergeometric
    var blendedDays=p50days;
    var blendedPacks=p50packs;
    if(winGaps&&avgGapDays&&p50days){
      // Weight: 60% hypergeometric, 40% empirical gap pattern
      blendedDays=Math.round(p50days*0.6+avgGapDays*0.4);
      blendedPacks=ppd>0?blendedDays*ppd:blendedPacks;
    }
    // Similar game distribution factor
    var simFactor=1.0;
    if(S.winModel&&S.winModel.valid){
      var pz2=g.pz?g.pz.slice().sort(function(ax,b){return b.a-ax.a;}):[];
      var topA=pz2.length?pz2[0].a:0,top1A=pz2.length>1?pz2[1].a:0;
      var btpA=0;for(var bi=pz2.length-1;bi>=0;bi--){if(pz2[bi].p/pc>=0.3&&pz2[bi].a>btpA)btpA=pz2[bi].a;}
      var jkC=0;for(var bj=0;bj<pz2.length;bj++){if(pz2[bj].a>btpA)jkC++;}
      var gapR=top1A>0?topA/top1A:99;
      var pt=g.pr<=5?'low':g.pr<=20?'mid':g.pr<=50?'high':'premium';
      var jb=jkC<=1?'single':jkC<=3?'few':jkC<=8?'multi':'mega';
      var gb=gapR<1.5?'tight':gapR<4?'moderate':'wide';
      var wk=pt+'_'+jb+'_'+gb;
      var wg=S.winModel.groups[wk];
      if(wg&&wg.valid&&wg.gapMean>0){
        var empPacks=Math.round(wg.gapP50*pc);
        simFactor=empPacks>0&&p50packs>0?empPacks/p50packs:1.0;
        simFactor=Math.max(0.5,Math.min(2.0,simFactor));// clamp
      }
    }
    var claimDelay=estimateClaimDelay(j.a);
    tiers.push({
      amount:j.a,role:j.role,remaining:K,printed:j.printed||K,
      pPerPack:pPerPack,densityShift:j.shift,signal:j.signal,
      probs:probs,p50packs:p50packs,p50days:p50days,
      blendedDays:blendedDays,blendedPacks:blendedPacks,
      winGaps:winGaps,avgGapDays:avgGapDays,lastClaimDate:lastClaimDate,
      daysSinceLast:daysSinceLast,simFactor:simFactor,
      claimDelay:claimDelay,
      // Overdue signal: if daysSinceLast > avgGapDays, it's "overdue"
      overdue:daysSinceLast!==null&&avgGapDays!==null&&daysSinceLast>avgGapDays
    });
  }
  // Prize distribution by value
  var distByValue=[],distByCount=[],totalRemVal=0,totalRemCount=0;
  for(i=0;i<g.pz.length;i++){
    var p=g.pz[i],rem=p.p-p.c;if(rem<=0)continue;
    var cat=sel.tierCats[p.a]||'FLOOR';
    var val=p.a*rem;totalRemVal+=val;totalRemCount+=rem;
    distByValue.push({a:p.a,rem:rem,value:val,cat:cat});
    distByCount.push({a:p.a,rem:rem,value:val,cat:cat});
  }
  distByValue.sort(function(a,b){return b.value-a.value});
  distByCount.sort(function(a,b){return b.rem-a.rem});
  // Pack outcome distribution (deterministic, not Monte Carlo)
  var floorEV=sel.floorEV||0,packPrice=sel.packPrice;
  var totalJkRem=tiers.reduce(function(s,t){return s+t.remaining},0);
  var jkPct=epr>0?totalJkRem/epr:0;
  var midRem=0;for(i=0;i<g.pz.length;i++){var pr2=g.pz[i],cat2=sel.tierCats[pr2.a]||'?';if(cat2==='MID'){midRem+=pr2.p-pr2.c;}}
  var midPct=epr>0?midRem/epr:0;
  var floorOnlyPct=Math.max(0,1-jkPct-midPct);
  var outcomes=[
    {label:'Floor only ($'+fN(floorEV)+')',pct:floorOnlyPct,color:'#3d4f5f',ev:floorEV},
    {label:'Floor + Mid prizes',pct:midPct,color:'#3498db',ev:floorEV+sel.midRangeEV},
    {label:'Contains Jackpot',pct:jkPct,color:'#d4a017',ev:floorEV+sel.jackpotEVRaw}
  ];
  return{valid:true,tiers:tiers,ppd:ppd,ewPhase:ew&&ew.valid?ew.phase:'UNKNOWN',
    distByValue:distByValue,distByCount:distByCount,
    totalRemVal:totalRemVal,totalRemCount:totalRemCount,
    outcomes:outcomes,floorEV:floorEV,packPrice:packPrice,
    epr:epr,pc:pc,midRem:midRem,jkPct:jkPct,midPct:midPct,floorOnlyPct:floorOnlyPct};
}

// SVG chart helpers â€” lightweight inline charts
function svgPie(data,size){
  size=size||120;var cx=size/2,cy=size/2,r=size/2-4;
  var o='<svg width="'+size+'" height="'+size+'" viewBox="0 0 '+size+' '+size+'">';
  var total=0;for(var i=0;i<data.length;i++)total+=data[i].value;
  if(total<=0)return'';
  var startAngle=-Math.PI/2;
  for(i=0;i<data.length;i++){
    var slice=data[i],pct2=slice.value/total;
    if(pct2<=0)continue;
    var endAngle=startAngle+pct2*2*Math.PI;
    var largeArc=pct2>0.5?1:0;
    if(pct2>=0.999){o+='<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="'+slice.color+'"/>';
    }else{
      var x1=cx+r*Math.cos(startAngle),y1=cy+r*Math.sin(startAngle);
      var x2=cx+r*Math.cos(endAngle),y2=cy+r*Math.sin(endAngle);
      o+='<path d="M'+cx+','+cy+' L'+x1.toFixed(1)+','+y1.toFixed(1)+' A'+r+','+r+' 0 '+largeArc+',1 '+x2.toFixed(1)+','+y2.toFixed(1)+' Z" fill="'+slice.color+'" opacity="0.85"/>';
    }
    startAngle=endAngle;
  }
  o+='</svg>';return o;
}
function svgBar(data,w,h){
  w=w||260;h=h||100;
  var maxVal=0;for(var i=0;i<data.length;i++)if(data[i].value>maxVal)maxVal=data[i].value;
  if(maxVal<=0||!data.length)return'';
  var barW=Math.max(8,Math.floor((w-20)/data.length)-4),pad=2;
  var o='<svg width="'+w+'" height="'+(h+30)+'" viewBox="0 0 '+w+' '+(h+30)+'">';
  for(i=0;i<data.length;i++){
    var d=data[i],bh=Math.max(2,Math.round((d.value/maxVal)*(h-10)));
    var x=10+i*(barW+pad),y=h-bh;
    o+='<rect x="'+x+'" y="'+y+'" width="'+barW+'" height="'+bh+'" rx="2" fill="'+(d.color||'#3498db')+'" opacity="0.85"/>';
    o+='<text x="'+(x+barW/2)+'" y="'+(h+12)+'" text-anchor="middle" fill="#8899aa" font-size="8" font-family="sans-serif">'+esc(d.label)+'</text>';
    o+='<text x="'+(x+barW/2)+'" y="'+(y-3)+'" text-anchor="middle" fill="'+(d.color||'#8899aa')+'" font-size="8" font-weight="700" font-family="sans-serif">'+d.topLabel+'</text>';
  }
  o+='</svg>';return o;
}
function svgSparkArea(data,w,h,color){
  w=w||200;h=h||50;color=color||'#2ecc71';
  if(!data||data.length<2)return'';
  var mn=Infinity,mx=-Infinity;
  for(var i=0;i<data.length;i++){if(data[i]<mn)mn=data[i];if(data[i]>mx)mx=data[i];}
  var rng=mx-mn||1;
  var pts=[];
  for(i=0;i<data.length;i++){
    var x=Math.round((i/(data.length-1))*w);
    var y=Math.round(h-((data[i]-mn)/rng)*(h-6)-3);
    pts.push(x+','+y);
  }
  var o='<svg width="'+w+'" height="'+h+'" viewBox="0 0 '+w+' '+h+'">';
  // Area fill
  o+='<polygon points="0,'+h+' '+pts.join(' ')+' '+w+','+h+'" fill="'+color+'" opacity="0.15"/>';
  // Line
  o+='<polyline points="'+pts.join(' ')+'" fill="none" stroke="'+color+'" stroke-width="1.5" opacity="0.8"/>';
  // Last dot
  var lastPt=pts[pts.length-1].split(',');
  o+='<circle cx="'+lastPt[0]+'" cy="'+lastPt[1]+'" r="3" fill="'+color+'"/>';
  o+='</svg>';return o;
}

// Structural archetype â€” classifies by game DNA, not just price/prize
function classifyArchetype(a){
  if(!a.complete)return{type:'unknown',label:'???',color:'var(--dim)',desc:'Incomplete data.',tip:''};
  var g=a.g,pc=a.pc||1,epr=a.epr||1;
  var jkTotal=a.jackpotTiers?a.jackpotTiers.reduce(function(s,t){return s+t.printed},0):0;
  var topAmt=a.tp?a.tp.a:0,tpCount=a.tp?a.tp.p:0;
  // Structural fingerprints
  var spread=g.pr>0?topAmt/g.pr:0;// dream multiplier
  var floorPct=a.packPrice>0&&g.guar>0?g.guar/a.packPrice:0;// safety net
  var jkDensity=pc>0?jkTotal/pc:0;// jackpots per pack
  var tierCount=g.pz?g.pz.length:0;
  var gapRatio=0;
  if(g.pz&&g.pz.length>=2){var sorted=g.pz.slice().sort(function(x,y){return y.a-x.a});gapRatio=sorted.length>=2&&sorted[1].a>0?sorted[0].a/sorted[1].a:99;}
  var oddsGen=g.odds>0?g.odds:99;// lower = more generous

  // Classification by structural DNA
  if(spread>=10000&&gapRatio>=5&&jkDensity<0.01)
    return{type:'whale',label:'ðŸ‹ Whale',color:'#5b2c6f',desc:'Massive spread ('+fN(Math.round(spread))+'x), wide gap, ultra-rare jackpots.',tip:'Wait for 60%+ sold with density shift >1.2x'};
  if(spread>=1000&&tpCount<=10&&gapRatio>=3)
    return{type:'ghost',label:'ðŸ‘» Ghost',color:'#af7ac5',desc:'â‰¤'+tpCount+' top prizes in entire run. Needle in haystack.',tip:'High sensitivity â€” 1 claim changes everything'};
  if(oddsGen<=3.5&&jkDensity>=0.05&&tierCount>=8)
    return{type:'popcorn',label:'ðŸ¿ Popcorn',color:'#e74c3c',desc:'Odds 1:'+oddsGen.toFixed(1)+', '+tierCount+' tiers, prizes pop often.',tip:'Burns fast â€” check daily, act in 48hrs'};
  if(floorPct>=0.45&&spread<500)
    return{type:'trap',label:'ðŸ§² Trap',color:'#e67e22',desc:'Floor covers '+Math.round(floorPct*100)+'% of cost. Feels safe, ceiling is low.',tip:'Low ceiling. You rarely lose big but never win big.'};
  if(gapRatio<2.5&&tierCount<=6&&spread>=500)
    return{type:'sniper',label:'ðŸŽ¯ Sniper',color:'#27ae60',desc:'Tight gap ('+gapRatio.toFixed(1)+'x), concentrated prizes. Clean shot.',tip:'Best when density shift â‰¥1.3x â€” concentrated upside'};
  if(tierCount>=7&&jkDensity>=0.01&&jkDensity<0.05&&spread>=100)
    return{type:'scaffold',label:'ðŸ—ï¸ Scaffold',color:'#2980b9',desc:tierCount+' tiers, layered prizes. Complex structure.',tip:'Mid-range prizes carry the EV here'};
  if(g.pr>=10&&g.pr<=30&&jkTotal>=4&&jkTotal<=15&&spread>=200)
    return{type:'workhorse',label:'âš™ï¸ Workhorse',color:'#f39c12',desc:'Balanced structure. Steady mid-range flow.',tip:'Best for pack tracking â€” consistent data'};
  return{type:'vanilla',label:'ðŸ“¦ Vanilla',color:'var(--dim)',desc:'Standard structure. Nothing distinctive.',tip:'Only interesting if density shift is high'};
}

var S={tab:"picks",selId:null,sortBy:"score",filterPr:"all",data:[],moreTab:"pack",
  winModel:{valid:false},
  pack:{log:[],won:0,spent:0,af:false,pr:10,pk:50,nm:"",aa:100,ew:13},
  sessions:JSON.parse(localStorage.getItem("txs7")||"[]"),
  _promptPreview:null,_allPromptPreview:null,_promptMsg:null,
  bankroll:Number(localStorage.getItem("txb7")||"1000"),
  detailSearch:"",insightFilter:null,winSearch:"",winSort:"date",winSortDir:-1,winGame:""};

// === STAT SCORING ===
function applyStatScoring(data){
  if(!data||data.length===0)return;
  var scorable=data.filter(function(a){return a.btpInfo.hasJackpot&&a.complete});
  if(scorable.length<2){data.forEach(function(a){a.rank=1;a.rankOf=data.length;a.confidence=50;a.confLabel="AVERAGE";a.sc=a.rawSc;});return;}
  var sum=0;for(var i=0;i<scorable.length;i++)sum+=scorable[i].rawSc;
  var mean=sum/scorable.length,variance=0;
  for(i=0;i<scorable.length;i++)variance+=Math.pow(scorable[i].rawSc-mean,2);
  var stddev=Math.sqrt(variance/scorable.length)||1;
  scorable.sort(function(a,b){return b.rawSc-a.rawSc});
  scorable.forEach(function(a,idx){
    a.rank=idx+1;a.rankOf=scorable.length;a.sc=a.rawSc;var z=(a.rawSc-mean)/stddev;
    a.zScore=z;a.confidence=Math.round(Math.max(0,Math.min(100,z*25+50)));
    a.confLabel=a.confidence>=85?"STANDOUT":a.confidence>=70?"ABOVE FIELD":a.confidence>=50?"AVERAGE":a.confidence>=30?"BELOW FIELD":"WEAK";
  });
  var maxRank=scorable.length;
  data.forEach(function(a){if(a.btpInfo.hasJackpot&&a.complete)return;
    a.sc=a.rawSc;a.rank=maxRank+1;a.rankOf=data.length;a.zScore=0;a.confidence=0;
    a.confLabel=a.btpInfo.hasJackpot?"INCOMPLETE":"NO TOP TIERS";});
}

// === SESSION FEEDBACK LOOP ===
// Analyzes pack tracker history to learn which signals actually predict returns
function getSessionLearnings(){
  var sess=S.sessions;if(!sess||sess.length<3)return{valid:false,reason:'Need 3+ tracked packs'};
  var byScore={hi:[],mid:[],lo:[]},byArch={},total={s:0,w:0,n:0};
  for(var i=0;i<sess.length;i++){
    var s=sess[i];if(!s.s||s.s<=0)continue;
    var ret=s.w/s.s;total.s+=s.s;total.w+=s.w;total.n++;
    var sc=s.sc||50;
    if(sc>=65)byScore.hi.push(ret);else if(sc>=45)byScore.mid.push(ret);else byScore.lo.push(ret);
    if(s.arch){if(!byArch[s.arch])byArch[s.arch]={rets:[],s:0,w:0,n:0};byArch[s.arch].rets.push(ret);byArch[s.arch].s+=s.s;byArch[s.arch].w+=s.w;byArch[s.arch].n++;}
  }
  var avg=function(arr){return arr.length?arr.reduce(function(a,b){return a+b},0)/arr.length:null;};
  var hiAvg=avg(byScore.hi),midAvg=avg(byScore.mid),loAvg=avg(byScore.lo);
  // Does score predict returns?
  var scoreWorks=null,scoreDelta=0;
  if(byScore.hi.length>=2&&byScore.lo.length>=2){
    scoreDelta=hiAvg-loAvg;
    scoreWorks=scoreDelta>0.03;// hi-score games returned 3%+ better
  }else if(byScore.hi.length>=2&&byScore.mid.length>=2){
    scoreDelta=hiAvg-midAvg;
    scoreWorks=scoreDelta>0.02;
  }
  // Per-archetype performance
  var archInsights=[];
  Object.keys(byArch).forEach(function(arch){
    var d=byArch[arch];if(d.n<2)return;
    archInsights.push({arch:arch,avgRet:avg(d.rets),count:d.n,totalSpent:d.s,totalWon:d.w,pl:d.w-d.s});
  });
  archInsights.sort(function(a,b){return b.avgRet-a.avgRet;});
  return{valid:true,total:{spent:total.s,won:total.w,ret:total.s>0?total.w/total.s:0,n:total.n,pl:total.w-total.s},
    byScore:{hi:{avg:hiAvg,n:byScore.hi.length},mid:{avg:midAvg,n:byScore.mid.length},lo:{avg:loAvg,n:byScore.lo.length}},
    scoreWorks:scoreWorks,scoreDelta:scoreDelta,
    archInsights:archInsights,
    bestArch:archInsights.length?archInsights[0]:null,
    worstArch:archInsights.length>1?archInsights[archInsights.length-1]:null};
}

// Apply session feedback as scoring adjustment (post applyStatScoring)
function applySessionFeedback(data){
  var learn=getSessionLearnings();if(!learn||!learn.valid)return;
  S._learnings=learn;// cache for display
  // If we have enough data and score DOES predict returns, boost confidence in scoring
  // If score does NOT predict returns, dampen extreme scores toward center
  if(learn.scoreWorks===true&&learn.total.n>=5){
    // Score is validated â€” no change needed, model works
  }else if(learn.scoreWorks===false&&learn.total.n>=5){
    // Score NOT predicting â€” dampen extremes
    data.forEach(function(a){if(!a.complete)return;
      a.sc=Math.round(50+(a.sc-50)*0.8);// pull toward center
      if(!a._fbNote)a._fbNote=[];
      a._fbNote.push('Score dampened: your tracked packs show high-score games didn\'t outperform');
    });
  }
  // Archetype penalty/bonus â€” if an archetype consistently underperforms, flag it
  if(learn.archInsights.length>=2){
    var archMap={};learn.archInsights.forEach(function(ai){archMap[ai.arch]=ai;});
    data.forEach(function(a){if(!a.complete)return;
      var arch=classifyArchetype(a);
      var perf=archMap[arch.type];
      if(!perf||perf.n<3)return;
      if(perf.avgRet<0.3){// archetype returning <30% on average
        if(!a._fbNote)a._fbNote=[];
        a._fbNote.push(arch.label+' games avg '+Math.round(perf.avgRet*100)+'% return in your history');
      }
    });
  }
}

// === INIT ===
function init(){
  try{
    var c=localStorage.getItem("txr_gd7");
    if(c){GD=JSON.parse(c);GD.forEach(function(g){if(!g.id)g.id=String(g.gn);});if(GD.length){S.data=GD.map(function(g){return analyze(g)});applyStatScoring(S.data);applySessionFeedback(S.data);}}
    var wd=localStorage.getItem("txwd7");
    if(wd){S.winData=JSON.parse(wd);S.winModel=buildWinnerModel(S.winData,GD);}
  }catch(e){}
  DD=localStorage.getItem("txr_date7")||"";
  render();refreshAllData();
}
function setTab(t){S.tab=t;S.insightFilter=null;render()}
function setMore(t){S.moreTab=t;render()}
function setFilter(p){S.filterPr=p;render()}
function setSort(s){S.sortBy=s;render()}
function openDetail(id){S.selId=id;S.tab="detail";render()}
function setSel(id){S.selId=id;render()}
function setInsightFilter(f){S.insightFilter=S.insightFilter===f?null:f;S.tab="picks";render()}
function detailSearchInput(v){S.detailSearch=v;render()}
function winSearchInput(v){S.winSearch=v;render()}
function winSortBy(col){if(S.winSort===col)S.winSortDir*=-1;else{S.winSort=col;S.winSortDir=-1;}render()}
function winGameFilter(gn){S.winGame=gn;render()}

var DATA_URL="data/feed.json";var WINNER_URL="data/wdata.json";

async function refreshAllData(){
  if(S._refreshing)return;S._refreshing=true;S._refreshMsg="Fetching...";render();
  try{
    var resp=await fetch(DATA_URL);if(!resp.ok)throw new Error("HTTP "+resp.status);
    var json=await resp.json();
    if(json&&json.games&&json.games.length>0){
      GD=[];
      json.games.forEach(function(ng){if(!ng.pz||!ng.pz.length||!ng.pr||ng.pr<=0)return;ng.id=String(ng.gn);ng.pz.sort(function(a,b){return b.a-a.a});GD.push(ng);});
      S.data=GD.map(function(g){return analyze(g)});applyStatScoring(S.data);applySessionFeedback(S.data);
      if(S.winData)S.winModel=buildWinnerModel(S.winData,GD);
      DD=json.updated||"";localStorage.setItem("txr_date7",DD);localStorage.setItem("txr_gd7",JSON.stringify(GD));
      saveTrend();
      S._refreshMsg="Loaded "+GD.length+" games. Data: "+DD;
    }else{S._refreshMsg="No data. Run scraper.";}
  }catch(e){S._refreshMsg="Failed: "+e.message;}
  S._refreshing=false;render();
}

async function fetchWinners(){
  if(S._fetching)return;S._fetching=true;render();
  try{
    var r=await fetch(WINNER_URL);
    if(r.ok){var j=await r.json();if(j&&j.winners){S.winData=j.winners;S.winModel=buildWinnerModel(S.winData,GD);localStorage.setItem("txwd7",JSON.stringify(S.winData));}}
  }catch(e){}
  S._fetching=false;render();
}

// === PACK TRACKER ===
function scratch(amt){var pk=S.pack;pk.log.push({amt:amt,w:amt>0});pk.won+=amt;pk.spent+=pk.pr;pk.af=pk.af||amt>=pk.aa;render()}
function resetPack(){S.pack.log=[];S.pack.won=0;S.pack.spent=0;S.pack.af=false;render()}
function saveSession(){if(!S.pack.log.length)return;
  var sess={g:S.pack.nm,s:S.pack.spent,w:S.pack.won,t:S.pack.log.length,d:new Date().toLocaleDateString(),af:S.pack.af};
  // v7.5: Capture game ID, score, archetype for feedback loop
  if(S.pack._gn)sess.gn=S.pack._gn;
  if(S.pack._sc)sess.sc=S.pack._sc;
  if(S.pack._arch)sess.arch=S.pack._arch;
  if(S.pack._conf)sess.conf=S.pack._conf;
  S.sessions.push(sess);localStorage.setItem("txs7",JSON.stringify(S.sessions));resetPack()}
function clearSess(){S.sessions=[];localStorage.setItem("txs7","[]");render()}
function setBR(v){S.bankroll=v;localStorage.setItem("txb7",String(v));render()}
function startPack(id){var a;for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===id||String(S.data[i].g.gn)===String(id)){a=S.data[i];break}if(!a)return;var _arch=classifyArchetype(a);S.pack={log:[],won:0,spent:0,af:false,pr:a.g.pr,pk:a.g.pk,nm:a.g.nm+' #'+a.g.gn,aa:a.aa,ew:Math.round(a.g.pk/a.g.odds),_gn:a.g.gn,_sc:a.sc,_arch:_arch.type,_conf:a.confidence};S.tab="more";S.moreTab="pack";render()}
function mkv(){var pk=S.pack,rem=pk.pk-pk.log.length;if(rem<=0)return null;var wf=0;for(var i=0;i<pk.log.length;i++)if(pk.log[i].w)wf++;var wl=Math.max(0,pk.ew-wf),pA=pk.af?0:1/rem;var dec="EARLY",rsn="Pack early.";if(pk.af){dec="STOP";rsn="Anchor found.";}else if(pA>=0.15){dec="BUY";rsn=(pA*100).toFixed(1)+"% anchor chance.";}else if(pA>=0.05){dec="CONSIDER";}return{rem:rem,wl:wl,pW:wl/rem,pA:pA,dec:dec,rsn:rsn}}

// === AI PROMPTS ===
function buildGamePrompt(a){
  var g=a.g,L=[];
  L.push("=== TEXAS SCRATCH-OFF DEEP ANALYSIS v7.4 ===");
  L.push("Game: #"+g.gn+" "+g.nm+" ($"+g.pr+" ticket) | Prize Class: "+(a.prizeClass||'unknown').toUpperCase());
  L.push("Packs: "+fN(a.pc)+" printed / "+fN(a.eps)+" sold / "+fN(a.epr)+" remaining | Tickets: "+fN(a.totalTickets)+" total / "+fN(a.ets)+" sold / "+fN(a.etr)+" outstanding");
  L.push("Goal: Determine if the TOP PRIZE and TOP-1 prize tiers are statistically concentrated in the remaining unsold packs, making this game a better-than-launch buy.\n");

  L.push("--- METRIC DEFINITIONS ---");
  L.push("â€¢ Score: Raw points (base 50). Each factor adds/subtracts based on real data. Higher = better.");
  L.push("â€¢ Rank: Position among all games sorted by score. #1 = best.");
  L.push("â€¢ Confidence %: Z-score â€” how many standard deviations this game is above/below the field mean. 85%+=STANDOUT, 70%+=ABOVE FIELD, 50%=AVERAGE.");
  L.push("â€¢ Jackpot Density Shift (jkD): (top_prizes_remaining / packs_remaining) Ã· (top_prizes_printed / total_packs). >1.0 means top prizes are MORE concentrated now. 1.5x+ is very strong.");
  L.push("â€¢ Claim Lag: How far a prize tier's claim rate lags behind BTP (ticket sales rate). Positive = underclaimed. NOTE: prizes >$599 must be claimed at lottery office, creating minor travel delay. Scoring dampens this by 15%.");
  L.push("â€¢ Hypergeometric P(pack): Exact probability of getting â‰¥1 top-tier prize in one pack vs launch odds.");
  L.push("â€¢ Top-tier EV: Expected dollar value from TOP + TOP-1 tiers per pack. NOT total EV â€” just the rare upside.");
  L.push("â€¢ Floor: GUARANTEED minimum return per pack (from TX Lottery website). FACT, not estimate.");
  L.push("â€¢ BTP (Base Ticket Prize): Highest prize tier appearing ~1x per pack (always â‰¤$599). Its claim rate = clock for packs sold.");
  L.push("â€¢ Markov Signal: Compares each tier's claim rate to BTP rate. BUY=underclaimed. AVOID=overclaimed.");
  L.push("â€¢ Data Confidence: HIGH/MEDIUM/LOW based on agreement between 3 packs-sold estimation methods.");
  L.push("â€¢ IMPORTANT: Density calculations assume uniform distribution across remaining packs. In reality, TX Lottery uses algorithms to separate top prizes geographically. Our density is a CEILING (best case) of the actual concentration.\n");

  L.push("--- GAME FACTS (from TX Lottery website) ---");
  L.push("Ticket price: $"+g.pr);
  L.push("Pack: "+g.pk+" tickets Ã— $"+g.pr+" = $"+fN(a.packPrice)+" per pack");
  L.push("Total tickets printed: "+fN(a.totalTickets)+(a.totEstimated?" (estimated)":""));
  L.push("Total packs: "+fN(a.pc));
  L.push("Guaranteed floor return: $"+fN(g.guar)+" per pack ("+pct(g.guar/a.packPrice)+" of cost)");
  L.push("Overall win odds: 1 in "+g.odds+" (â‰ˆ"+(g.pk/g.odds).toFixed(1)+" winning tickets per pack)");
  L.push("BTP (anchor prize): $"+fN(a.aa)+(a.btpValid?" (validated against floor)":""));
  if(g.cs)L.push("âš  GAME IS CLOSING â€” limited packs remaining at retailers");
  L.push("");

  L.push("--- CURRENT STATUS ---");
  L.push("Score: "+a.sc+"/100");
  L.push("Tickets sold: "+pct(a.mat)+" ("+fN(a.ets)+" of "+fN(a.totalTickets)+")");
  L.push("Packs remaining: "+fN(a.epr)+" of "+fN(a.pc));
  L.push("Markov signal: "+a.gm.sig.replace(/_/g," ")+" â€” "+a.gm.rsn);
  L.push("Statistical confidence: "+a.confidence+"% ("+a.confLabel+") â€” rank #"+a.rank+" of "+a.rankOf);
  L.push("Data quality: "+a.dataConfidence);
  L.push("");

  L.push("--- TOP PRIZE TIER ANALYSIS (this is what matters) ---");
  if(a.jackpotShifts.length===0){L.push("NO RARE TIERS â€” all above-floor prizes are too common to track.");}
  else{
    a.jackpotShifts.forEach(function(j){
      L.push("$"+fN(j.a)+" ["+j.role+"] (score weight: "+Math.round(j.weight*100)+"%):");
      L.push("  Remaining: "+j.remaining+" of "+j.printed+" originally printed"+(j.remaining<=0?" â†’ ALL CLAIMED":""));
      L.push("  Density shift: "+j.shift.toFixed(2)+"x ("+j.signal+")");
      L.push("  Claim lag vs BTP: "+(j.claimLag>0?"+":"")+pct(j.claimLag)+(j.claimDelayTier?" [>$599: includes lottery office claim delay]":"")+(j.claimLag>0.1?" â€” LAGGING BEHIND sales":j.claimLag<-0.1?" â€” AHEAD of sales":""));
      L.push("  Pack odds: 1 in "+fN(j.currentOdds)+" packs (was 1 in "+fN(j.launchOdds)+" at launch)");
      if(j.printed<=10)L.push("  âš¡ HIGH SENSITIVITY: only "+j.printed+" printed â€” each claim changes odds by "+(100/j.printed).toFixed(0)+"%+");
    });
    L.push("\nWeighted metrics (TOP=100%, TOP-1=50%, TOP-2=display only):");
    L.push("  Weighted density shift: "+a.jackpotDensityShift.toFixed(2)+"x"+(a.jackpotDensityShift>=1.5?" (STRONG)":a.jackpotDensityShift>=1.2?" (GOOD)":a.jackpotDensityShift>=0.9?" (NEUTRAL)":a.jackpotDensityShift>=0.7?" (WEAK)":" (DEPLETED)"));
    L.push("  Top prize density (pure): "+a.topDensityShift.toFixed(2)+"x");
    L.push("  Top prize claim lag: "+(a.topClaimLag>0?"+":"")+pct(a.topClaimLag));
    L.push("  P(â‰¥1 top tier in pack): "+(a.hyperNow>=0.01?pct(a.hyperNow):"1 in "+fN(Math.round(1/a.hyperNow))));
    L.push("  P(TOP prize in pack): "+(a.hyperTopNow>=0.01?pct(a.hyperTopNow):a.hyperTopNow>0?"1 in "+fN(Math.round(1/a.hyperTopNow)):"N/A")+" ("+a.hyperTopRatio.toFixed(2)+"x vs launch)");
    L.push("  Raw top-tier EV: $"+a.jackpotEVRaw.toFixed(2)+" (was $"+a.jackpotEVLaunchRaw.toFixed(2)+")");
  }
  L.push("");

  L.push("--- EV MODEL (floor-based, no assumptions) ---");
  L.push("Floor (GUARANTEED):  $"+fN(a.floorEV));
  L.push("Mid-range upside:    $"+a.midRangeEV.toFixed(2)+" (non-top-tier prizes above floor)");
  L.push("Top-tier EV:         $"+a.jackpotEVRaw.toFixed(2)+" (TOP + TOP-1 + TOP-2 combined)");
  L.push("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
  L.push("Total EV per pack:   $"+Math.round(a.totalEV));
  L.push("Pack cost:           $"+fN(a.packPrice));
  L.push("Edge:                "+(a.edge>0?"+":"")+pct(a.edge)+(a.edge>0?" (positive edge â€” unusual)":a.edge>-0.1?" (near break-even)":" (house edge)"));
  L.push("At launch EV was:    $"+Math.round(a.totalEVLaunch)+" (edge: "+(a.edgeLaunch>0?"+":"")+pct(a.edgeLaunch)+")");
  L.push("");

  L.push("--- VALIDATION ---");
  L.push("Packs sold estimates: Method A (BTP clock)="+fN(a.methodA)+" | Method B (prize count)="+fN(a.methodB)+" | Method C ($yield)="+fN(a.methodC));
  L.push("Agreement: "+a.dataConfidence+(a.dataConfidence==="HIGH"?" (best pair within 5%)":a.dataConfidence==="MEDIUM"?" (best pair within 10%)":" (all pairs >10% â€” treat with caution)"));
  L.push("Implied yield: "+pct(a.impliedYield)+(a.yieldValid?" (reasonable)":"  âš  outside expected range"));
  L.push("");

  L.push("--- SCORE BREAKDOWN (base 50, adjusted) ---");
  a.scoreBreakdown.forEach(function(s){L.push("  "+(s.p>=0?"+":"")+s.p+" â†’ "+s.f);});
  L.push("  â•â•â• FINAL: "+a.sc+"/100");
  if(a.whyScore.length>0){L.push("\nKey drivers: "+a.whyScore.map(function(w){return(w.p>0?"â–²":"â–¼")+" "+w.f+" ("+(w.p>0?"+":"")+w.p+"pts)"}).join(", "));}
  L.push("");

  L.push("--- FULL PRIZE TABLE ---");
  L.push("Prize      | Category | Printed    | Claimed   | Left      | %Left  | Launch Odds | Current Odds | Shift");
  L.push("â”€".repeat(110));
  a.prizes.forEach(function(p){
    var pL=(100-p.pctC).toFixed(0);
    var shift=p.rem>0&&p.currO<p.origO?"BETTER":p.rem>0?"WORSE":"GONE";
    L.push(("$"+fN(p.a)).padEnd(11)+"| "+p.cat.padEnd(9)+"| "+(fN(p.p)).padEnd(11)+"| "+(fN(p.c)).padEnd(10)+"| "+(fN(p.rem)).padEnd(10)+"| "+(pL+"%").padEnd(7)+"| "+fmtO(p.origO).padEnd(12)+"| "+(p.rem>0?fmtO(p.currO):"â€”").padEnd(13)+"| "+shift);
  });
  if(a.flags.length>0){L.push("\n--- ACTIVE FLAGS ---");a.flags.forEach(function(f){L.push("["+f.t+"] "+f.m);});}
  // v7.4: Similarity model info
  var jpp=predictJackpotPacks(g,a,null);
  if(jpp.valid){L.push("\n--- PREDICTION ---");L.push("Prize class: "+jpp.prizeClass);L.push(jpp.note);
    jpp.predictions.forEach(function(p){
      L.push("$"+fN(p.prizeAmt)+" ("+p.role+"): Target pack #"+fN(p.rangeLow)+" â†’ #"+fN(p.rangeHigh)+" (best: #"+fN(p.bestPack)+") | "+p.basis+" | Conf: "+p.confidence);
    });
  }
  L.push("\n--- QUESTIONS ---");
  L.push("1. Should I buy a pack of this game? Give a clear YES/NO/MAYBE with confidence level and reasoning.");
  L.push("2. Is the TOP prize genuinely more concentrated in remaining packs? Is the claim lag real or noise?");
  L.push("3. Break down what happens when I spend $"+fN(a.packPrice)+" on one pack: guaranteed floor + realistic mid upside + top prize lottery.");
  L.push("4. Any red flags, data contradictions, or fragility risks (e.g., next claim kills the signal)?");
  L.push("5. Compare this game's top-tier EV ($"+a.jackpotEVRaw.toFixed(2)+"/pack) to its cost ($"+fN(a.packPrice)+"). Is the upside meaningful?");
  return L.join("\n");
}
function buildAllPrompt(){
  var tr=[];S.data.forEach(function(a){if(!a.complete||!a.btpInfo.hasJackpot)return;
    if(a.jackpotDensityShift>1.1||a.hyperRatio>1.1||a.returnGap>0.03||(a.g.cs&&a.tpr>0)||a.gm.sig==="BUY"||a.gm.sig==="STRONG_BUY"||a.gm.sig==="AVOID"||a.gm.sig==="DEAD"||a.returnGap<-0.03)tr.push(a);});
  if(!tr.length)return"No significant signals.";

  var L=[];
  L.push("=== TEXAS SCRATCH-OFF PORTFOLIO ANALYSIS ===");
  L.push("Focus: Games where TOP PRIZE and TOP-1 tiers are statistically concentrated in remaining unsold packs.");
  L.push("Data date: "+(DD||"unknown")+"\n");

  L.push("--- METRIC DEFINITIONS ---");
  L.push("â€¢ Score (0-100): Composite. 50=neutral. >65=buy. <35=avoid. Jackpot density is the PRIMARY driver (Â±20 pts).");
  L.push("â€¢ jkD (Jackpot Density Shift): (jackpot_remaining/packs_remaining) Ã· (jackpot_printed/total_packs). >1.0=jackpots MORE concentrated than launch. 1.5x+=strong signal.");
  L.push("â€¢ hyp (Hypergeometric): Exact P(â‰¥1 jackpot in 1 pack) now vs launch. Uses combinatorial math.");
  L.push("â€¢ jkEV (Top-tier EV/pack): $ value from TOP + TOP-1 tiers per pack. NOT total EV â€” just the rare upside.");
  L.push("â€¢ Floor: GUARANTEED minimum pack return (TX Lottery fact). Total EV = Floor + Mid upside + Jackpot EV.");
  L.push("â€¢ Markov: BUY=jackpots underclaimed vs sales rate. AVOID=overclaimed. STRONG_BUY=jackpot+mid both underclaimed.");
  L.push("â€¢ CLOSING: Game being removed from retail. Remaining packs = last chance. If jackpots left â†’ time-sensitive opportunity.\n");

  L.push("--- "+tr.length+" GAMES WITH SIGNALS (sorted by score) ---\n");

  // Group by signal type for easier reading
  var buys=tr.filter(function(a){return a.confidence>=70});
  var watches=tr.filter(function(a){return a.confidence>=40&&a.confidence<70});
  var avoids=tr.filter(function(a){return a.confidence<40});

  if(buys.length){
    L.push("ðŸŸ¢ BUY CANDIDATES (confidence â‰¥70%):");
    buys.sort(function(a,b){return b.sc-a.sc}).forEach(function(a){
      L.push("  #"+a.g.gn+" "+a.g.nm+" ($"+a.g.pr+") â€” "+a.sc+" pts | #"+a.rank+" of "+a.rankOf+" | "+a.confidence+"% "+a.confLabel);
      L.push("    jkD:"+a.jackpotDensityShift.toFixed(2)+"x | topLag:"+(a.topClaimLag>0?"+":"")+pct(a.topClaimLag)+" | jkEV:$"+a.jackpotEVRaw.toFixed(2)+"/pack | Top:"+a.tpr+"/"+a.tp.p+" $"+fN(a.tp.a)+" left");
      L.push("    "+pct(a.mat)+" sold | "+fN(a.epr)+" packs left | Markov:"+a.gm.sig+" | Floor:$"+fN(a.floorEV)+" | Pack:$"+fN(a.packPrice)+(a.g.cs?" | âš  CLOSING":""));
      // Key driver
      if(a.whyScore.length>0)L.push("    Key: "+a.whyScore.map(function(w){return(w.p>0?"â–²":"â–¼")+" "+w.f}).join(", "));
      L.push("");
    });
  }
  if(watches.length){
    L.push("ðŸŸ¡ WATCH LIST (confidence 40-69%):");
    watches.sort(function(a,b){return b.sc-a.sc}).forEach(function(a){
      L.push("  #"+a.g.gn+" "+a.g.nm+" ($"+a.g.pr+") sc:"+a.sc+" | jkD:"+a.jackpotDensityShift.toFixed(2)+"x | jkEV:$"+a.jackpotEV.toFixed(2)+" | top:"+a.tpr+"/"+a.tp.p+" | "+pct(a.mat)+" sold | "+a.gm.sig+(a.g.cs?" CLOSING":""));
    });
    L.push("");
  }
  if(avoids.length){
    L.push("ðŸ”´ AVOID (confidence <40%):");
    avoids.sort(function(a,b){return a.sc-b.sc}).forEach(function(a){
      L.push("  #"+a.g.gn+" "+a.g.nm+" ($"+a.g.pr+") sc:"+a.sc+" | jkD:"+a.jackpotDensityShift.toFixed(2)+"x | top:"+a.tpr+"/"+a.tp.p+" | "+a.gm.sig+(a.g.cs?" CLOSING":""));
    });
    L.push("");
  }

  // Best per price
  L.push("--- BEST PER PRICE POINT ---");
  var byP={};tr.forEach(function(a){if(!byP[a.g.pr]||a.sc>byP[a.g.pr].sc)byP[a.g.pr]=a});
  Object.keys(byP).sort(function(a,b){return Number(a)-Number(b)}).forEach(function(p){
    var a=byP[p];L.push("  $"+p+" â†’ #"+a.g.gn+" "+a.g.nm+" (sc:"+a.sc+", jkD:"+a.jackpotDensityShift.toFixed(2)+"x, jkEV:$"+a.jackpotEV.toFixed(2)+")");});

  L.push("\n--- QUESTIONS ---");
  L.push("1. Which 2-3 games should I buy TODAY? Consider score, jackpot density, closing status, and my budget.");
  L.push("2. Which games should I absolutely avoid and why?");
  L.push("3. For my top pick, break down: what do I spend, what's guaranteed, what's the realistic jackpot chance?");
  L.push("4. Any games where the data contradicts the score? (e.g., high score but top prizes almost gone)");
  L.push("5. For each price point ($2/$3/$5/$10/$20/$30/$50/$100), which single game is the best buy?");
  return L.join("\n");
}
function copyAIPrompt(id){var a=null;for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===id||String(S.data[i].g.gn)===String(id)){a=S.data[i];break}if(!a)return;navigator.clipboard.writeText(buildGamePrompt(a)).then(function(){S._promptMsg="âœ“ Copied!";render();setTimeout(function(){S._promptMsg=null;render()},2500)})}
function showAIPrompt(id){var a=null;for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===id||String(S.data[i].g.gn)===String(id)){a=S.data[i];break}if(!a)return;S._promptPreview=buildGamePrompt(a);render()}
function copyAllPrompt(){navigator.clipboard.writeText(buildAllPrompt()).then(function(){S._promptMsg="âœ“ Copied!";render();setTimeout(function(){S._promptMsg=null;render()},2500)})}
function showAllPrompt(){S._allPromptPreview=buildAllPrompt();render()}

// === RENDER ===
function render(){try{
  var pr={};GD.forEach(function(g){pr[g.pr]=1});var pArr=Object.keys(pr).map(Number).sort(function(a,b){return a-b});
  var f=S.data.slice();
  if(S.filterPr!=="all")f=f.filter(function(a){return a.g.pr===Number(S.filterPr)});
  if(S.insightFilter){var iF=S.insightFilter;
    if(iF==="top")f=f.filter(function(a){return a.btpInfo.hasJackpot});
    else if(iF==="buy")f=f.filter(function(a){return a.confidence>=70&&a.btpInfo.hasJackpot});
    else if(iF==="avoid")f=f.filter(function(a){return a.confidence<30&&a.btpInfo.hasJackpot});
    else if(iF==="closing")f=f.filter(function(a){return a.g.cs&&a.tpr>0&&a.btpInfo.hasJackpot});
    else if(iF==="new")f=f.filter(function(a){return a.mat<0.15&&a.complete&&a.btpInfo.hasJackpot});
    else if(iF==="concentrated")f=f.filter(function(a){return a.jackpotDensityShift>=1.3});
    else if(iF==="depleted")f=f.filter(function(a){return a.tpr===0&&a.btpInfo.hasJackpot});}
  var sorts={score:function(a,b){return b.sc-a.sc},density:function(a,b){return b.jackpotDensityShift-a.jackpotDensityShift},gap:function(a,b){return b.returnGap-a.returnGap},topOdds:function(a,b){return a.tpo-b.tpo},tickets:function(a,b){return a.mat-b.mat},hyper:function(a,b){return b.hyperRatio-a.hyperRatio},jackpotEV:function(a,b){return b.jackpotEV-a.jackpotEV}};
  f.sort(sorts[S.sortBy]||sorts.score);
  var sel=null;if(S.selId){for(var i=0;i<S.data.length;i++){if(S.data[i].g.id===S.selId||String(S.data[i].g.gn)===String(S.selId)){sel=S.data[i];break;}}}

  var o='<div class="H"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px"><div><h1>TX ENGINE <span style="color:var(--gld)">v7.5</span></h1>';
  o+='<div class="sub">'+GD.length+' games Â· Similarity + Variance Model Â· Jackpot Focused'+(DD?' Â· '+esc(DD):'')+'</div></div>';
  o+='<div class="B'+(S._refreshing?"":" on")+'" onclick="refreshAllData()">'+(S._refreshing?'â³':'â†» REFRESH')+'</div></div>';
  if(S._refreshMsg)o+='<div style="font-size:10px;color:var(--blu);margin-top:4px">'+esc(S._refreshMsg)+'</div>';
  if(S._promptMsg)o+='<div style="font-size:11px;color:var(--grn);margin-top:4px;font-weight:600">'+esc(S._promptMsg)+'</div>';
  o+='<div class="tabs">';
  [["picks","PICKS"],["detail","DETAIL"],["insights","INSIGHTS"],["winners","WINNERS"],["more","MORE"]].forEach(function(t){o+='<div class="T'+(S.tab===t[0]?" on":"")+'" onclick="setTab(\''+t[0]+'\')">'+t[1]+'</div>';});
  o+='</div></div>';

  if(GD.length===0){o+='<div class="C" style="text-align:center;padding:40px"><div style="font-size:18px;color:var(--amb)">No Data</div><div style="margin-top:8px">Run scraper â†’ deploy feed.json â†’ REFRESH</div></div>';document.getElementById("app").innerHTML=o;return;}

  // ==================== PICKS ====================
  if(S.tab==="picks"){
    if(S.insightFilter){
      var filterLabels={all:"ALL",top:"WITH TOP PRIZES",buy:"BUY CANDIDATES",avoid:"AVOID",closing:"CLOSING",new:"NEW GAMES",concentrated:"DENSITY 1.3x+",depleted:"TOP PRIZES GONE"};
      o+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;margin-bottom:8px;background:#2ecc7115;border:1px solid #2ecc7130;border-radius:8px"><div style="font-size:11px;font-weight:700;color:var(--grn)">FILTER: '+(filterLabels[S.insightFilter]||S.insightFilter)+' ('+f.length+')</div><div class="B" style="font-size:9px;padding:2px 10px" onclick="S.insightFilter=null;render()">âœ• CLEAR</div></div>';
    }
    o+='<div class="FR"><span class="L" style="margin:0">PRICE:</span>';
    ["all"].concat(pArr).forEach(function(p){var v=String(p);o+='<div class="B'+(S.filterPr===v?" on":"")+'" onclick="setFilter(\''+v+'\')" style="padding:5px 10px">'+(v==="all"?"ALL":"$"+v)+'</div>';});
    o+='</div><div class="FR"><span class="L" style="margin:0">SORT:</span>';
    [["score","Score"],["density","JK Density"],["hyper","JK P(pack)"],["jackpotEV","JK EV"],["gap","Gap"],["topOdds","Top Odds"],["tickets","Fresh"]].forEach(function(s){o+='<div class="B'+(S.sortBy===s[0]?" bn":"")+'" onclick="setSort(\''+s[0]+'\')" style="padding:5px 10px">'+s[1]+'</div>';});
    o+='</div>';
    for(var idx=0;idx<f.length;idx++){
      var a=f[idx],tr2=getTrend((a.g.id||String(a.g.gn)));
      var _br=computeBurnRate((a.g.id||String(a.g.gn)),a); // v7.1
      o+='<div class="C ck" onclick="openDetail(\''+(a.g.id||String(a.g.gn))+'\')">';
      if(idx===0&&f.length>1)o+='<div class="badge" style="right:12px;background:var(--grn);color:var(--bg)">TOP PICK</div>';
      if(a.g.cs)o+='<div class="badge" style="right:'+(idx===0&&f.length>1?'95px':'12px')+';background:var(--red);color:#fff">CLOSING</div>';
      if(!a.btpInfo.hasJackpot)o+='<div class="badge" style="left:12px;background:var(--dim);color:var(--bg)">NO JK</div>';
      else if(!a.complete)o+='<div class="badge" style="left:12px;background:var(--amb);color:var(--bg)">PARTIAL</div>';
      o+='<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px"><div style="flex:1;min-width:0">';
      o+='<div style="font-size:15px;font-weight:700;color:var(--wht);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(a.g.nm)+' <span class="d" style="font-weight:400">#'+a.g.gn+'</span></div>';
      o+='<div style="font-size:11px;color:var(--dim)">$'+a.g.pr+(a.g.pk?' Â· '+a.g.pk+'/pk':'')+(a.aa?' Â· BTP:$'+fN(a.aa):'')+(a.g.guar?' Â· Fl:$'+fN(a.g.guar):'')+(_br?' Â· <span style="color:var(--amb)">ðŸ”¥'+fN(_br.packsPerDay)+'/day</span>':'')+'</div></div>';
      // Sold% bar â€” prominent
      if(a.pc>0){var _soldPct=Math.round(a.mat*100),_barClr=_soldPct>80?'var(--red)':_soldPct>50?'var(--amb)':'var(--grn)';
        o+='<div style="margin-top:6px;display:flex;align-items:center;gap:8px">';
        o+='<div style="flex:1"><div style="height:8px;background:var(--bg);border-radius:4px;overflow:hidden"><div style="height:100%;width:'+_soldPct+'%;background:'+_barClr+';border-radius:4px"></div></div></div>';
        o+='<div style="font-size:14px;font-weight:800;color:'+_barClr+'">'+_soldPct+'%</div>';
        o+='<div style="font-size:11px;color:var(--wht);font-weight:700">'+fN(a.epr)+'<span style="font-size:9px;color:var(--dim);font-weight:400"> left</span></div>';
        if(_br){var _tpd=_br.packsPerDay*a.g.pk;o+='<div style="font-size:11px;font-weight:700;color:var(--amb)">ðŸ”¥'+fN(_br.packsPerDay)+'<span style="font-size:9px;font-weight:400">pk/day</span> <span style="font-size:9px;color:var(--dim);font-weight:400">('+fN(_tpd)+'tk)</span></div>';}
        o+='</div>';
      }
      // Archetype badge
      var _arch=classifyArchetype(a);
      o+='<div style="display:flex;gap:6px;align-items:center;margin-top:4px;flex-wrap:wrap">';
      o+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:'+_arch.color+'20;color:'+_arch.color+';border:1px solid '+_arch.color+'40">'+_arch.label+'</span>';
      if(a._fbNote&&a._fbNote.length)o+='<span style="font-size:8px;color:var(--amb)">âš  '+esc(a._fbNote[0])+'</span>';
      o+='</div>';
      // All winners with pack# and ticket#
      var _wc=S.winData&&S.winData[String(a.g.gn)]?S.winData[String(a.g.gn)]:null;
      if(_wc&&_wc.length>0){
        var _wcs=_wc.slice().sort(function(x,y){return(y.pn||0)-(x.pn||0)});
        o+='<div style="margin-top:4px;padding:4px 8px;background:#d4a01708;border-radius:6px;font-size:10px">';
        o+='<span style="color:var(--gld);font-weight:700">ðŸ† '+_wcs.length+' claims:</span> ';
        _wcs.forEach(function(r,ri){if(ri>0)o+=' Â· ';o+='<span style="color:var(--grn)">Pk#'+(r.pn>0?fN(r.pn):'?')+'</span>';if(r.tk)o+='<span class="d">/Tk'+r.tk+'</span>';o+=' <span class="d">'+esc(r.city||'')+'</span>';});
        o+='</div>';
      }
      var confClr=a.confidence>=85?"var(--grn)":a.confidence>=70?"var(--blu)":a.confidence>=50?"var(--dim)":a.confidence>=30?"var(--amb)":"var(--red)";
      o+='<div style="text-align:right;flex-shrink:0"><div class="V" style="color:'+confClr+';font-size:26px">'+a.sc+'<span style="font-size:12px;font-weight:600"> pts</span></div>';
      o+='<div style="font-size:9px;color:var(--dim)">#'+a.rank+' of '+a.rankOf+'</div>';
      o+='<div style="font-size:10px;font-weight:700;color:'+confClr+'">'+a.confidence+'% '+a.confLabel+'</div>';
      if(tr2.length>=3)o+='<div style="margin-top:2px">'+sparkline(tr2,"sc",14)+'</div>';
      o+='</div></div>';
      if(a.whyScore.length>0){o+='<div style="margin-top:5px">';a.whyScore.forEach(function(w){var c=w.p>0?"var(--grn)":w.p<0?"var(--red)":"var(--dim)";o+='<span class="why-tag" style="background:'+c+'15;color:'+c+';border:1px solid '+c+'30">'+(w.p>0?"â–²":"â–¼")+" "+w.f+'</span>';});o+='</div>';}
      o+='<div class="G" style="grid-template-columns:repeat(auto-fit,minmax(90px,1fr));margin-top:8px">';
      [{l:"JK Density",v:a.jackpotDensityShift>0?a.jackpotDensityShift.toFixed(2)+"x":"â€”",c:a.jackpotDensityShift>=1.2?"g":a.jackpotDensityShift>=0.9?"d":"r"},
       {l:"JK P(pack)",v:a.hyperRatio>0?a.hyperRatio.toFixed(2)+"x":"â€”",c:a.hyperRatio>1.1?"g":a.hyperRatio<0.9?"r":"d"},
       {l:"JK EV",v:a.jackpotEV>0?"$"+a.jackpotEV.toFixed(2):"â€”",c:a.jackpotEVShift>1.05?"g":"d"},
       {l:"Top Left",v:a.tpr+"/"+a.tp.p,c:a.tpr>0?"g":"r"},
       {l:"Top Lag",v:a.topClaimLag!==0?(a.topClaimLag>0?"+":"")+pct(a.topClaimLag):"â€”",c:a.topClaimLag>0.05?"g":a.topClaimLag<-0.05?"r":"d"},
       {l:"Markov",v:a.gm.sig.replace(/_/g," "),c:"BUY STRONG_BUY".indexOf(a.gm.sig)>=0?"g":"AVOID DEAD".indexOf(a.gm.sig)>=0?"r":"d"},
       {l:"Sold",v:pct(a.mat),c:a.mat<0.5?"g":a.mat<0.8?"a":"r"},
       {l:"Floor",v:a.floorEV>0?"$"+fN(a.floorEV):"â€”",c:"d"},
       {l:"Data",v:a.dataConfidence,c:a.dataConfidence==="HIGH"?"g":a.dataConfidence==="MEDIUM"?"a":"r"},
       {l:"Gap",v:a.returnGap!==0?(a.returnGap>0?"+":"")+pct(a.returnGap):"â€”",c:a.returnGap>0.01?"g":a.returnGap<-0.01?"r":"d"}
      ].forEach(function(m){o+='<div><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:12px;font-weight:700" class="'+m.c+'">'+m.v+'</div></div>';});
      o+='</div>';
      if(a.jackpotShifts.length>0){o+='<div style="margin-top:6px;padding:5px 8px;background:var(--bg);border-radius:6px;display:flex;gap:12px;flex-wrap:wrap">';
        a.jackpotShifts.forEach(function(j){var jc=j.signal==="STRONG"||j.signal==="GOOD"?"var(--grn)":j.signal==="NEUTRAL"?"var(--dim)":j.signal==="WEAK"?"var(--amb)":"var(--red)";
          var rc=j.role==="TOP"?"#d4a017":j.role==="TOP-1"?"#af7ac5":"#5a6a7a";
          o+='<div style="font-size:10px"><span style="font-size:8px;color:'+rc+'">'+j.role+'</span> <span style="font-weight:700;color:'+jc+'">$'+fN(j.a)+'</span> '+(j.remaining<=0?'<span class="r">GONE</span>':'<span class="d">'+j.remaining+'/'+j.printed+' '+j.shift.toFixed(2)+'x</span>'+(j.claimLag>0.05?' <span style="color:var(--grn)">lag+'+pct(j.claimLag)+'</span>':''))+'</div>';});
        o+='</div>';}
      if(a.flags.length>0){o+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:5px">';a.flags.slice(0,4).forEach(function(fl){o+='<span style="font-size:9px;font-weight:700;padding:3px 8px;border-radius:4px;background:var(--'+fl.c+'1);color:var(--'+fl.c+');border:1px solid var(--'+fl.c+')30">'+esc(fl.t)+'</span>';});o+='</div>';}
      o+='</div>';
    }
  }

  // ==================== DETAIL ====================
  if(S.tab==="detail"){
    o+='<div style="margin-bottom:14px">';
    o+='<input class="I" type="text" placeholder="Search by game name or number..." value="'+esc(S.detailSearch)+'" oninput="detailSearchInput(this.value)" style="margin-bottom:6px">';
    var detailList=S.data.slice().sort(function(a,b){return b.sc-a.sc});
    var sq=S.detailSearch.toLowerCase().trim();
    if(sq)detailList=detailList.filter(function(a){return a.g.nm.toLowerCase().indexOf(sq)>=0||String(a.g.gn).indexOf(sq)>=0});
    o+='<select class="I" onchange="setSel(this.value)"><option value="">â€” '+(sq?detailList.length+' matching':'Select game')+' â€”</option>';
    detailList.forEach(function(a){var _gid=a.g.id||String(a.g.gn);var confClr2=a.confidence>=70?"ðŸŸ¢":a.confidence>=50?"ðŸŸ¡":"ðŸ”´";o+='<option value="'+_gid+'"'+(_gid===S.selId?" selected":"")+'>'+confClr2+' $'+a.g.pr+' | '+esc(a.g.nm)+' #'+a.g.gn+' | '+a.sc+'pts #'+a.rank+' | '+a.confidence+'% '+a.confLabel+'</option>';});
    o+='</select></div>';

    if(sel){
      var burn=computeBurnRate((sel.g.id||String(sel.g.gn)),sel);
      // Header card
      o+='<div class="C"><div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px"><div>';
      o+='<div style="font-size:18px;font-weight:800;color:var(--wht)">'+esc(sel.g.nm)+' <span class="d" style="font-size:14px">#'+sel.g.gn+'</span></div>';
      o+='<div style="font-size:11px;color:var(--dim);margin-top:4px">$'+sel.g.pr+' Â· '+sel.g.pk+'/pack=$'+fN(sel.packPrice)+' Â· Floor:$'+fN(sel.g.guar||0)+' Â· Odds:1:'+sel.g.odds+'</div>';
      var _dArch=classifyArchetype(sel);
      o+='<span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;background:'+_dArch.color+'20;color:'+_dArch.color+';border:1px solid '+_dArch.color+'40">'+_dArch.label+'</span>';
      o+='<span style="font-size:9px;color:var(--dim);margin-left:6px">'+esc(_dArch.desc)+'</span>';
      if(_dArch.tip)o+='<div style="font-size:9px;color:var(--amb);margin-top:2px">ðŸ’¡ '+esc(_dArch.tip)+'</div>';
      // Similar games by archetype
      var _simGames=S.data.filter(function(x){return x.complete&&x.g.gn!==sel.g.gn&&classifyArchetype(x).type===_dArch.type}).sort(function(a,b){return b.sc-a.sc}).slice(0,5);
      if(_simGames.length>0){o+='<div style="margin-top:3px;font-size:9px;color:var(--dim)">Similar ('+_dArch.label+'): ';_simGames.forEach(function(sg,si){if(si>0)o+=', ';o+='<span class="ck" onclick="setSel(\''+(sg.g.id||String(sg.g.gn))+'\');render()" style="color:var(--blu);cursor:pointer">'+esc(sg.g.nm)+' ('+sg.sc+'pts)</span>';});o+='</div>';}
      o+='</div>';
      // Prominent sold% bar
      if(sel.pc>0){var _dSoldPct=Math.round(sel.mat*100),_dBarClr=_dSoldPct>80?'var(--red)':_dSoldPct>50?'var(--amb)':'var(--grn)';
        o+='<div style="margin-top:8px;padding:10px 14px;background:var(--bg);border-radius:8px">';
        o+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
        o+='<div><span style="font-size:22px;font-weight:800;color:'+_dBarClr+'">'+_dSoldPct+'%</span><span style="font-size:12px;color:var(--dim)"> sold</span></div>';
        o+='<div style="text-align:right"><span style="font-size:20px;font-weight:800;color:var(--wht)">'+fN(sel.epr)+'</span><span style="font-size:11px;color:var(--dim)"> packs left</span></div>';
        o+='</div>';
        o+='<div style="height:10px;background:var(--border);border-radius:5px;overflow:hidden"><div style="height:100%;width:'+_dSoldPct+'%;background:'+_dBarClr+';border-radius:5px"></div></div>';
        o+='<div style="display:flex;justify-content:space-between;margin-top:4px;font-size:10px;color:var(--dim)"><span>'+fN(sel.eps)+' sold</span>'+(burn?'<span style="color:var(--amb);font-weight:700">ðŸ”¥ '+fN(burn.packsPerDay)+'pk/day ('+fN(burn.packsPerDay*sel.g.pk)+'tk)'+(burn.daysLeft?' Â· '+burn.daysLeft+'d left':'')+'</span>':'')+'<span>'+fN(sel.pc)+' total</span></div>';
        o+='</div>';
      }
      if(sel.totalTickets>0)o+='<div style="font-size:10px;color:var(--dim);margin-top:4px">Tickets: '+fN(sel.totalTickets)+' total / '+fN(sel.ets)+' sold / '+fN(sel.etr)+' outstanding'+(sel.prizeClass?' <span style="font-weight:700;color:'+(sel.prizeClass==="high"?"#d4a017":"#5a6a7a")+'">'+sel.prizeClass.toUpperCase()+' VALUE</span>':'')+'</div>';
      // All winners with pack# and ticket#
      var _dw=S.winData&&S.winData[String(sel.g.gn)]?S.winData[String(sel.g.gn)]:null;
      if(_dw&&_dw.length>0){
        var _dws=_dw.slice().sort(function(a,b){return(b.pn||0)-(a.pn||0)});
        o+='<div style="margin-top:6px;padding:6px 10px;background:#d4a01710;border-radius:6px">';
        o+='<div style="font-size:10px;font-weight:700;color:var(--gld);margin-bottom:4px">ðŸ† ALL WINNER CLAIMS ('+_dws.length+')</div>';
        _dws.forEach(function(r){
          o+='<div style="font-size:10px;padding:3px 0;border-bottom:1px solid var(--border)20;display:flex;gap:8px;flex-wrap:wrap">';
          o+='<span style="color:var(--grn);font-weight:700">Pack #'+(r.pn>0?fN(r.pn):'?')+'</span>';
          if(r.tk)o+='<span class="d">Ticket #'+r.tk+'</span>';
          o+='<span class="d">'+esc(r.date||'')+'</span>';
          o+='<span style="color:var(--dim)">'+esc(r.store||'')+', '+esc(r.city||'')+'</span>';
          o+='</div>';
        });
        o+='</div>';
      }
      var selConfClr=sel.confidence>=85?"var(--grn)":sel.confidence>=70?"var(--blu)":sel.confidence>=50?"var(--dim)":sel.confidence>=30?"var(--amb)":"var(--red)";
      o+='<div style="text-align:right"><div class="V" style="color:'+selConfClr+'">'+sel.sc+'<span style="font-size:12px"> pts</span></div><div style="font-size:10px;color:var(--dim)">#'+sel.rank+' of '+sel.rankOf+'</div><div style="font-size:11px;font-weight:700;color:'+selConfClr+'">'+sel.confidence+'% '+sel.confLabel+'</div></div></div>';
      if(sel.whyScore.length){o+='<div style="margin-top:6px">';sel.whyScore.forEach(function(w){var c=w.p>0?"var(--grn)":w.p<0?"var(--red)":"var(--dim)";o+='<span class="why-tag" style="background:'+c+'15;color:'+c+';border:1px solid '+c+'30">'+(w.p>0?"â–²+":"â–¼")+w.p+' '+w.f+'</span>';});o+='</div>';}
      var dataConfClr=sel.dataConfidence==="HIGH"?"var(--grn)":sel.dataConfidence==="MEDIUM"?"var(--amb)":"var(--red)";
      o+='<div style="margin-top:8px;padding:8px 12px;background:var(--bg);border-radius:8px;font-size:12px">';
      o+='BTP:<strong class="g">$'+fN(sel.aa)+'</strong>'+(sel.btpValid?' <span class="d">âœ“</span>':'')+' Â· Signal:<strong style="color:'+("BUY STRONG_BUY".indexOf(sel.gm.sig)>=0?"var(--grn)":"AVOID DEAD".indexOf(sel.gm.sig)>=0?"var(--red)":"var(--dim)")+'">'+sel.gm.sig.replace(/_/g," ")+'</strong> Â· Data:<strong style="color:'+dataConfClr+'">'+sel.dataConfidence+'</strong></div>';
      if(!sel.complete)o+='<div style="margin-top:6px;padding:6px;background:var(--amb)18;border:1px solid var(--amb)30;border-radius:6px;font-size:11px;color:var(--amb)">âš  Missing data â€” run scraper with detail pages.</div>';
      o+='</div>';

      // TOP PRIZE TRACKER
      if(sel.jackpotShifts.length>0){
        o+='<div class="C" style="border-color:#d4a01744"><div class="L" style="margin-bottom:10px;color:var(--gld)">ðŸŽ¯ TOP PRIZE TRACKER</div>';
        sel.jackpotShifts.forEach(function(j){
          var sc2=j.signal==="STRONG"||j.signal==="GOOD"?"#2ecc71":j.signal==="NEUTRAL"?"#5a6a7a":j.signal==="WEAK"?"#f39c12":"#e74c3c";
          var roleClr=j.role==="TOP"?"#d4a017":j.role==="TOP-1"?"#af7ac5":"#5a6a7a";
          o+='<div style="padding:10px;background:var(--bg);border-radius:8px;margin-bottom:8px;border-left:3px solid '+sc2+';display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">';
          o+='<div><div style="font-size:20px;font-weight:800;color:'+sc2+'">$'+fN(j.a)+'</div><div style="font-size:9px;font-weight:700;color:'+roleClr+'">'+j.role+'</div></div>';
          if(j.remaining<=0)o+='<div style="font-size:16px;font-weight:800;color:var(--red)">ALL CLAIMED</div>';
          else{
            o+='<div style="text-align:center"><div style="font-size:16px;font-weight:800">'+j.remaining+'<span class="d" style="font-size:11px">/'+j.printed+'</span></div><div style="font-size:9px" class="d">LEFT</div></div>';
            o+='<div style="text-align:center"><div style="font-size:16px;font-weight:800;color:'+sc2+'">'+j.shift.toFixed(2)+'x</div><div style="font-size:9px" class="d">DENSITY</div></div>';
            o+='<div style="text-align:center"><div style="font-size:14px;font-weight:700">1:'+fN(j.currentOdds)+'</div><div style="font-size:8px;color:'+(j.launchOdds>j.currentOdds?"var(--grn)":"var(--red)")+'">'+(j.launchOdds>j.currentOdds?(j.launchOdds/j.currentOdds).toFixed(1)+"x better":"was 1:"+fN(j.launchOdds))+'</div></div>';
            o+='<div style="text-align:center"><div style="font-size:14px;font-weight:700;color:'+(j.claimLag>0.05?"var(--grn)":j.claimLag<-0.05?"var(--red)":"var(--dim)")+'">'+(j.claimLag>0?"+":"")+pct(j.claimLag)+'</div><div style="font-size:9px" class="d">CLAIM LAG</div></div>';
          }
          o+='<div style="font-size:11px;font-weight:700;color:'+sc2+';padding:4px 10px;background:'+sc2+'18;border-radius:6px">'+j.signal+'</div>';
          if(j.printed<=10)o+='<div style="width:100%;font-size:10px;color:var(--amb)">âš¡ â‰¤10 printed â€” high sensitivity</div>';
          o+='</div>';
        });
        o+='<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">';
        [{l:"P(TOP IN PACK)",v:sel.hyperTopNow>=0.01?pct(sel.hyperTopNow):sel.hyperTopNow>0?"1:"+fN(Math.round(1/sel.hyperTopNow)):"â€”",c:sel.hyperTopRatio>1.05?"var(--grn)":"var(--wht)",sub:sel.hyperTopRatio>0?sel.hyperTopRatio.toFixed(2)+"x vs launch":""},
         {l:"P(ANY TOP TIER)",v:sel.hyperNow>=0.01?pct(sel.hyperNow):"1:"+fN(Math.round(1/Math.max(sel.hyperNow,1e-9))),c:sel.hyperRatio>1.05?"var(--grn)":"var(--wht)",sub:sel.hyperRatio.toFixed(2)+"x vs launch"},
         {l:"TOP EV/PACK",v:"$"+sel.jackpotEVRaw.toFixed(2),c:"var(--pur)",sub:"was $"+sel.jackpotEVLaunchRaw.toFixed(2)},
         {l:"WEIGHTED DENSITY",v:sel.jackpotDensityShift.toFixed(2)+"x",c:sel.jackpotDensityShift>=1.2?"var(--grn)":"var(--wht)",sub:"TOP 100% + TOP-1 50%"},
         {l:"TOP PRIZE LAG",v:(sel.topClaimLag>0?"+":"")+pct(sel.topClaimLag),c:sel.topClaimLag>0.05?"var(--grn)":sel.topClaimLag<-0.05?"var(--red)":"var(--wht)",sub:"vs BTP claim rate"}
        ].forEach(function(e){o+='<div class="cl"><div class="L" style="font-size:8px">'+e.l+'</div><div style="font-size:18px;font-weight:800;color:'+e.c+'">'+e.v+'</div>'+(e.sub?'<div style="font-size:9px" class="d">'+e.sub+'</div>':'')+'</div>';});
        o+='</div></div>';
      }

      // EV MODEL
      o+='<div class="C" style="border-color:#3498db44"><div class="L" style="margin-bottom:10px;color:var(--blu)">ðŸ“Š FLOOR-BASED EV</div>';
      o+='<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px">';
      [{l:"Floor (FACT)",v:"$"+fN(sel.floorEV),c:"var(--grn)"},{l:"Mid Upside",v:"$"+sel.midRangeEV.toFixed(0),c:"var(--blu)"},{l:"Top EV",v:"$"+sel.jackpotEVRaw.toFixed(2),c:"var(--pur)"},{l:"Total EV",v:"$"+Math.round(sel.totalEV),c:"var(--wht)"},{l:"Pack Cost",v:"$"+fN(sel.packPrice),c:"var(--red)"},{l:"Edge",v:(sel.edge>0?"+":"")+pct(sel.edge),c:sel.edge>-0.1?"var(--amb)":"var(--red)"}].forEach(function(e){o+='<div class="cl"><div class="L" style="font-size:8px">'+e.l+'</div><div style="font-size:16px;font-weight:800;color:'+e.c+'">'+e.v+'</div></div>';});
      o+='</div>';
      var evMx=sel.packPrice||1;
      o+='<div style="height:28px;background:var(--bg);border-radius:6px;overflow:hidden;display:flex">';
      [{v:sel.floorEV,c:"var(--grn)"},{v:sel.midRangeEV,c:"var(--blu)"},{v:sel.jackpotEVRaw,c:"var(--pur)"}].forEach(function(e){o+='<div style="width:'+(e.v/evMx*100)+'%;height:100%;background:'+e.c+';opacity:.5"></div>';});
      o+='</div>';
      o+='<div style="font-size:10px;margin-top:4px" class="d"><span class="g">â– </span> Floor <span class="b">â– </span> Mid <span class="p">â– </span> JK</div></div>';

      // === v7.1: BURN RATE CARD ===
      if(burn){
        o+='<div class="C" style="border-color:#f39c1244"><div class="L" style="margin-bottom:10px;color:var(--amb)">ðŸ”¥ BURN RATE</div>';
        o+='<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">';
        [{l:"PACKS/DAY",v:fN(burn.packsPerDay),c:"var(--amb)"},{l:"$/DAY",v:"$"+fN(burn.dollarsPerDay),c:"var(--amb)"},{l:"DAYS LEFT",v:burn.daysLeft?burn.daysLeft+"d":"â€”",c:burn.daysLeft&&burn.daysLeft<30?"var(--red)":burn.daysLeft&&burn.daysLeft<90?"var(--amb)":"var(--grn)"},{l:"CONFIDENCE",v:burn.reliable?"HIGH":"LOW ("+burn.snapshots+"pts)",c:burn.reliable?"var(--grn)":"var(--amb)"}].forEach(function(m){o+='<div class="cl"><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:14px;font-weight:800;color:'+m.c+'">'+m.v+'</div></div>';});
        o+='</div>';
        if(burn.milestones&&burn.milestones.length){
          o+='<div style="font-size:11px;font-weight:700;color:var(--dim);margin-bottom:6px">MILESTONE ETAs (at current pace)</div>';
          o+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
          burn.milestones.forEach(function(m){var clr=m.pct<=0.20?"var(--grn)":m.pct<=0.50?"var(--blu)":"var(--dim)";
            o+='<div style="background:var(--bg);border-radius:6px;padding:5px 10px;border:1px solid var(--border)"><div style="font-size:9px;color:'+clr+';font-weight:700">'+(m.pct*100).toFixed(0)+'% SOLD</div><div style="font-size:12px;font-weight:700">'+m.label+'</div><div style="font-size:9px;color:var(--dim)">in '+m.days+'d</div></div>';});
          o+='</div>';
        }
        if(!burn.reliable)o+='<div style="font-size:10px;color:var(--amb);margin-top:6px">âš  Need more daily snapshots for accuracy. Check back each day.</div>';
        o+='</div>';
      }else{
        o+='<div class="C" style="border-color:#f39c1222"><div class="L" style="color:var(--amb)">ðŸ”¥ BURN RATE</div><div style="font-size:11px;color:var(--dim);margin-top:4px">No daily trend data yet â€” check back tomorrow after another REFRESH.</div></div>';
      }

      // ============================================================
      // v7.5: PROJECTION ENGINE â€” replaces Monte Carlo with deterministic model
      // ============================================================
      var _ew=elliottWaveBurnRate((sel.g.id||String(sel.g.gn)),sel);
      var _proj=comprehensiveProjection(sel,burn,_ew);
      if(_proj.valid){
        o+='<div class="C" style="border-color:#9b59b644">';
        o+='<div class="L" style="color:var(--pur);margin-bottom:10px">ðŸ“Š PROJECTION ENGINE</div>';

        // === ROW 1: Overview stats ===
        var _evPack=_proj.totalRemVal/_proj.epr,_evEdge=_proj.packPrice>0?(_evPack/_proj.packPrice)-1:0;
        o+='<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">';
        [{l:"Remaining Value",v:"$"+fN(Math.round(_proj.totalRemVal)),c:"var(--wht)"},
         {l:"EV/Pack",v:"$"+_evPack.toFixed(0),c:_evPack>=sel.packPrice?"var(--grn)":"var(--red)"},
         {l:"Edge",v:(_evEdge>=0?"+":"")+(_evEdge*100).toFixed(1)+"%",c:_evEdge>-0.1?"var(--amb)":"var(--red)"},
         {l:"Burn Rate",v:_proj.ppd>0?fN(_proj.ppd)+"/day":"â€”",c:"var(--amb)"},
         {l:"Phase",v:_ew&&_ew.valid?_ew.phase.replace(/_/g,' '):"â€”",c:_ew&&_ew.phase==='IMPULSE_UP'?"var(--grn)":_ew&&_ew.phase==='CORRECTIVE_DOWN'?"var(--red)":"var(--dim)"}
        ].forEach(function(e){o+='<div class="cl"><div class="L" style="font-size:8px">'+e.l+'</div><div style="font-size:13px;font-weight:800;color:'+e.c+'">'+e.v+'</div></div>';});
        o+='</div>';

        // === ROW 2: Two charts side by side ===
        o+='<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">';

        // LEFT: Prize distribution pie chart (by remaining VALUE)
        o+='<div style="flex:1;min-width:150px;padding:10px;background:var(--bg);border-radius:8px">';
        o+='<div style="font-size:9px;font-weight:700;color:var(--dim);margin-bottom:8px">REMAINING PRIZE VALUE</div>';
        var _pieData=[];
        var _catColors={'TOP':'#d4a017','TOP-1':'#af7ac5','TOP-2':'#7e57c2','MID':'#3498db','BTP':'#2ecc71','FLOOR':'#3d4f5f'};
        // Group by category
        var _catMap={};
        _proj.distByValue.forEach(function(d){var k=d.cat;if(!_catMap[k])_catMap[k]={value:0,count:0,label:k};_catMap[k].value+=d.value;_catMap[k].count+=d.rem;});
        Object.keys(_catMap).forEach(function(k){_pieData.push({value:_catMap[k].value,color:_catColors[k]||'#5a6a7a',label:k});});
        _pieData.sort(function(a,b){return b.value-a.value});
        o+='<div style="display:flex;align-items:center;gap:10px">';
        o+=svgPie(_pieData,110);
        o+='<div>';
        _pieData.forEach(function(d){
          var pctV=_proj.totalRemVal>0?Math.round(d.value/_proj.totalRemVal*100):0;
          o+='<div style="font-size:9px;display:flex;align-items:center;gap:4px;margin-bottom:2px"><span style="width:8px;height:8px;border-radius:2px;background:'+d.color+';display:inline-block"></span><span style="color:var(--dim)">'+d.label+'</span> <span style="font-weight:700">'+pctV+'%</span> <span class="d">($'+fN(Math.round(d.value))+')</span></div>';
        });
        o+='</div></div></div>';

        // RIGHT: Pack outcome distribution pie
        o+='<div style="flex:1;min-width:150px;padding:10px;background:var(--bg);border-radius:8px">';
        o+='<div style="font-size:9px;font-weight:700;color:var(--dim);margin-bottom:8px">PACK OUTCOME DISTRIBUTION</div>';
        var _outPie=_proj.outcomes.map(function(oc){return{value:Math.max(0.001,oc.pct),color:oc.color,label:oc.label}});
        o+='<div style="display:flex;align-items:center;gap:10px">';
        o+=svgPie(_outPie,110);
        o+='<div>';
        _proj.outcomes.forEach(function(oc){
          o+='<div style="font-size:9px;display:flex;align-items:center;gap:4px;margin-bottom:2px"><span style="width:8px;height:8px;border-radius:2px;background:'+oc.color+';display:inline-block"></span><span style="color:var(--dim)">'+oc.label+'</span> <span style="font-weight:700">'+Math.round(oc.pct*100)+'%</span></div>';
        });
        o+='</div></div></div>';
        o+='</div>';

        // === ROW 3: Jackpot projection per tier â€” bar chart + detail ===
        if(_proj.tiers.length>0){
          o+='<div style="padding:10px;background:var(--bg);border-radius:8px;margin-bottom:12px">';
          o+='<div style="font-size:9px;font-weight:700;color:var(--dim);margin-bottom:8px">JACKPOT PROJECTION â€” PACKS TO 50% PROBABILITY</div>';
          var _barData=_proj.tiers.map(function(t){
            return{value:t.blendedPacks||t.p50packs,color:t.role==='TOP'?'#d4a017':t.role==='TOP-1'?'#af7ac5':'#7e57c2',
              label:'$'+fN(t.amount),topLabel:fN(t.blendedPacks||t.p50packs)+'pk'};
          });
          o+=svgBar(_barData,Math.min(320,_barData.length*80+40),90);

          // Per-tier detailed cards
          _proj.tiers.forEach(function(t){
            var tc=t.role==='TOP'?'#d4a017':t.role==='TOP-1'?'#af7ac5':'#7e57c2';
            var sigC=t.signal==='STRONG'||t.signal==='GOOD'?'var(--grn)':t.signal==='NEUTRAL'?'var(--dim)':'var(--red)';
            o+='<div style="margin-top:8px;padding:8px;border-left:3px solid '+tc+';background:var(--card);border-radius:0 6px 6px 0">';
            o+='<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">';
            o+='<div><span style="font-size:15px;font-weight:800;color:'+tc+'">$'+fN(t.amount)+'</span> <span class="d">('+t.role+')</span> <span style="font-size:10px;font-weight:700;color:'+sigC+'">'+t.signal+' '+t.densityShift.toFixed(2)+'x</span></div>';
            o+='<div style="font-size:10px"><span class="d">Remaining:</span> <b>'+t.remaining+'/'+t.printed+'</b> Â· <span class="d">Odds:</span> <b>'+(t.pPerPack<0.001?'1:'+fN(Math.round(1/t.pPerPack)):(t.pPerPack*100).toFixed(2)+'%')+'</b>/pack</div>';
            o+='</div>';
            // Probability ladder
            o+='<div style="display:flex;gap:4px;margin-top:6px;flex-wrap:wrap">';
            t.probs.forEach(function(p){
              o+='<div style="flex:1;min-width:60px;padding:4px 6px;background:var(--bg);border-radius:4px;text-align:center"><div style="font-size:8px;color:var(--dim)">'+Math.round(p.conf*100)+'%</div><div style="font-size:11px;font-weight:700">'+fN(p.packs)+'</div><div style="font-size:8px;color:var(--dim)">packs</div></div>';
            });
            o+='</div>';
            // Time + gap estimates
            o+='<div style="display:flex;gap:12px;margin-top:6px;font-size:10px;flex-wrap:wrap">';
            if(t.blendedDays)o+='<span><span class="d">Est:</span> <b style="color:var(--grn)">~'+t.blendedDays+' days</b> ('+fN(t.blendedPacks)+' packs)</span>';
            else if(t.p50days)o+='<span><span class="d">Est:</span> <b>~'+t.p50days+' days</b></span>';
            if(t.winGaps)o+='<span><span class="d">Avg claim gap:</span> <b>'+t.avgGapDays+'d</b> ('+t.winGaps.count+' gaps)</span>';
            if(t.daysSinceLast!==null)o+='<span><span class="d">Since last claim:</span> <b style="color:'+(t.overdue?'var(--grn)':'var(--dim)')+'">'+t.daysSinceLast+'d</b>'+(t.overdue?' <span style="color:var(--grn);font-weight:700">OVERDUE</span>':'')+'</span>';
            if(t.lastClaimDate)o+='<span class="d">Last: '+esc(t.lastClaimDate)+'</span>';
            o+='</div>';
            if(t.simFactor!==1.0)o+='<div style="font-size:9px;color:var(--dim);margin-top:4px">Similar games adjust: '+t.simFactor.toFixed(2)+'x</div>';
            o+='</div>';
          });
          o+='</div>';
        }

        // === ROW 4: Burn Rate + Elliott Wave chart ===
        if(_ew&&_ew.valid&&_ew.series.length>=3){
          o+='<div style="padding:10px;background:var(--bg);border-radius:8px;margin-bottom:12px">';
          o+='<div style="font-size:9px;font-weight:700;color:var(--dim);margin-bottom:4px">BURN RATE TREND â€” ELLIOTT WAVE ANALYSIS</div>';
          o+='<div style="margin-bottom:6px">';
          o+=svgSparkArea(_ew.series.map(function(s){return s.ppd}),280,55,_ew.phase==='IMPULSE_UP'?'#2ecc71':_ew.phase==='CORRECTIVE_DOWN'?'#e74c3c':'#f39c12');
          o+='</div>';
          // Wave summary
          o+='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">';
          _ew.waves.slice(-5).forEach(function(w,wi){
            var wc=w.dir>0?'var(--grn)':'var(--red)';
            o+='<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:'+wc+'15;color:'+wc+';border:1px solid '+wc+'30">W'+(wi+1)+' '+w.label+' ('+w.startPpd+'â†’'+w.endPpd+')</span>';
          });
          o+='</div>';
          o+='<div style="display:flex;gap:12px;flex-wrap:wrap;font-size:10px">';
          o+='<span><span class="d">Current:</span> <b>'+fN(_ew.currentPpd)+'/day</b></span>';
          o+='<span><span class="d">Avg:</span> <b>'+fN(_ew.avgPpd)+'/day</b></span>';
          o+='<span><span class="d">EW Projected:</span> <b style="color:var(--pur)">'+fN(_ew.ewProjection)+'/day</b></span>';
          o+='<span><span class="d">Momentum:</span> <b style="color:'+(_ew.momentum>0?'var(--grn)':'var(--red)')+'">'+(_ew.momentum>0?'+':'')+Math.round(_ew.momentum*100)+'%</b></span>';
          if(_ew.projectedDaysLeft)o+='<span><span class="d">Days left:</span> <b>'+fN(_ew.projectedDaysLeft)+'</b></span>';
          o+='</div>';
          o+='<div style="font-size:8px;color:var(--dim);margin-top:4px">Phase: '+_ew.phase.replace(/_/g,' ')+' Â· Waves: '+_ew.impulseCount+' impulse, '+_ew.correctiveCount+' corrective Â· Conf: '+_ew.confidence+'</div>';
          o+='</div>';
        }

        // === ROW 5: Winner claim timeline (if winner data exists) ===
        var _wd=S.winData?S.winData[String(sel.g.gn)]:null;
        if(_wd&&_wd.length>1){
          var _wds=_wd.slice().sort(function(a,b){return new Date(a.date)-new Date(b.date)});
          o+='<div style="padding:10px;background:var(--bg);border-radius:8px;margin-bottom:12px">';
          o+='<div style="font-size:9px;font-weight:700;color:var(--dim);margin-bottom:6px">WINNER CLAIM TIMELINE â€” '+_wds.length+' CLAIMS</div>';
          // Gaps between claims
          var _gaps=[];
          for(var _gi=1;_gi<_wds.length;_gi++){
            var _d1=new Date(_wds[_gi-1].date),_d2=new Date(_wds[_gi].date);
            var _gapD=Math.round((_d2-_d1)/86400000);
            var _gapPk=Math.abs((_wds[_gi].pn||0)-(_wds[_gi-1].pn||0));
            _gaps.push({days:_gapD,packs:_gapPk});
          }
          if(_gaps.length){
            var _avgG=Math.round(_gaps.reduce(function(s,g2){return s+g2.days},0)/_gaps.length);
            var _minG=Math.min.apply(null,_gaps.map(function(g2){return g2.days}));
            var _maxG=Math.max.apply(null,_gaps.map(function(g2){return g2.days}));
            var _lastD=new Date(_wds[_wds.length-1].date);
            var _sinceL=Math.round((new Date()-_lastD)/86400000);
            // Gap bar chart
            var _gBarData=_gaps.map(function(g2,gi2){return{value:g2.days,color:g2.days>_avgG*1.5?'#e74c3c':g2.days<_avgG*0.5?'#2ecc71':'#3498db',label:'G'+(gi2+1),topLabel:g2.days+'d'}});
            o+=svgBar(_gBarData,Math.min(320,_gBarData.length*35+40),70);
            o+='<div style="display:flex;gap:12px;flex-wrap:wrap;font-size:10px;margin-top:6px">';
            o+='<span><span class="d">Avg gap:</span> <b>'+_avgG+' days</b></span>';
            o+='<span><span class="d">Range:</span> <b>'+_minG+'â€”'+_maxG+' days</b></span>';
            o+='<span><span class="d">Since last:</span> <b style="color:'+(_sinceL>_avgG?'var(--grn)':'var(--dim)')+'">'+_sinceL+' days</b>'+(_sinceL>_avgG?' <span style="color:var(--grn);font-weight:700">OVERDUE</span>':'')+'</span>';
            o+='</div>';
          }
          // Individual claims with date
          o+='<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">';
          _wds.forEach(function(r,ri){
            o+='<div style="font-size:9px;padding:3px 6px;border-radius:4px;background:var(--card);border:1px solid var(--border)">';
            o+='<span style="color:var(--grn);font-weight:700">Pk#'+(r.pn>0?fN(r.pn):'?')+'</span>';
            if(r.tk)o+=' <span class="d">Tk'+r.tk+'</span>';
            o+=' <span class="d">'+esc(r.date||'')+'</span>';
            if(ri>0&&_gaps[ri-1])o+=' <span style="color:var(--amb)">+'+_gaps[ri-1].days+'d</span>';
            o+='</div>';
          });
          o+='</div>';
          o+='</div>';
        }

        o+='</div>';// end PROJECTION ENGINE card
      }

      // === v7.1: PACK GUIDANCE CARD ===
      var pg=S.winModel?getPackGuidance(sel.g,sel,S.winModel):{valid:false,reason:'Fetch winners to enable guidance'};
      o+='<div class="C" style="border-color:#d4a01744">';
      o+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
      o+='<div class="L" style="color:var(--gld);margin-bottom:0">ðŸ“¦ PACK GUIDANCE</div>';
      if(pg.valid)o+='<div style="font-size:9px;color:var(--dim)">'+esc(pg.clusterKey)+' Â· '+pg.clusterSize+' winners Â· '+pg.clusterGames+' games'+(pg.usedFallback?' âš  fallback':'')+'</div>';
      o+='</div>';
      if(!pg.valid){
        o+='<div style="font-size:11px;color:var(--dim)">'+esc(pg.reason||'â€”')+'</div>';
        if(!S.winModel||!S.winModel.valid){o+='<div style="margin-top:8px"><div class="B bn" onclick="fetchWinners()">'+(S._fetching?'â³ Loading...':'â†“ FETCH WINNERS')+'</div></div>';}
      }else{
        // Prize structure fingerprint
        o+='<div style="padding:8px 10px;background:var(--bg);border-radius:8px;margin-bottom:10px">';
        o+='<div style="font-size:9px;font-weight:700;color:var(--dim);margin-bottom:6px">PRIZE STRUCTURE FINGERPRINT</div>';
        o+='<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px">';
        [{l:"Price",v:"$"+sel.g.pr,c:"var(--wht)"},{l:"JK Count",v:pg.jkBucket.toUpperCase(),c:"var(--blu)"},{l:"Gap Type",v:pg.gapBucket.toUpperCase(),c:pg.gapBucket==="tight"?"var(--amb)":pg.gapBucket==="wide"?"var(--pur)":"var(--grn)"},{l:"Top/Top-1",v:pg.gapRatio.toFixed(2)+"x",c:"var(--wht)"},{l:"Top-1/Top-2",v:pg.jk1to2Ratio<90?pg.jk1to2Ratio.toFixed(2)+"x":"â€”",c:"var(--dim)"}].forEach(function(m){o+='<div><div style="font-size:8px;color:var(--dim)">'+m.l+'</div><div style="font-size:11px;font-weight:700;color:'+m.c+'">'+m.v+'</div></div>';});
        o+='</div>';
        o+='<div style="font-size:11px;color:var(--text);line-height:1.6">'+esc(pg.gapNarrative)+'</div>';
        o+='</div>';
        // Recommended pack range â€” use prediction range if available (empirical gap model), else pack guidance
        var _topPred=jpp&&jpp.valid&&jpp.predictions.length?jpp.predictions[0]:null;
        var _recMin=_topPred?_topPred.rangeLow:pg.minPackNum;
        var _recMax=_topPred?_topPred.rangeHigh:pg.maxPackNum;
        var _recBest=_topPred?_topPred.bestPack:0;
        var _recBasis=_topPred?_topPred.basis:'Position percentiles';
        o+='<div style="padding:10px;background:#d4a01712;border:1px solid #d4a01730;border-radius:8px;margin-bottom:10px">';
        o+='<div style="font-size:9px;font-weight:700;color:var(--gld);margin-bottom:6px">TARGET PACK RANGE'+(sel.g.pz&&sel.g.pz.length?' (for $'+fN(sel.g.pz.slice().sort(function(a,b){return b.a-a.a})[0].a)+' top prize)':'')+'</div>';
        o+='<div style="font-size:20px;font-weight:800;color:var(--grn)">#'+fN(_recMin)+' â†’ #'+fN(_recMax)+'</div>';
        if(_recBest)o+='<div style="font-size:11px;color:var(--text);margin-top:4px">Best estimate: <b>#'+fN(_recBest)+'</b></div>';
        o+='<div style="font-size:9px;color:var(--dim);margin-top:3px">'+esc(_recBasis)+'</div>';
        if(pg.lastWinnerPack>0)o+='<div style="font-size:10px;color:var(--amb);margin-top:3px">Last known claim: pack #'+fN(pg.lastWinnerPack)+'</div>';
        if(pg.usedFallback&&pg.fallbackReason)o+='<div style="font-size:9px;color:var(--amb);margin-top:3px">âš  '+esc(pg.fallbackReason)+'</div>';
        o+='</div>';
        // Historical winner decile heatmap
        if(pg.deciles&&pg.deciles.length){
          o+='<div style="margin-bottom:10px"><div style="font-size:9px;font-weight:700;color:var(--dim);margin-bottom:5px">HISTORICAL WINNER POSITIONS â€” cluster: '+esc(pg.clusterKey)+' ('+pg.clusterSize+' winners)</div>';
          o+='<div style="display:flex;gap:2px;align-items:flex-end;height:50px">';
          var maxD=Math.max.apply(null,pg.deciles.map(function(d){return d.density;}));
          var currentDecile=Math.floor((sel.mat||0)*10);
          pg.deciles.forEach(function(d,idx){
            var h=maxD>0?Math.max(4,Math.round((d.density/maxD)*44)):4;
            var isCur=idx===currentDecile;
            var isRec=d.lo>=(pg.recommendedMinPct||0)-5&&d.hi<=(pg.recommendedMaxPct||100)+5;
            var barClr=isCur?"var(--amb)":isRec?"var(--grn)":"#2a3a4a";
            var txtClr=isCur?"var(--amb)":isRec?"var(--grn)":"var(--dim)";
            o+='<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:1px">';
            o+='<div style="font-size:7px;color:'+txtClr+';font-weight:'+(isCur||isRec?'700':'400')+'">'+Math.round(d.density*100)+'%</div>';
            o+='<div style="width:100%;height:'+h+'px;background:'+barClr+';border-radius:2px"></div>';
            o+='<div style="font-size:7px;color:'+txtClr+'">'+d.lo+'</div>';
            o+='</div>';
          });
          o+='</div>';
          o+='<div style="font-size:9px;color:var(--dim);margin-top:3px"><span style="color:var(--amb)">â– </span> Current sold zone &nbsp;<span style="color:var(--grn)">â– </span> Recommended range &nbsp;(x-axis: % of print run)</div>';
          o+='</div>';
        }
        // Jackpot zone map
        if(pg.zones&&pg.zones.length){
          o+='<div><div style="font-size:9px;font-weight:700;color:var(--dim);margin-bottom:5px">ESTIMATED JACKPOT ZONES â€” '+pg.remainingJkPrizes+' prizes in '+fN(sel.epr)+' remaining packs</div>';
          o+='<div style="display:flex;flex-wrap:wrap;gap:4px">';
          pg.zones.forEach(function(z){
            var zClr=z.isRecommended?"var(--grn)":"var(--dim)";
            var zBg=z.isRecommended?"#2ecc7115":"#1e2d3d";
            o+='<div style="background:'+zBg+';border:1px solid '+(z.isRecommended?"#2ecc7130":"#1e2d3d")+';border-radius:5px;padding:4px 8px;min-width:80px">';
            o+='<div style="font-size:8px;color:'+zClr+';font-weight:700">ZONE '+z.zone+'</div>';
            o+='<div style="font-size:10px;font-weight:700;color:var(--wht)">#'+fN(z.start)+'</div>';
            o+='<div style="font-size:8px;color:var(--dim)">â†’ #'+fN(z.end)+'</div></div>';
          });
          if(pg.zones.length>=12)o+='<div style="font-size:9px;color:var(--dim);align-self:center">+more</div>';
          o+='</div></div>';
        }
      }
      o+='</div>';


      // === v7.2: JACKPOT PREDICTIONS CARD ===
      var jpp=predictJackpotPacks(sel.g,sel,null);
      o+='<div class="C" style="border-color:#9b59b644">';
      o+='<div class="L" style="color:var(--pur);margin-bottom:8px">ðŸ”® PACK PREDICTIONS</div>';
      if(!jpp.valid){
        o+='<div style="font-size:11px;color:var(--dim)">'+esc(jpp.reason||'No remaining jackpot prizes.')+'</div>';
      }else{
        // Summary bar
        o+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">';
        [{l:"Packs Sold",v:fN(jpp.soldPacks)+"/"+fN(jpp.totalPacks)+" ("+Math.round(jpp.soldPacks/jpp.totalPacks*100)+"%)"},{l:"Remaining",v:fN(jpp.epr)},{l:"EV/Pack",v:"$"+jpp.evPerPack.toFixed(0),c:jpp.evPerPack>=sel.g.pr?"var(--grn)":"var(--red)"},{l:"Mid-Tier Shift",v:jpp.midShift.toFixed(2)+"x",c:jpp.midShift>=1.1?"var(--grn)":jpp.midShift>=0.9?"var(--dim)":"var(--red)"}].forEach(function(e){o+='<div class="cl"><div class="L" style="font-size:8px">'+e.l+'</div><div style="font-size:12px;font-weight:700;color:'+(e.c||"var(--wht)")+'">'+(e.v||"â€”")+'</div></div>';});
        o+='</div>';
        if(jpp.lastWinnerPack>0)o+='<div style="font-size:10px;color:var(--amb);margin-bottom:8px">Last known winner at pack #'+fN(jpp.lastWinnerPack)+'</div>';
        // Per-tier prediction cards
        jpp.predictions.forEach(function(p){
          var tierClr=p.role==="TOP"?"#d4a017":p.role==="TOP-1"?"#af7ac5":"#5a9bd5";
          var sigClr=p.signal==="STRONG"||p.signal==="GOOD"?"var(--grn)":p.signal==="NEUTRAL"?"var(--dim)":"var(--red)";
          var oddsStr=p.pPerPack<0.001?"1:"+fN(Math.round(1/p.pPerPack)):(p.pPerPack*100).toFixed(2)+"%";
          o+='<div style="margin-bottom:8px;padding:10px;background:var(--bg);border-radius:8px;border-left:3px solid '+tierClr+'">';
          // Header: prize amount + signal
          o+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
          o+='<div><span style="font-size:16px;font-weight:800;color:'+tierClr+'">$'+fN(p.prizeAmt)+'</span> <span style="font-size:10px;color:var(--dim)">('+p.role+')</span></div>';
          o+='<div style="padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;background:'+sigClr+'18;color:'+sigClr+'">'+p.signal+' '+p.densityShift.toFixed(2)+'x</div>';
          o+='</div>';
          // Key stats row
          o+='<div style="display:flex;gap:12px;flex-wrap:wrap;font-size:10px;margin-bottom:8px">';
          o+='<span><span class="d">Remaining:</span> <b>'+p.rem+'/'+p.printed+'</b></span>';
          o+='<span><span class="d">Odds/pack:</span> <b>'+oddsStr+'</b></span>';
          o+='<span><span class="d">Was:</span> 1:'+fN(p.launchOdds)+' <span class="d">â†’ Now:</span> 1:'+fN(p.currentOdds)+'</span>';
          o+='</div>';
          // Target pack
          o+='<div style="padding:8px;background:#9b59b610;border-radius:6px;margin-bottom:6px">';
          o+='<div style="font-size:10px;color:var(--dim);margin-bottom:2px">TARGET PACK RANGE</div>';
          o+='<div style="font-size:18px;font-weight:800;color:var(--grn)">#'+fN(p.rangeLow)+' â€” #'+fN(p.rangeHigh)+'</div>';
          o+='<div style="font-size:10px;color:var(--dim)">Best estimate: <b style="color:var(--wht)">#'+fN(p.bestPack)+'</b> ('+p.pctOfRun+'% into run)</div>';
          o+='</div>';
          // Probability breakdown
          o+='<div style="display:flex;gap:6px;font-size:9px">';
          o+='<div style="flex:1;padding:4px 6px;background:var(--card);border-radius:4px;text-align:center"><div class="d">25% chance</div><div style="font-weight:700">'+fN(p.p25)+' packs</div></div>';
          o+='<div style="flex:1;padding:4px 6px;background:var(--card);border-radius:4px;text-align:center"><div class="d">50% chance</div><div style="font-weight:700">'+fN(p.p50)+' packs</div></div>';
          o+='<div style="flex:1;padding:4px 6px;background:var(--card);border-radius:4px;text-align:center"><div class="d">75% chance</div><div style="font-weight:700">'+fN(p.p75)+' packs</div></div>';
          o+='</div>';
          o+='<div style="margin-top:4px;font-size:8px;color:var(--dim)">'+esc(p.basis)+' Â· Conf: <span style="font-weight:700;color:'+(p.confidence==='HIGH'?'var(--grn)':p.confidence==='MEDIUM'?'var(--amb)':'var(--red)')+'">'+p.confidence+'</span></div>';
          o+='</div>';
        });
        // Timeline visualization
        var soldPct3=(sel.mat||0)*100;
        o+='<div style="margin-top:6px"><div style="font-size:9px;font-weight:700;color:var(--dim);margin-bottom:4px">PACK TIMELINE</div>';
        o+='<div style="position:relative;height:36px;background:var(--bg);border-radius:6px;overflow:hidden">';
        o+='<div style="position:absolute;left:0;top:0;width:'+soldPct3+'%;height:100%;background:#ffffff08"></div>';
        jpp.predictions.forEach(function(p,idx){
          var tierClr2=p.role==="TOP"?"#d4a017":p.role==="TOP-1"?"#af7ac5":"#5a9bd5";
          var lp=(p.rangeLow/jpp.totalPacks)*100,hp=(p.rangeHigh/jpp.totalPacks)*100,cp=(p.bestPack/jpp.totalPacks)*100;
          o+='<div style="position:absolute;left:'+lp+'%;top:'+(8+idx*8)+'px;width:'+(hp-lp)+'%;height:8px;background:'+tierClr2+'33;border:1px solid '+tierClr2+'66;border-radius:2px" title="$'+fN(p.prizeAmt)+'"></div>';
          o+='<div style="position:absolute;left:'+cp+'%;top:'+(6+idx*8)+'px;width:2px;height:12px;background:'+tierClr2+'" title="Best: #'+fN(p.bestPack)+'"></div>';
        });
        o+='<div style="position:absolute;left:'+soldPct3+'%;top:0;width:2px;height:100%;background:var(--amb)"></div>';
        o+='</div>';
        o+='<div style="display:flex;gap:10px;margin-top:4px;font-size:9px;color:var(--dim);flex-wrap:wrap">';
        o+='<span><span style="color:var(--amb)">|</span> Sold ('+soldPct3.toFixed(0)+'%)</span>';
        jpp.predictions.forEach(function(p){var c=p.role==="TOP"?"#d4a017":p.role==="TOP-1"?"#af7ac5":"#5a9bd5";o+='<span><span style="color:'+c+'">â– </span> $'+fN(p.prizeAmt)+'</span>';});
        o+='</div></div>';
        o+='<div style="font-size:8px;color:var(--dim);margin-top:6px">âš  Estimates only â€” '+(jpp.winnerModel?'<span style="color:var(--grn)">'+esc(jpp.note)+'</span>':'based on hypergeometric probability + density shifts')+'</div>';
      }
      o+='</div>';

      // VALIDATION
      o+='<div class="C"><div class="L" style="margin-bottom:8px">VALIDATION</div>';

      if(sel.oddsCheck.valid===false&&sel.g.odds>0)o+='<div style="padding:6px 10px;background:var(--amb)18;border-radius:6px;font-size:11px;color:var(--amb);margin-bottom:8px">âš  Prize counts imply odds of 1:'+Math.round(sel.oddsCheck.computedOdds)+', published 1:'+sel.g.odds+' ('+pct(sel.oddsCheck.diff)+" diff)</div>";
      if(sel.yieldValid)o+='<div style="padding:6px 10px;background:var(--grn1);border-radius:6px;font-size:11px;color:var(--grn);margin-bottom:8px">âœ“ Implied yield '+pct(sel.impliedYield)+' within expected range.</div>';
      else if(sel.complete)o+='<div style="padding:6px 10px;background:var(--amb)18;border-radius:6px;font-size:11px;color:var(--amb);margin-bottom:8px">âš  Implied yield '+pct(sel.impliedYield)+' outside expected range.</div>';
      if(sel.btpInfo.valid&&!sel.btpInfo.floorValid&&sel.g.guar>0)o+='<div style="padding:6px 10px;background:var(--amb)18;border-radius:6px;font-size:11px;color:var(--amb);margin-bottom:8px">âš  Floor not validated. Published: $'+fN(sel.g.guar)+' vs computed: $'+fN(sel.btpInfo.computedFloor)+'</div>';
      else if(sel.btpInfo.valid&&sel.btpInfo.floorValid&&sel.g.guar>0)o+='<div style="padding:6px 10px;background:var(--grn1);border-radius:6px;font-size:11px;color:var(--grn);margin-bottom:8px">âœ“ Floor validated: $'+fN(sel.g.guar)+' matches prize structure.</div>';
      if(sel.hollowedOut)o+='<div style="padding:6px 10px;background:var(--red1);border-radius:6px;font-size:11px;color:var(--red);margin-bottom:8px">âš  HOLLOWED: Top prize remains but ALL mid-tier jackpots claimed.</div>';
      o+='<div style="display:flex;gap:10px;flex-wrap:wrap">';
      [{l:"Method A (BTP)",v:sel.methodA>0?fN(sel.methodA):"â€”"},{l:"Method B (Odds)",v:sel.methodB>0?fN(sel.methodB):"â€”"},{l:"Method C (Yield)",v:sel.methodC>0?fN(sel.methodC):"â€”"},{l:"Confidence",v:sel.dataConfidence,c:sel.dataConfidence==="HIGH"?"var(--grn)":sel.dataConfidence==="MEDIUM"?"var(--amb)":"var(--red)"}].forEach(function(e){o+='<div class="cl"><div class="L" style="font-size:8px">'+e.l+'</div><div style="font-size:13px;font-weight:700;color:'+(e.c||"var(--wht)")+'">'+e.v+'</div></div>';});
      o+='</div></div>';

      // SCORE BREAKDOWN
      o+='<div class="C"><div class="L" style="margin-bottom:8px">SCORE BREAKDOWN</div>';
      o+='<div style="font-size:11px;color:var(--dim);margin-bottom:8px">Base: 50 pts. Each factor adds or subtracts based on real prize claim data.</div>';
      var runTotal=50;
      sel.scoreBreakdown.forEach(function(s){
        runTotal+=s.p;
        var c=s.p>0?"var(--grn)":s.p<0?"var(--red)":"var(--dim)";
        o+='<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border)20">';
        o+='<div style="font-size:11px">'+esc(s.f)+'</div>';
        o+='<div style="font-size:11px;font-weight:700;color:'+c+'">'+(s.p>0?"+":"")+s.p+' â†’ <span style="color:var(--dim)">'+runTotal+'</span></div></div>';
      });
      o+='<div style="display:flex;justify-content:space-between;padding:6px 0;margin-top:4px"><div style="font-weight:700">FINAL SCORE</div><div style="font-size:16px;font-weight:800;color:'+selConfClr+'">'+sel.sc+'/100</div></div>';
      o+='</div>';

      // PRIZE TABLE
      o+='<div class="C"><div class="L" style="margin-bottom:8px">PRIZE TABLE</div>';
      o+='<div style="overflow-x:auto">';
      o+='<table><thead><tr><th style="text-align:left">Prize</th><th>Cat</th><th>Printed</th><th>Claimed</th><th>Left</th><th>% Clmd</th><th>LaunchOdds</th><th>NowOdds</th></tr></thead><tbody>';
      sel.prizes.forEach(function(p){
        var catClr=p.cat==="TOP"?"#d4a017":p.cat==="TOP-1"?"#af7ac5":p.cat==="TOP-2"?"#5a6a7a":p.cat==="BTP"?"var(--grn)":p.cat==="MID"?"var(--blu)":"var(--dim)";
        var leftClr=p.rem>0?"var(--grn)":"var(--red)";
        o+='<tr style="'+(p.isA?"background:#2ecc7108":"")+'">';
        o+='<td style="text-align:left;font-weight:700;color:'+catClr+';white-space:nowrap">$'+fN(p.a)+(p.highSens?' âš¡':'')+'</td>';
        o+='<td style="font-size:9px;font-weight:700;color:'+catClr+'">'+p.cat+'</td>';
        o+='<td>'+fN(p.p)+'</td><td>'+fN(p.c)+'</td>';
        o+='<td style="font-weight:700;color:'+leftClr+'">'+fN(p.rem)+'</td>';
        o+='<td>'+(p.p>0?p.pctC.toFixed(1):'â€”')+'%</td>';
        o+='<td class="d">'+fmtO(p.origO)+'</td>';
        o+='<td style="color:'+(p.rem>0&&p.currO<p.origO?"var(--grn)":p.rem<=0?"var(--red)":"var(--dim)")+'">'+( p.rem>0?fmtO(p.currO):'â€”')+'</td></tr>';
      });
      o+='</tbody></table></div></div>';

      // REMAINING POOL FORECAST
      var rpf=remainingPoolForecast(sel);
      if(rpf.valid){
        o+='<div class="C"><div class="L" style="margin-bottom:10px">REMAINING POOL FORECAST</div>';
        o+='<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">';
        [{l:"Total Rem Value",v:"$"+fN(Math.round(rpf.totalRemValue)),c:"var(--wht)"},{l:"Avg Per Pack",v:"$"+Math.round(rpf.totalRemValue/Math.max(1,rpf.epr)),c:"var(--wht)"},{l:"Jackpot Packs",v:fN(rpf.jackpotPacks)+" ("+pct(rpf.jackpotPct)+")",c:"var(--gld)"},{l:"Floor Only",v:fN(rpf.floorOnlyPacks)+" ("+pct(rpf.floorOnlyPacks/Math.max(1,rpf.epr))+")",c:"var(--dim)"}].forEach(function(e){o+='<div class="cl"><div class="L" style="font-size:8px">'+e.l+'</div><div style="font-size:13px;font-weight:700;color:'+e.c+'">'+e.v+'</div></div>';});
        o+='</div>';
        o+='<div style="height:24px;background:var(--bg);border-radius:6px;overflow:hidden;display:flex">';
        rpf.packCats.forEach(function(c){if(c.pct<=0)return;o+='<div style="width:'+(c.pct*100)+'%;height:100%;background:'+c.color+';opacity:.7" title="'+c.label+'"></div>';});
        o+='</div>';
        o+='<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px">';
        rpf.packCats.forEach(function(c){o+='<div style="font-size:9px;display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;border-radius:2px;background:'+c.color+';display:inline-block"></span>'+esc(c.label)+' '+pct(c.pct)+'</div>';});
        o+='</div></div>';
      }

      // FLAGS + AI PROMPT
      if(sel.flags.length){
        o+='<div class="C"><div class="L" style="margin-bottom:8px">FLAGS</div>';
        o+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
        sel.flags.forEach(function(fl){o+='<div style="padding:6px 12px;border-radius:8px;background:var(--'+fl.c+'1);border:1px solid var(--'+fl.c+')30"><div style="font-size:9px;font-weight:700;color:var(--'+fl.c+')">'+esc(fl.t)+'</div><div style="font-size:10px">'+esc(fl.m)+'</div></div>';});
        o+='</div></div>';
      }
      o+='<div class="C"><div class="L" style="margin-bottom:8px">AI ANALYSIS</div>';
      o+='<div style="display:flex;gap:8px;flex-wrap:wrap">';
      o+='<div class="B bn" onclick="copyAIPrompt(\''+(sel.g.id||String(sel.g.gn))+'\')">ðŸ“‹ Copy Game Prompt</div>';
      o+='<div class="B pn" onclick="showAIPrompt(\''+(sel.g.id||String(sel.g.gn))+'\')">ðŸ‘ Preview</div>';
      o+='<div class="B on" onclick="startPack(\''+(sel.g.id||String(sel.g.gn))+'\')">ðŸŽ° Start Pack Tracker</div>';
      o+='</div>';
      if(S._promptMsg)o+='<div style="color:var(--grn);font-weight:600;margin-top:6px">'+esc(S._promptMsg)+'</div>';
      if(S._promptPreview){
        o+='<pre style="margin-top:10px;background:var(--bg);border-radius:8px;padding:12px;font-size:10px;overflow-x:auto;max-height:400px;overflow-y:auto;white-space:pre-wrap;color:var(--text)">'+esc(S._promptPreview)+'</pre>';
        o+='<div class="B" style="margin-top:6px" onclick="S._promptPreview=null;render()">âœ• Close</div>';
      }
      o+='</div>';
    }
  }

  // ==================== INSIGHTS ====================
  if(S.tab==="insights"){
    var totGames=S.data.length;
    var compGames=S.data.filter(function(a){return a.complete}).length;
    var jkGames=S.data.filter(function(a){return a.btpInfo.hasJackpot}).length;
    var buyGames=S.data.filter(function(a){return a.confidence>=70&&a.btpInfo.hasJackpot}).length;
    var avoidGames=S.data.filter(function(a){return a.confidence<30&&a.btpInfo.hasJackpot}).length;
    var closingWithJk=S.data.filter(function(a){return a.g.cs&&a.tpr>0&&a.btpInfo.hasJackpot});
    var newGames=S.data.filter(function(a){return a.mat<0.15&&a.complete&&a.btpInfo.hasJackpot});
    var topConcentrated=S.data.filter(function(a){return a.jackpotDensityShift>=1.3});
    var topDepleted=S.data.filter(function(a){return a.tpr===0&&a.btpInfo.hasJackpot});

    // === MARKET SNAPSHOT â€” dynamic narrative ===
    o+='<div class="C" style="border-color:#2ecc7144"><div style="font-size:14px;font-weight:800;margin-bottom:8px">ðŸ“Š MARKET SNAPSHOT</div>';
    o+='<div style="font-size:12px;line-height:1.8">';
    o+='Analyzing <strong class="w">'+compGames+'</strong> complete games, <strong class="w">'+jkGames+'</strong> with trackable top prizes. ';
    if(buyGames>0)o+='<strong class="g">'+buyGames+' game'+(buyGames>1?"s":"")+'</strong> at 70%+ confidence (buy candidates). ';
    else o+='<span class="a">No games at 70%+ confidence.</span> ';
    if(closingWithJk.length>0)o+='<strong class="a">'+closingWithJk.length+' closing</strong> with jackpots â€” time-sensitive. ';
    if(newGames.length>0)o+='<strong class="b">'+newGames.length+' new game'+(newGames.length>1?"s":"")+'</strong> (<15% sold) â€” full prize pools. ';
    if(topConcentrated.length>0)o+='<strong class="g">'+topConcentrated.length+'</strong> with 1.3x+ jackpot density. ';
    if(topDepleted.length>0)o+='<strong class="r">'+topDepleted.length+'</strong> with ALL top prizes gone. ';
    o+='</div>';
    o+='<div class="G" style="grid-template-columns:repeat(auto-fit,minmax(80px,1fr));margin-top:10px">';
    [{l:"TOTAL",v:totGames,c:"var(--wht)",f:"all"},{l:"WITH TOP",v:jkGames,c:"var(--blu)",f:"top"},{l:"BUY 70%+",v:buyGames,c:"var(--grn)",f:"buy"},{l:"AVOID <30%",v:avoidGames,c:"var(--red)",f:"avoid"},{l:"CLOSING",v:closingWithJk.length,c:"var(--amb)",f:"closing"},{l:"NEW <15%",v:newGames.length,c:"var(--blu)",f:"new"},{l:"JK 1.3x+",v:topConcentrated.length,c:"var(--pur)",f:"concentrated"},{l:"TOP GONE",v:topDepleted.length,c:"var(--red)",f:"depleted"}].forEach(function(m){
      o+='<div class="cl" style="cursor:pointer" onclick="setInsightFilter(\''+m.f+'\')"><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:18px;font-weight:800;color:'+m.c+'">'+m.v+'</div></div>';});
    o+='</div></div>';

    // Cluster detection â€” which price point has the hottest pool?
    var priceCluster={};S.data.forEach(function(a){if(!a.complete||!a.btpInfo.hasJackpot)return;if(!priceCluster[a.g.pr])priceCluster[a.g.pr]={count:0,buys:0,avgDensity:0,totalDensity:0};var pc2=priceCluster[a.g.pr];pc2.count++;pc2.totalDensity+=a.jackpotDensityShift;pc2.avgDensity=pc2.totalDensity/pc2.count;if(a.confidence>=70)pc2.buys++;});
    var hotPrices=Object.keys(priceCluster).filter(function(p){return priceCluster[p].buys>=2}).sort(function(a,b){return priceCluster[b].avgDensity-priceCluster[a].avgDensity});
    if(hotPrices.length>0){
      o+='<div style="margin-top:8px;padding:8px 12px;background:var(--bg);border-radius:8px;font-size:12px;line-height:1.6">';
      o+='<strong style="color:var(--pur)">Cluster insight:</strong> ';
      hotPrices.forEach(function(hp,idx){
        var pc3=priceCluster[hp];
        o+='The <strong>$'+hp+'</strong> tier has '+pc3.buys+' buy candidates out of '+pc3.count+' games (avg density '+pc3.avgDensity.toFixed(2)+'x). ';
      });
      o+='</div>';
    }
    var byPrice={};S.data.forEach(function(a){if(!a.complete||!a.btpInfo.hasJackpot)return;if(!byPrice[a.g.pr]||a.sc>byPrice[a.g.pr].sc)byPrice[a.g.pr]=a;});
    var priceKeys=Object.keys(byPrice).sort(function(a,b){return Number(a)-Number(b)});
    if(priceKeys.length>1){
      o+='<div class="C" style="border-color:#3498db44"><div style="font-size:14px;font-weight:800;margin-bottom:8px;color:var(--blu)">ðŸ’° BEST PER PRICE POINT</div>';
      priceKeys.forEach(function(pr2){
        var a=byPrice[pr2];var cnt=S.data.filter(function(x){return x.g.pr===Number(pr2)&&x.btpInfo.hasJackpot}).length;
        var scClr=a.confidence>=70?"var(--grn)":a.confidence>=40?"var(--amb)":"var(--red)";
        var reason="";
        if(a.jackpotDensityShift>=1.3)reason="Jackpots "+a.jackpotDensityShift.toFixed(1)+"x concentrated";
        else if(a.g.cs&&a.tpr>0)reason="Closing with "+a.tpr+" top prizes";
        else if(a.gm.sig==="STRONG_BUY"||a.gm.sig==="BUY")reason="Markov: "+a.gm.sig.replace(/_/g," ").toLowerCase();
        else if(a.tpr===a.tp.p)reason="All "+a.tp.p+" top prizes available";
        else reason="Best of "+cnt+" games";
        o+='<div class="ck" onclick="openDetail(\''+(a.g.id||String(a.g.gn))+'\')" style="display:flex;justify-content:space-between;align-items:center;padding:8px;margin-bottom:4px;background:var(--bg);border-radius:6px;border-left:3px solid '+scClr+'">';
        o+='<div><span style="font-size:12px;font-weight:800;color:'+prClr(Number(pr2))+'">$'+pr2+'</span> <span style="font-size:12px;font-weight:700;color:var(--wht)">'+esc(a.g.nm)+'</span> <span class="d">#'+a.g.gn+'</span>';
        o+='<div style="font-size:10px;color:var(--dim)">'+reason+' Â· '+cnt+' game'+(cnt>1?"s":"")+'</div></div>';
        o+='<div style="font-size:20px;font-weight:800;color:'+scClr+'">'+a.sc+'</div></div>';
      });
      o+='</div>';
    }

    // === AI PROMPT ===
    o+='<div class="C" style="border-color:#9b59b644"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px"><div><div style="font-size:14px;font-weight:800;color:#9b59b6">ðŸ§  AI ANALYSIS</div><div style="font-size:10px" class="d">Full context prompt for any AI</div></div>';
    o+='<div class="B pn" onclick="copyAllPrompt()">ðŸ“‹ Copy All</div><div class="B pn" onclick="showAllPrompt()">ðŸ‘ Preview</div></div>';
    if(S._allPromptPreview){o+='<div style="margin-top:8px"><div style="display:flex;justify-content:space-between"><div class="L" style="color:#9b59b6">PROMPT</div><div class="B" style="font-size:9px;padding:2px 8px" onclick="S._allPromptPreview=null;render()">âœ•</div></div><pre style="font-size:10px;white-space:pre-wrap;word-break:break-word;max-height:500px;overflow-y:auto;background:var(--bg);padding:8px;border-radius:6px;margin:6px 0 0">'+esc(S._allPromptPreview)+'</pre></div>';}
    o+='</div>';

    // === DYNAMIC NARRATIVE PATTERN RECOGNITION ===
    // Build ONE rich narrative per game instead of fragmented signals
    function buildNarrative(a){
      var g=a.g,parts=[],action="",actionClr="",icon="";
      var pkLeft=a.epr>0?fN(a.epr):"?";
      var pctTopLeft=a.tp.p>0?Math.round(a.tpr/a.tp.p*100):0;
      var pctRemain=Math.round((1-a.mat)*100);

      // Determine primary action â€” uses raw pts + confidence
      if(a.tpr===0){action="SKIP";actionClr="var(--red)";icon="âŒ";}
      else if(a.gm.sig==="DEAD"){action="DEAD";actionClr="var(--red)";icon="ðŸ’€";}
      else if(a.confidence>=85){action="STANDOUT";actionClr="var(--grn)";icon="ðŸ”¥";}
      else if(a.g.cs&&a.tpr>0&&a.sc>=55){action="CLOSING â€” ACT NOW";actionClr="var(--amb)";icon="â°";}
      else if(a.mat<0.10&&a.complete){action="NEW GAME";actionClr="var(--blu)";icon="ðŸ†•";}
      else if(a.mat<0.15&&a.complete){action="EARLY â€” WATCH";actionClr="var(--blu)";icon="ðŸŒ±";}
      else if(a.confidence>=70){action="ABOVE FIELD";actionClr="var(--grn)";icon="ðŸŸ¢";}
      else if(a.confidence>=50){action="AVERAGE";actionClr="var(--amb)";icon="ðŸ‘€";}
      else if(a.confidence>=30){action="BELOW FIELD";actionClr="var(--dim)";icon="âšª";}
      else{action="AVOID";actionClr="var(--red)";icon="ðŸ”´";}

      // Build narrative sentences based on what's INTERESTING about this game
      // 1. Lifecycle position
      if(a.g.cs&&a.tpr>0){
        parts.push("Game is CLOSING with "+a.tpr+" of "+a.tp.p+" top prizes ($"+fN(a.tp.a)+") still out there in only "+pkLeft+" remaining packs. Once pulled from stores, unclaimed prizes are gone forever.");
      }else if(a.g.cs&&a.tpr===0){
        parts.push("Game is closing and all top prizes are claimed. Nothing to chase.");
      }else if(a.mat<0.05){
        parts.push("Just launched â€” only "+pct(a.mat)+" sold. Full prize pool intact: all "+a.tp.p+" top prizes ($"+fN(a.tp.a)+") available. Density data is still thin this early so score is dampened, but this is a fresh game to monitor.");
      }else if(a.mat<0.15){
        parts.push("Early stage at "+pct(a.mat)+" sold. All "+a.tpr+" of "+a.tp.p+" top prizes remain. The analysis will sharpen as more tickets sell â€” right now the signals are preliminary.");
      }

      // 2. The jackpot story â€” what makes this game interesting or not
      if(a.tpr===0){
        parts.push("All "+a.tp.p+" top prizes ($"+fN(a.tp.a)+") are gone."+(a.prizes.length>1?" Biggest remaining win is $"+fN(a.prizes[1].a)+".":"")+" Floor is $"+fN(a.floorEV)+" on a $"+fN(a.packPrice)+" pack â€” you're guaranteed to lose $"+fN(a.packPrice-a.floorEV)+" per pack minimum.");
      }else if(a.jackpotDensityShift>=1.5){
        parts.push("Jackpot prizes are "+a.jackpotDensityShift.toFixed(2)+"x MORE concentrated in remaining packs than at launch. "+pct(a.mat)+" of tickets sold but "+pctTopLeft+"% of top prizes remain â€” they're disproportionately sitting in unsold packs. Your odds per pack: "+(a.hyperNow>=0.01?pct(a.hyperNow):"1 in "+fN(Math.round(1/a.hyperNow)))+" ("+(a.hyperRatio).toFixed(1)+"x better than day one).");
      }else if(a.jackpotDensityShift>=1.15){
        parts.push("Jackpot density is "+a.jackpotDensityShift.toFixed(2)+"x launch. "+a.tpr+"/"+a.tp.p+" top prizes ($"+fN(a.tp.a)+") remain in "+pkLeft+" packs â€” moderately favorable. Odds per pack: "+(a.hyperNow>=0.01?pct(a.hyperNow):"1 in "+fN(Math.round(1/a.hyperNow)))+", "+a.hyperRatio.toFixed(2)+"x vs launch.");
      }else if(a.jackpotDensityShift>=0.85&&a.jackpotDensityShift<1.15&&a.mat>0.15){
        parts.push("Jackpot density is "+a.jackpotDensityShift.toFixed(2)+"x â€” tracking roughly proportional to sales. "+a.tpr+"/"+a.tp.p+" top prizes remain. No significant concentration advantage.");
      }else if(a.jackpotDensityShift<0.85&&a.jackpotDensityShift>0&&a.tpr>0){
        parts.push("Jackpot density is only "+a.jackpotDensityShift.toFixed(2)+"x â€” prizes are being claimed FASTER than tickets are selling. Only "+pctTopLeft+"% of top prizes left but "+pctRemain+"% of packs remain. Bad ratio â€” the good packs have already been sold.");
      }

      // 3. Per-tier oddities
      for(var jj=0;jj<a.jackpotShifts.length;jj++){
        var js=a.jackpotShifts[jj];
        if(js.remaining===0&&js.printed>0){
          parts.push("âš  All "+js.printed+" prizes at $"+fN(js.a)+" are gone.");
        }else if(js.shift>=2.0&&js.remaining>0){
          parts.push("ðŸŽ¯ The $"+fN(js.a)+" tier is "+js.shift.toFixed(1)+"x concentrated â€” "+js.remaining+"/"+js.printed+" left. Pack odds: 1 in "+fN(js.currentOdds)+" (was 1 in "+fN(js.launchOdds)+").");
        }else if(js.shift<0.5&&js.remaining>0&&a.mat>0.2){
          parts.push("âš  The $"+fN(js.a)+" tier is depleted at "+js.shift.toFixed(2)+"x â€” being claimed much faster than expected.");
        }
        if(js.printed<=5&&js.remaining>0){
          parts.push("âš¡ Only "+js.printed+" $"+fN(js.a)+" prizes exist total â€” each claim swings odds dramatically.");
        }
      }

      // 4. Markov oddities â€” only mention if signal is strong or contradicts density
      if(a.gm.sig==="STRONG_BUY"&&a.jackpotDensityShift<1.1){
        parts.push("Interesting: Markov says STRONG BUY (claim rates underclaim) but density is only "+a.jackpotDensityShift.toFixed(2)+"x. The claim pattern favors you even though the raw ratio is neutral.");
      }else if(a.gm.sig==="AVOID"&&a.jackpotDensityShift>1.1){
        parts.push("Contradiction: Density is "+a.jackpotDensityShift.toFixed(2)+"x (good) but Markov says AVOID â€” jackpot tiers are being claimed faster than the sales clock. The concentration may be eroding.");
      }else if(a.gm.sig==="STRONG_BUY"){
        parts.push("Markov confirms: both jackpot AND mid-tier prizes are underclaimed relative to sales â€” remaining packs are enriched at multiple levels.");
      }else if(a.gm.sig==="AVOID"){
        parts.push("Markov warns: jackpot prizes depleting faster than tickets are selling.");
      }

      // 5. Hollowed out
      if(a.hollowedOut){
        parts.push("HOLLOWED: Top prize ($"+fN(a.tp.a)+") still exists but intermediate jackpot tiers are depleted. No stepping stones â€” it's either floor ($"+fN(a.floorEV)+") or the big one.");
      }

      // 6. Return gap â€” only mention if significant
      if(a.returnGap>0.05){
        parts.push("Cross-check: remaining packs return "+(a.returnGap*100).toFixed(1)+"% more per dollar than sold packs (across ALL prize tiers, not just jackpot).");
      }else if(a.returnGap<-0.05){
        parts.push("Cross-check: remaining packs are "+(Math.abs(a.returnGap)*100).toFixed(1)+"% THINNER than sold packs â€” prize pool depleted disproportionately.");
      }

      // 7. Data quality
      if(a.dataConfidence==="LOW"&&a.complete){
        parts.push("âš  LOW confidence â€” the three packs-sold estimation methods disagree by >10%. Treat this analysis cautiously.");
      }
      if(!a.yieldValid&&a.complete){
        parts.push("âš  Implied yield "+pct(a.impliedYield)+" is outside expected range â€” possible data quality issue.");
      }

      // 8. Oddities and anomalies
      // Almost-gone top prize (1 left)
      if(a.tpr===1&&a.tp.p>1){
        parts.push("ðŸ”´ Only 1 top prize ($"+fN(a.tp.a)+") left out of "+a.tp.p+" originally. Next claim kills this game.");
      }
      // All top prizes still exist in mature game
      if(a.tpr===a.tp.p&&a.mat>0.4){
        parts.push("Unusual: "+pct(a.mat)+" of tickets sold but ALL "+a.tp.p+" top prizes ($"+fN(a.tp.a)+") still untouched. Either very rare or they're concentrated in remaining unsold territory.");
      }
      // Very high jackpot EV relative to pack cost
      if(a.jackpotEV>0&&a.packPrice>0&&a.jackpotEV/a.packPrice>0.15){
        parts.push("Notable: Jackpot EV alone is $"+a.jackpotEV.toFixed(2)+" per $"+fN(a.packPrice)+" pack â€” "+pct(a.jackpotEV/a.packPrice)+" of cost coming from rare prizes.");
      }
      // Score much higher than similar games at same price
      var samePrice=S.data.filter(function(x){return x.g.pr===g.pr&&x.btpInfo.hasJackpot&&x.complete});
      if(samePrice.length>=3){
        var avgSc=samePrice.reduce(function(s,x){return s+x.sc},0)/samePrice.length;
        if(a.sc>avgSc+20){
          parts.push("Stands out: score "+a.sc+" is "+Math.round(a.sc-avgSc)+" points above the $"+g.pr+" average ("+Math.round(avgSc)+"). Top pick at this price.");
        }else if(a.sc<avgSc-15){
          parts.push("Below average: score "+a.sc+" is "+Math.round(avgSc-a.sc)+" points below the $"+g.pr+" average ("+Math.round(avgSc)+").");
        }
      }

      // 9. Ranking context â€” where does this game sit overall?
      var allScored=S.data.filter(function(x){return x.complete&&x.btpInfo.hasJackpot}).sort(function(x,y){return y.sc-x.sc});
      var rank=allScored.findIndex(function(x){return x.g.id===a.g.id||String(x.g.gn)===String(a.g.gn)})+1;
      if(rank>0&&allScored.length>=5){
        if(rank<=3)parts.push("Ranked #"+rank+" of "+allScored.length+" games with jackpot tiers.");
        else if(rank>=allScored.length-2)parts.push("Ranked #"+rank+" of "+allScored.length+" â€” near bottom.");
      }

      // 10. Fragility â€” how sensitive is this score to the next claim?
      if(a.tpr>0&&a.tpr<=3&&a.tp.p>1){
        // Calculate what density shift would be if one more top prize is claimed
        var densityLaunch=a.pc>0?a.tp.p/a.pc:0;
        var shiftIfClaimed=a.tpr>1&&densityLaunch>0?((a.tpr-1)/a.epr)/densityLaunch:0;
        if(a.tpr===1) parts.push("Fragile: If the last top prize is claimed, this game dies. Act now or don't bother.");
        else parts.push("Fragility check: If 1 more top prize is claimed, density drops from "+a.jackpotDensityShift.toFixed(2)+"x to ~"+shiftIfClaimed.toFixed(2)+"x. Signal "+(shiftIfClaimed>1.1?"would survive":"may weaken significantly")+".");
      }

      // 11. Opportunity window for closing games
      if(a.g.cs&&a.tpr>0&&a.epr>0){
        var weeksLeft=a.epr>10000?">4 weeks":a.epr>5000?"2-4 weeks":a.epr>1000?"1-2 weeks":"days";
        parts.push("Time estimate: ~"+pkLeft+" packs remain at retail. At current claim rates, estimated "+weeksLeft+" before game is pulled.");
      }

      // EV summary line
      if(a.floorEV>0&&a.packPrice>0&&a.tpr>0){
        parts.push("EV breakdown: Floor $"+fN(a.floorEV)+" (guaranteed) + mid $"+Math.round(a.midRangeEV)+" + jackpot $"+a.jackpotEV.toFixed(2)+" = $"+Math.round(a.totalEV)+" total vs $"+fN(a.packPrice)+" cost ("+(a.edge>0?"+":"")+pct(a.edge)+" edge).");
      }

      return{action:action,actionClr:actionClr,icon:icon,text:parts.join(" "),score:a.sc,id:(a.g.id||String(a.g.gn)),pr:g.pr,name:g.nm+" #"+g.gn,isClosing:!!g.cs,isNew:a.mat<0.15&&a.complete};
    }

    // Generate narratives for all games worth showing
    var narratives=[];
    S.data.forEach(function(a){
      if(!a.complete||!a.btpInfo.hasJackpot)return;
      // Show game if it has ANY interesting signal
      var dominated=false;
      if(a.confidence>=70||a.confidence<=25)dominated=true; // standout or weak
      if(a.g.cs&&a.tpr>0)dominated=true; // closing with prizes
      if(a.mat<0.15)dominated=true; // new game
      if(a.jackpotDensityShift>=1.3||a.jackpotDensityShift<=0.7)dominated=true; // strong density signal
      if(a.gm.sig==="STRONG_BUY"||a.gm.sig==="AVOID"||a.gm.sig==="DEAD")dominated=true;
      if(a.tpr===0)dominated=true; // top gone
      if(a.hollowedOut)dominated=true;
      if(Math.abs(a.returnGap)>0.05)dominated=true; // big return gap
      if(a.tpr===1&&a.tp.p>1)dominated=true; // last top prize
      if(a.tpr===a.tp.p&&a.mat>0.4)dominated=true; // all top intact in mature game
      if(a.jackpotEV>0&&a.packPrice>0&&a.jackpotEV/a.packPrice>0.15)dominated=true; // high jk EV ratio
      // Contradictions
      if(a.gm.sig==="AVOID"&&a.jackpotDensityShift>1.1)dominated=true;
      if(a.gm.sig==="STRONG_BUY"&&a.jackpotDensityShift<1.1)dominated=true;

      if(dominated)narratives.push(buildNarrative(a));
    });

    // Sort: closing first, then new games, then by score
    narratives.sort(function(a,b){
      // Closing first
      if(a.isClosing&&!b.isClosing)return -1;
      if(!a.isClosing&&b.isClosing)return 1;
      // New games second
      if(a.isNew&&!b.isNew)return -1;
      if(!a.isNew&&b.isNew)return 1;
      // Then by score
      return b.score-a.score;
    });

    o+='<div class="C"><div style="font-size:14px;font-weight:800">ðŸ” GAME ANALYSIS</div><div style="font-size:11px" class="d">'+narratives.length+' games with notable patterns out of '+totGames+' total. Sorted: closing â†’ new â†’ score.</div></div>';

    narratives.forEach(function(n){
      o+='<div class="C ck" onclick="openDetail(\''+n.id+'\')" style="border-left:3px solid '+n.actionClr+'">';
      o+='<div style="display:flex;justify-content:space-between;gap:8px"><div style="flex:1;min-width:0">';
      // Header: icon + action + price badge + name
      o+='<div style="display:flex;gap:6px;align-items:center;margin-bottom:4px;flex-wrap:wrap">';
      o+='<span style="font-size:11px;font-weight:800;color:'+n.actionClr+'">'+n.icon+' '+esc(n.action)+'</span>';
      o+='<span style="font-size:9px;font-weight:800;color:#fff;background:'+prClr(n.pr)+';padding:1px 6px;border-radius:3px">$'+n.pr+'</span>';
      o+='</div>';
      o+='<div style="font-size:14px;font-weight:700;color:var(--wht)">'+esc(n.name)+'</div>';
      // Narrative text
      o+='<div style="font-size:11px;color:var(--text);margin-top:6px;line-height:1.6">'+esc(n.text)+'</div>';
      o+='</div>';
      // Score
      o+='<div style="text-align:right;flex-shrink:0"><div style="font-size:24px;font-weight:800;color:'+n.actionClr+'">'+n.score+'</div><div style="font-size:9px;color:var(--dim)">SCORE</div></div>';
      o+='</div></div>';
    });
  }

  // ==================== WINNERS ====================
  if(S.tab==="winners"){
    o+='<div class="C"><div class="L" style="margin-bottom:8px">WINNER DATA</div>';
    o+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">';
    o+='<div class="B bn" onclick="fetchWinners()">'+(S._fetching?'â³ Loading...':'â†“ FETCH WINNERS')+'</div>';
    if(S.winModel&&S.winModel.valid)o+='<div style="font-size:10px;color:var(--grn);align-self:center">âœ“ Winner model active</div>';
    o+='</div>';
    if(!S.winData){o+='<div style="font-size:11px;color:var(--dim)">No winner data loaded.</div></div>';document.getElementById("app").innerHTML=o;return;}
    var allWinners=[];
    Object.keys(S.winData).forEach(function(gn){
      var recs=S.winData[gn];
      recs.forEach(function(r){allWinners.push({gn:gn,date:r.date,store:r.store,city:r.city,zip:r.zip,pn:r.pn,tk:r.tk});});
    });
    var wq=S.winSearch.toLowerCase().trim();
    var wf2=allWinners;
    if(S.winGame)wf2=wf2.filter(function(w){return w.gn===S.winGame;});
    if(wq)wf2=wf2.filter(function(w){var nm='';for(var i=0;i<GD.length;i++)if(String(GD[i].gn)===w.gn){nm=GD[i].nm;break;}return w.store.toLowerCase().indexOf(wq)>=0||w.city.toLowerCase().indexOf(wq)>=0||String(w.gn).indexOf(wq)>=0||nm.toLowerCase().indexOf(wq)>=0;});
    var wsorts={date:function(a,b){return S.winSortDir*(new Date(b.date)-new Date(a.date))},pn:function(a,b){return S.winSortDir*(b.pn-a.pn)},city:function(a,b){return S.winSortDir*a.city.localeCompare(b.city)}};
    wf2.sort(wsorts[S.winSort]||wsorts.date);
    var gnList=Object.keys(S.winData).sort(function(a,b){
      var gA=null,gB=null;for(var i=0;i<GD.length;i++){if(String(GD[i].gn)===a)gA=GD[i];if(String(GD[i].gn)===b)gB=GD[i];}
      var pA=gA?gA.pr:0,pB=gB?gB.pr:0;if(pA!==pB)return pB-pA;return a.localeCompare(b);});
    o+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">';
    o+='<input class="I" type="text" placeholder="Search store, city, game name or #..." value="'+esc(S.winSearch)+'" oninput="winSearchInput(this.value)" style="flex:1;min-width:150px">';
    o+='<select class="I" style="flex:1;min-width:120px" onchange="winGameFilter(this.value)"><option value="">All Games ('+allWinners.length+' records)</option>';
    gnList.forEach(function(gn){var gObj=null;for(var i=0;i<GD.length;i++)if(String(GD[i].gn)===gn){gObj=GD[i];break;}var nm=gObj?gObj.nm:'';var pr=gObj?'$'+gObj.pr:'';o+='<option value="'+gn+'"'+(S.winGame===gn?" selected":"")+'>'+pr+' | '+esc(nm)+' #'+gn+' ('+S.winData[gn].length+' claims)</option>';});
    o+='</select></div>';
    o+='<div style="font-size:11px;color:var(--dim);margin-bottom:8px">'+wf2.length+' records | ';
    [["date","Date"],["pn","Pack#"],["city","City"]].forEach(function(s){o+='<span style="cursor:pointer;color:'+(S.winSort===s[0]?"var(--grn)":"var(--dim)")+'" onclick="winSortBy(\''+s[0]+'\')">'+(S.winSort===s[0]?(S.winSortDir>0?"â†‘":"â†“")+" ":"")+s[1]+'</span> ';});
    o+='</div>';
    o+='<div style="overflow-x:auto"><table><thead><tr>';
    o+='<th style="text-align:left">Game</th><th style="text-align:left">Name</th><th>Price</th><th style="text-align:left">Date</th><th style="text-align:left">Store</th><th style="text-align:left">City</th><th>Pack #</th><th>Ticket</th></tr></thead><tbody>';
    wf2.slice(0,200).forEach(function(w){
      var gObj=null;for(var gi=0;gi<GD.length;gi++)if(String(GD[gi].gn)===w.gn){gObj=GD[gi];break;}
      o+='<tr><td style="font-weight:700">#'+w.gn+'</td><td style="text-align:left;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(gObj?gObj.nm:'')+'</td><td>'+(gObj?'$'+gObj.pr:'')+'</td><td>'+esc(w.date)+'</td><td style="text-align:left;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(w.store)+'</td><td style="text-align:left">'+esc(w.city)+'</td><td style="font-weight:700;color:var(--grn)">'+(w.pn>0?fN(w.pn):"â€”")+'</td><td>'+(w.tk||"â€”")+'</td></tr>';
    });
    o+='</tbody></table></div>';
    if(wf2.length>200)o+='<div style="font-size:11px;color:var(--dim);margin-top:6px">Showing 200 of '+wf2.length+' records.</div>';
    o+='</div>';
  }

  // ==================== MORE ====================
  if(S.tab==="more"){
    o+='<div class="tabs" style="margin-bottom:14px">';
    [["pack","PACK TRACKER"],["session","SESSIONS"],["settings","SETTINGS"]].forEach(function(t){o+='<div class="T'+(S.moreTab===t[0]?" on":"")+'" onclick="setMore(\''+t[0]+'\')">'+t[1]+'</div>';});
    o+='</div>';

    if(S.moreTab==="pack"){
      var pk=S.pack,v=mkv();
      o+='<div class="C"><div class="L" style="margin-bottom:8px">PACK TRACKER â€” '+esc(pk.nm||"No game selected")+'</div>';
      o+='<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">';
      [{l:"Tickets",v:pk.log.length+"/"+pk.pk,c:"var(--wht)"},{l:"Spent",v:"$"+fN(pk.spent),c:"var(--red)"},{l:"Won",v:"$"+fN(pk.won),c:"var(--grn)"},{l:"P/L",v:(pk.won-pk.spent>=0?"+":"")+"$"+fN(pk.won-pk.spent),c:pk.won>=pk.spent?"var(--grn)":"var(--red)"},{l:"Anchor",v:pk.af?"FOUND":"â€”",c:pk.af?"var(--gld)":"var(--dim)"}].forEach(function(e){o+='<div class="cl"><div class="L" style="font-size:8px">'+e.l+'</div><div style="font-size:14px;font-weight:800;color:'+e.c+'">'+e.v+'</div></div>';});
      o+='</div>';
      if(v){var decClr=v.dec==="BUY"?"var(--grn)":v.dec==="STOP"?"var(--red)":v.dec==="CONSIDER"?"var(--amb)":"var(--dim)";
        o+='<div style="padding:10px;background:var(--bg);border-radius:8px;margin-bottom:10px;border-left:4px solid '+decClr+'"><div style="font-size:18px;font-weight:800;color:'+decClr+'">'+v.dec+'</div><div style="font-size:11px;margin-top:2px">'+esc(v.rsn)+'</div><div style="font-size:11px;color:var(--dim);margin-top:2px">'+v.rem+' tickets left Â· Expected winners: '+v.wl+'</div></div>';}
      o+='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">';
      [0,pk.pr,pk.aa].forEach(function(a){o+='<div class="B'+(a>=pk.aa&&a>0?" on":"")+'" onclick="scratch('+a+')" style="padding:10px 16px;font-size:13px">'+(a===0?"$0":a>=pk.aa?"â­ $"+fN(a):"$"+fN(a))+'</div>';});
      o+='<div class="B rn" onclick="scratch(0)">$0 LOSER</div>';
      o+='</div>';
      o+='<div style="display:flex;gap:6px;flex-wrap:wrap">';
      o+='<div class="B" onclick="resetPack()">â†º Reset Pack</div>';
      o+='<div class="B on" onclick="saveSession()">ðŸ’¾ Save Session</div></div></div>';
      if(pk.log.length>0){
        o+='<div class="C"><div class="L" style="margin-bottom:8px">PACK LOG</div>';
        o+='<div style="display:flex;flex-wrap:wrap;gap:4px">';
        pk.log.forEach(function(l,i){var c=l.amt>=pk.aa?"var(--gld)":l.amt>0?"var(--grn)":"var(--dim)";o+='<div style="padding:3px 8px;border-radius:5px;background:'+c+'18;border:1px solid '+c+'30;font-size:10px;font-weight:600;color:'+c+'">'+i+1+': '+(l.amt===0?"$0":"$"+fN(l.amt))+'</div>';});
        o+='</div></div>';
      }
    }

    if(S.moreTab==="session"){
      o+='<div class="C"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div class="L" style="margin-bottom:0">SESSION HISTORY ('+S.sessions.length+')</div>'+(S.sessions.length?'<div class="B rn" onclick="clearSess()" style="font-size:9px;padding:4px 10px">Clear All</div>':'')+'</div>';
      if(!S.sessions.length){o+='<div style="color:var(--dim);font-size:11px">No sessions saved.</div>';}
      else{var totW=0,totS=0;S.sessions.forEach(function(s){totW+=s.w;totS+=s.s;});
        o+='<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">';
        [{l:"Sessions",v:S.sessions.length,c:"var(--wht)"},{l:"Total Spent",v:"$"+fN(totS),c:"var(--red)"},{l:"Total Won",v:"$"+fN(totW),c:"var(--grn)"},{l:"Overall P/L",v:(totW-totS>=0?"+":"")+"$"+fN(totW-totS),c:totW>=totS?"var(--grn)":"var(--red)"},{l:"Anchors",v:S.sessions.filter(function(s){return s.af}).length,c:"var(--gld)"}].forEach(function(e){o+='<div class="cl"><div class="L" style="font-size:8px">'+e.l+'</div><div style="font-size:14px;font-weight:800;color:'+e.c+'">'+e.v+'</div></div>';});
        o+='</div>';
        // Session Learnings â€” feedback loop insights
        var _learn=S._learnings||getSessionLearnings();
        if(_learn&&_learn.valid){
          o+='<div class="C" style="border-color:var(--pur)44"><div class="L" style="color:var(--pur)">ðŸ§  WHAT YOUR DATA SHOWS</div>';
          o+='<div style="font-size:11px;margin-top:4px;line-height:1.7">';
          o+='Overall return: <strong style="color:'+(_learn.total.ret>=0.5?'var(--grn)':'var(--red)')+'">'+Math.round(_learn.total.ret*100)+'%</strong> ($'+fN(_learn.total.won)+' won on $'+fN(_learn.total.spent)+' spent)<br>';
          if(_learn.byScore.hi.n>=2)o+='High-score games (65+): <strong>'+Math.round(_learn.byScore.hi.avg*100)+'%</strong> return ('+_learn.byScore.hi.n+' packs)<br>';
          if(_learn.byScore.mid.n>=2)o+='Mid-score games (45-64): <strong>'+Math.round(_learn.byScore.mid.avg*100)+'%</strong> return ('+_learn.byScore.mid.n+' packs)<br>';
          if(_learn.byScore.lo.n>=2)o+='Low-score games (<45): <strong>'+Math.round(_learn.byScore.lo.avg*100)+'%</strong> return ('+_learn.byScore.lo.n+' packs)<br>';
          if(_learn.scoreWorks===true)o+='<span style="color:var(--grn);font-weight:700">âœ“ Score predicts returns</span> â€” high-score games return '+Math.round(_learn.scoreDelta*100)+'% more<br>';
          else if(_learn.scoreWorks===false)o+='<span style="color:var(--red);font-weight:700">âœ— Score not predicting</span> â€” extreme scores dampened<br>';
          o+='</div>';
          if(_learn.archInsights.length>0){
            o+='<div style="margin-top:6px"><div class="L" style="font-size:8px;color:var(--pur)">BY ARCHETYPE</div>';
            _learn.archInsights.forEach(function(ai){
              var retClr=ai.avgRet>=0.5?'var(--grn)':ai.avgRet>=0.35?'var(--amb)':'var(--red)';
              o+='<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:11px;border-bottom:1px solid var(--border)20"><span>'+esc(ai.arch)+'</span><span><strong style="color:'+retClr+'">'+Math.round(ai.avgRet*100)+'%</strong> ret Â· '+ai.count+' packs Â· P/L '+(ai.pl>=0?'+':'')+' $'+fN(ai.pl)+'</span></div>';
            });
            o+='</div>';
          }
          if(_learn.total.n<5)o+='<div style="font-size:10px;color:var(--amb);margin-top:6px">âš  Need 5+ packs for reliable learning. Keep tracking!</div>';
          o+='</div>';
        }else{
          o+='<div class="C" style="border-color:var(--pur)44"><div class="L" style="color:var(--pur)">ðŸ§  FEEDBACK LOOP</div>';
          o+='<div style="font-size:11px;color:var(--dim)">Track 3+ packs to unlock learning insights. Use the Pack Tracker on games you buy, then save each session. The engine will learn which scores and archetypes actually perform for you.</div></div>';
        }
        S.sessions.slice().reverse().forEach(function(s){var pl=s.w-s.s;o+='<div style="padding:8px;background:var(--bg);border-radius:8px;margin-bottom:6px"><div style="display:flex;justify-content:space-between;flex-wrap:wrap"><div style="font-weight:600">'+esc(s.g)+'</div><div style="color:var(--dim);font-size:10px">'+esc(s.d)+(s.sc?' Â· <span style="color:var(--pur)">score:'+s.sc+'</span>':'')+(s.arch?' Â· '+esc(s.arch):'')+'</div></div><div style="display:flex;gap:8px;margin-top:4px;font-size:11px;flex-wrap:wrap"><span class="r">spent $'+fN(s.s)+'</span><span class="g">won $'+fN(s.w)+'</span><span style="color:'+(pl>=0?"var(--grn)":"var(--red)")+';font-weight:700">'+(pl>=0?"+":"")+"$"+fN(pl)+'</span>'+(s.af?'<span style="color:var(--gld)">â­ ANCHOR</span>':'')+'</div></div>';});
      }
      o+='</div>';
    }

    if(S.moreTab==="settings"){
      o+='<div class="C"><div class="L" style="margin-bottom:10px">SETTINGS</div>';
      o+='<div style="margin-bottom:12px"><div class="L">BANKROLL</div><div style="display:flex;gap:8px;align-items:center">';
      o+='<input class="I" type="number" value="'+S.bankroll+'" onchange="setBR(Number(this.value))" style="width:120px">  <span style="font-size:12px;color:var(--dim)">current: $'+fN(S.bankroll)+'</span></div></div>';
      o+='<div style="margin-bottom:12px"><div class="L">WINNER MODEL</div>';
      o+='<div style="font-size:11px;color:var(--dim);margin-bottom:6px">Load winner claim data to enable self-learning pack guidance. Model is built from '+(S.winData?Object.values(S.winData).reduce(function(s,v){return s+v.length;},0):0)+' winner records across '+(S.winData?Object.keys(S.winData).length:0)+' games.</div>';
      o+='<div class="B bn" onclick="fetchWinners()" style="margin-bottom:6px">'+(S._fetching?'â³ Fetching...':'â†“ FETCH WINNER DATA')+'</div>';
      if(S.winModel&&S.winModel.valid){var clusters=Object.keys(S.winModel.groups).filter(function(k){return S.winModel.groups[k].valid;});o+='<div style="font-size:11px;color:var(--grn);margin-top:4px">âœ“ Model active: '+clusters.length+' clusters, ready for pack guidance.</div>';}
      o+='</div>';
      o+='<div><div class="L">TREND DATA</div>';
      var trendCount=Object.keys(JSON.parse(localStorage.getItem("txt7")||"{}")).length;
      o+='<div style="font-size:11px;color:var(--dim);margin-bottom:6px">'+trendCount+' games with trend history saved locally. Burn rate activates after 2+ daily snapshots.</div>';
      o+='<div class="B rn" onclick="if(confirm(\'Clear all trend data?\'))localStorage.removeItem(\'txt7\');render()">Clear Trend Data</div></div></div>';
    }
  }

  document.getElementById("app").innerHTML=o;
}catch(e){document.getElementById("app").innerHTML='<div style="padding:20px;color:red;font-size:14px"><b>Render Error:</b> '+e.message+'<br><pre>'+e.stack+'</pre></div>';console.error("Render error:",e);}
}

// iOS Safari fix: ensure clicks work on all elements with onclick
// Walk up from touch target to find clickable ancestor
document.addEventListener("touchend",function(e){
  var el=e.target;
  while(el&&el!==document){
    if(el.getAttribute&&el.getAttribute("onclick")){
      e.preventDefault();
      el.click();
      return;
    }
    el=el.parentElement;
  }
},{passive:false});
window.addEventListener("load",init);
</script>
</body>
</html>
