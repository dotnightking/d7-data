<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TX Engine">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230d1118' width='100' height='100' rx='20'/><text x='50' y='62' text-anchor='middle' fill='%232ecc71' font-size='36' font-weight='900' font-family='system-ui'>TX</text></svg>">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>TX Scratch-Off Engine v7</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé∞</text></svg>">
<style>
:root{
  --bg:#0d1118;--card:#151d28;--border:#1e2d3d;--text:#d0dae6;--dim:#8899aa;
  --grn:#2ecc71;--red:#e74c3c;--blu:#3498db;--amb:#f39c12;--pur:#9b59b6;--wht:#ecf0f1;--gld:#d4a017;
  --grn1:#2ecc7118;--red1:#e74c3c18;--blu1:#3498db18;--pur1:#9b59b618;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;font-size:13px;line-height:1.5;min-height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}input[type=number]{-moz-appearance:textfield}
.W{max-width:960px;margin:0 auto;padding:0 14px 100px}
.H{padding:14px 0;border-bottom:1px solid var(--border);margin-bottom:16px;position:sticky;top:0;background:var(--bg);z-index:99}
h1{font-size:20px;font-weight:800;color:var(--grn);letter-spacing:-.02em}
.sub{font-size:11px;color:var(--gld);margin-top:2px}
.stale{color:var(--amb);font-weight:700}
.tabs{display:flex;gap:5px;margin-top:10px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none}.tabs::-webkit-scrollbar{display:none}
.T{padding:8px 16px;border-radius:8px;border:1px solid var(--border);color:var(--dim);cursor:pointer;font:600 11px/1 'Segoe UI',sans-serif;white-space:nowrap;background:0 0;transition:.15s}
.T:hover{border-color:var(--dim);color:var(--text)}
.T.on{border-color:var(--grn);background:var(--grn1);color:var(--grn)}
.C{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px;position:relative}
.L{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.06em;font-weight:600;margin-bottom:4px}
.V{font-size:24px;font-weight:800;line-height:1}
.g{color:var(--grn)}.r{color:var(--red)}.b{color:var(--blu)}.a{color:var(--amb)}.p{color:var(--pur)}.w{color:var(--wht)}.d{color:var(--dim)}
.G{display:grid;gap:10px}.GA{grid-template-columns:repeat(auto-fit,minmax(130px,1fr))}
.G2{grid-template-columns:1fr 1fr}.G3{grid-template-columns:1fr 1fr 1fr}
.cl{background:var(--bg);border-radius:8px;padding:10px}
.B{padding:8px 16px;border-radius:8px;border:1px solid var(--border);color:var(--dim);cursor:pointer;font:600 11px 'Segoe UI',sans-serif;background:0 0;display:inline-block;transition:.15s}
.B:hover{border-color:var(--dim);color:var(--text)}
.B.on{border-color:var(--grn);background:var(--grn1);color:var(--grn)}
.B.bn{border-color:var(--blu);background:var(--blu1);color:var(--blu)}
.B.pn{border-color:var(--pur);background:var(--pur1);color:var(--pur)}
.B.rn{border-color:var(--red);background:var(--red1);color:var(--red)}
.I{background:#0a0e14;border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font:13px 'Segoe UI',sans-serif;outline:0;width:100%}
.I:focus{border-color:var(--blu)}select.I{cursor:pointer;-webkit-appearance:none}
.FR{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
.sig{margin-top:8px;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:600}
.sig.buy{background:var(--grn1);color:var(--grn);border:1px solid #2ecc7130}
.sig.avoid{background:var(--red1);color:var(--red);border:1px solid #e74c3c30}
.badge{font-size:9px;font-weight:700;padding:3px 10px;border-radius:0 0 6px 6px;position:absolute;top:-1px;letter-spacing:.04em}
table{width:100%;border-collapse:collapse}
th{text-align:right;padding:6px 8px;font-size:10px;color:var(--dim);border-bottom:1px solid var(--border);font-weight:600}
td{padding:6px 8px;text-align:right;font-size:11px;border-bottom:1px solid #1e2d3d20}
.ck{cursor:pointer;transition:.15s}.ck:hover{background:#ffffff08;border-color:#ffffff18}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.bar-label{width:80px;text-align:right;font-size:11px;font-weight:600;flex-shrink:0}
.bar-track{flex:1;height:22px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative;display:flex}
.bar-pct{position:absolute;right:6px;top:3px;font-size:9px;color:var(--wht);font-weight:600;text-shadow:0 1px 2px #000}
.spark{display:inline-flex;align-items:end;gap:1px;height:20px;vertical-align:middle}
.spark-bar{width:3px;border-radius:1px;min-height:2px}
.why-tag{font-size:10px;padding:3px 8px;border-radius:5px;font-weight:700;display:inline-block;margin:2px 2px}
@media(max-width:640px){.G3{grid-template-columns:1fr 1fr}.GA{grid-template-columns:repeat(auto-fit,minmax(110px,1fr))}h1{font-size:17px}.bar-label{width:60px;font-size:10px}}
</style>
</head>
<body>
<div class="W" id="app"></div>
<script>
// ============================================================
// TX SCRATCH-OFF ENGINE v7 ‚Äî SURGICAL UPGRADE
// Changes from v6:
// 1. Fact-based BTP detection (floor + odds + prize table)
// 2. Jackpot focus: top 2-3 tiers $10K+ drive score
// 3. Floor-based EV (no yield guessing)
// 4. Monte Carlo simulation
// 5. "Why this score?" tags
// 6. Trend tracking with sparklines
// 7. logC defined once globally
// 8. Never mutate g.tot
// ============================================================

var GD=[];
var DD="";

// === UTILITIES (unchanged from v6) ===
function fmt(n){if(n>=1e6)return "$"+(n/1e6).toFixed(1)+"M";if(n>=1e3)return "$"+(n/1e3).toFixed(1)+"K";return "$"+Math.round(n)}
function pct(n){return(n*100).toFixed(1)+"%"}
function fmtO(n){if(n===Infinity||n>1e9)return "-";if(n>=1e6)return "1:"+Math.round(n/1e6)+"M";if(n>=1e3)return "1:"+Math.round(n/1e3)+"K";return "1:"+Math.round(n)}
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function fN(n){return n.toLocaleString()}
function prClr(pr){var m={1:"#c39bd3",2:"#bb8fce",3:"#af7ac5",5:"#a569bd",10:"#9b59b6",20:"#884ea0",30:"#7d3c98",50:"#6c3483",100:"#5b2c6f"};return m[pr]||"#9b59b6"}

// === GLOBAL logC (used everywhere, defined ONCE) ===
function logC(n,k){
  if(k>n||k<0)return -Infinity;
  if(k===0||k===n)return 0;
  if(k>n-k)k=n-k;
  var s=0;for(var i=1;i<=k;i++)s+=Math.log(n-i+1)-Math.log(i);return s;
}

// === ODDS VALIDATION ===
// Verify prize counts match published odds
function validateOdds(g){
  if(!g.odds||g.odds<=0||!g.tot||g.tot<=0)return{valid:false};
  var totalWinners=0;
  for(var i=0;i<g.pz.length;i++)totalWinners+=g.pz[i].p;
  var computedOdds=g.tot/totalWinners;
  var diff=Math.abs(computedOdds-g.odds)/g.odds;
  return{valid:diff<0.05,computedOdds:computedOdds,diff:diff,totalWinners:totalWinners};
}

// === FACT-BASED BTP DETECTION ===
function detectBTP(g){
  var i,p;
  var packPrice=g.pk*g.pr;
  var pc=g.tot>0&&g.pk>0?Math.round(g.tot/g.pk):0;
  if(pc<=0)return{valid:false,reason:"Missing total/pack size"};

  var tiers=[];
  for(i=0;i<g.pz.length;i++){
    p=g.pz[i];
    tiers.push({a:p.a,printed:p.p,claimed:p.c,rem:p.p-p.c,ratio:p.p/pc,idx:i});
  }

  // Floor zone: tiers with ratio >= 0.3 (appear in 30%+ of packs)
  var floorZone=[],aboveFloor=[];
  for(i=0;i<tiers.length;i++){
    if(tiers[i].ratio>=0.3)floorZone.push(tiers[i]);
    else aboveFloor.push(tiers[i]);
  }

  // BTP = highest dollar tier with ratio >= 0.5 in floor zone
  var btp=null;
  for(i=0;i<floorZone.length;i++){
    if(floorZone[i].ratio>=0.5&&(!btp||floorZone[i].a>btp.a))btp=floorZone[i];
  }
  if(!btp&&floorZone.length>0)btp=floorZone.reduce(function(a,b){return a.a>b.a?a:b});

  // Validate BTP against floor guarantee
  var floorValid=false,computedFloor=0;
  if(g.guar>0&&floorZone.length>0){
    var fzs=floorZone.slice().sort(function(a,b){return b.a-a.a});
    // Try greedy: 1x each tier from highest down
    var target=g.guar,comp=0;
    for(i=0;i<fzs.length;i++){
      var cnt=Math.max(1,Math.floor(fzs[i].ratio));
      var maxByTarget=Math.floor(target/fzs[i].a);
      cnt=Math.min(cnt,Math.max(1,maxByTarget));
      if(cnt>0&&target>=fzs[i].a){comp+=fzs[i].a*cnt;target-=fzs[i].a*cnt;}
    }
    computedFloor=comp;
    floorValid=Math.abs(g.guar-comp)<=Math.max(g.pr,g.guar*0.08);
  }

  // Jackpot tiers: $10K+, rare (ratio < 0.05), top 3
  var jackpotTiers=[];
  for(i=0;i<aboveFloor.length;i++){
    if(aboveFloor[i].a>=10000&&aboveFloor[i].ratio<0.05)jackpotTiers.push(aboveFloor[i]);
  }
  jackpotTiers.sort(function(a,b){return b.a-a.a});
  jackpotTiers=jackpotTiers.slice(0,3);

  // Mid tiers: above floor but not jackpot
  var jkMap={};for(i=0;i<jackpotTiers.length;i++)jkMap[jackpotTiers[i].a]=1;
  var midTiers=aboveFloor.filter(function(t){return!jkMap[t.a]}).sort(function(a,b){return b.a-a.a});

  return{
    valid:true,pc:pc,packPrice:packPrice,
    floorZone:floorZone.sort(function(a,b){return b.a-a.a}),
    floorValid:floorValid,computedFloor:computedFloor,
    btp:btp,hasJackpot:jackpotTiers.length>0,
    jackpotTiers:jackpotTiers,midTiers:midTiers
  };
}

// === CORE ANALYSIS ENGINE (v7: fact-based, jackpot-focused) ===
function analyze(g){
  var i,j,p;
  var R=function(p){return p.p-p.c};

  // === PACK COUNT ‚Äî never mutate g.tot ===
  var totalTickets=g.tot;
  var totWinP=0;for(i=0;i<g.pz.length;i++)totWinP+=g.pz[i].p;
  var tpvp=0;for(i=0;i<g.pz.length;i++)tpvp+=g.pz[i].a*g.pz[i].p;
  if(totalTickets<=0&&g.odds>0)totalTickets=Math.round(totWinP*g.odds);
  var totEstimated=totalTickets!==g.tot;

  var complete=totalTickets>0&&g.pk>0&&g.guar>0&&g.odds>0;
  var pc=totalTickets>0&&g.pk>0?Math.round(totalTickets/g.pk):0;
  var packPrice=g.pk*g.pr;

  // === DESIGNED RETURN ===
  var designedReturn=totalTickets>0&&g.pr>0?tpvp/(totalTickets*g.pr):0;

  // === FACT-BASED BTP ===
  var gd={tot:totalTickets,pk:g.pk,pr:g.pr,guar:g.guar,odds:g.odds,pz:g.pz};
  var btpInfo=detectBTP(gd);
  var oddsCheck=validateOdds(gd);

  var aa=btpInfo.valid&&btpInfo.btp?btpInfo.btp.a:0;
  var ai=g.pz.findIndex(function(p){return p.a===aa});
  var at=ai>=0?g.pz[ai]:null;
  var acr=at&&at.p>0?at.c/at.p:0;
  var btpValid=btpInfo.valid&&btpInfo.floorValid;

  // === PACKS SOLD (BTP clock) ===
  var eps=pc>0?Math.round(pc*acr):0;
  var epr=Math.max(1,pc-eps);
  var ets=eps*g.pk;
  var etr=Math.max(0,totalTickets-ets);

  // === PRIZE VALUES ===
  var tpvc=0;for(i=0;i<g.pz.length;i++)tpvc+=g.pz[i].a*g.pz[i].c;
  var tpvr=tpvp-tpvc;
  var pkc=packPrice;

  // === RETURN GAP ===
  var soldReturn=ets>0?tpvc/ets:0;
  var remainReturn=etr>0?tpvr/etr:0;
  var returnGap=soldReturn>0?(remainReturn-soldReturn)/soldReturn:0;
  var remainReturnPct=etr>0&&g.pr>0?tpvr/(etr*g.pr):0;

  // === ABOVE-BTP tiers ===
  var ot=ai>=0?g.pz.slice(0,ai):[];
  var olr=0,oot=0;
  for(i=0;i<ot.length;i++){olr+=R(ot[i]);oot+=ot[i].p}
  var orpC=epr>0?olr/epr:0,orpO=pc>0?oot/pc:0;
  var orpS=orpO>0?((orpC-orpO)/orpO)*100:0;

  var abvC=0,abvP=0;for(i=0;i<ot.length;i++){abvC+=ot[i].c;abvP+=ot[i].p}
  var abvPct=abvP>0?abvC/abvP:0;
  var blwC=0,blwP=0;for(i=ai+1;i<g.pz.length;i++){blwC+=g.pz[i].c;blwP+=g.pz[i].p}
  var blwPct=blwP>0?blwC/blwP:0;

  // === TOP PRIZE ===
  var tp=g.pz[0],tpr=R(tp),tpo=etr>0&&tpr>0?etr/tpr:Infinity;
  var mat=totalTickets>0?ets/totalTickets:0;
  var tpPack=epr>0&&tpr>0?tpr/epr:0;

  // === JACKPOT TIER ANALYSIS ‚Äî PRIMARY FOCUS ===
  var jackpotTiers=btpInfo.valid?btpInfo.jackpotTiers:[];
  var jackpotRem=0,jackpotPrinted=0;
  for(i=0;i<jackpotTiers.length;i++){jackpotRem+=jackpotTiers[i].rem;jackpotPrinted+=jackpotTiers[i].printed;}

  // Density
  var jackpotDensityNow=epr>0?jackpotRem/epr:0;
  var jackpotDensityLaunch=pc>0?jackpotPrinted/pc:0;
  var jackpotDensityShift=jackpotDensityLaunch>0?jackpotDensityNow/jackpotDensityLaunch:0;

  // Per-tier shifts
  var jackpotShifts=[];
  for(i=0;i<jackpotTiers.length;i++){
    var jt=jackpotTiers[i];
    var lD=pc>0?jt.printed/pc:0;
    var cD=epr>0?jt.rem/epr:0;
    var sh=lD>0?cD/lD:0;
    var lO=pc>0&&jt.printed>0?Math.round(pc/jt.printed):Infinity;
    var cO=epr>0&&jt.rem>0?Math.round(epr/jt.rem):Infinity;
    jackpotShifts.push({a:jt.a,printed:jt.printed,remaining:jt.rem,claimed:jt.claimed,
      launchOdds:lO,currentOdds:cO,shift:sh,
      signal:jt.rem<=0?"GONE":sh>=1.5?"STRONG":sh>=1.2?"GOOD":sh>=0.9?"NEUTRAL":sh>=0.7?"WEAK":"DEPLETED"});
  }

  // Jackpot EV
  var jackpotEV=0,jackpotEVLaunch=0;
  for(i=0;i<jackpotTiers.length;i++){
    if(jackpotTiers[i].rem>0&&epr>0)jackpotEV+=jackpotTiers[i].a*(jackpotTiers[i].rem/epr);
    if(jackpotTiers[i].printed>0&&pc>0)jackpotEVLaunch+=jackpotTiers[i].a*(jackpotTiers[i].printed/pc);
  }
  var jackpotEVShift=jackpotEVLaunch>0?jackpotEV/jackpotEVLaunch:0;

  // === HYPERGEOMETRIC ‚Äî JACKPOT TIERS ONLY ===
  var hyperNow=0,hyperLaunch=0;
  if(etr>0&&g.pk>0&&jackpotRem>0){hyperNow=1-Math.exp(logC(etr-jackpotRem,g.pk)-logC(etr,g.pk));}
  if(totalTickets>0&&g.pk>0&&jackpotPrinted>0){hyperLaunch=1-Math.exp(logC(totalTickets-jackpotPrinted,g.pk)-logC(totalTickets,g.pk));}
  var hyperRatio=hyperLaunch>0?hyperNow/hyperLaunch:0;

  // === HOLLOWED OUT ===
  var hollowedOut=false;
  if(jackpotTiers.length>=2&&jackpotTiers[0].rem>0){
    var midGone=true;for(i=1;i<jackpotTiers.length;i++)if(jackpotTiers[i].rem>0)midGone=false;
    if(midGone)hollowedOut=true;
  }

  // === WIN ODDS ===
  var totRem=0;for(i=0;i<g.pz.length;i++)totRem+=R(g.pz[i]);
  var winOdds=etr>0&&totRem>0?etr/totRem:Infinity;

  // === MARKOV VELOCITY (all above-BTP for display, jackpot for score) ===
  var ts=[],gSig="NEUTRAL",gRsn="Claims tracking normally.";
  for(i=0;i<ot.length;i++){
    p=ot[i];var ar=p.p>0?p.c/p.p:0;
    var dev=acr>0?(ar-acr)/acr:0;
    var minSample=Math.max(5,p.p*0.05);
    var isJackpot=p.a>=10000&&(pc>0?p.p/pc:1)<0.05;
    var sig=p.c>=minSample&&dev<-0.05?"HOT":p.c>=minSample&&dev>0.05?"COLD":"NORMAL";
    ts.push({a:p.a,ar:ar,er:acr,dev:dev,sig:sig,rem:R(p),cat:isJackpot?"JACKPOT":"MID",isJackpot:isJackpot});
  }

  // Signal from JACKPOT tiers
  var jkH=0,jkC=0,jkN=0,allJkG=true;
  for(i=0;i<ts.length;i++){if(!ts[i].isJackpot)continue;jkN++;if(ts[i].rem>0)allJkG=false;if(ts[i].sig==="HOT")jkH++;if(ts[i].sig==="COLD")jkC++;}

  if(!btpInfo.hasJackpot){gSig="NO_JACKPOT";gRsn="No $10K+ prize tiers.";}
  else if(allJkG&&jkN>0){gSig="DEAD";gRsn="All jackpot prizes claimed.";}
  else if(jkC>0&&jkH===0){gSig="AVOID";gRsn="Jackpot prizes depleting faster than tickets selling.";}
  else if(jkH>0&&jkC===0){
    gSig="BUY";gRsn="Jackpot prizes underclaimed ‚Äî in remaining packs.";
    if(ts.filter(function(t){return!t.isJackpot&&t.sig==="HOT"}).length>0){gSig="STRONG_BUY";gRsn="Jackpot AND mid prizes underclaimed.";}
  }else if(jkH>0&&jkC>0){gSig="MIXED";gRsn="Some jackpot tiers under, others overclaimed.";}
  else{
    var mH=ts.filter(function(t){return!t.isJackpot&&t.sig==="HOT"}).length;
    var mC=ts.filter(function(t){return!t.isJackpot&&t.sig==="COLD"}).length;
    if(mH>0&&mC===0){gSig="BUY";gRsn="Jackpot neutral but mid prizes underclaimed.";}
    else if(mC>0&&mH===0){gSig="CAUTION";gRsn="Jackpot neutral but mid prizes depleting.";}
  }
  if(returnGap<-0.03&&(gSig==="STRONG_BUY"||gSig==="BUY")){gSig="NEUTRAL";gRsn="Counts lag but dollars claimed disproportionately.";}
  if(returnGap>0.03&&gSig==="AVOID"){gSig="NEUTRAL";gRsn="Some tiers depleted but dollar value favors remaining.";}

  // === FLOOR-BASED EV ===
  var floorEV=g.guar>0?g.guar:0;
  var midRangeEV=0;
  if(btpInfo.valid){for(i=0;i<btpInfo.midTiers.length;i++){var mt=btpInfo.midTiers[i];if(mt.rem>0&&epr>0)midRangeEV+=mt.a*(mt.rem/epr);}}
  var totalEV=floorEV+midRangeEV+jackpotEV;
  var edge=packPrice>0?(totalEV/packPrice)-1:0;
  var midEVL=0;
  if(btpInfo.valid){for(i=0;i<btpInfo.midTiers.length;i++){var mt2=btpInfo.midTiers[i];if(mt2.printed>0&&pc>0)midEVL+=mt2.a*(mt2.printed/pc);}}
  var totalEVLaunch=floorEV+midEVL+jackpotEVLaunch;
  var edgeLaunch=packPrice>0?(totalEVLaunch/packPrice)-1:0;

  // === IMPLIED YIELD ‚Äî DIAGNOSTIC ONLY ===
  var impliedYield=eps>0&&packPrice>0?tpvc/(eps*packPrice):0;
  var yieldValid=g.guar>0&&packPrice>0?(impliedYield>=(g.guar/packPrice)*0.9&&impliedYield<=0.85):false;

  // === THREE-METHOD VALIDATION ===
  var methodA=eps;
  var totalClaimed=0;for(i=0;i<g.pz.length;i++)totalClaimed+=g.pz[i].c;
  var methodB=g.odds>0&&g.pk>0?Math.round(totalClaimed/(g.pk/g.odds)):0;
  var methodC=packPrice>0?Math.round(tpvc/(packPrice*0.70)):0;
  var methods=[methodA,methodB,methodC].filter(function(m){return m>0});
  var confidence="LOW";
  if(methods.length>=2){var mx=Math.max.apply(null,methods),mn=Math.min.apply(null,methods);var sp=mx>0?(mx-mn)/mx:1;if(sp<=0.05)confidence="HIGH";else if(sp<=0.10)confidence="MEDIUM";}

  // === SCORING ‚Äî JACKPOT FOCUSED ===
  var sc=50;
  var scoreBreakdown=[];

  // 1. Jackpot density shift: ¬±20 pts (PRIMARY)
  if(jackpotDensityShift>0){var jdP=Math.max(-20,Math.min(20,(jackpotDensityShift-1)*25));sc+=jdP;scoreBreakdown.push({f:"Jackpot density "+jackpotDensityShift.toFixed(2)+"x",p:Math.round(jdP)});}
  // 2. Top prize: ¬±15 pts
  if(tpr===0){sc-=15;scoreBreakdown.push({f:"Top prize GONE",p:-15});}
  else if(tp.p>0){var tpP=Math.min(5,Math.round((tpr/tp.p)*5));sc+=tpP;scoreBreakdown.push({f:"Top "+tpr+"/"+tp.p+" left",p:tpP});}
  // 3. Hypergeometric: ¬±10 pts
  if(hyperRatio>0){var hyP=Math.max(-10,Math.min(10,(hyperRatio-1)*20));sc+=hyP;scoreBreakdown.push({f:"Jackpot P(pack) "+hyperRatio.toFixed(2)+"x",p:Math.round(hyP)});}
  // 4. Jackpot EV shift: ¬±10 pts
  if(jackpotEVShift>0){var evP=Math.max(-10,Math.min(10,(jackpotEVShift-1)*15));sc+=evP;scoreBreakdown.push({f:"Jackpot EV "+jackpotEVShift.toFixed(2)+"x",p:Math.round(evP)});}
  // 5. Markov jackpot: ¬±8 pts
  var mkMap={"STRONG_BUY":8,"BUY":5,"NEUTRAL":0,"NO_JACKPOT":0,"MIXED":0,"CAUTION":-3,"AVOID":-8,"DEAD":-15};
  var mkV=mkMap[gSig]||0;sc+=mkV;scoreBreakdown.push({f:"Markov "+gSig.replace(/_/g," "),p:mkV});
  // 6. Return gap: ¬±5 pts (cross-check)
  if(returnGap!==0){var rgP=Math.max(-5,Math.min(5,returnGap*50));sc+=rgP;scoreBreakdown.push({f:"Return gap "+(returnGap>0?"+":"")+pct(returnGap),p:Math.round(rgP)});}
  // 7. Win odds: ¬±5 pts
  if(g.odds>0&&winOdds<Infinity){var odP=Math.max(-5,Math.min(5,((g.odds-winOdds)/g.odds)*20));sc+=odP;scoreBreakdown.push({f:"Win odds shift",p:Math.round(odP)});}
  // 8. Closing: +8/-10
  if(g.cs&&tpr>0){sc+=8;scoreBreakdown.push({f:"CLOSING + jackpot left",p:8});}
  else if(g.cs&&tpr===0){sc-=10;scoreBreakdown.push({f:"CLOSING + gone",p:-10});}
  // 9. Hollowed: -10
  if(hollowedOut){sc-=10;scoreBreakdown.push({f:"HOLLOWED ‚Äî mid tiers gone",p:-10});}
  // 10. No jackpot cap
  if(!btpInfo.hasJackpot){sc=Math.min(sc,30);scoreBreakdown.push({f:"No $10K+ tiers",p:0});}
  // 11. Early game dampen
  if(mat<0.15&&mat>0){var pre=sc;sc=Math.round(50+(sc-50)*0.6);scoreBreakdown.push({f:"Early ("+pct(mat)+") dampen",p:sc-pre});}
  // 12. Incomplete
  if(!complete){sc-=5;scoreBreakdown.push({f:"Incomplete data",p:-5});}
  // 13. LOW confidence dampen
  if(confidence==="LOW"&&complete){var pre2=sc;sc=Math.round(50+(sc-50)*0.7);scoreBreakdown.push({f:"LOW conf dampen",p:sc-pre2});}

  sc=Math.round(Math.min(100,Math.max(0,sc)));

  // "Why this score?" ‚Äî top 2 drivers
  var whyScore=scoreBreakdown.slice().sort(function(a,b){return Math.abs(b.p)-Math.abs(a.p)}).filter(function(s){return s.p!==0}).slice(0,2);

  // === TIER CATEGORIZATION ===
  var tierCats={};
  if(btpInfo.valid){
    for(i=0;i<btpInfo.floorZone.length;i++)tierCats[btpInfo.floorZone[i].a]=btpInfo.floorZone[i].a===aa?"BTP":"FLOOR";
    for(i=0;i<btpInfo.midTiers.length;i++)tierCats[btpInfo.midTiers[i].a]="MID";
    for(i=0;i<btpInfo.jackpotTiers.length;i++)tierCats[btpInfo.jackpotTiers[i].a]="JACKPOT";
  }else{
    if(ai>=0)tierCats[g.pz[ai].a]="BTP";
    for(i=0;i<ai;i++)tierCats[g.pz[i].a]=i<2?"JACKPOT":"MID";
    for(i=ai+1;i<g.pz.length;i++)tierCats[g.pz[i].a]="FLOOR";
  }

  // === TIER ADVANTAGE ===
  var tierAdv=[];
  for(i=0;i<ot.length;i++){p=ot[i];var trm=R(p);if(trm<=0)continue;
    var oO=totalTickets>0&&p.p>0?totalTickets/p.p:Infinity;
    var cO2=etr>0&&trm>0?etr/trm:Infinity;
    var pB=oO>0&&oO<Infinity?((oO-cO2)/oO)*100:0;
    tierAdv.push({a:p.a,origO:oO,currO:cO2,pctB:pB,rem:trm,cat:tierCats[p.a]||"?"});}

  // === PRIZES TABLE ===
  var prizes=[];for(i=0;i<g.pz.length;i++){p=g.pz[i];var rm=R(p);
    prizes.push({a:p.a,p:p.p,c:p.c,rem:rm,pctC:p.p>0?(p.c/p.p*100):0,
      origO:totalTickets>0?totalTickets/p.p:Infinity,currO:etr>0&&rm>0?etr/rm:Infinity,
      isA:p.a===aa,isO:ai>=0&&i<ai,cat:tierCats[p.a]||"?",
      isJackpot:p.a>=10000&&(pc>0?p.p/pc:1)<0.05,
      highSens:p.p<=10});}

  // === FLAGS ===
  var flags=[];
  if(tpr===0)flags.push({t:"DANGER",m:"All "+fmt(tp.a)+" claimed",c:"r"});
  if(g.cs&&tpr>0)flags.push({t:"CLOSING",m:tpr+" top prizes left in closing game",c:"a"});
  if(gSig==="STRONG_BUY")flags.push({t:"HOT",m:gRsn,c:"g"});
  if(gSig==="BUY")flags.push({t:"BUY",m:gRsn,c:"g"});
  if(gSig==="DEAD")flags.push({t:"DEAD",m:gRsn,c:"r"});
  if(gSig==="AVOID")flags.push({t:"AVOID",m:gRsn,c:"r"});
  if(gSig==="CAUTION")flags.push({t:"CAUTION",m:gRsn,c:"a"});
  if(gSig==="NO_JACKPOT")flags.push({t:"NO JACKPOT",m:"No $10K+ tiers",c:"d"});
  if(hollowedOut)flags.push({t:"HOLLOWED",m:"Top exists but mid tiers gone",c:"a"});
  if(returnGap>0.02)flags.push({t:"RICH",m:"Remaining "+(returnGap*100).toFixed(1)+"% richer",c:"g"});
  if(returnGap<-0.02)flags.push({t:"THIN",m:"Remaining "+(Math.abs(returnGap)*100).toFixed(1)+"% thinner",c:"r"});
  if(hyperRatio>1.2)flags.push({t:"JACKPOT+",m:"Odds "+hyperRatio.toFixed(1)+"x vs launch",c:"g"});
  if(mat<0.08)flags.push({t:"FRESH",m:"Only "+pct(mat)+" sold",c:"b"});
  if(!complete)flags.push({t:"INCOMPLETE",m:"Missing detail page data",c:"a"});
  for(i=0;i<jackpotShifts.length;i++){if(jackpotShifts[i].printed<=10)flags.push({t:"‚ö°$"+fN(jackpotShifts[i].a),m:"‚â§10 printed ‚Äî high sensitivity",c:"a"});}
  for(i=0;i<ts.length;i++){if(ts[i].isJackpot&&ts[i].sig==="HOT"&&ts[i].dev<-0.15)flags.push({t:"$"+fN(ts[i].a)+" HOT",m:"Underclaimed",c:"p"});}
  if(!yieldValid&&complete)flags.push({t:"YIELD‚ö†",m:"Implied "+pct(impliedYield)+" outside range",c:"a"});
  if(oddsCheck.valid===false&&g.odds>0)flags.push({t:"ODDS‚ö†",m:"Prize counts don't match published odds",c:"a"});

  return{g:g,pc:pc,aa:aa,ai:ai,acr:acr,eps:eps,epr:epr,ets:ets,etr:etr,
    tpvp:tpvp,tpvc:tpvc,tpvr:tpvr,pkc:pkc,complete:complete,
    totalTickets:totalTickets,packPrice:packPrice,totEstimated:totEstimated,
    designedReturn:designedReturn,soldReturn:soldReturn,remainReturn:remainReturn,
    returnGap:returnGap,remainReturnPct:remainReturnPct,
    btpInfo:btpInfo,btpValid:btpValid,oddsCheck:oddsCheck,
    orpC:orpC,orpO:orpO,orpS:orpS,abvPct:abvPct,blwPct:blwPct,
    tp:tp,tpr:tpr,tpo:tpo,mat:mat,sc:sc,tpPack:tpPack,
    winOdds:winOdds,totRem:totRem,
    jackpotTiers:jackpotTiers,jackpotShifts:jackpotShifts,
    jackpotDensityNow:jackpotDensityNow,jackpotDensityLaunch:jackpotDensityLaunch,
    jackpotDensityShift:jackpotDensityShift,
    jackpotEV:jackpotEV,jackpotEVLaunch:jackpotEVLaunch,jackpotEVShift:jackpotEVShift,
    hyperNow:hyperNow,hyperLaunch:hyperLaunch,hyperRatio:hyperRatio,
    hollowedOut:hollowedOut,
    floorEV:floorEV,midRangeEV:midRangeEV,totalEV:totalEV,edge:edge,
    totalEVLaunch:totalEVLaunch,edgeLaunch:edgeLaunch,
    methodA:methodA,methodB:methodB,methodC:methodC,confidence:confidence,
    impliedYield:impliedYield,yieldValid:yieldValid,
    scoreBreakdown:scoreBreakdown,whyScore:whyScore,
    tierAdv:tierAdv,tierCats:tierCats,prizes:prizes,
    gm:{ts:ts,sig:gSig,rsn:gRsn},flags:flags};
}

// === MONTE CARLO PACK SIMULATION ===
function simulatePacks(a,N){
  if(!a.complete||a.epr<=0||a.etr<=0)return{valid:false};
  N=N||10000;
  var g=a.g,pk=g.pk,cost=a.packPrice,eW=g.odds>0?pk/g.odds:0;
  // Build prize pool weights
  var pool=[],totP=0;
  for(var i=0;i<g.pz.length;i++){var rm=g.pz[i].p-g.pz[i].c;if(rm>0){pool.push({a:g.pz[i].a,w:rm});totP+=rm;}}
  if(totP<=0)return{valid:false};
  // Cumulative weights for fast sampling
  var cum=[];var c=0;for(i=0;i<pool.length;i++){c+=pool[i].w;cum.push(c);}

  var results=[],pFl=0,pPr=0,pJk=0,p5d=0,tRet=0;
  var buckets=[{l:"Below Floor",mn:0,mx:a.floorEV-1,n:0},{l:"At Floor",mn:a.floorEV-1,mx:a.floorEV+cost*0.01,n:0},{l:"Floor+",mn:a.floorEV+cost*0.01,mx:cost,n:0},{l:"Break Even",mn:cost,mx:cost*2,n:0},{l:"2x-5x",mn:cost*2,mx:cost*5,n:0},{l:"5x+",mn:cost*5,mx:Infinity,n:0}];

  for(var s=0;s<N;s++){
    var tot=0,hasJ=false,has5=false;
    var nW=Math.floor(eW)+(Math.random()<(eW%1)?1:0);
    if(Math.random()<0.1)nW+=Math.random()<0.5?1:-1;
    nW=Math.max(1,nW);
    for(var w=0;w<nW;w++){
      var r=Math.random()*totP,lo=0,hi=cum.length-1,drawn=pool[0].a;
      while(lo<=hi){var mid2=(lo+hi)>>1;if(cum[mid2]<r)lo=mid2+1;else{drawn=pool[mid2].a;hi=mid2-1;}}
      tot+=drawn;if(drawn>=10000)has5=true;if(drawn>=50000)hasJ=true;
    }
    if(a.floorEV>0&&tot<a.floorEV)tot=a.floorEV;
    results.push(tot);tRet+=tot;
    if(tot<=a.floorEV+1)pFl++;if(tot>=cost)pPr++;if(has5)p5d++;if(hasJ)pJk++;
    for(var b=0;b<buckets.length;b++){if(tot>buckets[b].mn&&tot<=buckets[b].mx){buckets[b].n++;break;}}
  }
  results.sort(function(a,b){return a-b});
  return{valid:true,N:N,mean:tRet/N,median:results[N>>1],p5:results[Math.floor(N*0.05)],p95:results[Math.floor(N*0.95)],
    pFloor:pFl/N,pProfit:pPr/N,p5Digit:p5d/N,pJackpot:pJk/N,
    worst:results[0],best:results[N-1],cost:cost,floor:a.floorEV,
    buckets:buckets,expPL:(tRet/N)-cost};
}

// === TREND TRACKING ===
function saveTrend(){
  if(!S.data.length)return;
  var d=new Date().toISOString().slice(0,10);
  var t=JSON.parse(localStorage.getItem("txt7")||"{}");
  S.data.forEach(function(a){
    if(!a.complete)return;
    var k=a.g.id;if(!t[k])t[k]=[];
    if(t[k].length>0&&t[k][t[k].length-1].d===d)return;
    t[k].push({d:d,sc:a.sc,jd:a.jackpotDensityShift,jr:a.jackpotTiers.reduce(function(s,x){return s+x.rem},0),mat:a.mat,tpr:a.tpr});
    if(t[k].length>60)t[k]=t[k].slice(-60);
  });
  localStorage.setItem("txt7",JSON.stringify(t));
}
function getTrend(id){return(JSON.parse(localStorage.getItem("txt7")||"{}"))[id]||[];}
function sparkline(data,field,h){
  if(!data||data.length<2)return"";h=h||20;
  var v=data.map(function(d){return d[field]||0}),mn=Math.min.apply(null,v),mx=Math.max.apply(null,v),rng=mx-mn||1;
  var o='<span class="spark">';
  for(var i=0;i<v.length;i++){var bh=Math.max(2,Math.round(((v[i]-mn)/rng)*h));
    o+='<span class="spark-bar" style="height:'+bh+'px;background:'+(i===v.length-1?"var(--grn)":"var(--dim)")+'"></span>';}
  return o+'</span>';
}

// === STATE ===
var S={tab:"picks",selId:null,sortBy:"score",filterPr:"all",data:[],moreTab:"pack",
  pack:{log:[],won:0,spent:0,af:false,pr:10,pk:50,nm:"",aa:100,ew:13},
  sessions:JSON.parse(localStorage.getItem("txs7")||"[]"),
  _promptPreview:null,_allPromptPreview:null,_promptMsg:null,
  bankroll:Number(localStorage.getItem("txb7")||"1000")};

// === INIT ===
function init(){
  try{var c=localStorage.getItem("txr_gd7");if(c){GD=JSON.parse(c);if(GD.length)S.data=GD.map(function(g){return analyze(g)})}}catch(e){}
  DD=localStorage.getItem("txr_date7")||"";
  render();refreshAllData();
}
function setTab(t){S.tab=t;render()}
function setMore(t){S.moreTab=t;render()}
function setFilter(p){S.filterPr=p;render()}
function setSort(s){S.sortBy=s;render()}
function openDetail(id){S.selId=id;S.tab="detail";render()}
function setSel(id){S.selId=id;render()}

// === DATA LOADING (unchanged) ===
var DATA_URL="data/feed.json";
var WINNER_URL="data/wdata.json";

async function refreshAllData(){
  if(S._refreshing)return;S._refreshing=true;S._refreshMsg="Fetching...";render();
  try{
    var resp=await fetch(DATA_URL);if(!resp.ok)throw new Error("HTTP "+resp.status);
    var json=await resp.json();
    if(json&&json.games&&json.games.length>0){
      GD=[];
      json.games.forEach(function(ng){
        if(!ng.pz||!ng.pz.length||!ng.pr||ng.pr<=0)return;
        ng.id=String(ng.gn);ng.pz.sort(function(a,b){return b.a-a.a});GD.push(ng);
      });
      S.data=GD.map(function(g){return analyze(g)});
      DD=json.updated||"";
      localStorage.setItem("txr_date7",DD);localStorage.setItem("txr_gd7",JSON.stringify(GD));
      saveTrend();
      var comp=S.data.filter(function(a){return a.complete}).length;
      var jk=S.data.filter(function(a){return a.btpInfo.hasJackpot}).length;
      S._refreshMsg="Loaded "+GD.length+" games ("+comp+" complete, "+jk+" with jackpot). Data: "+DD;
    }else{S._refreshMsg="No data. Run scraper.";}
  }catch(e){S._refreshMsg="Failed: "+e.message;}
  S._refreshing=false;render();
}

async function fetchWinners(){
  if(S._fetching)return;S._fetching=true;render();
  if(!S.winData)S.winData={};
  try{var r=await fetch(WINNER_URL);if(r.ok){var j=await r.json();if(j&&j.winners){S.winData=j.winners;localStorage.setItem("txwd7",JSON.stringify(S.winData));}}}catch(e){}
  S._fetching=false;render();
}

// === PACK TRACKER (unchanged) ===
function scratch(amt){var pk=S.pack;pk.log.push({amt:amt,w:amt>0});pk.won+=amt;pk.spent+=pk.pr;pk.af=pk.af||amt>=pk.aa;render()}
function resetPack(){S.pack.log=[];S.pack.won=0;S.pack.spent=0;S.pack.af=false;render()}
function saveSession(){if(!S.pack.log.length)return;S.sessions.push({g:S.pack.nm,s:S.pack.spent,w:S.pack.won,t:S.pack.log.length,d:new Date().toLocaleDateString(),af:S.pack.af});localStorage.setItem("txs7",JSON.stringify(S.sessions));resetPack()}
function clearSess(){S.sessions=[];localStorage.setItem("txs7","[]");render()}
function setBR(v){S.bankroll=v;localStorage.setItem("txb7",String(v));render()}
function startPack(id){var a;for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===id){a=S.data[i];break}if(!a)return;S.pack={log:[],won:0,spent:0,af:false,pr:a.g.pr,pk:a.g.pk,nm:a.g.nm+' #'+a.g.gn,aa:a.aa,ew:Math.round(a.g.pk/a.g.odds)};S.tab="more";S.moreTab="pack";render()}
function mkv(){var pk=S.pack,rem=pk.pk-pk.log.length;if(rem<=0)return null;var wf=0;for(var i=0;i<pk.log.length;i++)if(pk.log[i].w)wf++;var wl=Math.max(0,pk.ew-wf),pW=wl/rem,pA=pk.af?0:1/rem;var dec="EARLY",rsn="Pack early ‚Äî "+(pA*100).toFixed(1)+"% per ticket.";if(pk.af){dec="STOP";rsn="Anchor found.";}else if(pA>=0.15){dec="BUY";rsn=(pA*100).toFixed(1)+"% anchor chance. "+rem+" left.";}else if(pA>=0.05){dec="CONSIDER";rsn=(pA*100).toFixed(1)+"% per ticket.";}return{rem:rem,wl:wl,pW:pW,pA:pA,dec:dec,rsn:rsn}}

// === AI PROMPTS (streamlined for v7) ===
function buildGamePrompt(a){
  var g=a.g,L=[];
  L.push("Analyze TX scratch-off #"+g.gn+" "+g.nm+" ($"+g.pr+"). Focus: are jackpot prizes ($10K+) concentrated in remaining packs?\n");
  L.push("FACTS: $"+g.pr+" ticket | "+g.pk+"/pack=$"+fN(a.packPrice)+" | "+fN(a.totalTickets)+" tickets | "+fN(a.pc)+" packs | Floor:$"+fN(g.guar)+" ("+pct(g.guar/a.packPrice)+") | Odds:1:"+g.odds+" | BTP:$"+fN(a.aa)+(a.btpValid?" validated":"")+(g.cs?" | CLOSING":""));
  L.push("STATUS: Score:"+a.sc+" | "+pct(a.mat)+" sold | "+fN(a.epr)+" packs left | Signal:"+a.gm.sig+"\n");
  L.push("JACKPOT TIERS:");
  a.jackpotShifts.forEach(function(j){L.push("  $"+fN(j.a)+": "+j.remaining+"/"+j.printed+" | density:"+j.shift.toFixed(2)+"x | odds:1:"+fN(j.currentOdds)+" (was 1:"+fN(j.launchOdds)+") | "+j.signal);});
  L.push("JK EV/pack: $"+a.jackpotEV.toFixed(2)+" (launch:$"+a.jackpotEVLaunch.toFixed(2)+", "+a.jackpotEVShift.toFixed(2)+"x) | P(jk): "+(a.hyperNow>=0.01?pct(a.hyperNow):"1:"+fN(Math.round(1/a.hyperNow)))+" ("+a.hyperRatio.toFixed(2)+"x)\n");
  L.push("EV: Floor:$"+fN(a.floorEV)+" + Mid:$"+a.midRangeEV.toFixed(0)+" + JK:$"+a.jackpotEV.toFixed(2)+" = $"+Math.round(a.totalEV)+" | Edge:"+(a.edge>0?"+":"")+pct(a.edge));
  L.push("Validation: A="+fN(a.methodA)+" B="+fN(a.methodB)+" C="+fN(a.methodC)+" Conf:"+a.confidence+"\n");
  L.push("PRIZE TABLE:");a.prizes.forEach(function(p){L.push("$"+fN(p.a)+" "+p.cat+" | "+fN(p.p)+"/"+fN(p.c)+"/"+fN(p.rem)+" | "+fmtO(p.origO)+"‚Üí"+(p.rem>0?fmtO(p.currO):"GONE"));});
  L.push("\n1. Worth buying? YES/NO/MAYBE. 2. Jackpots concentrated? 3. Pack breakdown: floor+mid+jackpot. 4. Contradictions?");
  return L.join("\n");
}
function buildAllPrompt(){
  var tr=[];S.data.forEach(function(a){if(!a.complete||!a.btpInfo.hasJackpot)return;
    if(a.jackpotDensityShift>1.1||a.hyperRatio>1.1||a.returnGap>0.03||a.g.cs&&a.tpr>0||a.gm.sig==="BUY"||a.gm.sig==="STRONG_BUY"||a.gm.sig==="AVOID"||a.gm.sig==="DEAD"||a.returnGap<-0.03)tr.push(a);});
  if(!tr.length)return"No significant signals.";
  var L=["TX scratch-off analysis ‚Äî jackpot focus ($10K+)\n"];
  tr.sort(function(a,b){return b.sc-a.sc}).forEach(function(a){
    L.push("#"+a.g.gn+" "+a.g.nm+" $"+a.g.pr+" | sc:"+a.sc+" | jkD:"+a.jackpotDensityShift.toFixed(2)+"x | hyp:"+a.hyperRatio.toFixed(2)+"x | top:"+a.tpr+"/"+a.tp.p+"($"+fN(a.tp.a)+") | "+pct(a.mat)+" sold | "+a.gm.sig+" | jkEV:$"+a.jackpotEV.toFixed(2)+(a.g.cs?" CLOSING":""));});
  L.push("\n1. Top 2-3 buys? 2. Avoid? 3. Best per price?");return L.join("\n");
}
function copyAIPrompt(id){var a=null;for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===id){a=S.data[i];break}if(!a)return;navigator.clipboard.writeText(buildGamePrompt(a)).then(function(){S._promptMsg="‚úì Copied!";render();setTimeout(function(){S._promptMsg=null;render()},2500)})}
function showAIPrompt(id){var a=null;for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===id){a=S.data[i];break}if(!a)return;S._promptPreview=buildGamePrompt(a);render()}
function copyAllPrompt(){navigator.clipboard.writeText(buildAllPrompt()).then(function(){S._promptMsg="‚úì Copied!";render();setTimeout(function(){S._promptMsg=null;render()},2500)})}
function showAllPrompt(){S._allPromptPreview=buildAllPrompt();render()}

// === RENDER ===
function render(){
  var pr={};GD.forEach(function(g){pr[g.pr]=1});var pArr=Object.keys(pr).map(Number).sort(function(a,b){return a-b});
  var f=S.data.slice();
  if(S.filterPr!=="all")f=f.filter(function(a){return a.g.pr===Number(S.filterPr)});
  var sorts={score:function(a,b){return b.sc-a.sc},density:function(a,b){return b.jackpotDensityShift-a.jackpotDensityShift},gap:function(a,b){return b.returnGap-a.returnGap},topOdds:function(a,b){return a.tpo-b.tpo},tickets:function(a,b){return a.mat-b.mat},hyper:function(a,b){return b.hyperRatio-a.hyperRatio},jackpotEV:function(a,b){return b.jackpotEV-a.jackpotEV}};
  f.sort(sorts[S.sortBy]||sorts.score);
  var sel=null;if(S.selId){for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===S.selId){sel=S.data[i];break}}

  var o='<div class="H"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px"><div><h1>TX ENGINE v7</h1><div class="sub">'+GD.length+' games ¬∑ Jackpot focused'+(DD?' ¬∑ '+esc(DD):'')+'</div></div>';
  o+='<div class="B'+(S._refreshing?"":" on")+'" onclick="refreshAllData()" style="font-size:10px;padding:6px 12px">'+(S._refreshing?'‚è≥...':'‚Üª REFRESH')+'</div></div>';
  if(S._refreshMsg)o+='<div style="font-size:10px;color:var(--blu);margin-top:4px">'+esc(S._refreshMsg)+'</div>';
  if(S._promptMsg)o+='<div style="font-size:11px;color:#2ecc71;margin-top:4px;font-weight:600">'+esc(S._promptMsg)+'</div>';
  o+='<div class="tabs">';
  [["picks","PICKS"],["detail","DETAIL"],["insights","INSIGHTS"],["winners","WINNERS"],["more","MORE"]].forEach(function(t){o+='<div class="T'+(S.tab===t[0]?" on":"")+'" onclick="setTab(\''+t[0]+'\')">'+t[1]+'</div>';});
  o+='</div></div>';

  if(GD.length===0){o+='<div class="C" style="text-align:center;padding:40px"><div style="font-size:18px;color:var(--amb)">No Data</div><div style="margin-top:8px">Run scraper ‚Üí deploy feed.json ‚Üí REFRESH</div></div>';document.getElementById("app").innerHTML=o;return;}

  // ==================== PICKS ====================
  if(S.tab==="picks"){
    o+='<div class="FR"><span class="L" style="margin:0">PRICE:</span>';
    ["all"].concat(pArr).forEach(function(p){var v=String(p);o+='<div class="B'+(S.filterPr===v?" on":"")+'" onclick="setFilter(\''+v+'\')" style="padding:5px 10px">'+(v==="all"?"ALL":"$"+v)+'</div>';});
    o+='</div><div class="FR"><span class="L" style="margin:0">SORT:</span>';
    [["score","Score"],["density","JK Density"],["hyper","JK P(pack)"],["jackpotEV","JK EV"],["gap","Gap"],["topOdds","Top Odds"],["tickets","Fresh"]].forEach(function(s){o+='<div class="B'+(S.sortBy===s[0]?" bn":"")+'" onclick="setSort(\''+s[0]+'\')" style="padding:5px 10px">'+s[1]+'</div>';});
    o+='</div>';

    for(var idx=0;idx<f.length;idx++){var a=f[idx];var tr=getTrend(a.g.id);
      o+='<div class="C ck" onclick="openDetail(\''+a.g.id+'\')">';
      if(idx===0&&f.length>1)o+='<div class="badge" style="right:12px;background:var(--grn);color:var(--bg)">TOP PICK</div>';
      if(a.g.cs)o+='<div class="badge" style="right:'+(idx===0&&f.length>1?'95px':'12px')+';background:var(--red);color:#fff">CLOSING</div>';
      if(!a.btpInfo.hasJackpot)o+='<div class="badge" style="left:12px;background:var(--dim);color:var(--bg)">NO JK</div>';
      else if(!a.complete)o+='<div class="badge" style="left:12px;background:var(--amb);color:var(--bg)">PARTIAL</div>';

      o+='<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px"><div style="flex:1;min-width:0">';
      o+='<div style="font-size:15px;font-weight:700;color:var(--wht);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(a.g.nm)+' <span class="d" style="font-weight:400">#'+a.g.gn+'</span></div>';
      o+='<div style="font-size:11px;color:var(--dim)">$'+a.g.pr+(a.g.pk?' ¬∑ '+a.g.pk+'/pk':'')+(a.aa?' ¬∑ BTP:$'+fN(a.aa):'')+(a.g.guar?' ¬∑ Fl:$'+fN(a.g.guar):'')+'</div></div>';
      o+='<div style="text-align:right;flex-shrink:0"><div class="V" style="color:'+(a.sc>=65?"var(--grn)":a.sc>=40?"var(--amb)":"var(--red)")+';font-size:28px">'+a.sc+'</div><div style="font-size:9px;color:var(--dim)">SCORE</div>';
      if(tr.length>=3)o+='<div style="margin-top:2px">'+sparkline(tr,"sc",14)+'</div>';
      o+='</div></div>';

      // Why this score
      if(a.whyScore.length>0){o+='<div style="margin-top:5px">';a.whyScore.forEach(function(w){var c=w.p>0?"var(--grn)":w.p<0?"var(--red)":"var(--dim)";o+='<span class="why-tag" style="background:'+c+'15;color:'+c+';border:1px solid '+c+'30">'+(w.p>0?"‚ñ≤":"‚ñº")+" "+w.f+'</span>';});o+='</div>';}

      // Key metrics
      o+='<div class="G" style="grid-template-columns:repeat(auto-fit,minmax(90px,1fr));margin-top:8px">';
      [{l:"JK Density",v:a.jackpotDensityShift>0?a.jackpotDensityShift.toFixed(2)+"x":"‚Äî",c:a.jackpotDensityShift>=1.2?"g":a.jackpotDensityShift>=0.9?"d":"r"},
       {l:"JK P(pack)",v:a.hyperRatio>0?a.hyperRatio.toFixed(2)+"x":"‚Äî",c:a.hyperRatio>1.1?"g":a.hyperRatio<0.9?"r":"d"},
       {l:"JK EV",v:a.jackpotEV>0?"$"+a.jackpotEV.toFixed(2):"‚Äî",c:a.jackpotEVShift>1.05?"g":"d"},
       {l:"Top Left",v:a.tpr+"/"+a.tp.p,c:a.tpr>0?"g":"r"},
       {l:"Markov",v:a.gm.sig.replace(/_/g," "),c:"BUY STRONG_BUY".indexOf(a.gm.sig)>=0?"g":"AVOID DEAD".indexOf(a.gm.sig)>=0?"r":"d"},
       {l:"Sold",v:pct(a.mat),c:a.mat<0.5?"g":a.mat<0.8?"a":"r"},
       {l:"Floor",v:a.floorEV>0?"$"+fN(a.floorEV):"‚Äî",c:"d"},
       {l:"Conf",v:a.confidence,c:a.confidence==="HIGH"?"g":a.confidence==="MEDIUM"?"a":"r"},
       {l:"Gap",v:a.returnGap!==0?(a.returnGap>0?"+":"")+pct(a.returnGap):"‚Äî",c:a.returnGap>0.01?"g":a.returnGap<-0.01?"r":"d"}
      ].forEach(function(m){o+='<div><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:12px;font-weight:700" class="'+m.c+'">'+m.v+'</div></div>';});
      o+='</div>';

      // Jackpot tier quick view
      if(a.jackpotShifts.length>0){o+='<div style="margin-top:6px;padding:5px 8px;background:var(--bg);border-radius:6px;display:flex;gap:12px;flex-wrap:wrap">';
        a.jackpotShifts.forEach(function(j){var jc=j.signal==="STRONG"||j.signal==="GOOD"?"var(--grn)":j.signal==="NEUTRAL"?"var(--dim)":j.signal==="WEAK"?"var(--amb)":"var(--red)";
          o+='<div style="font-size:10px"><span style="font-weight:700;color:'+jc+'">$'+fN(j.a)+'</span> '+(j.remaining<=0?'<span class="r">GONE</span>':'<span class="d">'+j.remaining+'/'+j.printed+' '+j.shift.toFixed(2)+'x</span>')+'</div>';});
        o+='</div>';}

      if(a.flags.length>0){o+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:5px">';a.flags.slice(0,4).forEach(function(fl){o+='<span style="font-size:9px;font-weight:700;padding:3px 8px;border-radius:4px;background:var(--'+fl.c+'1);color:var(--'+fl.c+');border:1px solid var(--'+fl.c+')30">'+esc(fl.t)+'</span>';});o+='</div>';}
      o+='</div>';
    }
  }

  // ==================== DETAIL ====================
  if(S.tab==="detail"){
    o+='<select class="I" style="margin-bottom:14px" onchange="setSel(this.value)"><option value="">‚Äî Select game ‚Äî</option>';
    S.data.slice().sort(function(a,b){return b.sc-a.sc}).forEach(function(a){o+='<option value="'+a.g.id+'"'+(S.selId===a.g.id?" selected":"")+'>['+a.sc+'] '+esc(a.g.nm)+' #'+a.g.gn+' ($'+a.g.pr+')</option>';});
    o+='</select>';
    if(sel){
      // Header
      o+='<div class="C"><div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px"><div>';
      o+='<div style="font-size:18px;font-weight:800;color:var(--wht)">'+esc(sel.g.nm)+' <span class="d" style="font-size:14px">#'+sel.g.gn+'</span></div>';
      o+='<div style="font-size:11px;color:var(--dim);margin-top:4px">$'+sel.g.pr+' ¬∑ '+sel.g.pk+'/pack=$'+fN(sel.packPrice)+' ¬∑ Floor:$'+fN(sel.g.guar||0)+' ¬∑ Odds:1:'+sel.g.odds+'</div></div>';
      o+='<div style="text-align:right"><div class="V" style="color:'+(sel.sc>=65?"var(--grn)":sel.sc>=40?"var(--amb)":"var(--red)")+'">'+sel.sc+'</div><div class="L">SCORE</div></div></div>';
      // Why
      if(sel.whyScore.length){o+='<div style="margin-top:6px">';sel.whyScore.forEach(function(w){var c=w.p>0?"var(--grn)":w.p<0?"var(--red)":"var(--dim)";o+='<span class="why-tag" style="background:'+c+'15;color:'+c+';border:1px solid '+c+'30">'+(w.p>0?"‚ñ≤+":"‚ñº")+w.p+' '+w.f+'</span>';});o+='</div>';}
      o+='<div style="margin-top:8px;padding:8px 12px;background:var(--bg);border-radius:8px;font-size:12px">';
      o+='BTP:<strong class="g">$'+fN(sel.aa)+'</strong>'+(sel.btpValid?' <span class="d">‚úì</span>':'')+' ¬∑ Signal:<strong style="color:'+("BUY STRONG_BUY".indexOf(sel.gm.sig)>=0?"var(--grn)":"AVOID DEAD".indexOf(sel.gm.sig)>=0?"var(--red)":"var(--dim)")+'">'+sel.gm.sig.replace(/_/g," ")+'</strong> ¬∑ Conf:<strong style="color:'+(sel.confidence==="HIGH"?"var(--grn)":sel.confidence==="MEDIUM"?"var(--amb)":"var(--red)")+'">'+sel.confidence+'</strong></div>';
      if(!sel.complete)o+='<div style="margin-top:6px;padding:6px;background:var(--amb)18;border:1px solid var(--amb)30;border-radius:6px;font-size:11px;color:var(--amb)">‚ö† Missing data. Run scraper with detail pages.</div>';
      o+='</div>';

      // === JACKPOT TRACKER ===
      if(sel.jackpotShifts.length>0){
        o+='<div class="C" style="border-color:#d4a01744"><div class="L" style="margin-bottom:10px;color:var(--gld)">üéØ JACKPOT TRACKER</div>';
        sel.jackpotShifts.forEach(function(j){
          var sc2=j.signal==="STRONG"||j.signal==="GOOD"?"#2ecc71":j.signal==="NEUTRAL"?"#5a6a7a":j.signal==="WEAK"?"#f39c12":"#e74c3c";
          o+='<div style="padding:10px;background:var(--bg);border-radius:8px;margin-bottom:8px;border-left:3px solid '+sc2+';display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">';
          o+='<div style="font-size:20px;font-weight:800;color:'+sc2+'">$'+fN(j.a)+'</div>';
          if(j.remaining<=0)o+='<div style="font-size:16px;font-weight:800;color:var(--red)">ALL CLAIMED</div>';
          else{o+='<div style="text-align:center"><div style="font-size:16px;font-weight:800">'+j.remaining+'<span class="d" style="font-size:11px">/'+j.printed+'</span></div><div style="font-size:9px" class="d">LEFT</div></div>';
            o+='<div style="text-align:center"><div style="font-size:16px;font-weight:800;color:'+sc2+'">'+j.shift.toFixed(2)+'x</div><div style="font-size:9px" class="d">DENSITY</div></div>';
            o+='<div style="text-align:center"><div style="font-size:14px;font-weight:700">1:'+fN(j.currentOdds)+'</div><div style="font-size:8px;color:'+(j.launchOdds>j.currentOdds?"var(--grn)":"var(--red)")+'">'+(j.launchOdds>j.currentOdds?(j.launchOdds/j.currentOdds).toFixed(1)+"x better":"was 1:"+fN(j.launchOdds))+'</div></div>';}
          o+='<div style="font-size:11px;font-weight:700;color:'+sc2+';padding:4px 10px;background:'+sc2+'18;border-radius:6px">'+j.signal+'</div>';
          if(j.printed<=10)o+='<div style="width:100%;font-size:10px;color:var(--amb)">‚ö° ‚â§10 printed ‚Äî high sensitivity</div>';
          o+='</div>';});
        // Combined stats
        o+='<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">';
        o+='<div class="cl"><div class="L" style="font-size:8px">P(JK IN PACK)</div><div style="font-size:18px;font-weight:800;color:'+(sel.hyperRatio>1.05?'var(--grn)':'var(--wht)')+'">'+(sel.hyperNow>=0.01?pct(sel.hyperNow):'1:'+fN(Math.round(1/sel.hyperNow)))+'</div><div style="font-size:9px" class="d">'+sel.hyperRatio.toFixed(2)+'x vs launch</div></div>';
        o+='<div class="cl"><div class="L" style="font-size:8px">JK EV/PACK</div><div style="font-size:18px;font-weight:800;color:var(--pur)">$'+sel.jackpotEV.toFixed(2)+'</div><div style="font-size:9px" class="d">was $'+sel.jackpotEVLaunch.toFixed(2)+' ('+sel.jackpotEVShift.toFixed(2)+'x)</div></div>';
        o+='<div class="cl"><div class="L" style="font-size:8px">JK DENSITY</div><div style="font-size:18px;font-weight:800;color:'+(sel.jackpotDensityShift>=1.2?'var(--grn)':'var(--wht)')+'">'+sel.jackpotDensityShift.toFixed(2)+'x</div></div>';
        o+='</div></div>';}

      // === EV MODEL ===
      o+='<div class="C" style="border-color:#3498db44"><div class="L" style="margin-bottom:10px;color:var(--blu)">üìä FLOOR-BASED EV</div>';
      o+='<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px">';
      [{l:"Floor(FACT)",v:"$"+fN(sel.floorEV),c:"var(--grn)"},{l:"Mid Upside",v:"$"+sel.midRangeEV.toFixed(0),c:"var(--blu)"},{l:"Jackpot EV",v:"$"+sel.jackpotEV.toFixed(2),c:"var(--pur)"},{l:"Total EV",v:"$"+Math.round(sel.totalEV),c:"var(--wht)"},{l:"Pack Cost",v:"$"+fN(sel.packPrice),c:"var(--red)"},{l:"Edge",v:(sel.edge>0?"+":"")+pct(sel.edge),c:sel.edge>-0.1?"var(--amb)":"var(--red)"}].forEach(function(e){o+='<div class="cl"><div class="L" style="font-size:8px">'+e.l+'</div><div style="font-size:16px;font-weight:800;color:'+e.c+'">'+e.v+'</div></div>';});
      o+='</div>';
      var evMx=sel.packPrice||1;
      o+='<div style="height:28px;background:var(--bg);border-radius:6px;overflow:hidden;position:relative;display:flex">';
      [{v:sel.floorEV,c:"var(--grn)"},{v:sel.midRangeEV,c:"var(--blu)"},{v:sel.jackpotEV,c:"var(--pur)"}].forEach(function(e){o+='<div style="width:'+(e.v/evMx*100)+'%;height:100%;background:'+e.c+';opacity:.5"></div>';});
      o+='<div style="position:absolute;right:0;top:0;width:2px;height:100%;background:var(--red)"></div>';
      o+='<span style="position:absolute;right:8px;top:6px;font-size:11px;color:#fff;font-weight:600">$'+fN(sel.packPrice)+'</span></div>';
      o+='<div style="font-size:10px;margin-top:4px" class="d"><span class="g">‚ñ†</span>Floor <span class="b">‚ñ†</span>Mid <span class="p">‚ñ†</span>JK <span class="r">|</span>Cost</div></div>';

      // === SIMULATION ===
      var sim=simulatePacks(sel);
      if(sim.valid){
        o+='<div class="C" style="border-color:#9b59b644"><div class="L" style="margin-bottom:10px;color:var(--pur)">üé≤ SIMULATION ('+fN(sim.N)+' packs)</div>';
        o+='<div class="G" style="grid-template-columns:repeat(auto-fit,minmax(85px,1fr));margin-bottom:10px">';
        [{l:"P(Floor)",v:pct(sim.pFloor),c:sim.pFloor>0.7?"var(--red)":"var(--amb)"},{l:"P(Profit)",v:pct(sim.pProfit),c:sim.pProfit>0.05?"var(--grn)":"var(--red)"},{l:"P($10K+)",v:sim.p5Digit>0.001?pct(sim.p5Digit):"<0.1%",c:"var(--dim)"},{l:"P(JK$50K+)",v:sim.pJackpot>0.0001?pct(sim.pJackpot):"<0.01%",c:"var(--dim)"},{l:"Mean",v:"$"+Math.round(sim.mean),c:"var(--wht)"},{l:"Median",v:"$"+Math.round(sim.median),c:"var(--wht)"},{l:"Exp P&L",v:(sim.expPL>=0?"+":"")+"$"+Math.round(sim.expPL),c:sim.expPL>=0?"var(--grn)":"var(--red)"}].forEach(function(m){o+='<div class="cl"><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:13px;font-weight:800;color:'+m.c+'">'+m.v+'</div></div>';});
        o+='</div>';
        var mxBk=Math.max.apply(null,sim.buckets.map(function(b){return b.n}));
        sim.buckets.forEach(function(b){var w=mxBk>0?(b.n/mxBk)*100:0;var p2=(b.n/sim.N*100).toFixed(1);var c=b.l.indexOf("Break")>=0||b.l.indexOf("2x")>=0||b.l.indexOf("5x")>=0?"var(--grn)":b.l.indexOf("Floor+")>=0?"var(--amb)":"var(--dim)";
          o+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px"><div style="width:70px;text-align:right;font-size:10px;font-weight:600;color:'+c+'">'+b.l+'</div><div style="flex:1;height:18px;background:var(--bg);border-radius:3px;overflow:hidden;position:relative"><div style="width:'+w+'%;height:100%;background:'+c+';opacity:.5;border-radius:3px"></div><span style="position:absolute;right:6px;top:1px;font-size:10px;color:#fff;font-weight:600">'+p2+'%</span></div></div>';});
        o+='<div style="font-size:10px;margin-top:4px" class="d">Range: $'+fN(sim.worst)+'‚Äì$'+fN(sim.best)+' ¬∑ Cost: $'+fN(sim.cost)+'</div></div>';}

      // === VALIDATION ===
      o+='<div class="C"><div class="L" style="margin-bottom:8px">VALIDATION</div>';
      o+='<div class="G G3">';
      [{l:"BTP Clock(A)",v:fN(sel.methodA)},{l:"Prize Cnt(B)",v:fN(sel.methodB)},{l:"$Yield(C)",v:fN(sel.methodC)}].forEach(function(m){o+='<div class="cl"><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:13px;font-weight:700">'+m.v+'</div></div>';});
      o+='</div>';
      o+='<div style="margin-top:6px;font-size:11px">Conf:<strong style="color:'+(sel.confidence==="HIGH"?"var(--grn)":sel.confidence==="MEDIUM"?"var(--amb)":"var(--red)")+'"> '+sel.confidence+'</strong> ¬∑ Yield:<strong style="color:'+(sel.yieldValid?"var(--grn)":"var(--red)")+'"> '+pct(sel.impliedYield)+'</strong>'+(sel.yieldValid?' ‚úì':' ‚ö†');
      if(sel.btpInfo.valid){o+=' ¬∑ BTP Zone: ';sel.btpInfo.floorZone.forEach(function(fz,idx){o+='<strong style="color:'+(fz.a===sel.aa?'var(--grn)':'var(--dim)')+'">$'+fN(fz.a)+'</strong>('+fz.ratio.toFixed(2)+')';if(idx<sel.btpInfo.floorZone.length-1)o+='¬∑';});if(sel.btpInfo.floorValid)o+=' <span class="g">Floor‚úì</span>';}
      o+='</div></div>';

      // === RETURN GAP ===
      o+='<div class="C"><div class="L" style="margin-bottom:8px">RETURN GAP (cross-check)</div>';
      var dr=sel.designedReturn*100,rr=sel.remainReturnPct*100,mxR=Math.max(dr,rr,1);
      [{l:"DESIGNED",v:dr,c:"#5a6a7a"},{l:"REMAINING",v:rr,c:rr>dr?"#2ecc71":"#e74c3c"}].forEach(function(b){o+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><div style="width:80px;text-align:right;font-size:10px;font-weight:600;color:'+b.c+'">'+b.l+'</div><div style="flex:1;height:22px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative"><div style="width:'+(b.v/mxR*100)+'%;height:100%;background:'+b.c+';border-radius:4px"></div><span style="position:absolute;right:8px;top:3px;font-size:11px;color:#fff;font-weight:600">'+b.v.toFixed(1)+'%</span></div></div>';});
      if(sel.returnGap!==0)o+='<div style="text-align:center;font-size:16px;font-weight:800;color:'+(sel.returnGap>0?"var(--grn)":"var(--red)")+'">'+(sel.returnGap>0?"+":"")+pct(sel.returnGap)+'</div>';
      o+='</div>';

      // === PRIZE BARS ===
      o+='<div class="C"><div class="L" style="margin-bottom:8px">PRIZE POOL</div>';
      sel.prizes.forEach(function(p){var pC=p.p>0?p.c/p.p*100:0,pR=100-pC;var c=p.cat==="JACKPOT"?"#d4a017":p.cat==="MID"?"#9b59b6":p.isA?"#2ecc71":"#3498db";
        o+='<div class="bar-row"><div class="bar-label" style="color:'+c+'">$'+fN(p.a)+(p.isA?' BTP':'')+(p.isJackpot?' üéØ':'')+'</div><div class="bar-track"><div style="width:'+pC+'%;height:100%;background:'+c+';opacity:.25"></div><div style="width:'+pR+'%;height:100%;background:'+c+';opacity:.7"></div><div class="bar-pct">'+fN(p.rem)+' ('+pR.toFixed(0)+'%)</div></div></div>';});
      o+='<div style="font-size:10px;margin-top:4px" class="d"><span style="color:#d4a017">‚ñ†</span>JK <span style="color:#9b59b6">‚ñ†</span>MID <span style="color:#2ecc71">‚ñ†</span>BTP <span style="color:#3498db">‚ñ†</span>FLOOR</div></div>';

      // === MARKOV ===
      if(sel.gm.ts.length>0){
        o+='<div class="C"><div class="L" style="margin-bottom:8px">MARKOV ‚Äî <span style="color:'+("BUY STRONG_BUY".indexOf(sel.gm.sig)>=0?"var(--grn)":"AVOID DEAD".indexOf(sel.gm.sig)>=0?"var(--red)":"var(--dim)")+'">'+sel.gm.sig.replace(/_/g," ")+'</span></div>';
        o+='<div style="font-size:11px;margin-bottom:8px">'+esc(sel.gm.rsn)+'</div>';
        sel.gm.ts.forEach(function(t){var tc=t.sig==="HOT"?"#2ecc71":t.sig==="COLD"?"#e74c3c":"#5a6a7a";
          o+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="width:70px;text-align:right;font-weight:600;font-size:11px">$'+fN(t.a)+'</span><span style="width:45px;font-size:8px;color:'+(t.isJackpot?'var(--gld)':'var(--dim)')+'">'+t.cat+'</span><div style="flex:1;height:20px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative"><div style="width:'+Math.min(100,Math.max(2,t.ar*100))+'%;height:100%;background:'+tc+';opacity:.65;border-radius:4px"></div><div style="position:absolute;left:'+Math.min(95,Math.max(0,t.er*100))+'%;top:0;width:2px;height:100%;background:#f39c12"></div></div><span style="width:45px;font-size:10px;font-weight:700;color:'+tc+'">'+(t.sig==="NORMAL"?"‚Äî":t.sig)+'</span></div>';});
        o+='<div style="font-size:10px;margin-top:4px" class="d">Bar=claim rate ¬∑ Yellow=BTP rate ¬∑ JK tiers drive score</div></div>';}

      // === SCORE BREAKDOWN ===
      o+='<div class="C"><div class="L" style="margin-bottom:8px">SCORE ('+sel.sc+'/100)</div><div style="font-size:10px" class="d">Base: 50</div>';
      sel.scoreBreakdown.forEach(function(s){var c=s.p>0?"var(--grn)":s.p<0?"var(--red)":"var(--dim)";o+='<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:11px"><span>'+esc(s.f)+'</span><span style="font-weight:700;color:'+c+'">'+(s.p>0?"+":"")+s.p+'</span></div>';});
      o+='<div style="border-top:1px solid var(--border);margin-top:4px;padding-top:4px;display:flex;justify-content:space-between;font-weight:700"><span>FINAL</span><span style="color:'+(sel.sc>=65?"var(--grn)":sel.sc>=40?"var(--amb)":"var(--red)")+'">'+sel.sc+'</span></div></div>';

      // === TREND ===
      var tr2=getTrend(sel.g.id);
      if(tr2.length>=3){
        o+='<div class="C"><div class="L" style="margin-bottom:8px">TREND ('+tr2.length+' days)</div>';
        o+='<div style="display:flex;gap:20px;flex-wrap:wrap">';
        [{l:"Score",f:"sc"},{l:"JK Density",f:"jd"},{l:"JK Left",f:"jr"},{l:"Top Left",f:"tpr"}].forEach(function(s){
          o+='<div><div class="L" style="font-size:8px">'+s.l+'</div>'+sparkline(tr2,s.f,24)+'<div style="font-size:10px;font-weight:700;margin-top:2px">'+tr2[tr2.length-1][s.f]+'</div></div>';});
        o+='</div></div>';}

      // === FULL TABLE ===
      o+='<div class="C" style="overflow-x:auto"><div class="L" style="margin-bottom:8px">PRIZE TABLE</div><table><thead><tr>';
      ["Prize","Cat","Printed","Claimed","Left","%","Launch","Now","Shift"].forEach(function(h){o+='<th>'+h+'</th>';});
      o+='</tr></thead><tbody>';
      sel.prizes.forEach(function(p){var rc=p.cat==="JACKPOT"?"var(--gld)":p.cat==="MID"?"var(--pur)":p.isA?"var(--grn)":"var(--wht)";var pL=100-p.pctC;
        o+='<tr'+(p.isJackpot?' style="background:#d4a01708"':'')+'><td style="font-weight:700;color:'+rc+'">$'+fN(p.a)+(p.highSens?' ‚ö°':'')+'</td><td style="font-size:9px" class="d">'+p.cat+'</td><td class="d">'+fN(p.p)+'</td><td class="d">'+fN(p.c)+'</td><td style="font-weight:700;color:'+(p.rem>0?"var(--grn)":"var(--red)")+'">'+fN(p.rem)+'</td><td style="color:'+(pL>50?"var(--grn)":pL>20?"var(--amb)":"var(--red)")+'">'+pL.toFixed(0)+'%</td><td class="d">'+fmtO(p.origO)+'</td><td>'+(p.rem>0?fmtO(p.currO):"-")+'</td><td>';
        if(p.rem>0&&p.currO<1e9){var bt=p.currO<p.origO;o+='<span style="color:'+(bt?"var(--grn)":"var(--red)")+'">'+(bt?"BETTER":"WORSE")+'</span>';}
        o+='</td></tr>';});
      o+='</tbody></table></div>';

      // Flags
      if(sel.flags.length){o+='<div class="C"><div class="L" style="margin-bottom:8px">SIGNALS</div>';sel.flags.forEach(function(fl){o+='<div style="display:flex;gap:8px;margin-bottom:5px;padding:5px 8px;background:var(--bg);border-radius:6px;border-left:3px solid var(--'+fl.c+')"><div style="font-size:9px;font-weight:700;color:var(--'+fl.c+');min-width:75px">'+esc(fl.t)+'</div><div style="font-size:11px">'+esc(fl.m)+'</div></div>';});o+='</div>';}

      // Actions
      o+='<div style="margin-top:4px;display:flex;gap:8px;flex-wrap:wrap"><div class="B on" onclick="startPack(\''+sel.g.id+'\')">Track Pack ‚Üí</div><div class="B pn" onclick="copyAIPrompt(\''+sel.g.id+'\')">üìã Prompt</div><div class="B pn" onclick="showAIPrompt(\''+sel.g.id+'\')">üëÅ Show</div></div>';
      if(S._promptPreview){o+='<div class="C" style="margin-top:8px;border-color:#9b59b644"><div style="display:flex;justify-content:space-between"><div class="L" style="color:#9b59b6">PROMPT</div><div class="B" style="font-size:9px;padding:2px 8px" onclick="S._promptPreview=null;render()">‚úï</div></div><pre style="font-size:10px;white-space:pre-wrap;word-break:break-word;max-height:400px;overflow-y:auto;background:var(--bg);padding:8px;border-radius:6px;margin:6px 0 0">'+esc(S._promptPreview)+'</pre></div>';}
    }
  }

  // ==================== INSIGHTS ====================
  if(S.tab==="insights"){
    o+='<div class="C" style="border-color:#9b59b644"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px"><div><div style="font-size:14px;font-weight:800;color:#9b59b6">üß† AI ANALYSIS</div><div style="font-size:10px" class="d">Generate prompt, paste into any AI</div></div>';
    o+='<div class="B pn" onclick="copyAllPrompt()">üìã Copy</div><div class="B pn" onclick="showAllPrompt()">üëÅ Show</div></div>';
    var trg=[];S.data.forEach(function(a){if(!a.complete||!a.btpInfo.hasJackpot)return;if(a.jackpotDensityShift>1.1||a.hyperRatio>1.1||a.returnGap>0.03||(a.g.cs&&a.tpr>0)||a.gm.sig==="BUY"||a.gm.sig==="STRONG_BUY"||a.gm.sig==="AVOID"||a.gm.sig==="DEAD"||a.returnGap<-0.03)trg.push(a);});
    o+='<div style="margin-top:6px;font-size:11px" class="d">'+trg.length+' games with signals</div>';
    if(trg.length){o+='<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">';trg.sort(function(a,b){return b.sc-a.sc}).slice(0,20).forEach(function(t){o+='<span class="ck" onclick="openDetail(\''+t.g.id+'\')" style="font-size:9px;padding:3px 8px;background:#9b59b618;border:1px solid #9b59b630;border-radius:4px;color:#9b59b6">'+esc(t.g.nm)+' $'+t.g.pr+' ['+t.sc+']</span>';});o+='</div>';}
    if(S._allPromptPreview){o+='<div style="margin-top:8px"><div style="display:flex;justify-content:space-between"><div class="L" style="color:#9b59b6">PROMPT</div><div class="B" style="font-size:9px;padding:2px 8px" onclick="S._allPromptPreview=null;render()">‚úï</div></div><pre style="font-size:10px;white-space:pre-wrap;word-break:break-word;max-height:500px;overflow-y:auto;background:var(--bg);padding:8px;border-radius:6px;margin:6px 0 0">'+esc(S._allPromptPreview)+'</pre></div>';}
    o+='</div>';

    var ins=[];
    S.data.forEach(function(a){
      var gl=a.g.nm+" #"+a.g.gn;
      if(a.g.cs&&a.tpr>0)ins.push({pri:3,cat:"CLOSING",t:gl+" ‚Äî "+a.tpr+" top left",d:fmtO(a.tpo)+" odds",c:"var(--amb)",pr:a.g.pr,id:a.g.id,sc:a.sc});
      if(a.tpr===0)ins.push({pri:8,cat:"TOP GONE",t:gl,d:"All "+fmt(a.tp.a)+" claimed",c:"var(--red)",pr:a.g.pr,id:a.g.id,sc:a.sc});
      if(a.jackpotDensityShift>1.2)ins.push({pri:1,cat:"JK DENSE",t:gl+" ‚Äî "+a.jackpotDensityShift.toFixed(1)+"x",d:"Jackpots concentrated",c:"var(--grn)",pr:a.g.pr,id:a.g.id,sc:a.sc});
      if(a.hyperRatio>1.2)ins.push({pri:2,cat:"JK ODDS+",t:gl+" ‚Äî "+a.hyperRatio.toFixed(1)+"x launch",d:"",c:"var(--grn)",pr:a.g.pr,id:a.g.id,sc:a.sc});
      if(a.gm.sig==="STRONG_BUY")ins.push({pri:1,cat:"STRONG BUY",t:gl,d:a.gm.rsn,c:"var(--grn)",pr:a.g.pr,id:a.g.id,sc:a.sc});
      if(a.gm.sig==="DEAD")ins.push({pri:9,cat:"DEAD",t:gl,d:a.gm.rsn,c:"var(--red)",pr:a.g.pr,id:a.g.id,sc:a.sc});
      if(a.gm.sig==="AVOID")ins.push({pri:7,cat:"AVOID",t:gl,d:a.gm.rsn,c:"var(--red)",pr:a.g.pr,id:a.g.id,sc:a.sc});
      if(a.hollowedOut)ins.push({pri:6,cat:"HOLLOWED",t:gl,d:"Top exists but mid gone",c:"var(--amb)",pr:a.g.pr,id:a.g.id,sc:a.sc});
      if(a.returnGap>0.02)ins.push({pri:4,cat:"RICH",t:gl+" +"+(a.returnGap*100).toFixed(1)+"%",d:"",c:"var(--grn)",pr:a.g.pr,id:a.g.id,sc:a.sc});
      if(a.returnGap<-0.02)ins.push({pri:7,cat:"THIN",t:gl+" "+(a.returnGap*100).toFixed(1)+"%",d:"",c:"var(--red)",pr:a.g.pr,id:a.g.id,sc:a.sc});
      if(a.mat<0.08&&a.complete)ins.push({pri:5,cat:"FRESH",t:gl+" "+pct(a.mat),d:"Full pool",c:"var(--blu)",pr:a.g.pr,id:a.g.id,sc:a.sc});
    });
    var byP={};S.data.forEach(function(a){if(!byP[a.g.pr]||a.sc>byP[a.g.pr].sc)byP[a.g.pr]=a});
    Object.keys(byP).forEach(function(pr2){var a=byP[pr2];var cnt=S.data.filter(function(x){return x.g.pr===a.g.pr}).length;if(cnt>=2)ins.push({pri:5,cat:"BEST $"+pr2,t:a.g.nm+" #"+a.g.gn,d:"Score:"+a.sc+" of "+cnt+" games",c:"var(--blu)",pr:a.g.pr,id:a.g.id,sc:a.sc});});
    ins.sort(function(a,b){return a.pri!==b.pri?a.pri-b.pri:b.sc-a.sc});

    o+='<div class="C"><div style="font-size:14px;font-weight:800">PATTERNS</div><div style="font-size:11px" class="d">'+ins.length+' from '+S.data.length+' games</div></div>';
    ins.forEach(function(n){
      o+='<div class="C ck" onclick="openDetail(\''+n.id+'\')" style="border-left:3px solid '+n.c+'"><div style="display:flex;justify-content:space-between;gap:8px"><div>';
      o+='<div style="display:flex;gap:6px;margin-bottom:3px"><span style="font-size:9px;font-weight:700;color:'+n.c+'">'+esc(n.cat)+'</span>';
      if(n.pr)o+='<span style="font-size:9px;font-weight:800;color:#fff;background:'+prClr(n.pr)+';padding:1px 6px;border-radius:3px">$'+n.pr+'</span>';
      o+='</div><div style="font-size:13px;font-weight:700;color:var(--wht)">'+esc(n.t)+'</div>';
      if(n.d)o+='<div style="font-size:11px;margin-top:2px">'+esc(n.d)+'</div>';
      o+='</div><div style="font-size:18px;opacity:.3">‚Ä∫</div></div></div>';
    });
  }

  // ==================== WINNERS ====================
  if(S.tab==="winners"){
    if(!S.winData)S.winData=JSON.parse(localStorage.getItem("txwd7")||"{}");
    var allW=[];Object.keys(S.winData).forEach(function(gn){(S.winData[gn]||[]).forEach(function(w){w.gn=Number(gn);allW.push(w)})});
    o+='<div class="C"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:16px;font-weight:800">WINNERS</div><div style="font-size:11px" class="d">'+allW.length+' records</div></div><div class="B'+(S._fetching?"":" on")+'" onclick="fetchWinners()">'+(S._fetching?'...':'FETCH')+'</div></div></div>';
    if(allW.length>0){
      var stores={};allW.forEach(function(w){if(!w.store)return;var k=w.store.toUpperCase().trim();if(!stores[k])stores[k]={name:w.store,city:w.city||"",count:0};stores[k].count++});
      var hot=Object.values(stores).filter(function(s){return s.count>=2}).sort(function(a,b){return b.count-a.count});
      if(hot.length){o+='<div class="C"><div class="L" style="color:var(--grn);margin-bottom:6px">REPEAT STORES</div>';hot.forEach(function(s){o+='<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #1e2d3d20"><div style="font-size:12px">'+esc(s.name)+' <span class="d">'+esc(s.city)+'</span></div><div class="g" style="font-weight:800">'+s.count+'x</div></div>';});o+='</div>';}
      o+='<div class="C" style="overflow-x:auto"><table><thead><tr>';
      ["Date","Game","Store","City","Pack#","Tk#"].forEach(function(h){o+='<th style="text-align:left">'+h+'</th>'});
      o+='</tr></thead><tbody>';
      allW.sort(function(a,b){return(b.date||"").localeCompare(a.date||"")}).slice(0,200).forEach(function(w){
        o+='<tr><td style="text-align:left;font-size:10px">'+esc(w.date||"-")+'</td><td style="text-align:left;font-size:10px">#'+w.gn+'</td><td style="text-align:left;font-size:10px">'+esc(w.store||"-")+'</td><td style="text-align:left;font-size:10px">'+esc(w.city||"-")+'</td><td style="text-align:left;font-size:10px;color:var(--blu)">'+(w.pn?fN(w.pn):"-")+'</td><td style="text-align:left;font-size:10px;color:var(--amb)">'+(w.tk||"-")+'</td></tr>';});
      o+='</tbody></table></div>';
    }
  }

  // ==================== MORE ====================
  if(S.tab==="more"){
    o+='<div class="FR">';[["pack","PACK P&L"],["bank","BANKROLL"]].forEach(function(t){o+='<div class="B'+(S.moreTab===t[0]?" on":"")+'" onclick="setMore(\''+t[0]+'\')">'+t[1]+'</div>';});o+='</div>';
    if(S.moreTab==="pack"){
      var pk2=S.pack,mk=mkv();
      o+='<div class="C"><div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px"><div><div style="font-size:15px;font-weight:700;color:var(--wht)">'+(pk2.nm||"Select from Detail")+'</div><div style="font-size:10px" class="d">$'+pk2.pr+' ¬∑ '+pk2.pk+'/pk ¬∑ BTP:$'+pk2.aa+'</div></div>';
      o+='<div style="text-align:right"><div style="font-size:24px;font-weight:800;color:'+((pk2.won-pk2.spent)>=0?"var(--grn)":"var(--red)")+'">'+((pk2.won-pk2.spent)>=0?"+":"")+'$'+(pk2.won-pk2.spent)+'</div><div class="L">P&L</div></div></div></div>';
      if(mk&&pk2.nm){var mkc=mk.dec==="BUY"?"var(--grn)":mk.dec==="STOP"?"var(--red)":mk.dec==="CONSIDER"?"var(--amb)":"var(--blu)";
        o+='<div class="C"><div class="L" style="color:var(--blu)">MARKOV MID-PACK</div><div class="G GA" style="margin:8px 0">';
        [{l:"Left",v:mk.rem,c:"var(--wht)"},{l:"P(Win)",v:pct(mk.pW),c:"var(--blu)"},{l:"P(Anchor)",v:pct(mk.pA),c:pk2.af?"var(--dim)":"var(--grn)"},{l:"Found?",v:pk2.af?"YES":"NO",c:pk2.af?"var(--grn)":"var(--amb)"}].forEach(function(m){o+='<div><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:16px;font-weight:700;color:'+m.c+'">'+m.v+'</div></div>';});
        o+='</div><div style="padding:8px;background:var(--bg);border-radius:6px"><span style="font-size:14px;font-weight:700;color:'+mkc+'">'+mk.dec+'</span> <span style="font-size:11px">'+esc(mk.rsn)+'</span></div></div>';}
      o+='<div class="C"><div class="L" style="margin-bottom:8px">LOG TICKET</div><div class="FR">';
      o+='<div class="B rn" onclick="scratch(0)">LOSER</div>';
      var qb2=[pk2.pr,pk2.pr*2,pk2.pr*5,pk2.aa,pk2.aa*2],sn2={};
      for(var qi=0;qi<qb2.length;qi++){if(!sn2[qb2[qi]]){sn2[qb2[qi]]=1;o+='<div class="B'+(qb2[qi]>=pk2.aa?" pn":" on")+'" onclick="scratch('+qb2[qi]+')">$'+fN(qb2[qi])+'</div>';}}
      o+='<input type="number" id="cAmt" class="I" style="width:80px;display:inline-block" placeholder="$"><div class="B bn" onclick="var v=document.getElementById(\'cAmt\').value;if(v){scratch(+v);document.getElementById(\'cAmt\').value=\'\'}">LOG</div></div>';
      o+='<div style="display:flex;gap:16px;margin:8px 0">';
      [{l:"Done",v:pk2.log.length+"/"+pk2.pk,c:"var(--wht)"},{l:"Spent",v:"$"+pk2.spent,c:"var(--red)"},{l:"Won",v:"$"+pk2.won,c:"var(--grn)"},{l:"ROI",v:pk2.spent>0?pct(pk2.won/pk2.spent-1):"‚Äî",c:pk2.spent>0?(pk2.won>=pk2.spent?"var(--grn)":"var(--red)"):"var(--dim)"}].forEach(function(m){o+='<div><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:18px;font-weight:700;color:'+m.c+'">'+m.v+'</div></div>';});
      o+='</div>';
      o+='<div style="background:var(--bg);border-radius:6px;height:20px;overflow:hidden"><div style="width:'+((pk2.log.length/pk2.pk)*100)+'%;height:100%;background:linear-gradient(90deg,var(--grn),var(--blu));border-radius:6px;transition:width .2s"></div></div>';
      if(pk2.log.length>0){o+='<div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:10px">';pk2.log.forEach(function(e){o+='<div style="min-width:'+(e.w?34:24)+'px;height:20px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:'+(e.w?9:10)+'px;font-weight:600;padding:0 3px;background:'+(e.amt>=pk2.aa?"var(--pur1)":e.w?"var(--grn1)":"var(--bg)")+';color:'+(e.amt>=pk2.aa?"var(--pur)":e.w?"var(--grn)":"#1e2d3d")+';border:1px solid '+(e.amt>=pk2.aa?"#9b59b644":e.w?"#2ecc7130":"#1e2d3d44")+'">'+(e.w?"$"+e.amt:"x")+'</div>';});o+='</div>';}
      o+='<div style="display:flex;gap:6px;margin-top:12px"><div class="B rn" onclick="resetPack()">RESET</div><div class="B on" onclick="saveSession()">SAVE</div></div></div>';
    }
    if(S.moreTab==="bank"){
      var tss=0,tsw=0;S.sessions.forEach(function(s){tss+=s.s;tsw+=s.w});
      o+='<div class="C"><div class="L" style="margin-bottom:8px">BANKROLL</div>';
      o+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px"><span class="d">Starting: $</span><input type="number" value="'+S.bankroll+'" onchange="setBR(+this.value)" class="I" style="width:110px"></div>';
      o+='<div class="G GA">';
      [{l:"BANKROLL",v:fmt(S.bankroll),c:"var(--wht)"},{l:"SPENT",v:fmt(tss),c:"var(--red)"},{l:"WON",v:fmt(tsw),c:"var(--grn)"},{l:"NET",v:((tsw-tss)>=0?"+":"")+fmt(tsw-tss),c:(tsw-tss)>=0?"var(--grn)":"var(--red)"},{l:"LEFT",v:fmt(S.bankroll-tss+tsw),c:"var(--wht)"}].forEach(function(m){o+='<div class="cl"><div class="L" style="font-size:8px">'+m.l+'</div><div class="V" style="color:'+m.c+'">'+m.v+'</div></div>';});
      o+='</div></div>';
      if(S.sessions.length){o+='<div class="C"><div class="L" style="margin-bottom:6px">HISTORY</div>';
        S.sessions.forEach(function(s){var pl=s.w-s.s;o+='<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #1e2d3d20"><div><div style="font-size:12px;color:var(--wht)">'+esc(s.g)+'</div><div style="font-size:10px" class="d">'+s.t+' tk ¬∑ '+s.d+'</div></div><div style="font-size:14px;font-weight:700;color:'+(pl>=0?"var(--grn)":"var(--red)")+'">'+(pl>=0?"+":"")+'$'+pl+'</div></div>';});
        if(S.sessions.length>=2){var avgL=0;S.sessions.forEach(function(s){avgL+=s.s-s.w});avgL/=S.sessions.length;var remBR=S.bankroll-tss+tsw;var sessL=avgL>0?Math.floor(remBR/avgL):999;
          o+='<div style="margin-top:10px;padding:8px;background:var(--bg);border-radius:6px"><div class="L" style="color:var(--amb)">BURN RATE</div><div style="font-size:12px;margin-top:4px">Avg loss: <strong class="r">$'+avgL.toFixed(0)+'</strong> ¬∑ Sessions left: <strong style="color:'+(sessL<5?"var(--red)":"var(--amb)")+'">'+sessL+'</strong></div></div>';}
        o+='<div class="B rn" style="margin-top:8px" onclick="clearSess()">Clear</div></div>';
      }
    }
  }

  o+='<div style="text-align:center;margin-top:30px;padding:14px 0;border-top:1px solid var(--border);font-size:9px;color:#1e2d3d88;line-height:1.6">TX Engine v7 ¬∑ Jackpot Focused ¬∑ Fact-Based<br>Play responsibly ¬∑ 1-800-522-4700</div>';
  document.getElementById("app").innerHTML=o;
}
init();
</script>
</body>
</html>
