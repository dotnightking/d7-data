<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TX Engine">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230d1118' width='100' height='100' rx='20'/><text x='50' y='62' text-anchor='middle' fill='%232ecc71' font-size='36' font-weight='900' font-family='system-ui'>TX</text></svg>">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>TX Scratch-Off Engine v6</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé∞</text></svg>">
<style>
:root{
  --bg:#0d1118;--card:#151d28;--border:#1e2d3d;--text:#d0dae6;--dim:#8899aa;
  --grn:#2ecc71;--red:#e74c3c;--blu:#3498db;--amb:#f39c12;--pur:#9b59b6;--wht:#ecf0f1;--gld:#d4a017;
  --grn1:#2ecc7118;--red1:#e74c3c18;--blu1:#3498db18;--pur1:#9b59b618;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;font-size:13px;line-height:1.5;min-height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}input[type=number]{-moz-appearance:textfield}
.W{max-width:960px;margin:0 auto;padding:0 14px 100px}
.H{padding:14px 0;border-bottom:1px solid var(--border);margin-bottom:16px;position:sticky;top:0;background:var(--bg);z-index:99}
h1{font-size:20px;font-weight:800;color:var(--grn);letter-spacing:-.02em}
.sub{font-size:11px;color:var(--gld);margin-top:2px}
.stale{color:var(--amb);font-weight:700}
.tabs{display:flex;gap:5px;margin-top:10px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none}.tabs::-webkit-scrollbar{display:none}
.T{padding:8px 16px;border-radius:8px;border:1px solid var(--border);color:var(--dim);cursor:pointer;font:600 11px/1 'Segoe UI',sans-serif;white-space:nowrap;background:0 0;transition:.15s}
.T:hover{border-color:var(--dim);color:var(--text)}
.T.on{border-color:var(--grn);background:var(--grn1);color:var(--grn)}
.C{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px;position:relative}
.L{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.06em;font-weight:600;margin-bottom:4px}
.V{font-size:24px;font-weight:800;line-height:1}
.g{color:var(--grn)}.r{color:var(--red)}.b{color:var(--blu)}.a{color:var(--amb)}.p{color:var(--pur)}.w{color:var(--wht)}.d{color:var(--dim)}
.G{display:grid;gap:10px}.GA{grid-template-columns:repeat(auto-fit,minmax(130px,1fr))}
.G2{grid-template-columns:1fr 1fr}.G3{grid-template-columns:1fr 1fr 1fr}
.cl{background:var(--bg);border-radius:8px;padding:10px}
.B{padding:8px 16px;border-radius:8px;border:1px solid var(--border);color:var(--dim);cursor:pointer;font:600 11px 'Segoe UI',sans-serif;background:0 0;display:inline-block;transition:.15s}
.B:hover{border-color:var(--dim);color:var(--text)}
.B.on{border-color:var(--grn);background:var(--grn1);color:var(--grn)}
.B.bn{border-color:var(--blu);background:var(--blu1);color:var(--blu)}
.B.pn{border-color:var(--pur);background:var(--pur1);color:var(--pur)}
.B.rn{border-color:var(--red);background:var(--red1);color:var(--red)}
.I{background:#0a0e14;border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font:13px 'Segoe UI',sans-serif;outline:0;width:100%}
.I:focus{border-color:var(--blu)}select.I{cursor:pointer;-webkit-appearance:none}
.FR{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
.sig{margin-top:8px;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:600}
.sig.buy{background:var(--grn1);color:var(--grn);border:1px solid #2ecc7130}
.sig.avoid{background:var(--red1);color:var(--red);border:1px solid #e74c3c30}
.badge{font-size:9px;font-weight:700;padding:3px 10px;border-radius:0 0 6px 6px;position:absolute;top:-1px;letter-spacing:.04em}
table{width:100%;border-collapse:collapse}
th{text-align:right;padding:6px 8px;font-size:10px;color:var(--dim);border-bottom:1px solid var(--border);font-weight:600}
td{padding:6px 8px;text-align:right;font-size:11px;border-bottom:1px solid #1e2d3d20}
.ck{cursor:pointer;transition:.15s}.ck:hover{background:#ffffff08;border-color:#ffffff18}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.bar-label{width:80px;text-align:right;font-size:11px;font-weight:600;flex-shrink:0}
.bar-track{flex:1;height:22px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative;display:flex}
.bar-pct{position:absolute;right:6px;top:3px;font-size:9px;color:var(--wht);font-weight:600;text-shadow:0 1px 2px #000}
@media(max-width:640px){.G3{grid-template-columns:1fr 1fr}.GA{grid-template-columns:repeat(auto-fit,minmax(110px,1fr))}h1{font-size:17px}.bar-label{width:60px;font-size:10px}}
</style>
</head>
<body>
<div class="W" id="app"></div>
<script>
// === ZERO HARDCODED DATA ===
// All game data loaded from feed.json (scraper output)
var GD=[];  // populated by refreshAllData() ONLY
var DD="";  // data date from feed.json

// === UTILITY FUNCTIONS ===
function fmt(n){if(n>=1e6)return "$"+(n/1e6).toFixed(1)+"M";if(n>=1e3)return "$"+(n/1e3).toFixed(1)+"K";return "$"+Math.round(n)}
function pct(n){return(n*100).toFixed(1)+"%"}
function fmtO(n){if(n===Infinity||n>1e9)return "-";if(n>=1e6)return "1:"+Math.round(n/1e6)+"M";if(n>=1e3)return "1:"+Math.round(n/1e3)+"K";return "1:"+Math.round(n)}
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function fN(n){return n.toLocaleString()}
function prClr(pr){var m={1:"#c39bd3",2:"#bb8fce",3:"#af7ac5",5:"#a569bd",10:"#9b59b6",20:"#884ea0",30:"#7d3c98",50:"#6c3483",100:"#5b2c6f"};return m[pr]||"#9b59b6"}

// === CORE ANALYSIS ENGINE ===
// Every number derived from game's own data. Zero assumptions.
function analyze(g){
  var i,j,p,ratio,above;
  var R=function(p){return p.p-p.c};
  
  // === DATA COMPLETENESS CHECK ===
  var totWinP=0;for(i=0;i<g.pz.length;i++)totWinP+=g.pz[i].p;
  var tpvp=0;for(i=0;i<g.pz.length;i++)tpvp+=g.pz[i].a*g.pz[i].p;
  
  // If tot is missing or produces impossible return (>95%), use odds-based estimate
  if(g.tot<=0&&g.odds>0)g.tot=Math.round(totWinP*g.odds);
  if(g.tot>0&&g.pr>0&&tpvp/(g.tot*g.pr)>0.95&&g.odds>0){
    // tot is wrong (more prize $ than ticket revenue). Recalc from odds.
    g.tot=Math.round(totWinP*g.odds);
  }
  if(g.pk<=0)g.pk=0; // truly unknown, don't guess
  
  var complete=g.tot>0&&g.pk>0&&g.guar>0&&g.odds>0;
  var pc=g.pk>0&&g.tot>0?Math.round(g.tot/g.pk):0;
  
  // === DESIGNED RETURN ===
  // total_prize_value / (total_tickets √ó ticket_price)
  var designedReturn=g.tot>0&&g.pr>0?tpvp/(g.tot*g.pr):0;
  
  // === BTP DETECTION (hybrid: ratio + floor) ===
  var ratBTP=null,cands=[];
  if(pc>0){
    for(i=0;i<g.pz.length;i++){p=g.pz[i];if(p.p<10)continue;ratio=p.p/pc;if(ratio>=0.5&&ratio<=2.0)cands.push({a:p.a,r:ratio})}
    cands.sort(function(a,b){return b.a-a.a});
    for(i=0;i<cands.length;i++){above=0;for(j=0;j<g.pz.length;j++)if(g.pz[j].a>cands[i].a)above+=g.pz[j].p;if(above/pc<1){ratBTP=cands[i].a;break}}
  }
  var flBTP=null;
  if(pc>0&&g.guar>0){
    var sp=g.pz.slice().sort(function(a,b){return a.a-b.a}),cv=0;
    for(i=0;i<sp.length;i++){p=sp[i];ratio=p.p/pc;if(ratio<0.05)continue;cv+=p.a*ratio;if(cv>=g.guar&&!flBTP){above=0;for(j=0;j<g.pz.length;j++)if(g.pz[j].a>p.a)above+=g.pz[j].p;if(above/pc<1)flBTP=p.a}}
  }
  
  // BTP: use highest of ratio-based and floor-based, no fallback table
  var aa=0;
  if(ratBTP&&flBTP)aa=Math.max(ratBTP,flBTP);else if(ratBTP)aa=ratBTP;else if(flBTP)aa=flBTP;
  // If BTP can't be detected (missing pk/guar), use highest tier with ratio near 1
  if(aa===0&&pc>0){for(i=g.pz.length-1;i>=0;i--){if(g.pz[i].p/pc>=0.5&&g.pz[i].p/pc<=2){aa=g.pz[i].a;break}}}
  
  // === BTP VALIDATION via designed return ===
  // Floor return should be 30-70% of designed return (floor is minimum, not average)
  var btpValid=false;
  if(aa>0&&g.guar>0&&g.pk>0&&g.pr>0){
    var floorReturn=g.guar/(g.pk*g.pr);
    var floorRatio=designedReturn>0?floorReturn/designedReturn:0;
    btpValid=floorRatio>=0.25&&floorRatio<=0.85;
  }
  
  var ai=g.pz.findIndex(function(p){return p.a===aa}),at=ai>=0?g.pz[ai]:null;
  var acr=at&&at.p>0?at.c/at.p:0; // BTP claim rate = our clock
  
  // === PACKS SOLD ESTIMATION (from BTP clock) ===
  var eps=pc>0?Math.round(pc*acr):0;
  var epr=Math.max(1,pc-eps);
  var ets=eps*g.pk;
  var etr=Math.max(0,g.tot-ets);
  
  // === PRIZE VALUE ANALYSIS ===
  var tpvc=0;for(i=0;i<g.pz.length;i++)tpvc+=g.pz[i].a*g.pz[i].c;
  var tpvr=tpvp-tpvc;
  var pkc=g.pk*g.pr;
  
  // === RETURN GAP (remaining vs sold pack value) ===
  // sold_return = claimed_prize_value / sold_tickets
  // remaining_return = remaining_prize_value / remaining_tickets  
  var soldReturn=ets>0?tpvc/ets:0;
  var remainReturn=etr>0?tpvr/etr:0;
  var returnGap=soldReturn>0?(remainReturn-soldReturn)/soldReturn:0; // +ve = remaining richer
  var remainReturnPct=etr>0&&g.pr>0?tpvr/(etr*g.pr):0; // per-ticket return rate of remaining
  
  // === TIER CATEGORIZATION (frequency break detection) ===
  var ot=ai>=0?g.pz.slice(0,ai):[];
  var tierCats={};
  if(ai>=0)tierCats[g.pz[ai].a]="BTP";
  for(i=ai+1;i<g.pz.length;i++)tierCats[g.pz[i].a]="BELOW";
  
  if(ot.length>0&&pc>0){
    var freqs=[];
    for(i=0;i<ot.length;i++)freqs.push({a:ot[i].a,freq:ot[i].p/pc,idx:i});
    // freqs[0] = highest amount = lowest frequency typically
    // Find biggest frequency ratio gap between consecutive tiers
    var maxGR=0,gapIdx=-1;
    for(i=0;i<freqs.length-1;i++){
      var gr=freqs[i].freq>0?freqs[i+1].freq/freqs[i].freq:0;
      if(gr>maxGR){maxGR=gr;gapIdx=i}
    }
    if(maxGR>10&&gapIdx>=0){
      for(i=0;i<=gapIdx;i++)tierCats[freqs[i].a]="TOP";
      for(i=gapIdx+1;i<freqs.length;i++)tierCats[freqs[i].a]="MID";
    }else{
      for(i=0;i<ot.length;i++)tierCats[ot[i].a]=i<2?"TOP":"MID";
    }
  }
  
  // === ABOVE-BTP ANALYSIS ===
  var olr=0,oot=0;
  for(i=0;i<ot.length;i++){olr+=R(ot[i]);oot+=ot[i].p}
  var orpC=epr>0?olr/epr:0,orpO=pc>0?oot/pc:0;
  var orpS=orpO>0?((orpC-orpO)/orpO)*100:0;
  
  var abvC=0,abvP=0;for(i=0;i<ot.length;i++){abvC+=ot[i].c;abvP+=ot[i].p}
  var abvPct=abvP>0?abvC/abvP:0;
  var blwC=0,blwP=0;for(i=ai+1;i<g.pz.length;i++){blwC+=g.pz[i].c;blwP+=g.pz[i].p}
  var blwPct=blwP>0?blwC/blwP:0;
  
  var tp=g.pz[0],tpr=R(tp),tpo=etr>0&&tpr>0?etr/tpr:Infinity;
  var mat=g.tot>0?ets/g.tot:0;
  
  // === HYPERGEOMETRIC PROBABILITY ===
  // P(at least 1 top-tier prize in pack) using hypergeometric distribution
  // P(X>=1) = 1 - P(X=0) = 1 - C(N-K,n)/C(N,n) where:
  //   N=remaining tickets, K=remaining top prizes, n=pack size
  var topTiers=ot.filter(function(p){return tierCats[p.a]==="TOP"});
  var topRem=0;for(i=0;i<topTiers.length;i++)topRem+=R(topTiers[i]);
  
  // Hypergeometric: P(0 top in pack) = C(etr-topRem, pk) / C(etr, pk)
  // Use log to avoid overflow: log(C(n,k)) = sum(log(n-i+1) - log(i)) for i=1..k
  function logC(n,k){if(k>n||k<0)return-Infinity;if(k===0||k===n)return 0;if(k>n-k)k=n-k;var s=0;for(var i=1;i<=k;i++)s+=Math.log(n-i+1)-Math.log(i);return s}
  
  var hyperNow=0,hyperLaunch=0;
  if(etr>0&&g.pk>0&&topRem>0){
    var lp0=logC(etr-topRem,g.pk)-logC(etr,g.pk);
    hyperNow=1-Math.exp(lp0);
  }
  // At launch
  var topPrinted=0;for(i=0;i<topTiers.length;i++)topPrinted+=topTiers[i].p;
  if(g.tot>0&&g.pk>0&&topPrinted>0){
    var lp0L=logC(g.tot-topPrinted,g.pk)-logC(g.tot,g.pk);
    hyperLaunch=1-Math.exp(lp0L);
  }
  var hyperRatio=hyperLaunch>0?hyperNow/hyperLaunch:0;
  
  // Simple top prize per pack (for display)
  var tpPack=epr>0&&tpr>0?tpr/epr:0;
  
  // === WIN ODDS ===
  var totRem=0;for(i=0;i<g.pz.length;i++)totRem+=R(g.pz[i]);
  var winOdds=etr>0&&totRem>0?etr/totRem:Infinity;
  
  // === MARKOV VELOCITY (focused: TOP + TOP-1 + BTP only) ===
  // Only the tiers that change your buy decision matter.
  // Mid-range tiers ($500, $300, $200) are noise ‚Äî they don't change anything.
  var ts=[],gSig="NEUTRAL",gRsn="Claims tracking normally.";
  
  // Compute per-tier stats for display (all above-BTP tiers)
  for(i=0;i<ot.length;i++){
    p=ot[i];var ar=p.p>0?p.c/p.p:0;
    var dev=acr>0?(ar-acr)/acr:0;
    var minSample=Math.max(5,p.p*0.02);
    var sig=p.c>=minSample&&dev<-0.05?"HOT":p.c>=minSample&&dev>0.05?"COLD":"NORMAL";
    ts.push({a:p.a,ar:ar,er:acr,dev:dev,sig:sig,rem:R(p),cat:tierCats[p.a]||"?"});
  }
  
  // Focus: only TOP-category tiers drive the signal
  var topTierCount=0,topHot=0,topCold=0,topGone=false;
  for(i=0;i<ts.length;i++){
    if(ts[i].cat!=="TOP")continue;
    topTierCount++;
    if(ts[i].rem<=0)topGone=true;
    if(ts[i].sig==="HOT")topHot++;
    if(ts[i].sig==="COLD")topCold++;
  }
  var allTopGone=topTierCount>0&&ts.filter(function(t){return t.cat==="TOP"&&t.rem>0}).length===0;
  // Also check TOP-1 (first MID tier = biggest non-top prize)
  var mid1=null;
  for(i=0;i<ts.length;i++){if(ts[i].cat==="MID"){mid1=ts[i];break;}}
  
  // Build signal from what matters
  if(allTopGone){
    gSig="DEAD";gRsn="All top-tier prizes claimed. Only mid/base prizes remain.";
  }else if(topCold>0&&topHot===0){
    gSig="AVOID";gRsn="Top prizes depleting faster than tickets are selling.";
  }else if(topHot>0&&topCold===0){
    gSig="BUY";gRsn="Top prizes underclaimed ‚Äî sitting in remaining packs.";
    if(mid1&&mid1.sig==="HOT"){gSig="STRONG_BUY";gRsn="Top AND mid-high prizes underclaimed ‚Äî remaining packs enriched.";}
  }else if(topHot>0&&topCold>0){
    gSig="MIXED";gRsn="Some top tiers underclaimed, others overclaimed.";
  }else{
    // No significant deviation in top tiers
    if(mid1&&mid1.sig==="HOT"){gSig="BUY";gRsn="Top tier neutral but mid-high prizes underclaimed.";}
    else if(mid1&&mid1.sig==="COLD"){gSig="CAUTION";gRsn="Top tier neutral but mid-high prizes depleting.";}
  }
  // Dollar reconciliation: if return gap strongly contradicts, override
  if(returnGap<-0.03&&(gSig==="STRONG_BUY"||gSig==="BUY")){gSig="NEUTRAL";gRsn="Tier counts lag but dollar value already claimed disproportionately.";}
  if(returnGap>0.03&&gSig==="AVOID"){gSig="NEUTRAL";gRsn="Some tiers depleted but overall dollar value favors remaining.";}
  
  // === SCORING ===
  var sc=50;
  
  // 1. Return gap: -15 to +15 pts (strongest signal)
  if(returnGap!==0)sc+=Math.max(-15,Math.min(15,returnGap*100));
  
  // 2. Top-tier hypergeometric vs launch: -10 to +10 pts
  if(hyperRatio>0)sc+=Math.max(-10,Math.min(10,(hyperRatio-1)*20));
  
  // 3. Markov (now focused on top tiers): -10 to +10 pts
  var mkPts={"STRONG_BUY":10,"BUY":5,"NEUTRAL":0,"MIXED":0,"CAUTION":-3,"AVOID":-8,"DEAD":-15};
  sc+=(mkPts[gSig]||0);
  
  // 4. Top prizes: -20 if gone (hard penalty), +3 if most remain
  if(tpr===0)sc-=20;else if(tp.p>0)sc+=Math.min(3,(tpr/tp.p)*3);
  
  // 5. Win odds shift: -5 to +5 pts
  if(g.odds>0&&winOdds<Infinity){var oddsShift=(g.odds-winOdds)/g.odds;sc+=Math.max(-5,Math.min(5,oddsShift*20))}
  
  // 6. Closing: hard penalty if closing + dead, bonus if closing + top left
  if(g.cs&&tpr===0)sc-=10;else if(g.cs&&tpr>0)sc+=3;
  
  // 7. Remaining return vs designed: -5 to +5
  if(designedReturn>0&&remainReturnPct>0){var retShift=(remainReturnPct-designedReturn)/designedReturn;sc+=Math.max(-5,Math.min(5,retShift*15))}
  
  // 8. Incomplete data penalty
  if(!complete)sc-=5;
  
  sc=Math.round(Math.min(100,Math.max(0,sc)));
  
  // === TIER ADVANTAGE ===
  var tierAdv=[];
  for(i=0;i<ot.length;i++){p=ot[i];var trm=R(p);if(trm<=0)continue;
    var origO=g.tot>0&&p.p>0?g.tot/p.p:Infinity;
    var currO=etr>0&&trm>0?etr/trm:Infinity;
    var pctB=origO>0&&origO<Infinity?((origO-currO)/origO)*100:0;
    tierAdv.push({a:p.a,origO:origO,currO:currO,pctB:pctB,rem:trm,cat:tierCats[p.a]||"?"})}
  
  // === PRIZES TABLE DATA ===
  var prizes=[];for(i=0;i<g.pz.length;i++){p=g.pz[i];var rm=R(p);
    prizes.push({a:p.a,p:p.p,c:p.c,rem:rm,pctC:p.p>0?(p.c/p.p*100):0,
      origO:g.tot>0?g.tot/p.p:Infinity,currO:etr>0&&rm>0?etr/rm:Infinity,
      isA:p.a===aa,isO:ai>=0&&i<ai,cat:tierCats[p.a]||"?"})}
  
  // === FLAGS ===
  var flags=[];
  if(tpr===0)flags.push({t:"DANGER",m:"All "+fmt(tp.a)+" top prizes claimed",c:"r"});
  if(g.cs&&tpr>0)flags.push({t:"CLOSING",m:"Game closing with "+tpr+" top prizes left",c:"a"});
  if(gSig==="STRONG_BUY")flags.push({t:"HOT",m:gRsn,c:"g"});
  if(gSig==="BUY")flags.push({t:"BUY SIGNAL",m:gRsn,c:"g"});
  if(gSig==="DEAD")flags.push({t:"DEAD GAME",m:gRsn,c:"r"});
  if(gSig==="AVOID")flags.push({t:"AVOID",m:gRsn,c:"r"});
  if(gSig==="CAUTION")flags.push({t:"CAUTION",m:gRsn,c:"a"});
  if(returnGap>0.02)flags.push({t:"RICH POOL",m:"Remaining packs "+(returnGap*100).toFixed(1)+"% richer than sold",c:"g"});
  if(returnGap<-0.02)flags.push({t:"THIN POOL",m:"Remaining packs "+(Math.abs(returnGap)*100).toFixed(1)+"% thinner than sold",c:"r"});
  if(hyperRatio>1.2)flags.push({t:"TOP TIER+",m:"Top-tier odds "+(hyperRatio).toFixed(1)+"x better than launch",c:"g"});
  if(mat<0.08)flags.push({t:"FRESH",m:"Only "+pct(mat)+" sold",c:"b"});
  if(!complete)flags.push({t:"INCOMPLETE",m:"Missing pack/odds/floor data from detail page",c:"a"});
  for(i=0;i<ts.length;i++){if(ts[i].sig==="HOT"&&ts[i].dev<-0.15)flags.push({t:"$"+fN(ts[i].a)+" HOT",m:"Underclaimed vs ticket sales",c:"p"});}
  
  return{g:g,pc:pc,aa:aa,ai:ai,acr:acr,eps:eps,epr:epr,ets:ets,etr:etr,
    tpvp:tpvp,tpvc:tpvc,tpvr:tpvr,pkc:pkc,complete:complete,
    designedReturn:designedReturn,soldReturn:soldReturn,remainReturn:remainReturn,
    returnGap:returnGap,remainReturnPct:remainReturnPct,btpValid:btpValid,
    orpC:orpC,orpO:orpO,orpS:orpS,
    abvPct:abvPct,blwPct:blwPct,
    tp:tp,tpr:tpr,tpo:tpo,mat:mat,sc:sc,
    winOdds:winOdds,totRem:totRem,
    hyperNow:hyperNow,hyperLaunch:hyperLaunch,hyperRatio:hyperRatio,
    tpPack:tpPack,tierAdv:tierAdv,tierCats:tierCats,
    prizes:prizes,gm:{ts:ts,sig:gSig,rsn:gRsn},flags:flags};
}

// === STATE ===
var S={tab:"picks",selId:null,sortBy:"score",filterPr:"all",data:[],moreTab:"pack",
  pack:{log:[],won:0,spent:0,af:false,pr:10,pk:50,nm:"",aa:100,ew:13},
  sessions:JSON.parse(localStorage.getItem("txs6")||"[]"),
  _aiLoading:false,_aiBriefing:null,
  bankroll:Number(localStorage.getItem("txb6")||"1000")};

// === INIT: auto-fetch, no hardcoded data ===
function init(){
  // Try cached data for instant render
  try{var c=localStorage.getItem("txr_gd6");if(c){GD=JSON.parse(c);if(GD.length)S.data=GD.map(analyze)}}catch(e){}
  DD=localStorage.getItem("txr_date6")||"";
  render();
  refreshAllData();
}

function setTab(t){S.tab=t;render()}
function setMore(t){S.moreTab=t;render()}
function setFilter(p){S.filterPr=p;render()}
function setSort(s){S.sortBy=s;render()}
function openDetail(id){S.selId=id;S.tab="detail";render()}
function setSel(id){S.selId=id;render()}

// === DATA LOADING ‚Äî feed.json ONLY, zero fallbacks ===
var DATA_URL="data/feed.json";
var WINNER_URL="data/wdata.json";

async function refreshAllData(){
  if(S._refreshing)return;S._refreshing=true;S._refreshMsg="Fetching data...";render();
  try{
    var resp=await fetch(DATA_URL);
    if(!resp.ok)throw new Error("HTTP "+resp.status);
    var json=await resp.json();
    if(json&&json.games&&json.games.length>0){
      // Replace GD entirely ‚Äî feed.json is ground truth
      GD=[];
      json.games.forEach(function(ng){
        if(!ng.pz||ng.pz.length===0||!ng.pr||ng.pr<=0)return;
        ng.id=String(ng.gn);
        ng.pz.sort(function(a,b){return b.a-a.a});
        // Keep whatever the scraper provided ‚Äî no fallback estimates
        GD.push(ng);
      });
      S.data=GD.map(analyze);
      DD=json.updated||"";
      localStorage.setItem("txr_date6",DD);
      localStorage.setItem("txr_gd6",JSON.stringify(GD));
      var comp=S.data.filter(function(a){return a.complete}).length;
      S._refreshMsg="Loaded "+GD.length+" games ("+comp+" complete). Data: "+DD;
    }else{
      S._refreshMsg="No data in feed.json. Run scraper first.";
    }
  }catch(e){
    S._refreshMsg="Failed: "+e.message+". Deploy feed.json via scraper.";
  }
  S._refreshing=false;render();
}

// === WINNER DATA ===
async function fetchWinners(){
  if(S._fetching)return;S._fetching=true;render();
  if(!S.winData)S.winData={};
  try{
    var resp=await fetch(WINNER_URL);
    if(resp.ok){
      var json=await resp.json();
      if(json&&json.winners){
        S.winData=json.winners;
        localStorage.setItem("txwd6",JSON.stringify(S.winData));
        localStorage.setItem("txwd_date6",json.updated||"");
      }
    }
  }catch(e){}
  S._fetching=false;render();
}

// === LLM INTELLIGENCE BRIEFING ===
async function runAIBriefing(){
  if(S._aiLoading||!S.data.length)return;
  S._aiLoading=true;S._aiBriefing=null;render();
  
  // Filter: only games with significant top-tier signals
  var triggered=[];
  S.data.forEach(function(a){
    if(!a.complete)return;
    var reasons=[];
    if(a.hyperRatio>1.1)reasons.push("top-tier odds "+a.hyperRatio.toFixed(2)+"x vs launch");
    if(a.returnGap>0.03)reasons.push("gap +"+(a.returnGap*100).toFixed(1)+"%");
    if(a.tpr===a.tp.p&&a.mat>0.2)reasons.push("all top prizes intact at "+(a.mat*100).toFixed(0)+"% sold");
    if(a.g.cs&&a.tpr>0)reasons.push("closing with "+a.tpr+" top prizes");
    if((a.gm.sig==="BUY"||a.gm.sig==="STRONG_BUY")&&a.tpr>0)reasons.push("Markov "+a.gm.sig);
    if(reasons.length>0)triggered.push(a);
  });
  
  if(triggered.length===0){
    S._aiBriefing="No games currently showing significant top-tier signals. All games are tracking near expected claim rates.";
    S._aiLoading=false;render();return;
  }
  
  // Build compact data table for triggered games
  var lines=triggered.map(function(a){
    return "#"+a.g.gn+" "+a.g.nm+" $"+a.g.pr+
      " | score:"+a.sc+
      " | gap:"+(a.returnGap>0?"+":"")+(a.returnGap*100).toFixed(1)+"%"+
      " | markov:"+a.gm.sig+
      " | top:"+a.tpr+"/"+a.tp.p+" ($"+fN(a.tp.a)+")"+
      " | sold:"+(a.mat*100).toFixed(1)+"%"+
      " | hyper:"+a.hyperRatio.toFixed(2)+"x"+
      " | design:"+(a.designedReturn*100).toFixed(1)+"%"+
      " | remain:"+(a.remainReturnPct*100).toFixed(1)+"%"+
      " | packs_left:"+fN(a.epr)+
      (a.g.cs?" | CLOSING":"");
  });
  
  // Also include best per price and games to avoid for context
  var byP={};S.data.forEach(function(a){if(a.complete&&(!byP[a.g.pr]||a.sc>byP[a.g.pr].sc))byP[a.g.pr]=a});
  var avoids=S.data.filter(function(a){return a.complete&&(a.gm.sig==="AVOID"||a.gm.sig==="DEAD"||a.returnGap<-0.03)});
  
  var sysPrompt="You are a Texas scratch-off analyst. You study publicly available prize claim data to identify which games currently have favorable conditions for top-tier prizes.\n\n"+
    "METRICS EXPLAINED:\n"+
    "- score: 0-100 composite (higher=better)\n"+
    "- gap: return gap. Positive = remaining unsold packs return more per dollar than already-sold packs (good). Negative = remaining packs are poorer.\n"+
    "- markov: BUY/STRONG_BUY = top-tier prizes underclaimed vs ticket sales pace. AVOID = top prizes depleting fast. NEUTRAL = no clear signal.\n"+
    "- top: remaining/total top-tier prizes and their value\n"+
    "- hyper: hypergeometric ratio vs launch. >1.0 means your odds of getting a top-tier prize in a pack are BETTER now than at launch.\n"+
    "- design: the game's built-in return rate. remain: current per-ticket return rate of unsold tickets.\n"+
    "- packs_left: remaining packs available\n\n"+
    "YOUR JOB:\n"+
    "1. Identify the 2-3 BEST games to buy right now and why (focus on top-tier prize probability)\n"+
    "2. Flag any unusual patterns across games (cross-price trends, closing opportunities)\n"+
    "3. Call out 1-2 games to AVOID and why\n"+
    "4. If a game at a specific price point clearly dominates others at that price, say so\n\n"+
    "RULES:\n"+
    "- Be specific with numbers. Don't be vague.\n"+
    "- Focus on top-tier prize availability vs remaining packs ‚Äî that's what matters.\n"+
    "- Short, direct sentences. No filler. No disclaimers about gambling.\n"+
    "- 200 words max.";
  
  var userMsg="Today's data ("+new Date().toLocaleDateString()+"). "+triggered.length+" games flagged with significant signals:\n\n"+
    lines.join("\n");
  
  if(avoids.length>0){
    userMsg+="\n\nGames showing negative signals:\n";
    avoids.slice(0,5).forEach(function(a){
      userMsg+="#"+a.g.gn+" "+a.g.nm+" $"+a.g.pr+" | gap:"+(a.returnGap*100).toFixed(1)+"% | markov:"+a.gm.sig+" | top:"+a.tpr+"/"+a.tp.p+"\n";
    });
  }
  
  try{
    var apiKey=localStorage.getItem("txr_apikey")||"";
    var headers={"Content-Type":"application/json","anthropic-version":"2023-06-01"};
    if(apiKey)headers["x-api-key"]=apiKey;
    var resp=await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:headers,
      body:JSON.stringify({
        model:"claude-sonnet-4-20250514",
        max_tokens:1000,
        system:sysPrompt,
        messages:[{role:"user",content:userMsg}]
      })
    });
    var data=await resp.json();
    if(data&&data.content){
      var text=data.content.map(function(b){return b.text||""}).join("\n").trim();
      S._aiBriefing=text;
    }else{
      S._aiBriefing="Analysis unavailable. API response: "+(data.error?data.error.message:"unknown error");
    }
  }catch(e){
    S._aiBriefing="Analysis unavailable: "+e.message;
  }
  S._aiLoading=false;render();
}

// === PACK TRACKER ===
function scratch(amt){var pk=S.pack;pk.log.push({amt:amt,w:amt>0});pk.won+=amt;pk.spent+=pk.pr;pk.af=pk.af||amt>=pk.aa;render()}
function resetPack(){S.pack.log=[];S.pack.won=0;S.pack.spent=0;S.pack.af=false;render()}
function saveSession(){if(!S.pack.log.length)return;S.sessions.push({g:S.pack.nm,s:S.pack.spent,w:S.pack.won,t:S.pack.log.length,d:new Date().toLocaleDateString(),af:S.pack.af});localStorage.setItem("txs6",JSON.stringify(S.sessions));resetPack()}
function clearSess(){S.sessions=[];localStorage.setItem("txs6","[]");render()}
function setBR(v){S.bankroll=v;localStorage.setItem("txb6",String(v));render()}
function startPack(id){var a;for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===id){a=S.data[i];break}if(!a)return;S.pack={log:[],won:0,spent:0,af:false,pr:a.g.pr,pk:a.g.pk,nm:a.g.nm+' #'+a.g.gn,aa:a.aa,ew:Math.round(a.g.pk/a.g.odds)};S.tab="more";S.moreTab="pack";render()}
function mkv(){var pk=S.pack,rem=pk.pk-pk.log.length;if(rem<=0)return null;var wf=0;for(var i=0;i<pk.log.length;i++)if(pk.log[i].w)wf++;var wl=Math.max(0,pk.ew-wf),pW=wl/rem,pA=pk.af?0:1/rem;var dec="EARLY",rsn="Pack is early ‚Äî "+(pA*100).toFixed(1)+"% per ticket.";if(pk.af){dec="STOP";rsn="Anchor found. Remaining are small winners/losers.";}else if(pA>=0.15){dec="BUY";rsn=(pA*100).toFixed(1)+"% chance anchor is next. Only "+rem+" left.";}else if(pA>=0.05){dec="CONSIDER";rsn=(pA*100).toFixed(1)+"% per ticket. "+rem+" remaining.";}return{rem:rem,wl:wl,pW:pW,pA:pA,dec:dec,rsn:rsn}}

// === RENDER ===
function render(){
  var pr={};GD.forEach(function(g){pr[g.pr]=1});var pArr=Object.keys(pr).map(Number).sort(function(a,b){return a-b});
  var f=S.data.slice();
  if(S.filterPr!=="all")f=f.filter(function(a){return a.g.pr===Number(S.filterPr)});
  var sorts={
    score:function(a,b){return b.sc-a.sc},
    gap:function(a,b){return b.returnGap-a.returnGap},
    topOdds:function(a,b){return a.tpo-b.tpo},
    tickets:function(a,b){return a.mat-b.mat},
    hyper:function(a,b){return b.hyperRatio-a.hyperRatio}
  };
  f.sort(sorts[S.sortBy]||sorts.score);
  var sel=null;if(S.selId){for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===S.selId){sel=S.data[i];break}}

  var o='<div class="H"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px"><div><h1>TX SCRATCH-OFF ENGINE v6</h1><div class="sub">'+GD.length+' games'+(DD?' ¬∑ Data: '+esc(DD):'')+'</div></div>';
  o+='<div class="B'+(S._refreshing?"":" on")+'" onclick="refreshAllData()" style="font-size:10px;padding:6px 12px">'+(S._refreshing?'‚è≥ REFRESHING...':'‚Üª REFRESH')+'</div></div>';
  if(S._refreshMsg)o+='<div style="font-size:10px;color:var(--blu);margin-top:4px">'+esc(S._refreshMsg)+'</div>';
  o+='<div class="tabs">';
  [["picks","PICKS"],["detail","DETAIL"],["insights","INSIGHTS"],["winners","WINNERS"],["more","MORE"]].forEach(function(t){
    o+='<div class="T'+(S.tab===t[0]?" on":"")+'" onclick="setTab(\''+t[0]+'\')">'+t[1]+'</div>';});
  o+='</div></div>';

  // === EMPTY STATE ===
  if(GD.length===0){
    o+='<div class="C" style="text-align:center;padding:40px 20px"><div style="font-size:18px;color:var(--amb);margin-bottom:12px">No Game Data Loaded</div>';
    o+='<div style="font-size:13px;color:var(--text);line-height:1.8">1. Run <code>python3 scrape.py</code> to fetch data from texaslottery.com<br>';
    o+='2. Deploy <code>data/feed.json</code> alongside this page<br>';
    o+='3. Click REFRESH above</div></div>';
    document.getElementById("app").innerHTML=o;return;
  }

  // === PICKS ===
  if(S.tab==="picks"){
    o+='<div class="FR"><span class="L" style="margin:0">PRICE:</span>';
    ["all"].concat(pArr).forEach(function(p){var v=String(p);o+='<div class="B'+(S.filterPr===v?" on":"")+'" onclick="setFilter(\''+v+'\')" style="padding:5px 10px">'+(v==="all"?"ALL":"$"+v)+'</div>';});
    o+='</div><div class="FR"><span class="L" style="margin:0">SORT:</span>';
    [["score","Score"],["gap","Return Gap"],["topOdds","Top Odds"],["tickets","Freshest"],["hyper","Top Tier+"]].forEach(function(s){
      o+='<div class="B'+(S.sortBy===s[0]?" bn":"")+'" onclick="setSort(\''+s[0]+'\')" style="padding:5px 10px">'+s[1]+'</div>';});
    o+='</div>';
    
    for(var idx=0;idx<f.length;idx++){var a=f[idx];
      o+='<div class="C ck" onclick="openDetail(\''+a.g.id+'\')">';
      if(idx===0&&f.length>1)o+='<div class="badge" style="right:12px;background:var(--grn);color:var(--bg)">TOP PICK</div>';
      if(a.g.cs)o+='<div class="badge" style="right:'+(idx===0&&f.length>1?"95px":"12px")+';background:var(--red);color:#fff">CLOSING</div>';
      if(!a.complete)o+='<div class="badge" style="left:12px;background:var(--amb);color:var(--bg)">PARTIAL DATA</div>';
      
      o+='<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px"><div style="flex:1;min-width:0">';
      o+='<div style="font-size:15px;font-weight:700;color:var(--wht);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(a.g.nm)+' <span style="color:var(--dim);font-weight:400">#'+a.g.gn+'</span></div>';
      o+='<div style="font-size:11px;color:var(--dim)">$'+a.g.pr+(a.g.pk?' ¬∑ '+a.g.pk+'/pack':'')+(a.aa?' ¬∑ BTP:$'+a.aa:'')+'</div></div>';
      o+='<div style="text-align:right;flex-shrink:0"><div class="V" style="color:'+(a.sc>=65?"var(--grn)":a.sc>=40?"var(--amb)":"var(--red)")+';font-size:28px">'+a.sc+'</div><div style="font-size:9px;color:var(--dim)">SCORE</div></div></div>';
      
      // Key metrics row
      var ms=[
        {l:"Return Gap",v:a.returnGap!==0?(a.returnGap>0?"+":"")+pct(a.returnGap):"‚Äî",c:a.returnGap>0.01?"g":a.returnGap<-0.01?"r":"d"},
        {l:"Top Tier Odds",v:a.hyperRatio>0?a.hyperRatio.toFixed(2)+"x":"‚Äî",c:a.hyperRatio>1.1?"g":a.hyperRatio<0.9?"r":"d"},
        {l:"Markov",v:a.gm.sig.replace("_"," "),c:a.gm.sig==="STRONG_BUY"?"g":a.gm.sig==="BUY"?"g":a.gm.sig==="AVOID"?"r":a.gm.sig==="DEAD"?"r":a.gm.sig==="CAUTION"?"a":a.gm.sig==="MIXED"?"a":"d"},
        {l:"Win Odds",v:"1:"+Math.round(a.winOdds),c:a.winOdds<a.g.odds?"g":"d"},
        {l:"Top Left",v:a.tpr+"/"+a.tp.p,c:a.tpr>0?"g":"r"},
        {l:"Sold",v:pct(a.mat),c:a.mat<0.5?"g":a.mat<0.8?"a":"r"},
        {l:"Designed Return",v:a.designedReturn>0?pct(a.designedReturn):"‚Äî",c:"d"},
        {l:"Remaining Return",v:a.remainReturnPct>0?pct(a.remainReturnPct):"‚Äî",c:a.remainReturnPct>a.designedReturn?"g":a.remainReturnPct<a.designedReturn?"r":"d"}
      ];
      o+='<div class="G" style="grid-template-columns:repeat(auto-fit,minmax(90px,1fr));margin-top:10px">';
      ms.forEach(function(m){o+='<div><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:12px;font-weight:700" class="'+m.c+'">'+m.v+'</div></div>';});
      o+='</div>';
      
      // Signal bar
      if(a.flags.length>0){
        o+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px">';
        a.flags.slice(0,4).forEach(function(fl){
          o+='<span style="font-size:9px;font-weight:700;padding:3px 8px;border-radius:4px;background:var(--'+fl.c+'1);color:var(--'+fl.c+');border:1px solid var(--'+fl.c+')30">'+esc(fl.t)+'</span>';
        });
        o+='</div>';
      }
      o+='</div>';
    }
  }

  // === DETAIL ===
  if(S.tab==="detail"){
    o+='<select class="I" style="margin-bottom:14px" onchange="setSel(this.value)"><option value="">‚Äî Select game ‚Äî</option>';
    S.data.slice().sort(function(a,b){return b.sc-a.sc}).forEach(function(a){
      o+='<option value="'+a.g.id+'"'+(S.selId===a.g.id?" selected":"")+'>['+a.sc+'] '+esc(a.g.nm)+' #'+a.g.gn+' ($'+a.g.pr+')</option>';});
    o+='</select>';
    
    if(sel){
      // Header
      o+='<div class="C"><div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div>';
      o+='<div style="font-size:18px;font-weight:800;color:var(--wht)">'+esc(sel.g.nm)+' <span style="color:var(--dim);font-size:14px;font-weight:400">#'+sel.g.gn+'</span></div>';
      o+='<div style="font-size:11px;color:var(--dim);margin-top:4px">$'+sel.g.pr+(sel.g.pk?' ¬∑ '+sel.g.pk+'/pack = $'+sel.pkc:'')+(sel.g.guar?' ¬∑ Floor: $'+sel.g.guar:'')+(sel.g.odds?' ¬∑ Odds: 1:'+sel.g.odds:'')+'</div></div>';
      o+='<div style="text-align:right"><div class="V" style="color:'+(sel.sc>=65?"var(--grn)":sel.sc>=40?"var(--amb)":"var(--red)")+'">'+sel.sc+'</div><div class="L">SCORE</div></div></div>';
      
      // Signal summary
      o+='<div style="margin-top:8px;padding:8px 12px;background:var(--bg);border-radius:8px;font-size:12px">';
      if(sel.aa)o+='BTP: <strong class="g">$'+sel.aa+'</strong>'+(sel.btpValid?' <span class="d">(validated)</span>':' <span class="a">(unvalidated)</span>')+' ¬∑ ';
      o+='Markov: <strong style="color:'+(sel.gm.sig==="STRONG_BUY"||sel.gm.sig==="BUY"?"var(--grn)":sel.gm.sig==="AVOID"||sel.gm.sig==="DEAD"?"var(--red)":sel.gm.sig==="CAUTION"||sel.gm.sig==="MIXED"?"var(--amb)":"var(--dim)")+'">'+sel.gm.sig.replace("_"," ")+'</strong>';
      if(sel.designedReturn>0)o+=' ¬∑ Design: <strong class="d">'+pct(sel.designedReturn)+'</strong>';
      o+='</div>';
      if(!sel.complete)o+='<div style="margin-top:6px;padding:6px 10px;background:var(--amb)18;border:1px solid var(--amb)30;border-radius:6px;font-size:11px;color:var(--amb)">‚ö† Missing detail page data (tot/pk/guar/odds). Some metrics estimated or unavailable. Run scraper with detail page fetching.</div>';
      o+='</div>';
      
      // Key metrics
      var dm=[
        {l:"DESIGNED RETURN",v:sel.designedReturn>0?pct(sel.designedReturn):"‚Äî",c:"var(--dim)",s:"Built into prize structure"},
        {l:"REMAINING RETURN",v:sel.remainReturnPct>0?pct(sel.remainReturnPct):"‚Äî",c:sel.remainReturnPct>sel.designedReturn?"var(--grn)":sel.remainReturnPct<sel.designedReturn?"var(--red)":"var(--dim)",s:"Current per-ticket return"},
        {l:"RETURN GAP",v:sel.returnGap!==0?(sel.returnGap>0?"+":"")+pct(sel.returnGap):"‚Äî",c:sel.returnGap>0?"var(--grn)":sel.returnGap<0?"var(--red)":"var(--dim)",s:sel.returnGap>0?"Remaining richer than sold":"Remaining thinner than sold"},
        {l:"TOP TIER P(PACK)",v:sel.hyperNow>0?sel.hyperNow>=0.01?pct(sel.hyperNow):"1:"+fN(Math.round(1/sel.hyperNow)):"‚Äî",c:sel.hyperRatio>1?"var(--grn)":"var(--dim)",s:sel.hyperRatio>0?sel.hyperRatio.toFixed(2)+"x vs launch":""},
        {l:"WIN ODDS (now)",v:"1:"+Math.round(sel.winOdds),c:sel.winOdds<sel.g.odds?"var(--grn)":"var(--dim)"},
        {l:"TOP PRIZES",v:sel.tpr+" / "+sel.tp.p+" left",c:sel.tpr>0?"var(--grn)":"var(--red)"},
        {l:"TICKETS LEFT",v:fN(sel.etr)+(sel.g.tot>0?" / "+fN(sel.g.tot):""),s:sel.mat>0?pct(1-sel.mat)+" remaining":"",c:"var(--wht)"},
        {l:"PRIZE $ LEFT",v:fmt(sel.tpvr),s:"of "+fmt(sel.tpvp),c:"var(--blu)"}
      ];
      o+='<div class="C"><div class="L" style="margin-bottom:8px">KEY METRICS</div><div class="G GA">';
      dm.forEach(function(m){o+='<div class="cl"><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:18px;font-weight:800;color:'+m.c+'">'+m.v+'</div>'+(m.s?'<div style="font-size:9px;color:var(--dim);margin-top:2px">'+m.s+'</div>':'')+'</div>';});
      o+='</div></div>';
      
      // === RETURN GAP GRAPH + TOP TIER DONUT ===
      o+='<div class="C"><div style="display:flex;gap:16px;flex-wrap:wrap">';
      
      // LEFT: Return gap visual
      o+='<div style="flex:1;min-width:200px">';
      o+='<div class="L" style="margin-bottom:10px">RETURN GAP ANALYSIS</div>';
      var drPct=sel.designedReturn>0?(sel.designedReturn*100):0;
      var soldPct=sel.g.pr>0&&sel.ets>0?(sel.soldReturn/sel.g.pr*100):0;
      var remPct=sel.remainReturnPct>0?(sel.remainReturnPct*100):0;
      var maxBar=Math.max(drPct,soldPct,remPct,1);
      // Designed return bar
      o+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">';
      o+='<div style="width:80px;text-align:right;font-size:10px;color:var(--dim);font-weight:600">DESIGNED</div>';
      o+='<div style="flex:1;height:24px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative">';
      o+='<div style="width:'+(drPct/maxBar*100)+'%;height:100%;background:#5a6a7a;border-radius:4px"></div>';
      o+='<span style="position:absolute;right:8px;top:4px;font-size:11px;color:#ccc;font-weight:600">'+drPct.toFixed(1)+'%</span></div></div>';
      // Sold return bar
      o+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">';
      o+='<div style="width:80px;text-align:right;font-size:10px;color:var(--amb);font-weight:600">SOLD</div>';
      o+='<div style="flex:1;height:24px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative">';
      o+='<div style="width:'+(soldPct/maxBar*100)+'%;height:100%;background:linear-gradient(90deg,#f39c12,#e67e22);border-radius:4px"></div>';
      o+='<span style="position:absolute;right:8px;top:4px;font-size:11px;color:#fff;font-weight:600">'+soldPct.toFixed(1)+'%</span></div></div>';
      // Remaining return bar
      var remClr=remPct>drPct?"#2ecc71":"#e74c3c";
      o+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">';
      o+='<div style="width:80px;text-align:right;font-size:10px;color:'+remClr+';font-weight:600">REMAINING</div>';
      o+='<div style="flex:1;height:24px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative">';
      o+='<div style="width:'+(remPct/maxBar*100)+'%;height:100%;background:linear-gradient(90deg,'+remClr+','+remClr+'cc);border-radius:4px"></div>';
      o+='<span style="position:absolute;right:8px;top:4px;font-size:11px;color:#fff;font-weight:600">'+remPct.toFixed(1)+'%</span></div></div>';
      // Gap callout
      if(sel.returnGap!==0){
        var gapClr=sel.returnGap>0?"#2ecc71":"#e74c3c";
        o+='<div style="text-align:center;margin-top:4px;font-size:18px;font-weight:800;color:'+gapClr+'">'+(sel.returnGap>0?"+":"")+pct(sel.returnGap)+'</div>';
        o+='<div style="text-align:center;font-size:10px;color:var(--dim)">'+(sel.returnGap>0?"Remaining packs return more than sold":"Remaining packs return less than sold")+'</div>';
      }
      o+='</div>';
      
      // RIGHT: Top tier donut (SVG)
      o+='<div style="flex:0 0 180px;text-align:center">';
      o+='<div class="L" style="margin-bottom:8px">TOP TIER vs PACKS</div>';
      // Donut: top-tier prizes remaining / total remaining packs
      var topRem2=0,topPrinted2=0;
      sel.prizes.forEach(function(p){if(p.cat==="TOP"){topRem2+=p.rem;topPrinted2+=p.p}});
      var topClaimed2=topPrinted2-topRem2;
      // SVG donut
      var r=65,cx=90,cy=90,sw=18;
      var circ=2*Math.PI*r;
      // Segments: claimed (red), remaining (green), empty packs (dark)
      var topPct2=topPrinted2>0?topClaimed2/topPrinted2:0;
      var remPct2=topPrinted2>0?topRem2/topPrinted2:0;
      var dash1=circ*topPct2,gap1=circ*(1-topPct2);
      var dash2=circ*remPct2,gap2=circ*(1-remPct2);
      o+='<svg width="180" height="180" viewBox="0 0 180 180">';
      // Background ring
      o+='<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="none" stroke="#1a2332" stroke-width="'+sw+'"/>';
      // Claimed segment
      o+='<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="none" stroke="#e74c3c" stroke-width="'+sw+'" stroke-dasharray="'+dash1+' '+gap1+'" stroke-dashoffset="'+(circ*0.25)+'" stroke-linecap="round"/>';
      // Remaining segment
      o+='<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="none" stroke="#2ecc71" stroke-width="'+sw+'" stroke-dasharray="'+dash2+' '+gap2+'" stroke-dashoffset="'+(circ*0.25-dash1)+'" stroke-linecap="round"/>';
      // Center text
      o+='<text x="'+cx+'" y="'+(cy-8)+'" text-anchor="middle" fill="#2ecc71" font-size="22" font-weight="800">'+topRem2+'</text>';
      o+='<text x="'+cx+'" y="'+(cy+8)+'" text-anchor="middle" fill="#8899aa" font-size="10">of '+topPrinted2+'</text>';
      o+='<text x="'+cx+'" y="'+(cy+22)+'" text-anchor="middle" fill="#8899aa" font-size="9">TOP LEFT</text>';
      o+='</svg>';
      // Pack ratio
      if(sel.epr>0&&topRem2>0){
        var packRatio=Math.round(sel.epr/topRem2);
        o+='<div style="font-size:12px;color:var(--wht);margin-top:4px;font-weight:700">1 in '+fN(packRatio)+' packs</div>';
        o+='<div style="font-size:10px;color:var(--dim)">has a TOP tier prize</div>';
      }else if(topRem2===0){
        o+='<div style="font-size:12px;color:var(--red);margin-top:4px;font-weight:700">ALL CLAIMED</div>';
      }
      o+='</div>';
      o+='</div></div>';
      o+='<div class="C"><div class="L" style="margin-bottom:10px">PRIZE POOL ‚Äî CLAIMED vs REMAINING</div>';
      sel.prizes.forEach(function(p){
        var pctC=p.p>0?p.c/p.p*100:0;var pctR=100-pctC;
        var clrMap={"TOP":"#9b59b6","MID":"#3498db","BTP":"#2ecc71","BELOW":"#5a6a7a"};
        var clr=p.isA?"#2ecc71":clrMap[p.cat]||"#5a6a7a";
        o+='<div class="bar-row"><div class="bar-label" style="color:'+clr+'">$'+fN(p.a);
        if(p.isA)o+=' <span style="font-size:7px;opacity:.7">BTP</span>';
        o+='</div><div class="bar-track">';
        o+='<div style="width:'+pctC+'%;height:100%;background:'+clr+';opacity:.25"></div>';
        o+='<div style="width:'+pctR+'%;height:100%;background:'+clr+';opacity:.7"></div>';
        o+='<div class="bar-pct">'+fN(p.rem)+' left ('+pctR.toFixed(0)+'%)</div></div></div>';
      });
      o+='<div style="margin-top:6px;font-size:10px;color:var(--dim)"><span style="color:#2ecc71">‚ñ†</span> BTP ¬∑ <span style="color:#9b59b6">‚ñ†</span> TOP ¬∑ <span style="color:#3498db">‚ñ†</span> MID ¬∑ Dark=claimed ¬∑ Bright=remaining</div></div>';
      
      // Markov velocity
      if(sel.gm.ts.length>0){
        o+='<div class="C"><div class="L" style="margin-bottom:8px">MARKOV VELOCITY ‚Äî <span style="color:'+(sel.gm.sig==="STRONG_BUY"||sel.gm.sig==="BUY"?"var(--grn)":sel.gm.sig==="AVOID"||sel.gm.sig==="DEAD"?"var(--red)":sel.gm.sig==="CAUTION"||sel.gm.sig==="MIXED"?"var(--amb)":"var(--dim)")+'">'+sel.gm.sig.replace("_"," ")+'</span></div>';
        o+='<div style="font-size:11px;color:var(--text);margin-bottom:10px">'+esc(sel.gm.rsn)+'</div>';
        sel.gm.ts.forEach(function(t){
          var tc=t.sig==="HOT"?"#2ecc71":t.sig==="COLD"?"#e74c3c":"#5a6a7a";
          o+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
          o+='<span style="width:70px;text-align:right;font-weight:600;font-size:11px;color:var(--wht)">$'+fN(t.a)+'</span>';
          o+='<span style="width:30px;font-size:8px;color:var(--dim)">'+t.cat+'</span>';
          o+='<div style="flex:1;height:20px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative">';
          o+='<div style="width:'+Math.min(100,Math.max(2,t.ar*100))+'%;height:100%;background:'+tc+';opacity:.65;border-radius:4px"></div>';
          o+='<div style="position:absolute;left:'+Math.min(95,Math.max(0,t.er*100))+'%;top:0;width:2px;height:100%;background:#f39c12"></div></div>';
          o+='<span style="width:50px;font-size:10px;font-weight:700;color:'+tc+'">'+(t.sig==="HOT"?"HOT":t.sig==="COLD"?"COLD":"‚Äî")+'</span></div>';
        });
        o+='<div style="font-size:10px;color:var(--dim);margin-top:6px">Bar=actual claim rate ¬∑ Yellow line=expected (BTP rate) ¬∑ HOT=underclaimed (good)</div></div>';
      }
      
      // Tier advantage
      if(sel.tierAdv.length>0){
        o+='<div class="C"><div class="L" style="margin-bottom:8px">TIER ADVANTAGE ‚Äî CURRENT vs LAUNCH ODDS</div>';
        sel.tierAdv.forEach(function(t){
          var better=t.pctB>0;
          o+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
          o+='<div style="width:70px;text-align:right;font-weight:700;font-size:12px;color:var(--pur)">$'+fN(t.a)+'</div>';
          o+='<div style="width:30px;font-size:8px;color:var(--dim)">'+t.cat+'</div>';
          o+='<div style="flex:1;font-size:11px;color:var(--text)">'+fmtO(t.origO)+' ‚Üí '+fmtO(t.currO)+'</div>';
          o+='<div style="width:60px;text-align:right;font-size:12px;font-weight:700;color:'+(better?"var(--grn)":"var(--red)")+'">'+(better?"+":"")+t.pctB.toFixed(0)+'%</div>';
          o+='<div style="width:50px;font-size:10px;color:var(--dim)">'+fN(t.rem)+' left</div></div>';
        });
        o+='</div>';
      }
      
      // Above vs Below BTP
      if(sel.abvPct>0||sel.blwPct>0){
        o+='<div class="C"><div class="L" style="margin-bottom:10px">ABOVE vs BELOW BTP ‚Äî POOL HEALTH</div>';
        var matW=sel.mat*100;
        // Above BTP bar
        o+='<div style="margin-bottom:10px"><div style="font-size:10px;color:var(--pur);font-weight:600;margin-bottom:4px">ABOVE BTP ‚Äî outlier prizes (what you want)</div>';
        o+='<div style="height:26px;background:var(--bg);border-radius:5px;overflow:hidden;position:relative">';
        o+='<div style="width:'+(sel.abvPct*100)+'%;height:100%;background:linear-gradient(90deg,#9b59b6,#8e44ad);border-radius:5px"></div>';
        o+='<div style="position:absolute;left:'+matW+'%;top:0;width:2px;height:100%;background:#f39c12"></div>';
        o+='<span style="position:absolute;right:8px;top:5px;font-size:11px;color:#fff;font-weight:700">'+(sel.abvPct*100).toFixed(1)+'% claimed</span></div></div>';
        // Below BTP bar
        o+='<div style="margin-bottom:8px"><div style="font-size:10px;color:var(--blu);font-weight:600;margin-bottom:4px">BELOW BTP ‚Äî base prizes (expected sales pace)</div>';
        o+='<div style="height:26px;background:var(--bg);border-radius:5px;overflow:hidden;position:relative">';
        o+='<div style="width:'+(sel.blwPct*100)+'%;height:100%;background:linear-gradient(90deg,#3498db,#2980b9);border-radius:5px"></div>';
        o+='<div style="position:absolute;left:'+matW+'%;top:0;width:2px;height:100%;background:#f39c12"></div>';
        o+='<span style="position:absolute;right:8px;top:5px;font-size:11px;color:#fff;font-weight:700">'+(sel.blwPct*100).toFixed(1)+'% claimed</span></div></div>';
        // Interpretation
        o+='<div style="font-size:11px;color:var(--text);padding:8px 10px;background:var(--bg);border-radius:6px">';
        o+='<span style="color:#f39c12;font-weight:600">Yellow line</span> = game maturity ('+matW.toFixed(1)+'% sold). ';
        if(sel.abvPct<sel.mat*0.85)o+='<span style="color:var(--grn);font-weight:600">Outlier prizes lagging behind sales ‚Äî remaining packs are enriched.</span>';
        else if(sel.abvPct>sel.mat*1.15)o+='<span style="color:var(--red);font-weight:600">Outlier prizes claimed faster than sales ‚Äî remaining packs depleted.</span>';
        else o+='<span style="color:var(--dim)">Claims tracking near expected pace.</span>';
        o+='</div></div>';
      }
      
      // Prize table
      o+='<div class="C" style="overflow-x:auto"><div class="L" style="margin-bottom:8px">FULL PRIZE TABLE</div><table><thead><tr>';
      ["Prize","Cat","Printed","Claimed","Left","% Left","Launch Odds","Now Odds","Shift"].forEach(function(h){o+='<th>'+h+'</th>';});
      o+='</tr></thead><tbody>';
      sel.prizes.forEach(function(p){
        var rc=p.cat==="TOP"?"var(--pur)":p.cat==="MID"?"var(--blu)":p.isA?"var(--grn)":"var(--wht)";
        var pctL=100-p.pctC;
        o+='<tr><td style="font-weight:700;color:'+rc+'">$'+fN(p.a)+'</td>';
        o+='<td style="font-size:9px;color:var(--dim)">'+p.cat+'</td>';
        o+='<td class="d">'+fN(p.p)+'</td><td class="d">'+fN(p.c)+'</td>';
        o+='<td style="font-weight:700;color:'+(p.rem>0?"var(--grn)":"var(--red)")+'">'+fN(p.rem)+'</td>';
        o+='<td style="color:'+(pctL>50?"var(--grn)":pctL>20?"var(--amb)":"var(--red)")+'">'+pctL.toFixed(0)+'%</td>';
        o+='<td class="d">'+fmtO(p.origO)+'</td>';
        o+='<td>'+(p.rem>0?fmtO(p.currO):"-")+'</td>';
        o+='<td>';if(p.rem>0&&p.currO<1e9){var b=p.currO<p.origO;o+='<span style="color:'+(b?"var(--grn)":"var(--red)")+'">'+(b?"BETTER":"WORSE")+'</span>';}
        o+='</td></tr>';});
      o+='</tbody></table></div>';
      
      // Insights for this game
      if(sel.flags.length>0){
        o+='<div class="C"><div class="L" style="margin-bottom:8px">SIGNALS</div>';
        sel.flags.forEach(function(fl){
          o+='<div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:6px;padding:6px 8px;background:var(--bg);border-radius:6px;border-left:3px solid var(--'+fl.c+')">';
          o+='<div style="font-size:9px;font-weight:700;color:var(--'+fl.c+');white-space:nowrap;min-width:80px">'+esc(fl.t)+'</div>';
          o+='<div style="font-size:11px;color:var(--text)">'+esc(fl.m)+'</div></div>';
        });
        o+='</div>';
      }
      o+='<div style="margin-top:4px"><div class="B on" onclick="startPack(\''+sel.g.id+'\')">Track Pack ‚Üí</div></div>';
    }
  }

  // === INSIGHTS (pattern detection + LLM briefing) ===
  if(S.tab==="insights"){
    
    // === LLM INTELLIGENCE BRIEFING ===
    o+='<div class="C" style="border-color:#9b59b644"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px"><div>';
    o+='<div style="font-size:14px;font-weight:800;color:#9b59b6">üß† INTELLIGENCE BRIEFING</div>';
    o+='<div style="font-size:10px;color:var(--dim)">AI analysis of games with significant signals</div></div>';
    o+='<div class="B'+(S._aiLoading?"":" on")+'" onclick="runAIBriefing()" style="font-size:10px;padding:5px 12px;border-color:#9b59b6;color:#9b59b6">'+(S._aiLoading?'‚è≥ ANALYZING...':'RUN ANALYSIS')+'</div></div>';
    // API key input
    var storedKey=localStorage.getItem("txr_apikey")||"";
    o+='<div style="margin-top:8px;display:flex;gap:6px;align-items:center">';
    o+='<span style="font-size:9px;color:var(--dim);white-space:nowrap">API Key:</span>';
    o+='<input type="password" id="apiKeyInput" value="'+esc(storedKey)+'" placeholder="sk-ant-..." class="I" style="flex:1;font-size:10px;padding:4px 8px" onchange="localStorage.setItem(\'txr_apikey\',this.value)">';
    o+='</div>';
    if(S._aiBriefing){
      o+='<div style="margin-top:12px;font-size:13px;color:var(--text);line-height:1.7;white-space:pre-wrap">'+esc(S._aiBriefing)+'</div>';
    }else if(!S._aiLoading){
      // Show which games would be sent
      var triggered=[];
      S.data.forEach(function(a){
        if(!a.complete)return;
        var reasons=[];
        if(a.hyperRatio>1.1)reasons.push("top-tier odds "+a.hyperRatio.toFixed(2)+"x vs launch");
        if(a.returnGap>0.03)reasons.push("return gap +"+(a.returnGap*100).toFixed(1)+"%");
        if(a.tpr===a.tp.p&&a.mat>0.2)reasons.push("all "+a.tpr+" top prizes intact at "+pct(a.mat)+" sold");
        if(a.g.cs&&a.tpr>0)reasons.push("closing with "+a.tpr+" top prizes");
        if((a.gm.sig==="BUY"||a.gm.sig==="STRONG_BUY")&&a.tpr>0)reasons.push("Markov "+a.gm.sig.replace("_"," "));
        if(reasons.length>0)triggered.push({nm:a.g.nm,gn:a.g.gn,pr:a.g.pr,reasons:reasons});
      });
      o+='<div style="margin-top:10px;font-size:11px;color:var(--dim)">'+triggered.length+' games with significant signals will be analyzed:</div>';
      if(triggered.length>0){
        o+='<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">';
        triggered.slice(0,15).forEach(function(t){o+='<span style="font-size:9px;padding:3px 8px;background:#9b59b618;border:1px solid #9b59b630;border-radius:4px;color:#9b59b6">'+esc(t.nm)+' $'+t.pr+'</span>'});
        if(triggered.length>15)o+='<span style="font-size:9px;padding:3px 8px;color:var(--dim)">+'+((triggered.length-15))+' more</span>';
        o+='</div>';
      }else{
        o+='<div style="margin-top:6px;font-size:12px;color:var(--amb)">No games currently showing significant top-tier signals.</div>';
      }
    }
    o+='</div>';
    
    var ins=[];
    S.data.forEach(function(a){
      if(a.g.cs&&a.tpr>0)ins.push({pri:1,cat:"CLOSING",title:a.g.nm+" #"+a.g.gn+" ‚Äî "+a.tpr+" top prizes left",detail:"Odds: "+fmtO(a.tpo)+" ¬∑ "+pct(1-a.mat)+" tickets remain.",c:"var(--amb)",pr:a.g.pr,id:a.g.id});
      if(a.tpr===0)ins.push({pri:1,cat:"TOP GONE",title:a.g.nm+" ‚Äî all "+fmt(a.tp.a)+" claimed",detail:"No top prizes remain.",c:"var(--red)",pr:a.g.pr,id:a.g.id});
      if(a.returnGap>0.02)ins.push({pri:2,cat:"RICH POOL",title:a.g.nm+" ‚Äî remaining "+(a.returnGap*100).toFixed(1)+"% richer",detail:"Return gap: sold="+pct(a.soldReturn/a.g.pr)+" vs remaining="+pct(a.remainReturnPct),c:"var(--grn)",pr:a.g.pr,id:a.g.id});
      if(a.returnGap<-0.02)ins.push({pri:3,cat:"THIN POOL",title:a.g.nm+" ‚Äî remaining "+(Math.abs(a.returnGap)*100).toFixed(1)+"% thinner",detail:"Better prizes already claimed disproportionately.",c:"var(--red)",pr:a.g.pr,id:a.g.id});
      if(a.hyperRatio>1.2)ins.push({pri:2,cat:"TOP TIER+",title:a.g.nm+" ‚Äî top-tier odds "+a.hyperRatio.toFixed(1)+"x launch",detail:"P(top in pack): "+pct(a.hyperNow)+" now vs "+pct(a.hyperLaunch)+" at launch.",c:"var(--grn)",pr:a.g.pr,id:a.g.id});
      if(a.gm.sig==="STRONG_BUY")ins.push({pri:2,cat:"STRONG BUY",title:a.g.nm+" ‚Äî Top prizes underclaimed",detail:a.gm.rsn,c:"var(--grn)",pr:a.g.pr,id:a.g.id});
      if(a.gm.sig==="DEAD")ins.push({pri:1,cat:"DEAD GAME",title:a.g.nm+" ‚Äî All top prizes gone",detail:a.gm.rsn,c:"var(--red)",pr:a.g.pr,id:a.g.id});
      if(a.gm.sig==="AVOID")ins.push({pri:3,cat:"AVOID",title:a.g.nm+" ‚Äî Top prizes depleting fast",detail:a.gm.rsn,c:"var(--red)",pr:a.g.pr,id:a.g.id});
      if(a.mat<0.08&&a.complete)ins.push({pri:4,cat:"NEW",title:a.g.nm+" ‚Äî only "+pct(a.mat)+" sold",detail:"Full prize pool. All "+a.tp.p+" top prizes available.",c:"var(--blu)",pr:a.g.pr,id:a.g.id});
      a.gm.ts.forEach(function(t){if(t.sig==="HOT"&&t.dev<-0.15&&t.rem>0)ins.push({pri:3,cat:"$"+fN(t.a)+" HOT",title:a.g.nm+" ‚Äî $"+fN(t.a)+" underclaimed "+(Math.abs(t.dev)*100).toFixed(0)+"%",detail:t.rem+" remain. Category: "+t.cat,c:"var(--pur)",pr:a.g.pr,id:a.g.id})});
    });
    // Best per price
    var byP={};S.data.forEach(function(a){if(!byP[a.g.pr]||a.sc>byP[a.g.pr].sc)byP[a.g.pr]=a});
    Object.keys(byP).forEach(function(pr){var a=byP[pr];var cnt=S.data.filter(function(x){return x.g.pr===a.g.pr}).length;
      if(cnt>=2)ins.push({pri:5,cat:"BEST $"+pr,title:a.g.nm+" leads "+cnt+" games at $"+pr,detail:"Score: "+a.sc+" ¬∑ Gap: "+(a.returnGap>0?"+":"")+pct(a.returnGap)+" ¬∑ "+a.tpr+"/"+a.tp.p+" top left",c:"var(--blu)",pr:a.g.pr,id:a.g.id})});
    ins.sort(function(a,b){return a.pri-b.pri});
    
    o+='<div class="C"><div style="font-size:14px;font-weight:800;color:var(--wht);margin-bottom:4px">PATTERN DETECTION</div>';
    o+='<div style="font-size:11px;color:var(--dim);margin-bottom:8px">'+S.data.length+' games ¬∑ '+ins.length+' patterns ¬∑ Real data only</div></div>';
    ins.forEach(function(n){
      o+='<div class="C ck" onclick="openDetail(\''+n.id+'\')" style="border-left:3px solid '+n.c+'">';
      o+='<div style="display:flex;justify-content:space-between;gap:8px"><div>';
      o+='<div style="display:flex;gap:6px;margin-bottom:3px"><span style="font-size:9px;font-weight:700;color:'+n.c+'">'+esc(n.cat)+'</span>';
      if(n.pr)o+='<span style="font-size:9px;font-weight:800;color:#fff;background:'+prClr(n.pr)+';padding:1px 6px;border-radius:3px">$'+n.pr+'</span>';
      o+='</div><div style="font-size:13px;font-weight:700;color:var(--wht)">'+esc(n.title)+'</div>';
      o+='<div style="font-size:11px;color:var(--text);margin-top:3px">'+esc(n.detail)+'</div></div>';
      o+='<div style="font-size:18px;opacity:.3">‚Ä∫</div></div></div>';
    });
  }

  // === WINNERS ===
  if(S.tab==="winners"){
    if(!S.winData)S.winData=JSON.parse(localStorage.getItem("txwd6")||"{}");
    var allW=[];Object.keys(S.winData).forEach(function(gn){(S.winData[gn]||[]).forEach(function(w){w.gn=Number(gn);allW.push(w)})});
    
    o+='<div class="C"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px"><div>';
    o+='<div style="font-size:16px;font-weight:800;color:var(--wht)">WINNER DATA</div>';
    o+='<div style="font-size:11px;color:var(--dim)">'+allW.length+' winners</div></div>';
    o+='<div class="B'+(S._fetching?"":" on")+'" onclick="fetchWinners()">'+(S._fetching?'FETCHING...':'FETCH WINNERS')+'</div></div></div>';
    
    if(allW.length>0){
      // Hot stores
      var stores={};allW.forEach(function(w){if(!w.store)return;var k=w.store.toUpperCase().trim();if(!stores[k])stores[k]={name:w.store,city:w.city||"",count:0};stores[k].count++});
      var hot=Object.values(stores).filter(function(s){return s.count>=2}).sort(function(a,b){return b.count-a.count});
      if(hot.length){
        o+='<div class="C"><div class="L" style="color:var(--grn);margin-bottom:8px">REPEAT STORES ('+hot.length+')</div>';
        hot.forEach(function(s){o+='<div style="padding:6px 0;border-bottom:1px solid #1e2d3d20;display:flex;justify-content:space-between"><div style="font-size:12px;color:var(--wht)">'+esc(s.name)+' <span class="d">'+esc(s.city)+'</span></div><div class="g" style="font-weight:800">'+s.count+'x</div></div>'});
        o+='</div>';
      }
      // Table
      o+='<div class="C" style="overflow-x:auto"><table><thead><tr>';
      ["Date","Game","Store","City","Pack#","Tk#"].forEach(function(h){o+='<th style="text-align:left">'+h+'</th>'});
      o+='</tr></thead><tbody>';
      allW.sort(function(a,b){return(b.date||"").localeCompare(a.date||"")}).slice(0,200).forEach(function(w){
        o+='<tr><td style="text-align:left;font-size:10px">'+esc(w.date||"-")+'</td>';
        o+='<td style="text-align:left;font-size:10px;color:var(--wht)">#'+w.gn+'</td>';
        o+='<td style="text-align:left;font-size:10px">'+esc(w.store||"-")+'</td>';
        o+='<td style="text-align:left;font-size:10px">'+esc(w.city||"-")+'</td>';
        o+='<td style="text-align:left;font-size:10px;color:var(--blu)">'+(w.pn?fN(w.pn):"-")+'</td>';
        o+='<td style="text-align:left;font-size:10px;color:var(--amb)">'+(w.tk||"-")+'</td></tr>';
      });
      o+='</tbody></table></div>';
    }
  }

  // === MORE (Pack P&L + Bankroll) ===
  if(S.tab==="more"){
    o+='<div class="FR">';
    [["pack","PACK P&L"],["bank","BANKROLL"]].forEach(function(t){o+='<div class="B'+(S.moreTab===t[0]?" on":"")+'" onclick="setMore(\''+t[0]+'\')">'+t[1]+'</div>';});
    o+='</div>';
    if(S.moreTab==="pack"){
      var pk2=S.pack,mk=mkv();
      o+='<div class="C"><div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px"><div>';
      o+='<div style="font-size:15px;font-weight:700;color:var(--wht)">'+(pk2.nm||"Select game from Detail tab")+'</div>';
      o+='<div style="font-size:10px;color:var(--dim)">$'+pk2.pr+' ¬∑ '+pk2.pk+'/pack ¬∑ BTP:$'+pk2.aa+'</div></div>';
      o+='<div style="text-align:right"><div style="font-size:24px;font-weight:800;color:'+((pk2.won-pk2.spent)>=0?"var(--grn)":"var(--red)")+'">'+((pk2.won-pk2.spent)>=0?"+":"")+'$'+(pk2.won-pk2.spent)+'</div><div class="L">P&L</div></div></div></div>';
      if(mk&&pk2.nm){
        var mkc=mk.dec==="BUY"?"var(--grn)":mk.dec==="STOP"?"var(--red)":mk.dec==="CONSIDER"?"var(--amb)":"var(--blu)";
        o+='<div class="C"><div class="L" style="color:var(--blu)">MARKOV MID-PACK</div>';
        o+='<div class="G GA" style="margin:10px 0">';
        [{l:"Left",v:mk.rem,c:"var(--wht)"},{l:"P(Win)",v:pct(mk.pW),c:"var(--blu)"},{l:"P(Anchor)",v:pct(mk.pA),c:pk2.af?"var(--dim)":"var(--grn)"},{l:"Found?",v:pk2.af?"YES":"NO",c:pk2.af?"var(--grn)":"var(--amb)"}].forEach(function(m){
          o+='<div><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:16px;font-weight:700;color:'+m.c+'">'+m.v+'</div></div>';});
        o+='</div><div style="padding:10px;background:var(--bg);border-radius:6px"><span style="font-size:14px;font-weight:700;color:'+mkc+'">'+mk.dec+'</span> <span style="font-size:11px;color:var(--text)">'+esc(mk.rsn)+'</span></div></div>';
      }
      o+='<div class="C"><div class="L" style="margin-bottom:8px">LOG TICKET</div><div class="FR">';
      o+='<div class="B rn" onclick="scratch(0)">LOSER</div>';
      var qb=[pk2.pr,pk2.pr*2,pk2.pr*5,pk2.aa,pk2.aa*2],seen2={};
      for(i=0;i<qb.length;i++){if(!seen2[qb[i]]){seen2[qb[i]]=1;o+='<div class="B'+(qb[i]>=pk2.aa?" pn":" on")+'" onclick="scratch('+qb[i]+')">$'+fN(qb[i])+'</div>'}}
      o+='<input type="number" id="cAmt" class="I" style="width:80px;display:inline-block" placeholder="$">';
      o+='<div class="B bn" onclick="var v=document.getElementById(\'cAmt\').value;if(v){scratch(+v);document.getElementById(\'cAmt\').value=\'\'}">LOG</div></div>';
      o+='<div style="display:flex;gap:16px;margin:10px 0">';
      [{l:"Done",v:pk2.log.length+"/"+pk2.pk,c:"var(--wht)"},{l:"Spent",v:"$"+pk2.spent,c:"var(--red)"},{l:"Won",v:"$"+pk2.won,c:"var(--grn)"},{l:"ROI",v:pk2.spent>0?pct(pk2.won/pk2.spent-1):"‚Äî",c:pk2.spent>0?(pk2.won>=pk2.spent?"var(--grn)":"var(--red)"):"var(--dim)"}].forEach(function(m){
        o+='<div><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:18px;font-weight:700;color:'+m.c+'">'+m.v+'</div></div>';});
      o+='</div>';
      o+='<div style="background:var(--bg);border-radius:6px;height:20px;overflow:hidden"><div style="width:'+((pk2.log.length/pk2.pk)*100)+'%;height:100%;background:linear-gradient(90deg,var(--grn),var(--blu));border-radius:6px;transition:width .2s"></div></div>';
      if(pk2.log.length>0){o+='<div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:10px">';
        pk2.log.forEach(function(e){o+='<div style="min-width:'+(e.w?34:24)+'px;height:20px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:'+(e.w?9:10)+'px;font-weight:600;padding:0 3px;background:'+(e.amt>=pk2.aa?"var(--pur1)":e.w?"var(--grn1)":"var(--bg)")+';color:'+(e.amt>=pk2.aa?"var(--pur)":e.w?"var(--grn)":"#1e2d3d")+';border:1px solid '+(e.amt>=pk2.aa?"#9b59b644":e.w?"#2ecc7130":"#1e2d3d44")+'">'+(e.w?"$"+e.amt:"x")+'</div>'});
        o+='</div>';}
      o+='<div style="display:flex;gap:6px;margin-top:12px"><div class="B rn" onclick="resetPack()">RESET</div><div class="B on" onclick="saveSession()">SAVE</div></div></div>';
    }
    if(S.moreTab==="bank"){
      var tss=0,tsw=0;S.sessions.forEach(function(s){tss+=s.s;tsw+=s.w});
      o+='<div class="C"><div class="L" style="margin-bottom:10px">BANKROLL</div>';
      o+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:14px"><span class="d">Starting: $</span><input type="number" value="'+S.bankroll+'" onchange="setBR(+this.value)" class="I" style="width:110px"></div>';
      o+='<div class="G GA">';
      [{l:"BANKROLL",v:fmt(S.bankroll),c:"var(--wht)"},{l:"SPENT",v:fmt(tss),c:"var(--red)"},{l:"WON",v:fmt(tsw),c:"var(--grn)"},{l:"NET",v:((tsw-tss)>=0?"+":"")+fmt(tsw-tss),c:(tsw-tss)>=0?"var(--grn)":"var(--red)"},{l:"LEFT",v:fmt(S.bankroll-tss+tsw),c:"var(--wht)"}].forEach(function(m){
        o+='<div class="cl"><div class="L" style="font-size:8px">'+m.l+'</div><div class="V" style="color:'+m.c+'">'+m.v+'</div></div>';});
      o+='</div></div>';
      if(S.sessions.length>0){
        o+='<div class="C"><div class="L" style="margin-bottom:8px">HISTORY</div>';
        S.sessions.forEach(function(s){var pl=s.w-s.s;
          o+='<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #1e2d3d20"><div><div style="font-size:12px;color:var(--wht)">'+esc(s.g)+'</div><div style="font-size:10px;color:var(--dim)">'+s.t+' tk ¬∑ '+s.d+'</div></div><div style="font-size:14px;font-weight:700;color:'+(pl>=0?"var(--grn)":"var(--red)")+'">'+(pl>=0?"+":"")+'$'+pl+'</div></div>';});
        if(S.sessions.length>=2){var avgLoss=0;S.sessions.forEach(function(s){avgLoss+=s.s-s.w});avgLoss/=S.sessions.length;var remBR=S.bankroll-tss+tsw;var sessLeft=avgLoss>0?Math.floor(remBR/avgLoss):999;
          o+='<div style="margin-top:12px;padding:10px 12px;background:var(--bg);border-radius:8px"><div class="L" style="color:var(--amb)">BURN RATE</div><div style="font-size:12px;color:var(--text);margin-top:6px">Avg loss/session: <strong style="color:var(--red)">$'+avgLoss.toFixed(0)+'</strong> ¬∑ Sessions left: <strong style="color:'+(sessLeft<5?"var(--red)":"var(--amb)")+'">'+sessLeft+'</strong>'+(sessLeft<5?' ¬∑ <strong style="color:var(--red)">LOW RUNWAY</strong>':'')+'</div></div>';}
        o+='<div class="B rn" style="margin-top:10px" onclick="clearSess()">Clear</div></div>';
      }
    }
  }

  o+='<div style="text-align:center;margin-top:30px;padding:14px 0;border-top:1px solid var(--border);font-size:9px;color:#1e2d3d88;line-height:1.6">TX Scratch-Off Engine v6 ¬∑ Scraper-only data ¬∑ No hardcoded values<br>Play responsibly ¬∑ 1-800-522-4700</div>';
  document.getElementById("app").innerHTML=o;
}
init();
</script>
</body>
</html>
