<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TX Engine">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230d1118' width='100' height='100' rx='20'/><text x='50' y='62' text-anchor='middle' fill='%232ecc71' font-size='36' font-weight='900' font-family='system-ui'>TX</text></svg>">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>TX Scratch-Off Engine v7.4</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ°</text></svg>">
<style>
:root{
  --bg:#0d1118;--card:#151d28;--border:#1e2d3d;--text:#d0dae6;--dim:#8899aa;
  --grn:#2ecc71;--red:#e74c3c;--blu:#3498db;--amb:#f39c12;--pur:#9b59b6;--wht:#ecf0f1;--gld:#d4a017;
  --grn1:#2ecc7118;--red1:#e74c3c18;--blu1:#3498db18;--pur1:#9b59b618;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,sans-serif;font-size:13px;line-height:1.5;min-height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}input[type=number]{-moz-appearance:textfield}
.W{max-width:960px;margin:0 auto;padding:0 14px 100px}
.H{padding:14px 0;border-bottom:1px solid var(--border);margin-bottom:16px;position:sticky;top:0;background:var(--bg);z-index:99}
h1{font-size:20px;font-weight:800;color:var(--grn);letter-spacing:-.02em}
.sub{font-size:11px;color:var(--gld);margin-top:2px}
.stale{color:var(--amb);font-weight:700}
.tabs{display:flex;gap:5px;margin-top:10px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none}.tabs::-webkit-scrollbar{display:none}
.T{padding:8px 16px;border-radius:8px;border:1px solid var(--border);color:var(--dim);cursor:pointer;font:600 11px/1 'Segoe UI',sans-serif;white-space:nowrap;background:0 0;transition:.15s}
.T:hover{border-color:var(--dim);color:var(--text)}
.T.on{border-color:var(--grn);background:var(--grn1);color:var(--grn)}
.C{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px;position:relative}
.L{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.06em;font-weight:600;margin-bottom:4px}
.V{font-size:24px;font-weight:800;line-height:1}
.g{color:var(--grn)}.r{color:var(--red)}.b{color:var(--blu)}.a{color:var(--amb)}.p{color:var(--pur)}.w{color:var(--wht)}.d{color:var(--dim)}
.G{display:grid;gap:10px}.GA{grid-template-columns:repeat(auto-fit,minmax(130px,1fr))}
.G2{grid-template-columns:1fr 1fr}.G3{grid-template-columns:1fr 1fr 1fr}
.cl{background:var(--bg);border-radius:8px;padding:10px}
.B{padding:8px 16px;border-radius:8px;border:1px solid var(--border);color:var(--dim);cursor:pointer;font:600 11px 'Segoe UI',sans-serif;background:0 0;display:inline-block;transition:.15s}
.B:hover{border-color:var(--dim);color:var(--text)}
.B.on{border-color:var(--grn);background:var(--grn1);color:var(--grn)}
.B.bn{border-color:var(--blu);background:var(--blu1);color:var(--blu)}
.B.pn{border-color:var(--pur);background:var(--pur1);color:var(--pur)}
.B.rn{border-color:var(--red);background:var(--red1);color:var(--red)}
.I{background:#0a0e14;border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font:13px 'Segoe UI',sans-serif;outline:0;width:100%}
.I:focus{border-color:var(--blu)}select.I{cursor:pointer;-webkit-appearance:none}
.FR{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
.sig{margin-top:8px;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:600}
.sig.buy{background:var(--grn1);color:var(--grn);border:1px solid #2ecc7130}
.sig.avoid{background:var(--red1);color:var(--red);border:1px solid #e74c3c30}
.badge{font-size:9px;font-weight:700;padding:3px 10px;border-radius:0 0 6px 6px;position:absolute;top:-1px;letter-spacing:.04em}
table{width:100%;border-collapse:collapse}
th{text-align:right;padding:6px 8px;font-size:10px;color:var(--dim);border-bottom:1px solid var(--border);font-weight:600}
td{padding:6px 8px;text-align:right;font-size:11px;border-bottom:1px solid #1e2d3d20}
.ck{cursor:pointer;transition:.15s}.ck:hover{background:#ffffff08;border-color:#ffffff18}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.bar-label{width:80px;text-align:right;font-size:11px;font-weight:600;flex-shrink:0}
.bar-track{flex:1;height:22px;background:var(--bg);border-radius:4px;overflow:hidden;position:relative;display:flex}
.bar-pct{position:absolute;right:6px;top:3px;font-size:9px;color:var(--wht);font-weight:600;text-shadow:0 1px 2px #000}
.spark{display:inline-flex;align-items:end;gap:1px;height:20px;vertical-align:middle}
.spark-bar{width:3px;border-radius:1px;min-height:2px}
.why-tag{font-size:10px;padding:3px 8px;border-radius:5px;font-weight:700;display:inline-block;margin:2px 2px}
.collapse-toggle{cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center}
.collapse-toggle:hover{opacity:0.85}
.collapse-body{overflow:hidden;transition:max-height 0.3s ease}
@media(max-width:640px){.G3{grid-template-columns:1fr 1fr}.GA{grid-template-columns:repeat(auto-fit,minmax(110px,1fr))}h1{font-size:17px}.bar-label{width:60px;font-size:10px}}
</style>
</head>
<body>
<div class="W" id="app"></div>
<script>
// ============================================================
// TX SCRATCH-OFF ENGINE v7.4 â€” SIMILARITY + VARIANCE MODEL
// v7.4 changes:
// 1. Fixed mat variable used before definition (returnGap bug)
// 2. Fixed duplicate filteredPrizes declaration
// 3. Prize class awareness (high-value >$1K vs low-value â‰¤$1K)
// 4. Similarity-based variance model for confidence calibration
// 5. 4 new functions: classifyPrizeClass, computeSimilarity,
//    findSimilarGames, buildVarianceModel
// 6. Modified predictJackpotPacks with similarity integration
// ============================================================

var GD=[];
var DD="";

function fmt(n){if(n>=1e6)return "$"+(n/1e6).toFixed(1)+"M";if(n>=1e3)return "$"+(n/1e3).toFixed(1)+"K";return "$"+Math.round(n)}
function pct(n){return(n*100).toFixed(1)+"%"}
function fmtO(n){if(n===Infinity||n>1e9)return "-";if(n>=1e6)return "1:"+Math.round(n/1e6)+"M";if(n>=1e3)return "1:"+Math.round(n/1e3)+"K";return "1:"+Math.round(n)}
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function fN(n){return n.toLocaleString()}
function prClr(pr){var m={1:"#c39bd3",2:"#bb8fce",3:"#af7ac5",5:"#a569bd",10:"#9b59b6",20:"#884ea0",30:"#7d3c98",50:"#6c3483",100:"#5b2c6f"};return m[pr]||"#9b59b6"}

function logC(n,k){
  if(k>n||k<0)return -Infinity;
  if(k===0||k===n)return 0;
  if(k>n-k)k=n-k;
  var s=0;for(var i=1;i<=k;i++)s+=Math.log(n-i+1)-Math.log(i);return s;
}

function validateOdds(g){
  if(!g.odds||g.odds<=0||!g.tot||g.tot<=0)return{valid:false};
  var totalWinners=0;
  for(var i=0;i<g.pz.length;i++)totalWinners+=g.pz[i].p;
  var computedOdds=g.tot/totalWinners;
  var diff=Math.abs(computedOdds-g.odds)/g.odds;
  return{valid:diff<0.05,computedOdds:computedOdds,diff:diff,totalWinners:totalWinners};
}

function detectBTP(g){
  var i,p;
  var packPrice=g.pk*g.pr;
  var pc=g.tot>0&&g.pk>0?Math.round(g.tot/g.pk):0;
  if(pc<=0)return{valid:false,reason:"Missing total/pack size"};
  var tiers=[];
  for(i=0;i<g.pz.length;i++){p=g.pz[i];tiers.push({a:p.a,printed:p.p,claimed:p.c,rem:p.p-p.c,ratio:p.p/pc,idx:i});}
  var floorZone=[],aboveFloor=[];
  for(i=0;i<tiers.length;i++){if(tiers[i].ratio>=0.3)floorZone.push(tiers[i]);else aboveFloor.push(tiers[i]);}
  var btp=null;
  for(i=0;i<floorZone.length;i++){if(floorZone[i].ratio>=0.5&&(!btp||floorZone[i].a>btp.a))btp=floorZone[i];}
  if(!btp&&floorZone.length>0)btp=floorZone.reduce(function(a,b){return a.a>b.a?a:b});
  var floorValid=false,computedFloor=0;
  if(g.guar>0&&floorZone.length>0){
    var fzs=floorZone.slice().sort(function(a,b){return b.a-a.a});
    var target=g.guar,comp=0;
    for(i=0;i<fzs.length;i++){var cnt=Math.max(1,Math.floor(fzs[i].ratio));var maxByTarget=Math.floor(target/fzs[i].a);cnt=Math.min(cnt,Math.max(1,maxByTarget));if(cnt>0&&target>=fzs[i].a){comp+=fzs[i].a*cnt;target-=fzs[i].a*cnt;}}
    computedFloor=comp;floorValid=Math.abs(g.guar-comp)<=Math.max(g.pr,g.guar*0.08);
  }
  var jackpotTiers=[];
  var aboveSorted=aboveFloor.slice().sort(function(a,b){return b.a-a.a});
  if(aboveSorted.length>=1){jackpotTiers.push(aboveSorted[0]);if(aboveSorted.length>=2&&aboveSorted[1].ratio<0.1){jackpotTiers.push(aboveSorted[1]);if(aboveSorted.length>=3&&aboveSorted[2].ratio<0.05){jackpotTiers.push(aboveSorted[2]);}}}
  var jkMap={};for(i=0;i<jackpotTiers.length;i++)jkMap[jackpotTiers[i].a]=1;
  var midTiers=aboveFloor.filter(function(t){return!jkMap[t.a]}).sort(function(a,b){return b.a-a.a});
  return{valid:true,pc:pc,packPrice:packPrice,floorZone:floorZone.sort(function(a,b){return b.a-a.a}),floorValid:floorValid,computedFloor:computedFloor,btp:btp,hasJackpot:jackpotTiers.length>0,jackpotTiers:jackpotTiers,midTiers:midTiers};
}

function analyze(g){
  var i,j,p;
  var R=function(p){return p.p-p.c};
  var totalTickets=g.tot;
  var totWinP=0;for(i=0;i<g.pz.length;i++)totWinP+=g.pz[i].p;
  var tpvp=0;for(i=0;i<g.pz.length;i++)tpvp+=g.pz[i].a*g.pz[i].p;
  if(totalTickets<=0&&g.odds>0)totalTickets=Math.round(totWinP*g.odds);
  var totEstimated=totalTickets!==g.tot;
  var complete=totalTickets>0&&g.pk>0&&g.guar>0&&g.odds>0;
  var pc=totalTickets>0&&g.pk>0?Math.round(totalTickets/g.pk):0;
  var packPrice=g.pk*g.pr;
  var designedReturn=totalTickets>0&&g.pr>0?tpvp/(totalTickets*g.pr):0;
  var gd={tot:totalTickets,pk:g.pk,pr:g.pr,guar:g.guar,odds:g.odds,pz:g.pz};
  var btpInfo=detectBTP(gd);
  var oddsCheck=validateOdds(gd);
  var aa=btpInfo.valid&&btpInfo.btp?btpInfo.btp.a:0;
  var ai=g.pz.findIndex(function(p){return p.a===aa});
  var at=ai>=0?g.pz[ai]:null;
  var acr=at&&at.p>0?at.c/at.p:0;
  var btpValid=btpInfo.valid&&btpInfo.floorValid;
  var eps=pc>0?Math.round(pc*acr):0;
  var epr=Math.max(1,pc-eps);
  var ets=eps*g.pk;
  var etr=Math.max(0,totalTickets-ets);
  var tpvc=0;for(i=0;i<g.pz.length;i++)tpvc+=g.pz[i].a*g.pz[i].c;
  var tpvr=tpvp-tpvc;
  var pkc=packPrice;

  // v7.4 FIX: mat MUST be computed BEFORE returnGap
  var tp=g.pz[0],tpr=R(tp),tpo=etr>0&&tpr>0?etr/tpr:Infinity;
  var mat=totalTickets>0?ets/totalTickets:0;
  var tpPack=epr>0&&tpr>0?tpr/epr:0;

  var soldReturn=ets>0?tpvc/ets:0;
  var remainReturn=etr>0?tpvr/etr:0;
  // v7.4: returnGap now works correctly (mat defined above)
  var returnGap=soldReturn>0&&mat>0.10?(remainReturn-soldReturn)/soldReturn:0;
  var remainReturnPct=etr>0&&g.pr>0?tpvr/(etr*g.pr):0;

  var ot=ai>=0?g.pz.slice(0,ai):[];
  var olr=0,oot=0;
  for(i=0;i<ot.length;i++){olr+=R(ot[i]);oot+=ot[i].p}
  var orpC=epr>0?olr/epr:0,orpO=pc>0?oot/pc:0;
  var orpS=orpO>0?((orpC-orpO)/orpO)*100:0;
  var abvC=0,abvP=0;for(i=0;i<ot.length;i++){abvC+=ot[i].c;abvP+=ot[i].p}
  var abvPct=abvP>0?abvC/abvP:0;
  var blwC=0,blwP=0;for(i=ai+1;i<g.pz.length;i++){blwC+=g.pz[i].c;blwP+=g.pz[i].p}
  var blwPct=blwP>0?blwC/blwP:0;

  var jackpotTiers=btpInfo.valid?btpInfo.jackpotTiers:[];
  var tierWeights=[1.0, 0.5, 0];
  var jackpotShifts=[];
  for(i=0;i<jackpotTiers.length;i++){
    var jt=jackpotTiers[i];var lD=pc>0?jt.printed/pc:0;var cD=epr>0?jt.rem/epr:0;var sh=lD>0?cD/lD:0;
    var lO=pc>0&&jt.printed>0?Math.round(pc/jt.printed):Infinity;var cO=epr>0&&jt.rem>0?Math.round(epr/jt.rem):Infinity;
    var role=i===0?"TOP":i===1?"TOP-1":"TOP-2";var wt=i<tierWeights.length?tierWeights[i]:0;
    var claimLag=acr>0?(acr-(jt.printed>0?jt.claimed/jt.printed:0))/acr:0;var claimDelayTier=jt.a>599;
    jackpotShifts.push({a:jt.a,printed:jt.printed,remaining:jt.rem,claimed:jt.claimed,launchOdds:lO,currentOdds:cO,shift:sh,role:role,weight:wt,claimLag:claimLag,claimDelayTier:claimDelayTier,signal:jt.rem<=0?"GONE":sh>=1.5?"STRONG":sh>=1.2?"GOOD":sh>=0.9?"NEUTRAL":sh>=0.7?"WEAK":"DEPLETED"});
  }
  var jackpotRem=0,jackpotPrinted=0,jackpotRemW=0,jackpotPrintedW=0;
  for(i=0;i<jackpotTiers.length;i++){jackpotRem+=jackpotTiers[i].rem;jackpotPrinted+=jackpotTiers[i].printed;var w2=i<tierWeights.length?tierWeights[i]:0;jackpotRemW+=jackpotTiers[i].rem*w2;jackpotPrintedW+=jackpotTiers[i].printed*w2;}
  var jackpotDensityNow=epr>0?jackpotRemW/epr:0;var jackpotDensityLaunch=pc>0?jackpotPrintedW/pc:0;var jackpotDensityShift=jackpotDensityLaunch>0?jackpotDensityNow/jackpotDensityLaunch:0;
  var topDensityShift=0,topClaimLag=0;
  if(jackpotShifts.length>0){topDensityShift=jackpotShifts[0].shift;topClaimLag=jackpotShifts[0].claimLag;}
  var jackpotEV=0,jackpotEVLaunch=0,jackpotEVRaw=0,jackpotEVLaunchRaw=0;
  for(i=0;i<jackpotTiers.length;i++){var evW=i<tierWeights.length?tierWeights[i]:0;var tierEV=jackpotTiers[i].rem>0&&epr>0?jackpotTiers[i].a*(jackpotTiers[i].rem/epr):0;var tierEVL=jackpotTiers[i].printed>0&&pc>0?jackpotTiers[i].a*(jackpotTiers[i].printed/pc):0;jackpotEV+=tierEV*evW;jackpotEVLaunch+=tierEVL*evW;jackpotEVRaw+=tierEV;jackpotEVLaunchRaw+=tierEVL;}
  var jackpotEVShift=jackpotEVLaunch>0?jackpotEV/jackpotEVLaunch:0;
  var hyperNow=0,hyperLaunch=0;
  if(etr>0&&g.pk>0&&jackpotRem>0){hyperNow=1-Math.exp(logC(etr-jackpotRem,g.pk)-logC(etr,g.pk));}
  if(totalTickets>0&&g.pk>0&&jackpotPrinted>0){hyperLaunch=1-Math.exp(logC(totalTickets-jackpotPrinted,g.pk)-logC(totalTickets,g.pk));}
  var hyperRatio=hyperLaunch>0?hyperNow/hyperLaunch:0;
  var hyperTopNow=0,hyperTopLaunch=0;
  if(jackpotTiers.length>0){var tpRem=jackpotTiers[0].rem,tpPri=jackpotTiers[0].printed;if(etr>0&&g.pk>0&&tpRem>0){hyperTopNow=1-Math.exp(logC(etr-tpRem,g.pk)-logC(etr,g.pk));}if(totalTickets>0&&g.pk>0&&tpPri>0){hyperTopLaunch=1-Math.exp(logC(totalTickets-tpPri,g.pk)-logC(totalTickets,g.pk));}}
  var hyperTopRatio=hyperTopLaunch>0?hyperTopNow/hyperTopLaunch:0;
  var hollowedOut=false;
  if(jackpotTiers.length>=2&&jackpotTiers[0].rem>0){var midGone=true;for(i=1;i<jackpotTiers.length;i++)if(jackpotTiers[i].rem>0)midGone=false;if(midGone)hollowedOut=true;}
  var totRem=0;for(i=0;i<g.pz.length;i++)totRem+=R(g.pz[i]);
  var winOdds=etr>0&&totRem>0?etr/totRem:Infinity;
  var ts=[],gSig="NEUTRAL",gRsn="Claims tracking normally.";
  for(i=0;i<ot.length;i++){p=ot[i];var ar=p.p>0?p.c/p.p:0;var dev=acr>0?(ar-acr)/acr:0;var minSample=Math.max(5,p.p*0.05);var isJackpot=false;if(btpInfo.valid){for(var jj=0;jj<btpInfo.jackpotTiers.length;jj++){if(btpInfo.jackpotTiers[jj].a===p.a){isJackpot=true;break;}}}var sig=p.c>=minSample&&dev<-0.05?"HOT":p.c>=minSample&&dev>0.05?"COLD":"NORMAL";ts.push({a:p.a,ar:ar,er:acr,dev:dev,sig:sig,rem:R(p),cat:isJackpot?"JACKPOT":"MID",isJackpot:isJackpot});}
  var jkH=0,jkC=0,jkN=0,allJkG=true;
  for(i=0;i<ts.length;i++){if(!ts[i].isJackpot)continue;jkN++;if(ts[i].rem>0)allJkG=false;if(ts[i].sig==="HOT")jkH++;if(ts[i].sig==="COLD")jkC++;}
  if(!btpInfo.hasJackpot){gSig="NO_JACKPOT";gRsn="No rare prize tiers above floor.";}
  else if(allJkG&&jkN>0){gSig="DEAD";gRsn="All jackpot prizes claimed.";}
  else if(jkC>0&&jkH===0){gSig="AVOID";gRsn="Jackpot prizes depleting faster than tickets selling.";}
  else if(jkH>0&&jkC===0){gSig="BUY";gRsn="Jackpot prizes underclaimed â€” in remaining packs.";if(ts.filter(function(t){return!t.isJackpot&&t.sig==="HOT"}).length>0){gSig="STRONG_BUY";gRsn="Jackpot AND mid prizes underclaimed.";}}
  else if(jkH>0&&jkC>0){gSig="MIXED";gRsn="Some jackpot tiers under, others overclaimed.";}
  else{var mH=ts.filter(function(t){return!t.isJackpot&&t.sig==="HOT"}).length;var mC=ts.filter(function(t){return!t.isJackpot&&t.sig==="COLD"}).length;if(mH>0&&mC===0){gSig="BUY";gRsn="Jackpot neutral but mid prizes underclaimed.";}else if(mC>0&&mH===0){gSig="CAUTION";gRsn="Jackpot neutral but mid prizes depleting.";}}
  if(returnGap<-0.03&&(gSig==="STRONG_BUY"||gSig==="BUY")){gSig="NEUTRAL";gRsn="Counts lag but dollars claimed disproportionately.";}
  if(returnGap>0.03&&gSig==="AVOID"){gSig="NEUTRAL";gRsn="Some tiers depleted but dollar value favors remaining.";}
  var floorEV=g.guar>0?g.guar:0;var midRangeEV=0;
  if(btpInfo.valid){for(i=0;i<btpInfo.midTiers.length;i++){var mt=btpInfo.midTiers[i];if(mt.rem>0&&epr>0)midRangeEV+=mt.a*(mt.rem/epr);}}
  var totalEV=floorEV+midRangeEV+jackpotEVRaw;var edge=packPrice>0?(totalEV/packPrice)-1:0;
  var midEVL=0;if(btpInfo.valid){for(i=0;i<btpInfo.midTiers.length;i++){var mt2=btpInfo.midTiers[i];if(mt2.printed>0&&pc>0)midEVL+=mt2.a*(mt2.printed/pc);}}
  var totalEVLaunch=floorEV+midEVL+jackpotEVLaunchRaw;var edgeLaunch=packPrice>0?(totalEVLaunch/packPrice)-1:0;
  var impliedYield=eps>0&&packPrice>0?tpvc/(eps*packPrice):0;var yieldValid=g.guar>0&&packPrice>0?(impliedYield>=(g.guar/packPrice)*0.9&&impliedYield<=0.85):false;
  var methodA=eps;var totalClaimed=0;for(i=0;i<g.pz.length;i++)totalClaimed+=g.pz[i].c;
  var methodB=g.odds>0&&g.pk>0?Math.round(totalClaimed/(g.pk/g.odds)):0;
  var yieldRate=designedReturn>0?designedReturn:0.70;
  var methodC=packPrice>0&&yieldRate>0?Math.round(tpvc/(packPrice*yieldRate)):0;
  var methods=[methodA,methodB,methodC].filter(function(m){return m>0});
  var confidence="LOW";
  if(methods.length>=2){var pairs=[];if(methodA>0&&methodB>0)pairs.push(Math.abs(methodA-methodB)/Math.max(methodA,methodB));if(methodA>0&&methodC>0)pairs.push(Math.abs(methodA-methodC)/Math.max(methodA,methodC));if(methodB>0&&methodC>0)pairs.push(Math.abs(methodB-methodC)/Math.max(methodB,methodC));var bestPair=Math.min.apply(null,pairs);if(bestPair<=0.05)confidence="HIGH";else if(bestPair<=0.10)confidence="MEDIUM";}

  var sc=50;var scoreBreakdown=[];
  function addPts(pts,label){var rp=Math.round(pts);if(rp===0)return;sc+=rp;scoreBreakdown.push({f:label,p:rp});}
  if(jackpotDensityShift>0)addPts(Math.max(-20,Math.min(20,(jackpotDensityShift-1)*25)),"Top density "+jackpotDensityShift.toFixed(2)+"x (weighted)");
  if(tpr===0){addPts(-15,"Top prize GONE");}else if(tp.p>0){var matScale=mat<0.2?0.3:mat<0.5?0.6:mat<0.7?0.8:1.0;var topAvailPts=Math.round(Math.min(15,((tpr/tp.p)*15)*matScale));addPts(topAvailPts,"Top "+tpr+"/"+tp.p+" @ "+pct(mat)+" sold");}
  if(topClaimLag!==0&&jackpotShifts.length>0&&mat>0.1){var lagDampen=jackpotShifts[0].a>599?0.85:1.0;addPts(Math.max(-8,Math.min(8,Math.round(topClaimLag*10*lagDampen))),"Top prize lag "+(topClaimLag>0?"+":"")+pct(topClaimLag)+(jackpotShifts[0].a>599?" (>$599 adj)":""));}
  if(hyperRatio>0)addPts(Math.max(-10,Math.min(10,Math.round((hyperRatio-1)*20))),"P(top in pack) "+hyperRatio.toFixed(2)+"x");
  if(jackpotEVShift>0)addPts(Math.max(-10,Math.min(10,Math.round((jackpotEVShift-1)*15))),"Top EV "+jackpotEVShift.toFixed(2)+"x");
  var mkMap={"STRONG_BUY":8,"BUY":5,"NEUTRAL":0,"NO_JACKPOT":0,"MIXED":0,"CAUTION":-3,"AVOID":-8,"DEAD":-15};
  addPts(mkMap[gSig]||0,"Markov "+gSig.replace(/_/g," "));
  if(returnGap!==0)addPts(Math.max(-5,Math.min(5,Math.round(returnGap*50))),"Return gap "+(returnGap>0?"+":"")+pct(returnGap));
  if(g.odds>0&&winOdds<Infinity)addPts(Math.max(-3,Math.min(3,Math.round(((g.odds-winOdds)/g.odds)*15))),"Win odds shift");
  var trend=getTrend(g.id);
  if(trend.length>=3){var recent=trend.slice(-3);var firstJd=recent[0].jd,lastJd=recent[recent.length-1].jd;if(firstJd>0){var trendDir=(lastJd-firstJd)/firstJd;addPts(Math.max(-5,Math.min(5,Math.round(trendDir*30))),"Trend "+(trendDir>0?"â–²":"â–¼")+" "+pct(Math.abs(trendDir)));}}
  if(g.cs&&tpr>0)addPts(8,"CLOSING + top left");else if(g.cs&&tpr===0)addPts(-10,"CLOSING + gone");
  if(hollowedOut)addPts(-10,"HOLLOWED â€” mid tiers gone");
  if(!btpInfo.hasJackpot){sc=Math.min(sc,30);scoreBreakdown.push({f:"No rare top tiers",p:0});}
  if(mat<0.15&&mat>0){var pre=sc;sc=Math.round(50+(sc-50)*0.6);scoreBreakdown.push({f:"Early ("+pct(mat)+") dampen",p:sc-pre});}
  if(!complete)addPts(-5,"Incomplete data");
  if(confidence==="LOW"&&complete){var pre2=sc;sc=Math.round(50+(sc-50)*0.7);scoreBreakdown.push({f:"LOW conf dampen",p:sc-pre2});}
  var rawSc=sc;sc=Math.round(Math.min(100,Math.max(0,sc)));
  var whyScore=scoreBreakdown.slice().sort(function(a,b){return Math.abs(b.p)-Math.abs(a.p)}).filter(function(s){return s.p!==0}).slice(0,2);
  var tierCats={};
  if(btpInfo.valid){for(i=0;i<btpInfo.floorZone.length;i++)tierCats[btpInfo.floorZone[i].a]=btpInfo.floorZone[i].a===aa?"BTP":"FLOOR";for(i=0;i<btpInfo.midTiers.length;i++)tierCats[btpInfo.midTiers[i].a]="MID";for(i=0;i<btpInfo.jackpotTiers.length;i++){var role2=i===0?"TOP":i===1?"TOP-1":"TOP-2";tierCats[btpInfo.jackpotTiers[i].a]=role2;}}else{if(ai>=0)tierCats[g.pz[ai].a]="BTP";for(i=0;i<ai;i++)tierCats[g.pz[i].a]=i===0?"TOP":i===1?"TOP-1":"MID";for(i=ai+1;i<g.pz.length;i++)tierCats[g.pz[i].a]="FLOOR";}
  var tierAdv=[];
  for(i=0;i<ot.length;i++){p=ot[i];var trm=R(p);if(trm<=0)continue;var oO=totalTickets>0&&p.p>0?totalTickets/p.p:Infinity;var cO2=etr>0&&trm>0?etr/trm:Infinity;var pB=oO>0&&oO<Infinity?((oO-cO2)/oO)*100:0;tierAdv.push({a:p.a,origO:oO,currO:cO2,pctB:pB,rem:trm,cat:tierCats[p.a]||"?"});}
  var prizes=[];for(i=0;i<g.pz.length;i++){p=g.pz[i];var rm=R(p);prizes.push({a:p.a,p:p.p,c:p.c,rem:rm,pctC:p.p>0?(p.c/p.p*100):0,origO:totalTickets>0?totalTickets/p.p:Infinity,currO:etr>0&&rm>0?etr/rm:Infinity,isA:p.a===aa,isO:ai>=0&&i<ai,cat:tierCats[p.a]||"?",isJackpot:tierCats[p.a]==="JACKPOT",highSens:p.p<=10});}
  var flags=[];
  if(tpr===0)flags.push({t:"DANGER",m:"All "+fmt(tp.a)+" claimed",c:"r"});
  if(g.cs&&tpr>0)flags.push({t:"CLOSING",m:tpr+" top prizes left in closing game",c:"a"});
  if(gSig==="STRONG_BUY")flags.push({t:"HOT",m:gRsn,c:"g"});
  if(gSig==="BUY")flags.push({t:"BUY",m:gRsn,c:"g"});
  if(gSig==="DEAD")flags.push({t:"DEAD",m:gRsn,c:"r"});
  if(gSig==="AVOID")flags.push({t:"AVOID",m:gRsn,c:"r"});
  if(gSig==="CAUTION")flags.push({t:"CAUTION",m:gRsn,c:"a"});
  if(gSig==="NO_JACKPOT")flags.push({t:"NO JACKPOT",m:"No rare tiers above floor",c:"d"});
  if(hollowedOut)flags.push({t:"HOLLOWED",m:"Top exists but mid tiers gone",c:"a"});
  if(returnGap>0.02)flags.push({t:"RICH",m:"Remaining "+(returnGap*100).toFixed(1)+"% richer",c:"g"});
  if(returnGap<-0.02)flags.push({t:"THIN",m:"Remaining "+(Math.abs(returnGap)*100).toFixed(1)+"% thinner",c:"r"});
  if(hyperRatio>1.2)flags.push({t:"JACKPOT+",m:"Odds "+hyperRatio.toFixed(1)+"x vs launch",c:"g"});
  if(mat<0.08)flags.push({t:"FRESH",m:"Only "+pct(mat)+" sold",c:"b"});
  if(!complete)flags.push({t:"INCOMPLETE",m:"Missing detail page data",c:"a"});
  for(i=0;i<jackpotShifts.length;i++){if(jackpotShifts[i].printed<=10)flags.push({t:"âš¡$"+fN(jackpotShifts[i].a),m:"â‰¤10 printed â€” high sensitivity",c:"a"});}
  for(i=0;i<ts.length;i++){if(ts[i].isJackpot&&ts[i].sig==="HOT"&&ts[i].dev<-0.15)flags.push({t:"$"+fN(ts[i].a)+" HOT",m:"Underclaimed",c:"p"});}
  if(!yieldValid&&complete)flags.push({t:"YIELDâš ",m:"Implied "+pct(impliedYield)+" outside range",c:"a"});
  if(oddsCheck.valid===false&&g.odds>0)flags.push({t:"ODDSâš ",m:"Prize counts don't match published odds",c:"a"});
  // v7.4: prize class
  var prizeClass=tp.a>1000?'high':'low';

  return{g:g,pc:pc,aa:aa,ai:ai,acr:acr,eps:eps,epr:epr,ets:ets,etr:etr,tpvp:tpvp,tpvc:tpvc,tpvr:tpvr,pkc:pkc,complete:complete,totalTickets:totalTickets,packPrice:packPrice,totEstimated:totEstimated,designedReturn:designedReturn,soldReturn:soldReturn,remainReturn:remainReturn,returnGap:returnGap,remainReturnPct:remainReturnPct,btpInfo:btpInfo,btpValid:btpValid,oddsCheck:oddsCheck,orpC:orpC,orpO:orpO,orpS:orpS,abvPct:abvPct,blwPct:blwPct,tp:tp,tpr:tpr,tpo:tpo,mat:mat,sc:sc,rawSc:rawSc,tpPack:tpPack,winOdds:winOdds,totRem:totRem,jackpotTiers:jackpotTiers,jackpotShifts:jackpotShifts,jackpotDensityNow:jackpotDensityNow,jackpotDensityLaunch:jackpotDensityLaunch,jackpotDensityShift:jackpotDensityShift,topDensityShift:topDensityShift,topClaimLag:topClaimLag,jackpotEV:jackpotEV,jackpotEVLaunch:jackpotEVLaunch,jackpotEVShift:jackpotEVShift,jackpotEVRaw:jackpotEVRaw,jackpotEVLaunchRaw:jackpotEVLaunchRaw,hyperNow:hyperNow,hyperLaunch:hyperLaunch,hyperRatio:hyperRatio,hyperTopNow:hyperTopNow,hyperTopLaunch:hyperTopLaunch,hyperTopRatio:hyperTopRatio,hollowedOut:hollowedOut,floorEV:floorEV,midRangeEV:midRangeEV,totalEV:totalEV,edge:edge,totalEVLaunch:totalEVLaunch,edgeLaunch:edgeLaunch,methodA:methodA,methodB:methodB,methodC:methodC,dataConfidence:confidence,impliedYield:impliedYield,yieldValid:yieldValid,scoreBreakdown:scoreBreakdown,whyScore:whyScore,tierAdv:tierAdv,tierCats:tierCats,prizes:prizes,gm:{ts:ts,sig:gSig,rsn:gRsn},flags:flags,prizeClass:prizeClass};
}

// === MONTE CARLO PACK SIMULATION ===
function simulatePacks(a,N){
  if(!a.complete||a.epr<=0||a.etr<=0)return{valid:false};
  N=N||10000;
  var g=a.g,pk=g.pk,cost=a.packPrice,eW=g.odds>0?pk/g.odds:0;
  var topAmt=a.jackpotShifts.length>0?a.jackpotShifts[0].a:Infinity;
  var top1Amt=a.jackpotShifts.length>1?a.jackpotShifts[1].a:Infinity;
  var pool=[],totP=0;
  for(var i=0;i<g.pz.length;i++){var rm=g.pz[i].p-g.pz[i].c;if(rm>0){pool.push({a:g.pz[i].a,w:rm});totP+=rm;}}
  if(totP<=0)return{valid:false};
  var cum=[];var c=0;for(i=0;i<pool.length;i++){c+=pool[i].w;cum.push(c);}
  var results=[],pFl=0,pPr=0,pTop=0,pTop1=0,tRet=0;
  var buckets=[{l:"Below Floor",mn:0,mx:a.floorEV-1,n:0},{l:"At Floor",mn:a.floorEV-1,mx:a.floorEV+cost*0.01,n:0},{l:"Floor+",mn:a.floorEV+cost*0.01,mx:cost,n:0},{l:"Break Even",mn:cost,mx:cost*2,n:0},{l:"2x-5x",mn:cost*2,mx:cost*5,n:0},{l:"5x+",mn:cost*5,mx:Infinity,n:0}];
  for(var s=0;s<N;s++){
    var tot=0,hitTop=false,hitTop1=false;
    var nW=Math.floor(eW)+(Math.random()<(eW%1)?1:0);
    if(Math.random()<0.1)nW+=Math.random()<0.5?1:-1;nW=Math.max(1,nW);
    for(var w=0;w<nW;w++){var r=Math.random()*totP,lo=0,hi=cum.length-1,drawn=pool[0].a;while(lo<=hi){var mid2=(lo+hi)>>1;if(cum[mid2]<r)lo=mid2+1;else{drawn=pool[mid2].a;hi=mid2-1;}}tot+=drawn;if(drawn>=topAmt)hitTop=true;if(drawn>=top1Amt)hitTop1=true;}
    if(a.floorEV>0&&tot<a.floorEV)tot=a.floorEV;
    results.push(tot);tRet+=tot;
    if(tot<=a.floorEV+1)pFl++;if(tot>=cost)pPr++;if(hitTop1)pTop1++;if(hitTop)pTop++;
    for(var b=0;b<buckets.length;b++){if(tot>buckets[b].mn&&tot<=buckets[b].mx){buckets[b].n++;break;}}
  }
  results.sort(function(a,b){return a-b});
  return{valid:true,N:N,mean:tRet/N,median:results[N>>1],p5:results[Math.floor(N*0.05)],p95:results[Math.floor(N*0.95)],pFloor:pFl/N,pProfit:pPr/N,pTop1:pTop1/N,pTop:pTop/N,topAmt:topAmt,top1Amt:top1Amt,worst:results[0],best:results[N-1],cost:cost,floor:a.floorEV,buckets:buckets,expPL:(tRet/N)-cost};
}

function remainingPoolForecast(a){
  if(!a.complete||a.epr<=0||a.etr<=0||!a.btpInfo.valid)return{valid:false};
  var g=a.g,pk=g.pk,cost=a.packPrice,epr=a.epr;
  var tiers=[];
  for(var i=0;i<g.pz.length;i++){var p=g.pz[i],rem=p.p-p.c;if(rem<=0)continue;var ratio=epr>0?rem/epr:0;var packsWith=Math.min(epr,rem);var pctPacks=epr>0?packsWith/epr:0;var cat=a.tierCats[p.a]||"?";var isJackpot=cat==="TOP"||cat==="TOP-1"||cat==="TOP-2";var isMid=cat==="MID";tiers.push({a:p.a,rem:rem,ratio:ratio,packsWith:packsWith,pctPacks:pctPacks,cat:cat,isJackpot:isJackpot,isMid:isMid});}
  var jackpotPacks=0,jackpotTierDetails=[];
  for(i=0;i<tiers.length;i++){if(!tiers[i].isJackpot)continue;var t=tiers[i];jackpotTierDetails.push({a:t.a,rem:t.rem,cat:t.cat,packsWith:t.rem,pctOfRemaining:epr>0?t.rem/epr:0,oddsPerPack:epr>0&&t.rem>0?"1:"+fN(Math.round(epr/t.rem)):"â€”"});jackpotPacks+=t.rem;}
  if(jackpotPacks>epr)jackpotPacks=epr;
  var midPrizes=0;for(i=0;i<tiers.length;i++){if(tiers[i].isMid)midPrizes+=tiers[i].rem;}
  var midLambda=epr>0?midPrizes/epr:0;var pMidPack=midLambda>0?1-Math.exp(-midLambda):0;var midPacks=Math.round(epr*pMidPack);
  var profitGap=cost-a.floorEV;var midEVPerPack=0;for(i=0;i<tiers.length;i++){if(tiers[i].isMid)midEVPerPack+=tiers[i].a*tiers[i].ratio;}
  var pNoMid=Math.exp(-midLambda);var floorOnlyPacks=Math.round(epr*pNoMid*(1-jackpotPacks/epr));var floorMidPacks=epr-floorOnlyPacks-jackpotPacks;if(floorMidPacks<0)floorMidPacks=0;
  var totalRemValue=0;for(i=0;i<tiers.length;i++)totalRemValue+=tiers[i].a*tiers[i].rem;var avgPackValue=epr>0?totalRemValue/epr:0;var totalRemCost=epr*cost;
  var packCats=[];
  for(i=0;i<jackpotTierDetails.length;i++){var jd=jackpotTierDetails[i];packCats.push({label:"Contains $"+fN(jd.a)+" ("+jd.cat+")",count:jd.rem,pct:jd.pctOfRemaining,color:jd.cat==="TOP"?"#d4a017":jd.cat==="TOP-1"?"#af7ac5":"#5a6a7a",isJackpot:true,prizeAmt:jd.a});}
  packCats.push({label:"Mid-tier prize (no jackpot)",count:Math.max(0,floorMidPacks),pct:epr>0?Math.max(0,floorMidPacks)/epr:0,color:"#3498db",isJackpot:false,prizeAmt:0});
  packCats.push({label:"Floor only ($"+fN(a.floorEV)+")",count:Math.max(0,floorOnlyPacks),pct:epr>0?Math.max(0,floorOnlyPacks)/epr:0,color:"#5a6a7a",isJackpot:false,prizeAmt:0});
  return{valid:true,epr:epr,cost:cost,floor:a.floorEV,totalRemValue:totalRemValue,totalRemCost:totalRemCost,avgPackValue:avgPackValue,jackpotPacks:jackpotPacks,jackpotPct:epr>0?jackpotPacks/epr:0,midPacks:midPacks,midPct:epr>0?midPacks/epr:0,floorOnlyPacks:floorOnlyPacks,floorOnlyPct:epr>0?floorOnlyPacks/epr:0,jackpotTierDetails:jackpotTierDetails,packCats:packCats,tiers:tiers,mat:a.mat};
}

// === TREND TRACKING ===
function saveTrend(){if(!S.data.length)return;var d=new Date().toISOString().slice(0,10);var t=JSON.parse(localStorage.getItem("txt7")||"{}");S.data.forEach(function(a){if(!a.complete)return;var k=a.g.id;if(!t[k])t[k]=[];if(t[k].length>0&&t[k][t[k].length-1].d===d)return;t[k].push({d:d,sc:a.sc,jd:a.jackpotDensityShift,jr:a.jackpotTiers.reduce(function(s,x){return s+x.rem},0),mat:a.mat,tpr:a.tpr});if(t[k].length>60)t[k]=t[k].slice(-60);});localStorage.setItem("txt7",JSON.stringify(t));}
function getTrend(id){return(JSON.parse(localStorage.getItem("txt7")||"{}"))[id]||[];}
function sparkline(data,field,h){if(!data||data.length<2)return"";h=h||20;var v=data.map(function(d){return d[field]||0}),mn=Math.min.apply(null,v),mx=Math.max.apply(null,v),rng=mx-mn||1;var o='<span class="spark">';for(var i=0;i<v.length;i++){var bh=Math.max(2,Math.round(((v[i]-mn)/rng)*h));o+='<span class="spark-bar" style="height:'+bh+'px;background:'+(i===v.length-1?"var(--grn)":"var(--dim)")+'"></span>';}return o+'</span>';}

function computeBurnRate(id,a){var trend=getTrend(id);if(!trend||trend.length<2||!a.pc||a.pc<=0)return null;var pairs=[];for(var i=trend.length-1;i>=1;i--){var cur=trend[i],prev=trend[i-1];if(!cur.mat||!prev.mat||cur.mat===prev.mat)continue;if(!cur.d||!prev.d||cur.d===prev.d)continue;var days=Math.max(1,Math.round((new Date(cur.d)-new Date(prev.d))/86400000));var deltaMat=cur.mat-prev.mat;if(deltaMat<=0)continue;var ppd=Math.round((deltaMat*a.pc)/days);pairs.push({packsPerDay:ppd,days:days});if(pairs.length>=3)break;}if(!pairs.length)return null;var avgPpd=Math.round(pairs.reduce(function(s,p){return s+p.packsPerDay;},0)/pairs.length);if(avgPpd<=0)return null;var daysLeft=a.epr>0?Math.round(a.epr/avgPpd):null;var milestones=[],currentMat=a.mat||0;[0.15,0.20,0.30,0.50,0.75,1.0].forEach(function(tgt){if(tgt<=currentMat)return;var daysToTgt=Math.round(((tgt-currentMat)*a.pc)/avgPpd);var etaDate=new Date();etaDate.setDate(etaDate.getDate()+daysToTgt);milestones.push({pct:tgt,days:daysToTgt,label:etaDate.toLocaleString('default',{month:'short'})+' '+etaDate.getDate()});});return{packsPerDay:avgPpd,dollarsPerDay:avgPpd*(a.packPrice||0),daysLeft:daysLeft,milestones:milestones,snapshots:pairs.length,reliable:pairs.length>=2};}

function buildWinnerModel(winData,gameData){if(!winData||!gameData||!gameData.length)return{valid:false};var groups={};gameData.forEach(function(g){var gn=String(g.gn),recs=winData[gn];if(!recs||!recs.length||!g.tot||!g.pk||!g.pr)return;var totalPacks=Math.round(g.tot/g.pk);if(totalPacks<=0)return;var pz=g.pz?g.pz.slice().sort(function(a,b){return b.a-a.a}):[];if(!pz.length)return;var topAmt=pz[0].a,top1Amt=pz.length>1?pz[1].a:0;var btpAmt=0;for(var i=pz.length-1;i>=0;i--){if(pz[i].p/totalPacks>=0.3&&pz[i].a>btpAmt)btpAmt=pz[i].a;}var jkCount=0;for(var j=0;j<pz.length;j++){if(pz[j].a>btpAmt)jkCount++;}var jkGapRatio=top1Amt>0?topAmt/top1Amt:99;var priceTier=g.pr<=5?'low':g.pr<=20?'mid':g.pr<=50?'high':'premium';var jkBucket=jkCount<=1?'single':jkCount<=3?'few':jkCount<=8?'multi':'mega';var gapBucket=jkGapRatio<1.5?'tight':jkGapRatio<4?'moderate':'wide';var key=priceTier+'_'+jkBucket+'_'+gapBucket;if(!groups[key])groups[key]={key:key,priceTier:priceTier,jkBucket:jkBucket,gapBucket:gapBucket,games:[],positions:[],jkGapRatios:[],topAmts:[],jkCounts:[]};var grp=groups[key];grp.games.push(gn);grp.jkGapRatios.push(jkGapRatio);grp.topAmts.push(topAmt);grp.jkCounts.push(jkCount);recs.forEach(function(r){if(!r.pn||r.pn<=0)return;var pos=(r.pn/totalPacks)*100;if(pos<0||pos>110)return;grp.positions.push({pos:Math.min(pos,100),pn:r.pn,gn:gn,totalPacks:totalPacks});});});Object.keys(groups).forEach(function(key){var grp=groups[key];if(grp.positions.length<3){grp.valid=false;return;}grp.valid=true;var pos=grp.positions.map(function(p){return p.pos;}).sort(function(a,b){return a-b;});var n=pos.length;grp.deciles=[];for(var d=0;d<10;d++){var lo=d*10,hi=(d+1)*10,cnt=pos.filter(function(p){return p>=lo&&p<hi;}).length;grp.deciles.push({lo:lo,hi:hi,cnt:cnt,density:n>0?cnt/n:0});}grp.p10=pos[Math.floor(n*0.10)]||0;grp.p25=pos[Math.floor(n*0.25)]||0;grp.p50=pos[Math.floor(n*0.50)]||0;grp.p75=pos[Math.floor(n*0.75)]||0;grp.p90=pos[Math.floor(n*0.90)]||0;grp.mean=pos.reduce(function(s,v){return s+v;},0)/n;grp.recommendedMinPct=15;grp.recommendedMaxPct=85;grp.sampleSize=n;grp.gameCount=grp.games.length;});return{valid:true,groups:groups};}

function getPackGuidance(g,a,model){if(!model||!model.valid||!a.pc||a.pc<=0)return{valid:false,reason:'No winner model'};var pz=g.pz?g.pz.slice().sort(function(ax,b){return b.a-ax.a;}):[];if(!pz.length)return{valid:false,reason:'No prize data'};var totalPacks=a.pc,topAmt=pz[0].a,top1Amt=pz.length>1?pz[1].a:0;var jkGapRatio=top1Amt>0?topAmt/top1Amt:99;var btpAmt=0;for(var i=pz.length-1;i>=0;i--){if(pz[i].p/totalPacks>=0.3&&pz[i].a>btpAmt)btpAmt=pz[i].a;}var jkCount=0;for(var j=0;j<pz.length;j++){if(pz[j].a>btpAmt)jkCount++;}var priceTier=g.pr<=5?'low':g.pr<=20?'mid':g.pr<=50?'high':'premium';var jkBucket=jkCount<=1?'single':jkCount<=3?'few':jkCount<=8?'multi':'mega';var gapBucket=jkGapRatio<1.5?'tight':jkGapRatio<4?'moderate':'wide';var key=priceTier+'_'+jkBucket+'_'+gapBucket;var grp=model.groups[key],usedFallback=false,fallbackReason='';if(!grp||!grp.valid){var f1=Object.keys(model.groups).filter(function(k){return k.indexOf(priceTier+'_'+jkBucket)===0&&model.groups[k].valid;}).sort(function(a2,b){return model.groups[b].sampleSize-model.groups[a2].sampleSize;});if(f1.length){grp=model.groups[f1[0]];usedFallback=true;fallbackReason='Gap relaxed';}}if(!grp||!grp.valid){var f2=Object.keys(model.groups).filter(function(k){return k.indexOf(priceTier)===0&&model.groups[k].valid;}).sort(function(a2,b){return model.groups[b].sampleSize-model.groups[a2].sampleSize;});if(f2.length){grp=model.groups[f2[0]];usedFallback=true;fallbackReason='Price tier only';}}if(!grp||!grp.valid)return{valid:false,reason:'No matching cluster'};var currentSoldPct=(a.mat||0)*100;var minPct=Math.max(currentSoldPct,grp.recommendedMinPct),maxPct=grp.recommendedMaxPct;var minPackNum=Math.round((minPct/100)*totalPacks),maxPackNum=Math.round((maxPct/100)*totalPacks);var lastWinnerPack=0;if(S.winData){var wd=S.winData[String(g.gn)];if(wd&&wd.length)lastWinnerPack=Math.max.apply(null,wd.map(function(r){return r.pn||0;}));}if(lastWinnerPack>minPackNum)minPackNum=lastWinnerPack+1;var remainingJkPrizes=a.jackpotTiers?a.jackpotTiers.reduce(function(s,t){return s+t.rem;},0):0;var zones=[];if(remainingJkPrizes>0&&a.epr>0){var startPack=Math.round(a.mat*totalPacks),zoneSize=Math.round(a.epr/Math.max(1,remainingJkPrizes));for(var z=0;z<Math.min(remainingJkPrizes,12);z++){var zStart=startPack+z*zoneSize,zEnd=zStart+zoneSize-1;zones.push({zone:z+1,start:zStart,end:zEnd,mid:Math.round((zStart+zEnd)/2),isRecommended:zStart>=minPackNum&&zStart<=maxPackNum});}}var gapNarrative='Prizes are distributed uniformly across the print run (confirmed by 11,000+ winner analysis). Gap: '+jkGapRatio.toFixed(1)+'x ('+fmt(topAmt)+' vs '+fmt(top1Amt)+'). Focus on density and probability, not pack numbers.';var specificAdvice='Any available pack has equal odds. '+fN(remainingJkPrizes)+' jackpot prizes in '+fN(a.epr)+' remaining packs.';if(lastWinnerPack>0)specificAdvice+=' Last claim: pack #'+fN(lastWinnerPack)+'.';return{valid:true,clusterKey:grp.key,clusterSize:grp.sampleSize,clusterGames:grp.gameCount,priceTier:priceTier,jkBucket:jkBucket,gapBucket:gapBucket,gapRatio:jkGapRatio,recommendedMinPct:minPct,recommendedMaxPct:maxPct,minPackNum:minPackNum,maxPackNum:maxPackNum,gapNarrative:gapNarrative,specificAdvice:specificAdvice,zones:zones,remainingJkPrizes:remainingJkPrizes,lastWinnerPack:lastWinnerPack,p25:grp.p25,p50:grp.p50,p75:grp.p75,p90:grp.p90,deciles:grp.deciles,usedFallback:usedFallback,fallbackReason:fallbackReason};}

function estimateClaimDelay(prizeAmt){if(prizeAmt<=599)return{minDays:0,maxDays:1,avgDays:0.3,method:'Retail (instant)',mobileImpact:false};if(prizeAmt<=2499)return{minDays:1,maxDays:5,avgDays:2,method:'App/Office',mobileImpact:true,mobileAvg:1.2};if(prizeAmt<=9999)return{minDays:2,maxDays:10,avgDays:5,method:'Regional office',mobileImpact:true,mobileAvg:3};return{minDays:3,maxDays:21,avgDays:10,method:'Austin HQ',mobileImpact:true,mobileAvg:6};}
function adjustedClaimLag(rawLag,prizeAmt,burnRate){var delay=estimateClaimDelay(prizeAmt);if(!delay.mobileImpact||!burnRate||!burnRate.packsPerDay)return rawLag;return rawLag*(prizeAmt<=599?1.0:prizeAmt<=2499?0.85:prizeAmt<=9999?0.70:0.55);}

function classifyArchetype(a){if(!a.complete)return{type:'unknown',label:'Unknown',color:'var(--dim)',desc:'Incomplete data.'};var g=a.g,jkTotal=a.jackpotTiers?a.jackpotTiers.reduce(function(s,t){return s+t.printed},0):0,topAmt=a.tp?a.tp.a:0;if(g.pr>=50&&topAmt>=500000)return{type:'premium-hunt',label:'Premium Hunt',color:'#5b2c6f',desc:'High-cost, massive jackpot.'};if(g.pr>=20&&topAmt>=50000&&jkTotal<=10)return{type:'slow-unicorn',label:'Slow Unicorn',color:'#af7ac5',desc:'Rare top prizes, slow claims.'};if(g.pr<=5&&jkTotal>=20)return{type:'fast-burner',label:'Fast Burner',color:'#e74c3c',desc:'Many small jackpots, fast burn.'};if(g.pr<=5&&jkTotal<20&&topAmt<=5000)return{type:'casual',label:'Casual',color:'#3498db',desc:'Low stakes, modest prizes.'};if(g.pr>=10&&g.pr<=30&&jkTotal>=4&&jkTotal<=15)return{type:'grinder',label:'Grinder',color:'#f39c12',desc:'Mid-range, steady prize flow.'};return{type:'standard',label:'Standard',color:'var(--dim)',desc:'Typical structure.'};}

function computeJackpotTimeline(a,burn){if(!a.complete||!a.epr||a.epr<=0)return{valid:false};var jkTiers=a.jackpotShifts||[];if(!jkTiers.length)return{valid:false};var ppd=burn?burn.packsPerDay:0;var timeline=[];jkTiers.forEach(function(jt){if(jt.remaining<=0){timeline.push({a:jt.a,role:jt.role,remaining:0,gone:true});return;}var N=a.epr,K=jt.remaining;var targets=[{pct:0.25,label:'25%'},{pct:0.50,label:'50%'},{pct:0.75,label:'75%'},{pct:0.90,label:'90%'}];var packsFor=[];targets.forEach(function(tgt){var lo2=1,hi2=N,best=N;while(lo2<=hi2){var mid3=(lo2+hi2)>>1;var ph=1-Math.exp(logC(N-K,mid3)-logC(N,mid3));if(ph>=tgt.pct){best=mid3;hi2=mid3-1;}else lo2=mid3+1;}var dn=ppd>0?Math.round(best/ppd):null,eta=null;if(dn!==null){eta=new Date();eta.setDate(eta.getDate()+dn);}packsFor.push({conf:tgt.pct,confLabel:tgt.label,packs:best,days:dn,eta:eta?eta.toLocaleString('default',{month:'short'})+' '+eta.getDate():null});});var cd=estimateClaimDelay(jt.a);var pPack=N>0&&K>0?1-Math.exp(logC(N-K,1)-logC(N,1)):0;timeline.push({a:jt.a,role:jt.role,remaining:jt.remaining,printed:jt.printed,pPerPack:pPack,packsFor:packsFor,claimDelay:cd,densityShift:jt.shift,signal:jt.signal,gone:false});});return{valid:true,timeline:timeline,hasBurn:ppd>0,ppd:ppd};}

function claimVelocity(id,a){if(!a.jackpotTiers||!a.jackpotTiers.length)return null;var trend=getTrend(id);if(!trend||trend.length<2)return null;var pairs=[];for(var i=trend.length-1;i>=1;i--){var cur=trend[i],prev=trend[i-1];if(!cur.d||!prev.d||cur.d===prev.d)continue;if(cur.jr===undefined||prev.jr===undefined)continue;var days=Math.max(1,Math.round((new Date(cur.d)-new Date(prev.d))/86400000));var deltaJk=prev.jr-cur.jr;if(deltaJk<0)deltaJk=0;pairs.push({claimsPerDay:deltaJk/days,days:days});if(pairs.length>=5)break;}if(!pairs.length)return null;var avgCpd=pairs.reduce(function(s,p){return s+p.claimsPerDay;},0)/pairs.length;var totalJkRem=a.jackpotTiers.reduce(function(s,t){return s+t.rem;},0);var daysToDepletion=avgCpd>0?Math.round(totalJkRem/avgCpd):null;return{claimsPerDay:avgCpd,daysToDepletion:daysToDepletion,totalRemaining:totalJkRem,snapshots:pairs.length,reliable:pairs.length>=2};}

function burnRateProjection(id,a){var burn=computeBurnRate(id,a);if(!burn||!burn.packsPerDay)return null;var cv=claimVelocity(id,a);var totalJkRem=a.jackpotTiers?a.jackpotTiers.reduce(function(s,t){return s+t.rem;},0):0;var result={packsPerDay:burn.packsPerDay,dollarsPerDay:burn.dollarsPerDay,daysLeft:burn.daysLeft,milestones:burn.milestones,reliable:burn.reliable,snapshots:burn.snapshots};if(totalJkRem>0&&a.epr>0){var density=totalJkRem/a.epr;var packsPerJk=density>0?Math.round(1/density):Infinity;var daysPerJk=burn.packsPerDay>0?Math.round(packsPerJk/burn.packsPerDay):null;result.jackpotETA={packsPerJackpot:packsPerJk,daysPerJackpot:daysPerJk,density:density,totalRemaining:totalJkRem};if(cv&&cv.claimsPerDay>0){result.jackpotETA.fromClaimVelocity={claimsPerDay:cv.claimsPerDay,daysToNext:Math.round(1/cv.claimsPerDay),daysToDepletion:cv.daysToDepletion};}result.jackpotETA.tiers=[];if(a.jackpotShifts){a.jackpotShifts.forEach(function(j){if(j.remaining<=0)return;var tierDensity=a.epr>0?j.remaining/a.epr:0;var tierPacksPer=tierDensity>0?Math.round(1/tierDensity):Infinity;var tierDaysPer=burn.packsPerDay>0?Math.round(tierPacksPer/burn.packsPerDay):null;var delay=estimateClaimDelay(j.a);var N=a.epr,K=j.remaining;var lo2=1,hi2=N,p50packs=N;while(lo2<=hi2){var mid3=(lo2+hi2)>>1;var ph=1-Math.exp(logC(N-K,mid3)-logC(N,mid3));if(ph>=0.5){p50packs=mid3;hi2=mid3-1;}else lo2=mid3+1;}var lo3=1,hi3=N,p25packs=N;while(lo3<=hi3){var mid4=(lo3+hi3)>>1;var ph2=1-Math.exp(logC(N-K,mid4)-logC(N,mid4));if(ph2>=0.25){p25packs=mid4;hi3=mid4-1;}else lo3=mid4+1;}result.jackpotETA.tiers.push({amount:j.a,role:j.role,remaining:j.remaining,packsPerHit:tierPacksPer,daysPerHit:tierDaysPer,claimDelay:delay,p50packs:p50packs,p25packs:p25packs,p50days:burn.packsPerDay>0?Math.round(p50packs/burn.packsPerDay):null});});}}return result;}

// ============================================================
// v7.4: PRIZE CLASS + SIMILARITY + VARIANCE MODEL
// ============================================================

// v7.4: Classify game prize class
// high (top > $1000): sparse rare winners â€” target for jackpot hunting
// low (top <= $1000): thousands of "winners" â€” NOT jackpot targets, data not mixed
function classifyPrizeClass(g){if(!g||!g.pz||!g.pz.length)return'unknown';var pz=g.pz.slice().sort(function(a,b){return b.a-a.a});return pz[0].a>1000?'high':'low';}

// v7.4: Compute similarity between two games (0-1 scale)
// Only for SAME prize class (hard filter applied before calling)
function computeSimilarity(gA,gB){
  if(!gA||!gB||!gA.pz||!gB.pz)return 0;
  var pzA=gA.pz.slice().sort(function(a,b){return b.a-a.a});var pzB=gB.pz.slice().sort(function(a,b){return b.a-a.a});
  var pcA=gA.tot>0&&gA.pk>0?Math.round(gA.tot/gA.pk):0;var pcB=gB.tot>0&&gB.pk>0?Math.round(gB.tot/gB.pk):0;
  if(!pcA||!pcB)return 0;
  var priceRatio=Math.min(gA.pr,gB.pr)/Math.max(gA.pr,gB.pr); // 0.20
  var packRatio=Math.min(pcA,pcB)/Math.max(pcA,pcB); // 0.15
  var topA=pzA[0].a,topB=pzB[0].a;var topRatio=Math.min(topA,topB)/Math.max(topA,topB); // 0.20
  var btpA=0,btpB=0;for(var i=pzA.length-1;i>=0;i--){if(pzA[i].p/pcA>=0.3&&pzA[i].a>btpA)btpA=pzA[i].a;}for(var j=pzB.length-1;j>=0;j--){if(pzB[j].p/pcB>=0.3&&pzB[j].a>btpB)btpB=pzB[j].a;}
  var jkA=0,jkB=0;for(i=0;i<pzA.length;i++){if(pzA[i].a>btpA)jkA++;}for(j=0;j<pzB.length;j++){if(pzB[j].a>btpB)jkB++;}
  var jkSim=jkA>0&&jkB>0?1-Math.abs(jkA-jkB)/Math.max(jkA,jkB):0; // 0.15
  var tierSim=1-Math.abs(pzA.length-pzB.length)/Math.max(pzA.length,pzB.length); // 0.10
  var topDensA=pcA>0?pzA[0].p/pcA:0;var topDensB=pcB>0?pzB[0].p/pcB:0;
  var densSim=(topDensA>0&&topDensB>0)?Math.min(topDensA,topDensB)/Math.max(topDensA,topDensB):0; // 0.20
  return priceRatio*0.20+packRatio*0.15+topRatio*0.20+jkSim*0.15+tierSim*0.10+densSim*0.20;
}

// v7.4: Find K most similar games with winner data (same prize class)
function findSimilarGames(targetGame,allGames,winData,K){
  K=K||5;if(!targetGame||!allGames||!winData)return[];
  var targetClass=classifyPrizeClass(targetGame);var candidates=[];
  for(var i=0;i<allGames.length;i++){var g=allGames[i];if(String(g.gn)===String(targetGame.gn))continue;if(classifyPrizeClass(g)!==targetClass)continue;var gn=String(g.gn);var recs=winData[gn];if(!recs||recs.length<3)continue;var sim=computeSimilarity(targetGame,g);if(sim<0.3)continue;candidates.push({game:g,gn:gn,similarity:sim,winnerCount:recs.length});}
  candidates.sort(function(a,b){return b.similarity-a.similarity});return candidates.slice(0,K);
}

// v7.4: Build variance model from similar games' actual winner gaps
function buildVarianceModel(similarGames,winData){
  if(!similarGames||!similarGames.length||!winData)return{valid:false,reason:'No similar games'};
  var allNormGaps=[],gameStats=[];
  for(var i=0;i<similarGames.length;i++){var sg=similarGames[i];var recs=winData[sg.gn];if(!recs||recs.length<3)continue;var g=sg.game;var totalPacks=g.tot>0&&g.pk>0?Math.round(g.tot/g.pk):0;if(totalPacks<=0)continue;
    var pns=[];for(var j=0;j<recs.length;j++){if(recs[j].pn&&recs[j].pn>0)pns.push(recs[j].pn);}pns.sort(function(a,b){return a-b});if(pns.length<3)continue;
    var gaps=[];for(j=0;j<pns.length-1;j++){var gap=pns[j+1]-pns[j];gaps.push(gap);allNormGaps.push(gap/totalPacks);}
    var avgGap=gaps.reduce(function(s,v){return s+v},0)/gaps.length;var variance=0;for(j=0;j<gaps.length;j++)variance+=Math.pow(gaps[j]-avgGap,2);var stddev=gaps.length>1?Math.sqrt(variance/(gaps.length-1)):0;var cv=avgGap>0?stddev/avgGap:0;
    gameStats.push({gn:sg.gn,similarity:sg.similarity,gaps:gaps.length,avgGap:avgGap,stddev:stddev,cv:cv,totalPacks:totalPacks,winnerCount:pns.length});}
  if(!allNormGaps.length)return{valid:false,reason:'No gap data from similar games'};
  allNormGaps.sort(function(a,b){return a-b});var n=allNormGaps.length;
  var totalWeight=0,weightedCV=0;for(i=0;i<gameStats.length;i++){var w=similarGames[i]?similarGames[i].similarity:0.5;weightedCV+=gameStats[i].cv*w;totalWeight+=w;}
  var avgCV=totalWeight>0?weightedCV/totalWeight:0.5;
  var sampleScore=Math.min(1,n/30);var simScore=similarGames.length>0?similarGames.reduce(function(s,g2){return s+g2.similarity},0)/similarGames.length:0;var cvConsistency=1-Math.min(1,avgCV);
  var confidenceScore=Math.round((sampleScore*0.4+simScore*0.3+cvConsistency*0.3)*100);
  var bandMultiplier=avgCV<0.3?0.25:avgCV<0.5?0.35:avgCV<0.8?0.45:0.55;
  return{valid:true,gamesUsed:gameStats.length,totalGaps:n,avgCV:avgCV,bandMultiplier:bandMultiplier,confidenceScore:confidenceScore,confLabel:confidenceScore>=75?'HIGH':confidenceScore>=50?'MODERATE':confidenceScore>=30?'LOW':'MINIMAL',gameStats:gameStats,p10:allNormGaps[Math.floor(n*0.10)]||0,p25:allNormGaps[Math.floor(n*0.25)]||0,p50:allNormGaps[Math.floor(n*0.50)]||0,p75:allNormGaps[Math.floor(n*0.75)]||0,p90:allNormGaps[Math.floor(n*0.90)]||0};
}

// v7.4: JACKPOT PACK PREDICTIONS (Uniform + Similarity Variance)
function predictJackpotPacks(g,a,model){
  if(!a.pc||a.pc<=0)return{valid:false,reason:'No pack count'};
  var totalPacks=a.pc,soldPacks=Math.round((a.mat||0)*totalPacks),epr=a.epr||0;
  var slots=[];
  if(a.jackpotTiers&&a.jackpotTiers.length){a.jackpotTiers.slice().sort(function(x,y){return y.a-x.a}).forEach(function(t){for(var i=0;i<t.rem;i++)slots.push({prizeAmt:t.a,role:t===a.jackpotTiers[0]?'TOP':'TOP-1'});});}
  if(!slots.length)return{valid:false,reason:'No remaining jackpot prizes'};
  var n=slots.length,packsPerPrize=epr>0?Math.round(epr/n):0,tooSparse=packsPerPrize>50000;
  var startPack=soldPacks,lastWinnerPack=0;
  if(S.winData){var wd=S.winData[String(g.gn)];if(wd&&wd.length)lastWinnerPack=Math.max.apply(null,wd.map(function(r){return r.pn||0;}));}
  if(lastWinnerPack>startPack)startPack=lastWinnerPack;
  var runLength=Math.max(1,totalPacks-startPack),segSize=Math.max(1,Math.round(runLength/(n+1)));
  // v7.4: Similarity-based variance
  var prizeClass=classifyPrizeClass(g);var simGames=[];var varianceModel={valid:false};
  if(prizeClass==='high'&&S.winData&&GD.length>0){simGames=findSimilarGames(g,GD,S.winData,7);if(simGames.length>=2){varianceModel=buildVarianceModel(simGames,S.winData);}}
  var predictions=[];
  for(var s=0;s<n;s++){
    var basePack=startPack+segSize*(s+1);if(s>0&&basePack<=predictions[s-1].predictedPack)basePack=predictions[s-1].predictedPack+Math.max(1,Math.round(segSize*0.5));basePack=Math.min(basePack,totalPacks-(n-s));basePack=Math.max(basePack,startPack+1);
    var margin;if(varianceModel.valid){margin=Math.max(Math.round(epr*0.03),Math.round(segSize*varianceModel.bandMultiplier));}else{margin=Math.max(Math.round(epr*0.05),Math.round(segSize*0.35));}
    var cd=estimateClaimDelay(slots[s].prizeAmt);predictions.push({predictedPack:basePack,rangeLow:Math.max(startPack+1,basePack-margin),rangeHigh:Math.min(totalPacks,basePack+margin),marginPacks:margin,prizeAmt:slots[s].prizeAmt,role:slots[s].role,claimDelay:cd});
  }
  var tierProbs=[];
  if(a.jackpotTiers)a.jackpotTiers.forEach(function(jt){if(jt.rem<=0)return;var N=epr,K=jt.rem;var pPack=N>0?1-Math.exp(logC(N-K,1)-logC(N,1)):0;var lo2=1,hi2=N,p50packs=N;while(lo2<=hi2){var mid3=(lo2+hi2)>>1;var ph=1-Math.exp(logC(N-K,mid3)-logC(N,mid3));if(ph>=0.5){p50packs=mid3;hi2=mid3-1;}else lo2=mid3+1;}tierProbs.push({a:jt.a,role:jt.role||'',rem:jt.remaining,pPerPack:pPack,packsFor50:p50packs,claimDelay:estimateClaimDelay(jt.a)});});
  predictions.sort(function(x,y){return x.predictedPack-y.predictedPack});
  return{valid:true,predictions:predictions,tierProbs:tierProbs,lastWinnerPack:lastWinnerPack,startPack:startPack,totalPacks:totalPacks,soldPacks:soldPacks,tooSparse:tooSparse,packsPerPrize:packsPerPrize,prizeClass:prizeClass,model:varianceModel.valid?'similarity':'uniform',similarGames:simGames.length,varianceModel:varianceModel,confidenceScore:varianceModel.valid?varianceModel.confidenceScore:0,confLabel:varianceModel.valid?varianceModel.confLabel:'UNIFORM',note:varianceModel.valid?'Variance from '+varianceModel.gamesUsed+' similar games ('+varianceModel.totalGaps+' gaps, avg CV='+varianceModel.avgCV.toFixed(2)+').':(prizeClass==='low'?'Low-value game (top \u22641K) \u2014 winner data not used for prediction.':'Uniform distribution (no similar game matches).')};
}

// === STATE ===
var S={tab:"picks",selId:null,sortBy:"score",filterPr:"all",data:[],moreTab:"pack",
  pack:{log:[],won:0,spent:0,af:false,pr:10,pk:50,nm:"",aa:100,ew:13},
  sessions:JSON.parse(localStorage.getItem("txs7")||"[]"),
  _promptPreview:null,_allPromptPreview:null,_promptMsg:null,
  bankroll:Number(localStorage.getItem("txb7")||"1000"),
  detailSearch:"",insightFilter:null,
  winSearch:"",winSort:"date",winSortDir:-1,winGame:"",winModel:{valid:false},predExpand:false,prizeFilter:"all",prizeSortCol:"a",prizeSortDir:-1,timelineExpand:false};

function applyStatScoring(data){
  if(!data||data.length===0)return;
  var scorable=data.filter(function(a){return a.btpInfo.hasJackpot&&a.complete});
  if(scorable.length<2){data.forEach(function(a){a.rank=1;a.rankOf=data.length;a.confidence=50;a.confLabel="AVERAGE";a.sc=a.rawSc;});return;}
  var sum=0;for(var i=0;i<scorable.length;i++)sum+=scorable[i].rawSc;var mean=sum/scorable.length;
  var variance=0;for(i=0;i<scorable.length;i++)variance+=Math.pow(scorable[i].rawSc-mean,2);var stddev=Math.sqrt(variance/scorable.length);if(stddev<1)stddev=1;
  scorable.sort(function(a,b){return b.rawSc-a.rawSc});
  scorable.forEach(function(a,idx){a.rank=idx+1;a.rankOf=scorable.length;a.sc=a.rawSc;var z=(a.rawSc-mean)/stddev;a.zScore=z;a.confidence=Math.round(Math.max(0,Math.min(100,z*25+50)));if(a.confidence>=85)a.confLabel="STANDOUT";else if(a.confidence>=70)a.confLabel="ABOVE FIELD";else if(a.confidence>=50)a.confLabel="AVERAGE";else if(a.confidence>=30)a.confLabel="BELOW FIELD";else a.confLabel="WEAK";});
  var maxRank=scorable.length;data.forEach(function(a){if(a.btpInfo.hasJackpot&&a.complete)return;a.sc=a.rawSc;a.rank=maxRank+1;a.rankOf=data.length;a.zScore=0;a.confidence=0;a.confLabel=a.btpInfo.hasJackpot?"INCOMPLETE":"NO TOP TIERS";});
}

function init(){try{var c=localStorage.getItem("txr_gd7");if(c){GD=JSON.parse(c);if(GD.length){S.data=GD.map(function(g){return analyze(g)});applyStatScoring(S.data);}}var wd=localStorage.getItem("txwd7");if(wd){S.winData=JSON.parse(wd);S.winModel=buildWinnerModel(S.winData,GD);}}catch(e){}DD=localStorage.getItem("txr_date7")||"";render();refreshAllData();}
function setTab(t){S.tab=t;S.insightFilter=null;render()}
function setMore(t){S.moreTab=t;render()}
function setFilter(p){S.filterPr=p;render()}
function setSort(s){S.sortBy=s;render()}
function openDetail(id){S.selId=id;S.tab="detail";render()}
function setSel(id){S.selId=id;render()}
function setInsightFilter(f){S.insightFilter=S.insightFilter===f?null:f;S.tab="picks";render()}
function detailSearchInput(v){S.detailSearch=v;render()}
function winSearchInput(v){S.winSearch=v;render()}
function winSortBy(col){if(S.winSort===col)S.winSortDir*=-1;else{S.winSort=col;S.winSortDir=-1;}render()}
function winGameFilter(gn){S.winGame=gn;render()}
function togglePred(){S.predExpand=!S.predExpand;render()}
function toggleTimeline(){S.timelineExpand=!S.timelineExpand;render()}
function setPrizeFilter(v){S.prizeFilter=v;render()}
function sortPrizeCol(col){if(S.prizeSortCol===col)S.prizeSortDir*=-1;else{S.prizeSortCol=col;S.prizeSortDir=-1;}render()}

var DATA_URL="data/feed.json";
var WINNER_URL="data/wdata.json";

async function refreshAllData(){if(S._refreshing)return;S._refreshing=true;S._refreshMsg="Fetching...";render();try{var resp=await fetch(DATA_URL);if(!resp.ok)throw new Error("HTTP "+resp.status);var json=await resp.json();if(json&&json.games&&json.games.length>0){GD=[];json.games.forEach(function(ng){if(!ng.pz||!ng.pz.length||!ng.pr||ng.pr<=0)return;ng.id=String(ng.gn);ng.pz.sort(function(a,b){return b.a-a.a});GD.push(ng);});S.data=GD.map(function(g){return analyze(g)});applyStatScoring(S.data);if(S.winData)S.winModel=buildWinnerModel(S.winData,GD);DD=json.updated||"";localStorage.setItem("txr_date7",DD);localStorage.setItem("txr_gd7",JSON.stringify(GD));saveTrend();var comp=S.data.filter(function(a){return a.complete}).length;var jk=S.data.filter(function(a){return a.btpInfo.hasJackpot}).length;S._refreshMsg="Loaded "+GD.length+" games ("+comp+" complete, "+jk+" with jackpot). Data: "+DD;}else{S._refreshMsg="No data. Run scraper.";}}catch(e){S._refreshMsg="Failed: "+e.message;}S._refreshing=false;render();}
async function fetchWinners(){if(S._fetching)return;S._fetching=true;render();if(!S.winData)S.winData={};try{var r=await fetch(WINNER_URL);if(r.ok){var j=await r.json();if(j&&j.winners){S.winData=j.winners;localStorage.setItem("txwd7",JSON.stringify(S.winData));}}}catch(e){}S._fetching=false;render();}

function scratch(amt){var pk=S.pack;pk.log.push({amt:amt,w:amt>0});pk.won+=amt;pk.spent+=pk.pr;pk.af=pk.af||amt>=pk.aa;render()}
function resetPack(){S.pack.log=[];S.pack.won=0;S.pack.spent=0;S.pack.af=false;render()}
function saveSession(){if(!S.pack.log.length)return;S.sessions.push({g:S.pack.nm,s:S.pack.spent,w:S.pack.won,t:S.pack.log.length,d:new Date().toLocaleDateString(),af:S.pack.af});localStorage.setItem("txs7",JSON.stringify(S.sessions));resetPack()}
function clearSess(){S.sessions=[];localStorage.setItem("txs7","[]");render()}
function setBR(v){S.bankroll=v;localStorage.setItem("txb7",String(v));render()}
function startPack(id){var a;for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===id){a=S.data[i];break}if(!a)return;S.pack={log:[],won:0,spent:0,af:false,pr:a.g.pr,pk:a.g.pk,nm:a.g.nm+' #'+a.g.gn,aa:a.aa,ew:Math.round(a.g.pk/a.g.odds)};S.tab="more";S.moreTab="pack";render()}
function mkv(){var pk=S.pack,rem=pk.pk-pk.log.length;if(rem<=0)return null;var wf=0;for(var i=0;i<pk.log.length;i++)if(pk.log[i].w)wf++;var wl=Math.max(0,pk.ew-wf),pW=wl/rem,pA=pk.af?0:1/rem;var dec="EARLY",rsn="Pack early â€” "+(pA*100).toFixed(1)+"% per ticket.";if(pk.af){dec="STOP";rsn="Anchor found.";}else if(pA>=0.15){dec="BUY";rsn=(pA*100).toFixed(1)+"% anchor chance. "+rem+" left.";}else if(pA>=0.05){dec="CONSIDER";rsn=(pA*100).toFixed(1)+"% per ticket.";}return{rem:rem,wl:wl,pW:pW,pA:pA,dec:dec,rsn:rsn}}

// === AI PROMPTS ===
function buildGamePrompt(a){
  var g=a.g,L=[];
  L.push("=== TX SCRATCH-OFF DEEP ANALYSIS v7.4 ===");
  L.push("Game: #"+g.gn+" "+g.nm+" ($"+g.pr+") | Prize Class: "+a.prizeClass.toUpperCase());
  L.push("Score: "+a.sc+" (#"+a.rank+"/"+a.rankOf+") | Conf: "+a.confidence+"% "+a.confLabel);
  L.push("Sold: "+pct(a.mat)+" | Packs left: "+fN(a.epr)+" | Markov: "+a.gm.sig.replace(/_/g," "));
  L.push("Floor: $"+fN(a.g.guar)+" | Pack: $"+fN(a.packPrice)+" | BTP: $"+fN(a.aa));
  var arch2=classifyArchetype(a);L.push("Archetype: "+arch2.label);
  if(g.cs)L.push("WARNING: GAME CLOSING");L.push("");
  L.push("--- TOP PRIZE TIERS ---");
  if(!a.jackpotShifts.length)L.push("No rare tiers.");
  else{a.jackpotShifts.forEach(function(j){L.push("$"+fN(j.a)+" ["+j.role+"]: "+j.remaining+"/"+j.printed+" | "+j.shift.toFixed(2)+"x "+j.signal+" | lag "+(j.claimLag>0?"+":"")+pct(j.claimLag)+" | 1:"+fN(j.currentOdds));});
    L.push("Wtd density: "+a.jackpotDensityShift.toFixed(2)+"x | P(top/pack): "+(a.hyperTopNow>=0.01?pct(a.hyperTopNow):"1:"+fN(Math.round(1/a.hyperTopNow)))+" ("+a.hyperTopRatio.toFixed(2)+"x)");
    L.push("JK EV: $"+a.jackpotEVRaw.toFixed(2)+" (was $"+a.jackpotEVLaunchRaw.toFixed(2)+")");}
  L.push("");L.push("--- EV ---");
  L.push("Floor $"+fN(a.floorEV)+" + Mid $"+a.midRangeEV.toFixed(0)+" + JK $"+a.jackpotEVRaw.toFixed(2)+" = $"+Math.round(a.totalEV)+" vs $"+fN(a.packPrice)+" ("+(a.edge>0?"+":"")+pct(a.edge)+")");
  if(a.returnGap!==0)L.push("Return gap: "+(a.returnGap>0?"+":"")+pct(a.returnGap));
  L.push("");L.push("--- SCORE ---");
  a.scoreBreakdown.forEach(function(s){L.push("  "+(s.p>=0?"+":"")+s.p+" "+s.f);});
  L.push("");L.push("--- PRIZES ---");
  a.prizes.forEach(function(p){L.push("$"+fN(p.a)+" "+p.cat+" "+fN(p.rem)+"/"+fN(p.p)+" "+(p.rem>0?fmtO(p.currO):"GONE"));});
  if(a.flags.length){L.push("");a.flags.forEach(function(f){L.push("["+f.t+"] "+f.m);});}
  // v7.4: similarity info
  var jpp=predictJackpotPacks(g,a,null);
  if(jpp.valid){L.push("");L.push("--- PREDICTION MODEL: "+jpp.model.toUpperCase()+" ---");
    L.push("Prize class: "+jpp.prizeClass+" | Similar games: "+jpp.similarGames);
    if(jpp.varianceModel&&jpp.varianceModel.valid)L.push("Variance: CV="+jpp.varianceModel.avgCV.toFixed(2)+" | Band: \u00b1"+Math.round(jpp.varianceModel.bandMultiplier*100)+"% | Conf: "+jpp.varianceModel.confidenceScore+"%");
    L.push(jpp.note);}
  L.push("\n1. Buy? YES/NO/MAYBE\n2. Top prize concentrated or noise?\n3. Break down $"+fN(a.packPrice)+" spend\n4. Red flags?");
  return L.join("\n");
}
function buildAllPrompt(){
  var tr=[];S.data.forEach(function(a){if(!a.complete||!a.btpInfo.hasJackpot)return;if(a.jackpotDensityShift>1.1||a.hyperRatio>1.1||a.returnGap>0.03||(a.g.cs&&a.tpr>0)||a.gm.sig==="BUY"||a.gm.sig==="STRONG_BUY"||a.gm.sig==="AVOID"||a.gm.sig==="DEAD"||a.returnGap<-0.03)tr.push(a);});
  if(!tr.length)return"No significant signals.";
  var L=[];L.push("=== TX SCRATCH-OFF PORTFOLIO v7.4 ===");L.push("Data: "+(DD||"?")+"\n");
  var buys=tr.filter(function(a){return a.confidence>=70});var watches=tr.filter(function(a){return a.confidence>=40&&a.confidence<70});var avoids=tr.filter(function(a){return a.confidence<40});
  if(buys.length){L.push("BUY (70%+):");buys.sort(function(a,b){return b.sc-a.sc}).forEach(function(a){L.push("  #"+a.g.gn+" "+a.g.nm+" $"+a.g.pr+" | "+a.sc+"pts "+a.confidence+"% | jkD:"+a.jackpotDensityShift.toFixed(2)+"x | top:"+a.tpr+"/"+a.tp.p+" | "+a.gm.sig);});L.push("");}
  if(watches.length){L.push("WATCH (40-69%):");watches.sort(function(a,b){return b.sc-a.sc}).forEach(function(a){L.push("  #"+a.g.gn+" "+a.g.nm+" $"+a.g.pr+" sc:"+a.sc+" jkD:"+a.jackpotDensityShift.toFixed(2)+"x "+a.gm.sig);});L.push("");}
  if(avoids.length){L.push("AVOID (<40%):");avoids.sort(function(a,b){return a.sc-b.sc}).forEach(function(a){L.push("  #"+a.g.gn+" "+a.g.nm+" $"+a.g.pr+" sc:"+a.sc+" "+a.gm.sig);});L.push("");}
  var byP={};tr.forEach(function(a){if(!byP[a.g.pr]||a.sc>byP[a.g.pr].sc)byP[a.g.pr]=a});
  L.push("BEST PER PRICE:");Object.keys(byP).sort(function(a,b){return Number(a)-Number(b)}).forEach(function(p){var a=byP[p];L.push("  $"+p+" > #"+a.g.gn+" "+a.g.nm+" ("+a.sc+"pts)");});
  L.push("\n1. Which 2-3 to buy today?\n2. Avoid?\n3. Top pick breakdown\n4. Data contradictions?");
  return L.join("\n");
}
function copyAIPrompt(id){var a=null;for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===id){a=S.data[i];break}if(!a)return;navigator.clipboard.writeText(buildGamePrompt(a)).then(function(){S._promptMsg="\u2713 Copied!";render();setTimeout(function(){S._promptMsg=null;render()},2500)})}
function showAIPrompt(id){var a=null;for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===id){a=S.data[i];break}if(!a)return;S._promptPreview=buildGamePrompt(a);render()}
function copyAllPrompt(){navigator.clipboard.writeText(buildAllPrompt()).then(function(){S._promptMsg="\u2713 Copied!";render();setTimeout(function(){S._promptMsg=null;render()},2500)})}
function showAllPrompt(){S._allPromptPreview=buildAllPrompt();render()}

// === RENDER ===
function render(){
  var pr={};GD.forEach(function(g){pr[g.pr]=1});var pArr=Object.keys(pr).map(Number).sort(function(a,b){return a-b});
  var f=S.data.slice();
  if(S.filterPr!=="all")f=f.filter(function(a){return a.g.pr===Number(S.filterPr)});
  if(S.insightFilter){var iF=S.insightFilter;if(iF==="top")f=f.filter(function(a){return a.btpInfo.hasJackpot});else if(iF==="buy")f=f.filter(function(a){return a.confidence>=70&&a.btpInfo.hasJackpot});else if(iF==="avoid")f=f.filter(function(a){return a.confidence<30&&a.btpInfo.hasJackpot});else if(iF==="closing")f=f.filter(function(a){return a.g.cs&&a.tpr>0&&a.btpInfo.hasJackpot});else if(iF==="new")f=f.filter(function(a){return a.mat<0.15&&a.complete&&a.btpInfo.hasJackpot});else if(iF==="concentrated")f=f.filter(function(a){return a.jackpotDensityShift>=1.3});else if(iF==="depleted")f=f.filter(function(a){return a.tpr===0&&a.btpInfo.hasJackpot});}
  var sorts={score:function(a,b){return b.sc-a.sc},density:function(a,b){return b.jackpotDensityShift-a.jackpotDensityShift},gap:function(a,b){return b.returnGap-a.returnGap},topOdds:function(a,b){return a.tpo-b.tpo},tickets:function(a,b){return a.mat-b.mat},hyper:function(a,b){return b.hyperRatio-a.hyperRatio},jackpotEV:function(a,b){return b.jackpotEV-a.jackpotEV}};
  f.sort(sorts[S.sortBy]||sorts.score);
  var sel=null;if(S.selId){for(var i=0;i<S.data.length;i++)if(S.data[i].g.id===S.selId){sel=S.data[i];break}}

  var o='<div class="H"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px"><div><h1>TX ENGINE v7.4</h1><div class="sub">'+GD.length+' games \xb7 Similarity + Variance Model \xb7 Jackpot focused'+(DD?' \xb7 '+esc(DD):'')+'</div></div>';
  o+='<div class="B'+(S._refreshing?"":" on")+'" onclick="refreshAllData()" style="font-size:10px;padding:6px 12px">'+(S._refreshing?'\u23f3...':'\u21bb REFRESH')+'</div></div>';
  if(S._refreshMsg)o+='<div style="font-size:10px;color:var(--blu);margin-top:4px">'+esc(S._refreshMsg)+'</div>';
  if(S._promptMsg)o+='<div style="font-size:11px;color:#2ecc71;margin-top:4px;font-weight:600">'+esc(S._promptMsg)+'</div>';
  o+='<div class="tabs">';
  [["picks","PICKS"],["detail","DETAIL"],["insights","INSIGHTS"],["winners","WINNERS"],["more","MORE"]].forEach(function(t){o+='<div class="T'+(S.tab===t[0]?" on":"")+'" onclick="setTab(\''+t[0]+'\')">'+t[1]+'</div>';});
  o+='</div></div>';

  if(GD.length===0){o+='<div class="C" style="text-align:center;padding:40px"><div style="font-size:18px;color:var(--amb)">No Data</div><div style="margin-top:8px">Run scraper \u2192 deploy feed.json \u2192 REFRESH</div></div>';document.getElementById("app").innerHTML=o;return;}

  // ==================== PICKS ====================
  if(S.tab==="picks"){
    if(S.insightFilter){var filterLabels={all:"ALL",top:"WITH TOP PRIZES",buy:"BUY 70%+",avoid:"AVOID <30%",closing:"CLOSING",new:"NEW <15%",concentrated:"DENSITY 1.3x+",depleted:"TOP GONE"};o+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;margin-bottom:8px;background:#2ecc7115;border:1px solid #2ecc7130;border-radius:8px"><div style="font-size:11px;font-weight:700;color:var(--grn)">FILTER: '+(filterLabels[S.insightFilter]||S.insightFilter)+' ('+f.length+')</div><div class="B" style="font-size:9px;padding:2px 10px" onclick="S.insightFilter=null;render()">\u2715</div></div>';}
    o+='<div class="FR"><span class="L" style="margin:0">PRICE:</span>';["all"].concat(pArr).forEach(function(p){var v=String(p);o+='<div class="B'+(S.filterPr===v?" on":"")+'" onclick="setFilter(\''+v+'\')" style="padding:5px 10px">'+(v==="all"?"ALL":"$"+v)+'</div>';});
    o+='</div><div class="FR"><span class="L" style="margin:0">SORT:</span>';
    [["score","Score"],["density","JK Density"],["hyper","JK P(pack)"],["jackpotEV","JK EV"],["gap","Gap"],["topOdds","Top Odds"],["tickets","Fresh"]].forEach(function(s){o+='<div class="B'+(S.sortBy===s[0]?" bn":"")+'" onclick="setSort(\''+s[0]+'\')" style="padding:5px 10px">'+s[1]+'</div>';});o+='</div>';
    for(var idx=0;idx<f.length;idx++){var a=f[idx];var tr2=getTrend(a.g.id);
      o+='<div class="C ck" onclick="openDetail(\''+a.g.id+'\')">';
      if(idx===0&&f.length>1)o+='<div class="badge" style="right:12px;background:var(--grn);color:var(--bg)">TOP PICK</div>';
      if(a.g.cs)o+='<div class="badge" style="right:'+(idx===0&&f.length>1?'95px':'12px')+';background:var(--red);color:#fff">CLOSING</div>';
      if(!a.btpInfo.hasJackpot)o+='<div class="badge" style="left:12px;background:var(--dim);color:var(--bg)">NO JK</div>';
      else if(!a.complete)o+='<div class="badge" style="left:12px;background:var(--amb);color:var(--bg)">PARTIAL</div>';
      o+='<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px"><div style="flex:1;min-width:0">';
      o+='<div style="font-size:15px;font-weight:700;color:var(--wht);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(a.g.nm)+' <span class="d" style="font-weight:400">#'+a.g.gn+'</span></div>';
      o+='<div style="font-size:11px;color:var(--dim)">$'+a.g.pr+(a.g.pk?' \xb7 '+a.g.pk+'/pk':'')+(a.aa?' \xb7 BTP:$'+fN(a.aa):'')+(a.g.guar?' \xb7 Fl:$'+fN(a.g.guar):'')+'</div></div>';
      var confClr=a.confidence>=85?"var(--grn)":a.confidence>=70?"var(--blu)":a.confidence>=50?"var(--dim)":a.confidence>=30?"var(--amb)":"var(--red)";
      o+='<div style="text-align:right;flex-shrink:0"><div class="V" style="color:'+confClr+';font-size:26px">'+a.sc+'<span style="font-size:12px;font-weight:600"> pts</span></div>';
      o+='<div style="font-size:9px;color:var(--dim)">#'+a.rank+' of '+a.rankOf+'</div>';
      o+='<div style="font-size:10px;font-weight:700;color:'+confClr+'">'+a.confidence+'% '+a.confLabel+'</div>';
      if(tr2.length>=3)o+='<div style="margin-top:2px">'+sparkline(tr2,"sc",14)+'</div>';
      o+='</div></div>';
      if(a.whyScore.length>0){o+='<div style="margin-top:5px">';a.whyScore.forEach(function(w){var c=w.p>0?"var(--grn)":w.p<0?"var(--red)":"var(--dim)";o+='<span class="why-tag" style="background:'+c+'15;color:'+c+';border:1px solid '+c+'30">'+(w.p>0?"\u25b2":"\u25bc")+" "+w.f+'</span>';});o+='</div>';}
      o+='<div class="G" style="grid-template-columns:repeat(auto-fit,minmax(90px,1fr));margin-top:8px">';
      [{l:"JK Density",v:a.jackpotDensityShift>0?a.jackpotDensityShift.toFixed(2)+"x":"\u2014",c:a.jackpotDensityShift>=1.2?"g":a.jackpotDensityShift>=0.9?"d":"r"},{l:"JK P(pack)",v:a.hyperRatio>0?a.hyperRatio.toFixed(2)+"x":"\u2014",c:a.hyperRatio>1.1?"g":a.hyperRatio<0.9?"r":"d"},{l:"JK EV",v:a.jackpotEV>0?"$"+a.jackpotEV.toFixed(2):"\u2014",c:a.jackpotEVShift>1.05?"g":"d"},{l:"Top Left",v:a.tpr+"/"+a.tp.p,c:a.tpr>0?"g":"r"},{l:"Top Lag",v:a.topClaimLag!==0?(a.topClaimLag>0?"+":"")+pct(a.topClaimLag):"\u2014",c:a.topClaimLag>0.05?"g":a.topClaimLag<-0.05?"r":"d"},{l:"Markov",v:a.gm.sig.replace(/_/g," "),c:"BUY STRONG_BUY".indexOf(a.gm.sig)>=0?"g":"AVOID DEAD".indexOf(a.gm.sig)>=0?"r":"d"},{l:"Sold",v:pct(a.mat),c:a.mat<0.5?"g":a.mat<0.8?"a":"r"},{l:"Floor",v:a.floorEV>0?"$"+fN(a.floorEV):"\u2014",c:"d"},{l:"Data",v:a.dataConfidence,c:a.dataConfidence==="HIGH"?"g":a.dataConfidence==="MEDIUM"?"a":"r"},{l:"Gap",v:a.returnGap!==0?(a.returnGap>0?"+":"")+pct(a.returnGap):"\u2014",c:a.returnGap>0.01?"g":a.returnGap<-0.01?"r":"d"}].forEach(function(m){o+='<div><div class="L" style="font-size:8px">'+m.l+'</div><div style="font-size:12px;font-weight:700" class="'+m.c+'">'+m.v+'</div></div>';});
      o+='</div>';
      if(a.jackpotShifts.length>0){o+='<div style="margin-top:6px;padding:5px 8px;background:var(--bg);border-radius:6px;display:flex;gap:12px;flex-wrap:wrap">';a.jackpotShifts.forEach(function(j){var jc=j.signal==="STRONG"||j.signal==="GOOD"?"var(--grn)":j.signal==="NEUTRAL"?"var(--dim)":j.signal==="WEAK"?"var(--amb)":"var(--red)";var rc=j.role==="TOP"?"#d4a017":j.role==="TOP-1"?"#af7ac5":"#5a6a7a";o+='<div style="font-size:10px"><span style="font-size:8px;color:'+rc+'">'+j.role+'</span> <span style="font-weight:700;color:'+jc+'">$'+fN(j.a)+'</span> '+(j.remaining<=0?'<span class="r">GONE</span>':'<span class="d">'+j.remaining+'/'+j.printed+' '+j.shift.toFixed(2)+'x</span>'+(j.claimLag>0.05?' <span style="color:var(--grn)">lag+'+pct(j.claimLag)+'</span>':''))+'</div>';});o+='</div>';}
      if(a.flags.length>0){o+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:5px">';a.flags.slice(0,4).forEach(function(fl){o+='<span style="font-size:9px;font-weight:700;padding:3px 8px;border-radius:4px;background:var(--'+fl.c+'1);color:var(--'+fl.c+');border:1px solid var(--'+fl.c+')30">'+esc(fl.t)+'</span>';});o+='</div>';}
      o+='</div>';
    }
  }

  // ==================== DETAIL ====================
  else if(S.tab==="detail"){
    if(!sel){
      o+='<div class="C"><div class="L">SELECT A GAME</div>';
      o+='<input class="I" style="margin:6px 0" placeholder="Search..." value="'+esc(S.detailSearch)+'" oninput="detailSearchInput(this.value)">';
      var filt=S.data;if(S.detailSearch){var q=S.detailSearch.toLowerCase();filt=filt.filter(function(a){return a.g.nm.toLowerCase().indexOf(q)>=0||String(a.g.gn).indexOf(q)>=0});}
      filt.sort(function(a,b){return b.sc-a.sc}).forEach(function(a){o+='<div class="ck" style="padding:8px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center" onclick="openDetail(\''+a.g.id+'\')">';o+='<div style="font-size:12px;font-weight:600;color:var(--wht)">'+esc(a.g.nm)+' <span class="d">#'+a.g.gn+'</span></div>';o+='<div style="font-size:12px;font-weight:700;color:'+(a.sc>=65?"var(--grn)":a.sc>=40?"var(--dim)":"var(--red)")+'">'+a.sc+'</div></div>';});
      o+='</div>';
    } else {
      var a=sel,g=a.g;
      var burn=burnRateProjection(g.id,a);
      var jkTimeline=computeJackpotTimeline(a,burn);
      var sim=simulatePacks(a);
      var guidance=getPackGuidance(g,a,S.winModel);
      var jpp=predictJackpotPacks(g,a,S.winModel);
      var arch2=classifyArchetype(a);
      var confClr=a.confidence>=85?"var(--grn)":a.confidence>=70?"var(--blu)":a.confidence>=50?"var(--dim)":a.confidence>=30?"var(--amb)":"var(--red)";
      o+='<div class="B" style="margin-bottom:10px" onclick="S.selId=null;render()">\u2190 Back</div>';
      o+='<div class="C">';
      o+='<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div style="flex:1;min-width:0">';
      o+='<div style="font-size:18px;font-weight:800;color:var(--wht)">'+esc(g.nm)+'</div>';
      o+='<div style="font-size:11px;color:var(--dim)">#'+g.gn+' \xb7 $'+g.pr+' \xb7 '+fN(g.pk)+'/pk \xb7 $'+fN(a.packPrice)+'</div>';
      o+='<div style="margin-top:4px"><span style="font-size:10px;padding:3px 8px;border-radius:4px;background:'+arch2.color+'25;color:'+arch2.color+';border:1px solid '+arch2.color+'50;font-weight:600">'+esc(arch2.label)+'</span>';
      o+=' <span style="font-size:10px;padding:3px 8px;border-radius:4px;background:'+(a.prizeClass==="high"?"#d4a01725":"#5a6a7a25")+';color:'+(a.prizeClass==="high"?"#d4a017":"#5a6a7a")+';border:1px solid '+(a.prizeClass==="high"?"#d4a01750":"#5a6a7a50")+';font-weight:600">'+a.prizeClass.toUpperCase()+' VALUE</span></div>';
      o+='</div>';
      o+='<div style="text-align:right"><div class="V" style="color:'+confClr+';font-size:28px">'+a.sc+'</div>';
      o+='<div style="font-size:10px;color:var(--dim)">#'+a.rank+'/'+a.rankOf+'</div>';
      o+='<div style="font-size:10px;font-weight:700;color:'+confClr+'">'+a.confidence+'% '+a.confLabel+'</div></div></div>';
      if(a.flags.length>0){o+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px">';a.flags.forEach(function(fl){o+='<span style="font-size:9px;font-weight:700;padding:3px 8px;border-radius:4px;background:var(--'+fl.c+'1);color:var(--'+fl.c+');border:1px solid var(--'+fl.c+')30" title="'+esc(fl.m)+'">'+esc(fl.t)+'</span>';});o+='</div>';}
      o+='</div>';

      // === OVERVIEW CARDS ===
      o+='<div class="G GA">';
      [{l:"Sold",v:pct(a.mat),c:"b"},{l:"Packs Left",v:fN(a.epr),c:"w"},{l:"Top Left",v:a.tpr+"/"+a.tp.p,c:a.tpr>0?"g":"r"},{l:"Top Odds",v:fmtO(a.tpo),c:a.topDensityShift>1?"g":"d"},{l:"JK Density",v:a.jackpotDensityShift.toFixed(2)+"x",c:a.jackpotDensityShift>=1.2?"g":a.jackpotDensityShift>=0.9?"d":"r"},{l:"JK P(pack)",v:a.hyperRatio>0?a.hyperRatio.toFixed(2)+"x":"\u2014",c:a.hyperRatio>1?"g":"d"},{l:"Floor",v:"$"+fN(a.floorEV),c:"d"},{l:"Pack EV",v:"$"+Math.round(a.totalEV),c:a.edge>0?"g":"r"},{l:"Edge",v:(a.edge>0?"+":"")+pct(a.edge),c:a.edge>0?"g":"r"},{l:"Markov",v:a.gm.sig.replace(/_/g," "),c:"BUY STRONG_BUY".indexOf(a.gm.sig)>=0?"g":"AVOID DEAD".indexOf(a.gm.sig)>=0?"r":"d"},{l:"Gap",v:(a.returnGap>0?"+":"")+pct(a.returnGap),c:a.returnGap>0?"g":a.returnGap<0?"r":"d"},{l:"Data",v:a.dataConfidence,c:a.dataConfidence==="HIGH"?"g":a.dataConfidence==="MEDIUM"?"a":"r"}].forEach(function(m){o+='<div class="cl"><div class="L">'+m.l+'</div><div style="font-size:14px;font-weight:700" class="'+m.c+'">'+m.v+'</div></div>';});
      o+='</div>';

      // === JACKPOT TIERS ===
      if(a.jackpotShifts.length>0){o+='<div class="C"><div class="L" style="margin-bottom:8px">JACKPOT TIERS</div>';
        a.jackpotShifts.forEach(function(j){var jc=j.signal==="STRONG"||j.signal==="GOOD"?"var(--grn)":j.signal==="NEUTRAL"?"var(--dim)":j.signal==="WEAK"?"var(--amb)":"var(--red)";var rc=j.role==="TOP"?"#d4a017":j.role==="TOP-1"?"#af7ac5":"#5a6a7a";
          o+='<div style="padding:8px;background:var(--bg);border-radius:8px;margin-bottom:6px"><div style="display:flex;justify-content:space-between;align-items:center">';
          o+='<div><span style="font-size:9px;color:'+rc+';font-weight:700">'+j.role+'</span> <span style="font-weight:700;font-size:15px;color:'+jc+'">'+fmt(j.a)+'</span></div>';
          o+='<div style="font-weight:700;color:'+jc+'">'+j.signal+'</div></div>';
          o+='<div class="G3" style="margin-top:5px">';
          o+='<div><div class="L" style="font-size:8px">Remain</div><div style="font-size:11px;font-weight:600">'+(j.remaining<=0?'<span class="r">GONE</span>':j.remaining+'/'+j.printed)+'</div></div>';
          o+='<div><div class="L" style="font-size:8px">Density</div><div style="font-size:11px;font-weight:600;color:'+jc+'">'+j.shift.toFixed(2)+'x</div></div>';
          o+='<div><div class="L" style="font-size:8px">Odds</div><div style="font-size:11px;font-weight:600">'+fmtO(j.currentOdds)+'</div></div>';
          o+='</div>';
          var cd=estimateClaimDelay(j.a);
          o+='<div style="font-size:9px;color:var(--dim);margin-top:3px">Lag: '+(j.claimLag>0?"+":"")+pct(j.claimLag)+' \xb7 Claim: '+cd.method+' ('+cd.avgDays+'d avg)</div>';
          o+='</div>';
        });
        o+='<div style="margin-top:6px;font-size:10px;color:var(--dim)">P(\u22651 top in pack): '+(a.hyperTopNow>=0.01?pct(a.hyperTopNow):"1:"+fN(Math.round(1/a.hyperTopNow)))+' ('+a.hyperTopRatio.toFixed(2)+'x) \xb7 JK EV: $'+a.jackpotEVRaw.toFixed(2)+'</div>';
        o+='</div>';}

      // === PRIZE TABLE ===
      o+='<div class="C"><div class="collapse-toggle" onclick="S._prizeOpen=!S._prizeOpen;render()"><div class="L">PRIZE TABLE</div><div style="font-size:10px;color:var(--dim)">'+(S._prizeOpen?'\u25b2':'\u25bc')+'</div></div>';
      if(S._prizeOpen){
        o+='<div style="margin-top:6px"><div class="FR"><span class="L" style="margin:0">SHOW:</span>';
        ["all","jackpot","mid","floor"].forEach(function(v){o+='<div class="B'+(S.prizeFilter===v?" on":"")+'" style="padding:3px 8px;font-size:9px" onclick="setPrizeFilter(\''+v+'\')">'+v.toUpperCase()+'</div>';});o+='</div>';
        var filteredPrizes=a.prizes.slice();
        if(S.prizeFilter==="jackpot")filteredPrizes=filteredPrizes.filter(function(p){return p.cat==="TOP"||p.cat==="TOP-1"||p.cat==="TOP-2"});
        else if(S.prizeFilter==="mid")filteredPrizes=filteredPrizes.filter(function(p){return p.cat==="MID"});
        else if(S.prizeFilter==="floor")filteredPrizes=filteredPrizes.filter(function(p){return p.cat==="FLOOR"||p.cat==="BTP"});
        var sortFns={a:function(x,y){return x.a-y.a},rem:function(x,y){return x.rem-y.rem},pctC:function(x,y){return x.pctC-y.pctC},currO:function(x,y){return x.currO-y.currO}};
        if(sortFns[S.prizeSortCol])filteredPrizes.sort(function(x,y){return sortFns[S.prizeSortCol](x,y)*S.prizeSortDir;});
        o+='<div style="overflow-x:auto"><table><tr>';
        [["a","Prize"],["cat","Tier"],["rem","Left"],["pctC","Clm%"],["currO","Odds"]].forEach(function(h){o+='<th style="cursor:pointer" onclick="sortPrizeCol(\''+h[0]+'\')">'+h[1]+(S.prizeSortCol===h[0]?(S.prizeSortDir>0?" \u25b2":" \u25bc"):"")+'</th>';});
        o+='</tr>';
        filteredPrizes.forEach(function(p){var rc2=p.cat==="TOP"?"#d4a017":p.cat==="TOP-1"?"#af7ac5":p.cat==="MID"?"#3498db":p.cat==="BTP"?"#2ecc71":"var(--dim)";
          o+='<tr'+(p.rem===0?' style="opacity:0.4"':'')+'><td style="text-align:left;font-weight:600;color:'+(p.rem>0?"var(--wht)":"var(--dim)")+'">'+fmt(p.a)+(p.highSens?' \u26a1':'')+'</td><td><span style="color:'+rc2+';font-size:9px;font-weight:700">'+p.cat+'</span></td><td>'+fN(p.rem)+'/'+fN(p.p)+'</td><td>'+p.pctC.toFixed(1)+'%</td><td>'+(p.rem>0?fmtO(p.currO):'\u2014')+'</td></tr>';});
        o+='</table></div></div>';}
      o+='</div>';

      // === v7.4: PREDICTIONS & TIMELINE ===
      if(jpp.valid){o+='<div class="C"><div class="collapse-toggle" onclick="togglePred()"><div class="L">JACKPOT PACK PREDICTIONS</div><div style="font-size:10px;color:var(--dim)">'+(S.predExpand?'\u25b2':'\u25bc')+'</div></div>';
        // v7.4: Show model type + similarity info
        o+='<div style="margin-top:6px;font-size:10px;padding:6px 10px;background:var(--bg);border-radius:6px">';
        o+='<span style="font-weight:700;color:'+(jpp.model==='similarity'?'var(--grn)':'var(--dim)')+'">MODEL: '+jpp.model.toUpperCase()+'</span>';
        if(jpp.model==='similarity'){o+=' \xb7 <span class="g">'+jpp.similarGames+' similar games</span> \xb7 Conf: <span style="font-weight:700;color:'+(jpp.confidenceScore>=75?'var(--grn)':jpp.confidenceScore>=50?'var(--blu)':'var(--amb)')+'">'+jpp.confidenceScore+'% '+jpp.confLabel+'</span>';
          if(jpp.varianceModel&&jpp.varianceModel.valid){o+='<br>CV='+jpp.varianceModel.avgCV.toFixed(2)+' \xb7 Band: \xb1'+Math.round(jpp.varianceModel.bandMultiplier*100)+'% \xb7 '+jpp.varianceModel.totalGaps+' gaps from '+jpp.varianceModel.gamesUsed+' games';}}
        else{o+=' \xb7 <span class="d">'+esc(jpp.note)+'</span>';}
        o+='</div>';
        if(S.predExpand){
          o+='<div style="margin-top:8px;font-size:10px;color:var(--dim)">Uniform spacing with '+(jpp.model==='similarity'?'similarity-calibrated':'default')+' variance bands.</div>';
          if(jpp.tooSparse)o+='<div style="font-size:10px;color:var(--amb);margin-top:4px">\u26a0 Very sparse: ~1 per '+fN(jpp.packsPerPrize)+' packs.</div>';
          jpp.predictions.forEach(function(p,pi){var rc3=p.role==="TOP"?"#d4a017":"#af7ac5";
            o+='<div style="padding:8px;background:var(--bg);border-radius:8px;margin-top:6px;border-left:3px solid '+rc3+'">';
            o+='<div style="display:flex;justify-content:space-between"><div><span style="font-size:9px;color:'+rc3+';font-weight:700">'+p.role+' #'+(pi+1)+'</span> <span style="font-weight:700;color:var(--wht)">'+fmt(p.prizeAmt)+'</span></div>';
            o+='<div style="font-size:12px;font-weight:700;color:var(--wht)">Pack #'+fN(p.predictedPack)+'</div></div>';
            o+='<div style="font-size:10px;color:var(--dim)">Range: #'+fN(p.rangeLow)+' \u2013 #'+fN(p.rangeHigh)+' (\xb1'+fN(p.marginPacks)+') \xb7 Claim: '+p.claimDelay.method+'</div></div>';});
          if(jpp.tierProbs.length){o+='<div style="margin-top:10px"><div class="L" style="margin-bottom:4px">PROBABILITY PER PACK</div>';
            jpp.tierProbs.forEach(function(tp2){o+='<div style="font-size:11px;padding:4px 0;border-bottom:1px solid var(--border)"><span style="font-weight:600">'+fmt(tp2.a)+'</span> <span class="d">'+tp2.role+'</span>: '+(tp2.pPerPack>=0.01?pct(tp2.pPerPack):"1:"+fN(Math.round(1/tp2.pPerPack)))+' per pack \xb7 50% after '+fN(tp2.packsFor50)+' packs</div>';});o+='</div>';}
        }
        o+='</div>';}

      // === TIMELINE ===
      if(jkTimeline&&jkTimeline.valid){o+='<div class="C"><div class="collapse-toggle" onclick="toggleTimeline()"><div class="L">JACKPOT TIMELINE</div><div style="font-size:10px;color:var(--dim)">'+(S.timelineExpand?'\u25b2':'\u25bc')+'</div></div>';
        if(S.timelineExpand){jkTimeline.timeline.forEach(function(t){if(t.gone){o+='<div style="padding:6px;opacity:0.4;font-size:11px">'+fmt(t.a)+' '+t.role+': <span class="r">ALL CLAIMED</span></div>';return;}
          o+='<div style="padding:8px;background:var(--bg);border-radius:8px;margin-top:6px">';
          o+='<div style="font-weight:700;font-size:13px">'+fmt(t.a)+' <span class="d" style="font-weight:400;font-size:10px">'+t.role+' \xb7 '+t.remaining+' left \xb7 P/pack: '+(t.pPerPack>=0.01?pct(t.pPerPack):"1:"+fN(Math.round(1/t.pPerPack)))+'</span></div>';
          o+='<div style="margin-top:4px">';t.packsFor.forEach(function(pf){o+='<div style="display:flex;justify-content:space-between;font-size:10px;padding:2px 0"><span class="d">'+pf.confLabel+' confidence</span><span>'+fN(pf.packs)+' packs'+(pf.eta?' \xb7 ~'+pf.eta:'')+'</span></div>';});
          o+='</div><div style="font-size:9px;color:var(--dim);margin-top:3px">Claim: '+t.claimDelay.method+' ('+t.claimDelay.minDays+'-'+t.claimDelay.maxDays+'d)</div></div>';});}
        o+='</div>';}

      // === SIMULATION ===
      if(sim&&sim.valid){o+='<div class="C"><div class="L" style="margin-bottom:6px">MONTE CARLO ('+fN(sim.N)+' packs)</div>';
        o+='<div class="G GA">';
        [{l:"Avg Return",v:"$"+Math.round(sim.mean),c:sim.mean>sim.cost?"g":"r"},{l:"Median",v:"$"+Math.round(sim.median),c:sim.median>sim.cost?"g":"r"},{l:"Worst",v:"$"+Math.round(sim.worst),c:"r"},{l:"Best",v:"$"+fN(Math.round(sim.best)),c:"g"},{l:"P(Profit)",v:pct(sim.pProfit),c:sim.pProfit>0.05?"g":"r"},{l:"P(Floor)",v:pct(sim.pFloor),c:"d"},{l:"Expected P/L",v:(sim.expPL>=0?"+":"")+Math.round(sim.expPL),c:sim.expPL>=0?"g":"r"},{l:"Range 90%",v:"$"+Math.round(sim.p5)+"-$"+fN(Math.round(sim.p95)),c:"d"}].forEach(function(m){o+='<div class="cl"><div class="L">'+m.l+'</div><div style="font-size:13px;font-weight:700" class="'+m.c+'">'+m.v+'</div></div>';});
        o+='</div>';
        o+='<div style="margin-top:8px">';sim.buckets.forEach(function(b){var w=sim.N>0?Math.round((b.n/sim.N)*100):0;var bClr=b.l.indexOf("Below")>=0?"var(--red)":b.l.indexOf("At Floor")>=0?"var(--dim)":b.l.indexOf("Floor+")>=0?"var(--amb)":b.l.indexOf("Break")>=0?"var(--blu)":"var(--grn)";o+='<div class="bar-row"><div class="bar-label">'+b.l+'</div><div class="bar-track"><div style="width:'+Math.max(1,w)+'%;background:'+bClr+';height:100%"></div><div class="bar-pct">'+w+'%</div></div></div>';});
        o+='</div></div>';}

      // === SCORE BREAKDOWN ===
      o+='<div class="C"><div class="L" style="margin-bottom:6px">SCORE BREAKDOWN</div>';
      o+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><div style="flex:1;height:6px;background:var(--bg);border-radius:3px;overflow:hidden"><div style="width:'+a.sc+'%;height:100%;background:linear-gradient(90deg,var(--red),var(--amb),var(--grn));border-radius:3px"></div></div><span style="font-weight:700;font-size:14px" class="'+(a.sc>=65?"g":a.sc>=40?"a":"r")+'">'+a.sc+'</span></div>';
      a.scoreBreakdown.forEach(function(s){var w2=Math.min(100,Math.abs(s.p)*3);var bc=s.p>0?"var(--grn)":s.p<0?"var(--red)":"var(--dim)";o+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;font-size:10px"><div style="width:40px;text-align:right;font-weight:700;color:'+bc+'">'+(s.p>=0?"+":"")+s.p+'</div><div style="flex:1;height:4px;background:var(--bg);border-radius:2px;overflow:hidden"><div style="width:'+w2+'%;height:100%;background:'+bc+';border-radius:2px"></div></div><div class="d" style="flex:2">'+esc(s.f)+'</div></div>';});
      o+='</div>';

      // === BURN RATE ===
      if(burn){o+='<div class="C"><div class="L" style="margin-bottom:6px">BURN RATE'+(burn.reliable?'':' (est)')+'</div>';
        o+='<div class="G GA">';
        [{l:"Packs/Day",v:fN(burn.packsPerDay),c:"b"},{l:"$/Day",v:"$"+fN(burn.dollarsPerDay),c:"b"},{l:"Days Left",v:burn.daysLeft?fN(burn.daysLeft):"?",c:burn.daysLeft&&burn.daysLeft<30?"r":"d"}].forEach(function(m){o+='<div class="cl"><div class="L">'+m.l+'</div><div style="font-size:13px;font-weight:700" class="'+m.c+'">'+m.v+'</div></div>';});
        o+='</div>';
        if(burn.milestones&&burn.milestones.length){o+='<div style="margin-top:6px">';burn.milestones.forEach(function(ms){o+='<div style="font-size:10px;padding:2px 0;display:flex;justify-content:space-between"><span class="d">'+(ms.pct*100)+'% sold</span><span>~'+ms.label+' ('+fN(ms.days)+'d)</span></div>';});o+='</div>';}
        if(burn.jackpotETA){o+='<div style="margin-top:8px;padding:6px;background:var(--bg);border-radius:6px"><div class="L" style="margin-bottom:3px">JACKPOT PACE</div>';
          o+='<div style="font-size:11px">'+fN(burn.jackpotETA.totalRemaining)+' prizes in '+fN(a.epr)+' packs \xb7 ~1 per '+fN(burn.jackpotETA.packsPerJackpot)+' packs';
          if(burn.jackpotETA.daysPerJackpot)o+=' (~'+fN(burn.jackpotETA.daysPerJackpot)+'d)';o+='</div>';
          if(burn.jackpotETA.tiers){burn.jackpotETA.tiers.forEach(function(t){o+='<div style="font-size:10px;padding:2px 0;color:var(--dim)">'+fmt(t.amount)+' '+t.role+': ~1/'+fN(t.packsPerHit)+'pk'+(t.daysPerHit?' (~'+t.daysPerHit+'d)':'')+'</div>';});}o+='</div>';}
        o+='</div>';}

      // === TREND ===
      var tr2=getTrend(g.id);
      if(tr2.length>=2){o+='<div class="C"><div class="L" style="margin-bottom:6px">TREND ('+tr2.length+' snapshots)</div>';
        o+='<div class="G3">';
        o+='<div><div class="L" style="font-size:8px">Score</div>'+sparkline(tr2,"sc",24)+'</div>';
        o+='<div><div class="L" style="font-size:8px">JK Density</div>'+sparkline(tr2,"jd",24)+'</div>';
        o+='<div><div class="L" style="font-size:8px">Top Left</div>'+sparkline(tr2,"tpr",24)+'</div>';
        o+='</div></div>';}

      // === AI PROMPT ===
      o+='<div class="C"><div class="L" style="margin-bottom:6px">AI ANALYSIS</div>';
      o+='<div style="display:flex;gap:8px"><div class="B on" style="font-size:10px" onclick="copyAIPrompt(\''+g.id+'\')">Copy Prompt</div>';
      o+='<div class="B" style="font-size:10px" onclick="showAIPrompt(\''+g.id+'\')">Preview</div>';
      o+='<div class="B" style="font-size:10px" onclick="startPack(\''+g.id+'\')">Track Pack</div></div>';
      if(S._promptPreview){o+='<pre style="margin-top:8px;font-size:9px;color:var(--dim);white-space:pre-wrap;max-height:300px;overflow:auto;background:var(--bg);padding:8px;border-radius:6px">'+esc(S._promptPreview)+'</pre>';o+='<div class="B" style="font-size:9px;margin-top:4px" onclick="S._promptPreview=null;render()">Close</div>';}
      o+='</div>';
    }
  }

  // ==================== INSIGHTS ====================
  else if(S.tab==="insights"){
    var complete=S.data.filter(function(a){return a.complete&&a.btpInfo.hasJackpot});
    var totalJkRem=0,totalJkPri=0;complete.forEach(function(a){a.jackpotTiers.forEach(function(t){totalJkRem+=t.rem;totalJkPri+=t.printed;});});
    o+='<div class="C"><div class="L">MARKET OVERVIEW ('+complete.length+' games with jackpot)</div>';
    o+='<div class="G GA" style="margin-top:8px">';
    [{l:"Total JK Left",v:fN(totalJkRem)+"/"+fN(totalJkPri),c:"w"},{l:"Avg Score",v:complete.length?Math.round(complete.reduce(function(s,a){return s+a.sc},0)/complete.length):"?",c:"d"},{l:"Buy Zone (70%+)",v:complete.filter(function(a){return a.confidence>=70}).length,c:"g"},{l:"Avoid (<30%)",v:complete.filter(function(a){return a.confidence<30}).length,c:"r"},{l:"Closing+Top",v:complete.filter(function(a){return a.g.cs&&a.tpr>0}).length,c:"a"},{l:"Top Gone",v:complete.filter(function(a){return a.tpr===0}).length,c:"r"}].forEach(function(m){o+='<div class="cl"><div class="L">'+m.l+'</div><div style="font-size:14px;font-weight:700" class="'+m.c+'">'+m.v+'</div></div>';});
    o+='</div></div>';
    o+='<div class="C"><div class="L" style="margin-bottom:8px">QUICK FILTERS</div>';
    [["top","WITH JACKPOT",complete.length],["buy","BUY 70%+",complete.filter(function(a){return a.confidence>=70}).length],["avoid","AVOID <30%",complete.filter(function(a){return a.confidence<30}).length],["concentrated","DENSITY 1.3x+",complete.filter(function(a){return a.jackpotDensityShift>=1.3}).length],["closing","CLOSING",complete.filter(function(a){return a.g.cs&&a.tpr>0}).length],["new","NEW <15%",complete.filter(function(a){return a.mat<0.15}).length],["depleted","TOP GONE",complete.filter(function(a){return a.tpr===0}).length]].forEach(function(fi){o+='<div class="ck" style="padding:8px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between" onclick="setInsightFilter(\''+fi[0]+'\')"><span style="font-size:12px;font-weight:600">'+fi[1]+'</span><span style="font-size:12px;font-weight:700;color:var(--blu)">'+fi[2]+'</span></div>';});
    o+='</div>';
    o+='<div class="C"><div class="L" style="margin-bottom:6px">PORTFOLIO AI</div>';
    o+='<div style="display:flex;gap:8px"><div class="B on" style="font-size:10px" onclick="copyAllPrompt()">Copy All Prompt</div>';
    o+='<div class="B" style="font-size:10px" onclick="showAllPrompt()">Preview</div></div>';
    if(S._allPromptPreview){o+='<pre style="margin-top:8px;font-size:9px;color:var(--dim);white-space:pre-wrap;max-height:300px;overflow:auto;background:var(--bg);padding:8px;border-radius:6px">'+esc(S._allPromptPreview)+'</pre>';o+='<div class="B" style="font-size:9px;margin-top:4px" onclick="S._allPromptPreview=null;render()">Close</div>';}
    o+='</div>';
    // Best per price
    var byP={};complete.forEach(function(a){if(!byP[a.g.pr]||a.sc>byP[a.g.pr].sc)byP[a.g.pr]=a;});
    var prKeys=Object.keys(byP).map(Number).sort(function(a,b){return a-b});
    if(prKeys.length>0){o+='<div class="C"><div class="L" style="margin-bottom:6px">BEST PER PRICE</div>';
      prKeys.forEach(function(p){var a=byP[p];o+='<div class="ck" style="padding:8px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center" onclick="openDetail(\''+a.g.id+'\')">';o+='<div><span style="font-weight:700;color:var(--wht)">$'+p+'</span> <span class="d">\u2192</span> <span style="font-weight:600">'+esc(a.g.nm)+'</span> <span class="d">#'+a.g.gn+'</span></div>';o+='<div style="font-weight:700;color:'+(a.confidence>=70?"var(--grn)":a.confidence>=40?"var(--dim)":"var(--red)")+'">'+a.sc+'</div></div>';});
      o+='</div>';}
  }
  // ==================== WINNERS ====================
  else if(S.tab==="winners"){
    o+='<div class="C"><div class="L">WINNER DATA</div>';
    o+='<div style="display:flex;gap:8px;margin-top:6px"><div class="B'+(S._fetching?'':' on')+'" onclick="fetchWinners()" style="font-size:10px">'+(S._fetching?'\u23f3...':'\u21bb Load Winners')+'</div></div>';
    if(!S.winData||!Object.keys(S.winData).length){o+='<div style="margin-top:10px;font-size:11px;color:var(--dim)">No winner data. Click Load Winners.</div></div>';}
    else{
      var wGames=Object.keys(S.winData);var totalRecs=0;wGames.forEach(function(gn){totalRecs+=S.winData[gn].length;});
      o+='<div style="margin-top:6px;font-size:11px">'+wGames.length+' games \xb7 '+fN(totalRecs)+' records</div>';
      o+='<input class="I" style="margin:8px 0" placeholder="Search game..." value="'+esc(S.winSearch)+'" oninput="winSearchInput(this.value)">';
      o+='<select class="I" style="margin-bottom:8px" onchange="winGameFilter(this.value)"><option value="">All Games</option>';
      wGames.sort().forEach(function(gn){var nm="";for(var i=0;i<GD.length;i++)if(String(GD[i].gn)===gn){nm=GD[i].nm;break;}o+='<option value="'+gn+'"'+(S.winGame===gn?' selected':'')+'>'+gn+(nm?' - '+esc(nm):'')+'</option>';});
      o+='</select>';
      var showGames=wGames;if(S.winGame)showGames=[S.winGame];
      if(S.winSearch){var wq=S.winSearch.toLowerCase();showGames=showGames.filter(function(gn){if(gn.indexOf(wq)>=0)return true;for(var i=0;i<GD.length;i++)if(String(GD[i].gn)===gn&&GD[i].nm.toLowerCase().indexOf(wq)>=0)return true;return false;});}
      showGames.slice(0,20).forEach(function(gn){var recs=S.winData[gn];if(!recs||!recs.length)return;
        var nm="",g2=null;for(var i=0;i<GD.length;i++)if(String(GD[i].gn)===gn){nm=GD[i].nm;g2=GD[i];break;}
        var pc2=g2&&g2.tot&&g2.pk?Math.round(g2.tot/g2.pk):0;
        var prizeClass=g2?classifyPrizeClass(g2):'unknown';
        o+='<div style="padding:8px;background:var(--bg);border-radius:8px;margin-top:6px">';
        o+='<div style="font-weight:600;font-size:12px;color:var(--wht)">'+esc(nm||gn)+' <span class="d">#'+gn+'</span> <span style="font-size:9px;padding:2px 6px;border-radius:3px;background:'+(prizeClass==="high"?"#d4a01725":"#5a6a7a25")+';color:'+(prizeClass==="high"?"#d4a017":"#5a6a7a")+'">'+prizeClass.toUpperCase()+'</span></div>';
        o+='<div style="font-size:10px;color:var(--dim)">'+recs.length+' claims'+(pc2?' \xb7 '+fN(pc2)+' packs':'')+'</div>';
        if(recs.length>=2&&pc2>0){
          var pns=recs.map(function(r){return r.pn||0}).filter(function(p){return p>0}).sort(function(a,b){return a-b});
          if(pns.length>=2){var gaps=[];for(i=0;i<pns.length-1;i++)gaps.push(pns[i+1]-pns[i]);
            var avgG=gaps.reduce(function(s,v){return s+v},0)/gaps.length;
            var stdG=gaps.length>1?Math.sqrt(gaps.reduce(function(s,v){return s+Math.pow(v-avgG,2)},0)/(gaps.length-1)):0;
            var cv=avgG>0?stdG/avgG:0;
            o+='<div style="font-size:10px;margin-top:3px">First: #'+fN(pns[0])+' Last: #'+fN(pns[pns.length-1])+' \xb7 Avg gap: '+fN(Math.round(avgG))+' \xb7 CV: '+cv.toFixed(2)+'</div>';}}
        o+='</div>';});
      if(showGames.length>20)o+='<div style="font-size:10px;color:var(--dim);margin-top:6px">'+(showGames.length-20)+' more...</div>';
      o+='</div>';
    }
  }
  // ==================== MORE ====================
  else if(S.tab==="more"){
    o+='<div class="tabs" style="margin-bottom:12px">';
    [["pack","PACK TRACKER"],["bank","BANKROLL"],["data","DATA"]].forEach(function(t){o+='<div class="T'+(S.moreTab===t[0]?" on":"")+'" onclick="setMore(\''+t[0]+'\')">'+t[1]+'</div>';});
    o+='</div>';
    if(S.moreTab==="pack"){
      var pk=S.pack,v2=mkv();
      o+='<div class="C"><div class="L">PACK: '+(pk.nm||"None")+'</div>';
      o+='<div class="G GA" style="margin-top:8px">';
      [{l:"Tickets",v:pk.log.length+"/"+pk.pk,c:"w"},{l:"Spent",v:"$"+fN(pk.spent),c:"r"},{l:"Won",v:"$"+fN(pk.won),c:"g"},{l:"Net",v:(pk.won-pk.spent>=0?"+":"")+fN(pk.won-pk.spent),c:pk.won-pk.spent>=0?"g":"r"}].forEach(function(m){o+='<div class="cl"><div class="L">'+m.l+'</div><div style="font-size:14px;font-weight:700" class="'+m.c+'">'+m.v+'</div></div>';});
      o+='</div>';
      if(v2){o+='<div class="sig '+(v2.dec==="BUY"||v2.dec==="EARLY"?"buy":"avoid")+'">'+v2.dec+': '+v2.rsn+'</div>';}
      o+='<div style="margin-top:12px"><div class="L" style="margin-bottom:4px">SCRATCH</div>';
      o+='<div style="display:flex;gap:5px;flex-wrap:wrap">';
      [0,pk.pr].concat([5,10,20,50,100,500].filter(function(x){return x!==pk.pr&&x>0})).forEach(function(amt){o+='<div class="B'+(amt===0?" rn":" on")+'" onclick="scratch('+amt+')" style="padding:6px 12px">'+(amt===0?"LOSS":"$"+amt)+'</div>';});
      o+='</div></div>';
      o+='<div style="margin-top:10px;display:flex;gap:8px"><div class="B" onclick="resetPack()">Reset</div><div class="B on" onclick="saveSession()">Save</div></div></div>';
      if(S.sessions.length>0){o+='<div class="C"><div class="L">SESSION LOG ('+S.sessions.length+')</div>';
        var totS=0,totW=0;S.sessions.forEach(function(s){totS+=s.s;totW+=s.w;});
        o+='<div style="font-size:12px;font-weight:700;margin:6px 0">Total: <span class="r">-$'+fN(totS)+'</span> / <span class="g">+$'+fN(totW)+'</span> = <span class="'+(totW-totS>=0?'g':'r')+'">'+(totW-totS>=0?'+':'')+fN(totW-totS)+'</span></div>';
        S.sessions.slice().reverse().forEach(function(s){o+='<div style="padding:4px 0;border-bottom:1px solid var(--border);font-size:10px;display:flex;justify-content:space-between"><span class="d">'+esc(s.d)+' '+esc(s.g)+' ('+s.t+'tk)</span><span class="'+(s.w-s.s>=0?'g':'r')+'">'+(s.w-s.s>=0?'+':'')+fN(s.w-s.s)+'</span></div>';});
        o+='<div class="B" style="margin-top:6px;font-size:9px" onclick="clearSess()">Clear All</div></div>';}
    }
    else if(S.moreTab==="bank"){
      o+='<div class="C"><div class="L">BANKROLL</div>';
      o+='<div class="V g" style="margin:8px 0">$'+fN(S.bankroll)+'</div>';
      o+='<input type="number" class="I" value="'+S.bankroll+'" onchange="setBR(Number(this.value))" style="width:150px">';
      var totSess=0,totWon2=0;S.sessions.forEach(function(s){totSess+=s.s;totWon2+=s.w;});
      o+='<div style="margin-top:10px;font-size:11px">Sessions P/L: <span class="'+(totWon2-totSess>=0?'g':'r')+'">'+(totWon2-totSess>=0?'+':'')+fN(totWon2-totSess)+'</span></div>';
      o+='<div style="font-size:11px">Effective: $'+fN(S.bankroll+(totWon2-totSess))+'</div></div>';
    }
    else if(S.moreTab==="data"){
      o+='<div class="C"><div class="L">DATA MANAGEMENT</div>';
      o+='<div style="font-size:11px;margin:8px 0">Games: '+GD.length+' \xb7 Date: '+(DD||"?")+' \xb7 Winners: '+(S.winData?Object.keys(S.winData).length:0)+' games</div>';
      o+='<div style="display:flex;gap:8px;flex-wrap:wrap">';
      o+='<div class="B on" style="font-size:10px" onclick="refreshAllData()">\u21bb Refresh Games</div>';
      o+='<div class="B bn" style="font-size:10px" onclick="fetchWinners()">\u21bb Load Winners</div>';
      o+='<div class="B rn" style="font-size:10px" onclick="if(confirm(\'Clear all local data?\')){localStorage.clear();location.reload()}">\u26a0 Reset All</div>';
      o+='</div></div>';
    }
  }

  document.getElementById("app").innerHTML=o;
}

// === BOOT ===
init();
</script>
</body>
</html>
